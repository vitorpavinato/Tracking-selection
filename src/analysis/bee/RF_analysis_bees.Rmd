---
title: "Tracking Selection in Bees with ABC-RF"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean cache, echo=TRUE, eval=FALSE, include=TRUE}
rm(list=ls())
ls()
```

## ABC random forests analysis

#### Install required packages
```{r install packages, echo=TRUE}
#install.packages(c("DataExplorer", 
#                   "abcrf",
#                   "weights",
#                   "grDevices",
#                   "gplots",
#                   "viridis",
#                   "gtools",
#                   "ENmisc"),
#                 dependencies = T)
```

#### Load packages and source file
```{r load packages, echo=TRUE, eval=FALSE, include=TRUE}
library(DataExplorer)
library(abcrf)
library(weights)     # for the weighted histograms
library(grDevices)
library(gplots)
library(viridis)
library(gtools)
library(ENmisc)      # for the weighted boxplot
```

#### Upload the RF training reference table files
```{r load superbatch 1, echo=TRUE, eval=FALSE, include=TRUE}
# MUSE 2 - Super-batch 1
load("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/Cluster_data/muse/tracking-selection-bees-2/results/pooled_reftable_2.RData")
pooled_raw_reftable_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 2, echo=TRUE, eval=FALSE, include=TRUE}
# MUSE 3 - Super-batch 2
load("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/Cluster_data/muse/tracking-selection-bees-3/results/pooled_reftable_3.RData")
pooled_raw_reftable_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 3, echo=TRUE, eval=FALSE, include=TRUE}
# MUSE 4 - Super-batch 3
load("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/Cluster_data/muse/tracking-selection-bees-4/results/pooled_reftable_4.RData")
pooled_raw_reftable_3 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 4, echo=TRUE, eval=FALSE, include=TRUE}
# MUSE 5 - Super-batch 4
load("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/Cluster_data/muse/tracking-selection-bees-5/results/pooled_reftable_5.RData")
pooled_raw_reftable_4 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 5, echo=TRUE, eval=FALSE, include=TRUE}
# OSC 1 - Super-batch 5
load("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/Cluster_data/osc/tracking-selection-bees-6/results/pooled_reftable_6.RData")
pooled_raw_reftable_5 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

#### Pool together the reftables from super-batches
```{r pooling reftable, echo=TRUE, eval=FALSE, include=TRUE}
pooled_raw_reftable_bees_total <- rbind(pooled_raw_reftable_1,
                                        pooled_raw_reftable_2,
                                        pooled_raw_reftable_3,
                                        pooled_raw_reftable_4,
                                        pooled_raw_reftable_5
                                       )

rm(pooled_raw_reftable_1)
rm(pooled_raw_reftable_2)
rm(pooled_raw_reftable_3)
rm(pooled_raw_reftable_4)
rm(pooled_raw_reftable_5)

#save(pooled_raw_reftable_bees_total, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_total",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_total",".RData"))
```

#### Prepare the training RF reftable
```{r training data preparation, echo=TRUE, eval=FALSE, include=TRUE}

## AVALON POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_avalon <- pooled_raw_reftable_bees_total[,-c(408:2135)]

#save(pooled_raw_reftable_bees_avalon, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_avalon",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_avalon) 
missing_count_ava <- sapply(pooled_raw_reftable_bees_avalon, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_avalon <- pooled_raw_reftable_bees_avalon[,missing_count_ava < nrow(pooled_raw_reftable_bees_avalon)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_avalon <- pooled_reftable_bees_avalon[,-c(123:124, # POPSelMean and POPSelSd
                                                               #126,     # POPStrongSelMean
                                                               127,     # POPStrongSelSd
                                                               129:130, # SAMSelMean and SAMSelSd
                                                               132:133, # SAMStrongSelMean and SAMStrongSelSd
                                                               134:138, # FSTfdrNS
                                                               139:167)]# LSS and WSSs 

# check it!
missing_count_ava <- sapply(pooled_reftable_bees_avalon, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_avalon) 

# remove remaining rows with missing data
pooled_reftable_bees_avalon <- pooled_reftable_bees_avalon[complete.cases(pooled_reftable_bees_avalon), ]

# check it again
plot_missing(pooled_reftable_bees_avalon)
table(missing_count_ava <- sapply(pooled_reftable_bees_avalon, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_ava <- sapply(pooled_reftable_bees_avalon, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_avalon)
# 13953   287

## Original
#save(pooled_reftable_bees_avalon, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_avalon",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_avalon, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_avalon_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_avalon_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_avalon <- pooled_reftable_bees_avalon[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_avalon)
# 13953   162

#save(global_sumstats4training_avalon, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_avalon",".RData"))

## HUMBOLDT POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_humboldt <- pooled_raw_reftable_bees_total[,-c(120:407, 696:2135)]

#save(pooled_raw_reftable_bees_humboldt, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_humboldt",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_humboldt) 
missing_count_hum <- sapply(pooled_raw_reftable_bees_humboldt, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_humboldt <- pooled_raw_reftable_bees_humboldt[,missing_count_hum < nrow(pooled_raw_reftable_bees_humboldt)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_humboldt <- pooled_reftable_bees_humboldt[,-c(123:124, # POPSelMean and POPSelSd
                                                                   #126,     # POPStrongSelMean
                                                                   127,     # POPStrongSelSd
                                                                   129:130, # SAMSelMean and SAMSelSd
                                                                   132:133, # SAMStrongSelMean and SAMStrongSelSd
                                                                   134:138, # FSTfdrNS
                                                                   139:167)]# LSS and WSSs 

# check it!
missing_count_hum <- sapply(pooled_reftable_bees_humboldt, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_humboldt) 

# remove remaining rows with missing data
pooled_reftable_bees_humboldt <- pooled_reftable_bees_humboldt[complete.cases(pooled_reftable_bees_humboldt), ]

# check it again
plot_missing(pooled_reftable_bees_humboldt)
table(missing_count_hum <- sapply(pooled_reftable_bees_humboldt, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_hum <- sapply(pooled_reftable_bees_humboldt, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_humboldt)
# 14216   287

#save(pooled_reftable_bees_humboldt, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_humboldt",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_humboldt, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_humboldt_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_humboldt_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_humboldt <- pooled_reftable_bees_humboldt[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_humboldt)
# 14216   162

#save(global_sumstats4training_humboldt, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_humboldt",".RData"))

## DAVIS POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_davis <- pooled_raw_reftable_bees_total[,-c(120:695, 984:2135)]

#save(pooled_raw_reftable_bees_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_davis",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_davis) 
missing_count_dav <- sapply(pooled_raw_reftable_bees_davis, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_davis <- pooled_raw_reftable_bees_davis[,missing_count_dav < nrow(pooled_raw_reftable_bees_davis)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_davis <- pooled_reftable_bees_davis[,-c(123:124, # POPSelMean and POPSelSd
                                                             #126,     # POPStrongSelMean
                                                             127,     #POPStrongSelSd
                                                             129:130, # SAMSelMean and SAMSelSd
                                                             132:133, # SAMStrongSelMean and SAMStrongSelSd
                                                             134:138, # FSTfdrNS
                                                             139:167)]# LSS and WSSs 

# check it!
missing_count_dav <- sapply(pooled_reftable_bees_davis, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_davis) 

# remove remaining rows with missing data
pooled_reftable_bees_davis <- pooled_reftable_bees_davis[complete.cases(pooled_reftable_bees_davis), ]

# check it again
plot_missing(pooled_reftable_bees_davis)
table(missing_count_dav <- sapply(pooled_reftable_bees_davis, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_dav <- sapply(pooled_reftable_bees_davis, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_davis)
# 13970   287

#save(pooled_reftable_bees_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_davis",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_davis_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_davis_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_davis <- pooled_reftable_bees_davis[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_davis)
# 13970   162

#save(global_sumstats4training_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_davis",".RData"))

## STANISLAUS POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_stanislaus <- pooled_raw_reftable_bees_total[,-c(120:983, 1272:2135)]

#save(pooled_raw_reftable_bees_stanislaus, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_stanislaus",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_stanislaus) 
missing_count_sta <- sapply(pooled_raw_reftable_bees_stanislaus, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_stanislaus <- pooled_raw_reftable_bees_stanislaus[,missing_count_sta < nrow(pooled_raw_reftable_bees_stanislaus)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_stanislaus <- pooled_reftable_bees_stanislaus[,-c(123:124, # POPSelMean and POPSelSd
                                                                       #126,     # POPStrongSelMean 
                                                                       127,     # POPStrongSelSd
                                                                       129:130, # SAMSelMean and SAMSelSd
                                                                       132:133, # SAMStrongSelMean and SAMStrongSelSd
                                                                       134:138, # FSTfdrNS
                                                                       139:167)]# LSS and WSSs 

# check it!
missing_count_sta <- sapply(pooled_reftable_bees_stanislaus, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_stanislaus) 

# remove remaining rows with missing data
pooled_reftable_bees_stanislaus <- pooled_reftable_bees_stanislaus[complete.cases(pooled_reftable_bees_stanislaus), ]

# check it again
plot_missing(pooled_reftable_bees_stanislaus)
table(missing_count_sta <- sapply(pooled_reftable_bees_stanislaus, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_sta <- sapply(pooled_reftable_bees_stanislaus, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_stanislaus)
# 13956   287

#save(pooled_reftable_bees_stanislaus, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stanislaus",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_stanislaus, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stanislaus_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stanislaus_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_stanislaus <- pooled_reftable_bees_stanislaus[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_stanislaus)
# 13956   162

#save(global_sumstats4training_stanislaus, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_stanislaus",".RData"))

## STEBBINS POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_stebbins <- pooled_raw_reftable_bees_total[,-c(120:1271, 1560:2135)]

#save(pooled_raw_reftable_bees_stebbins, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_stebbins",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_stebbins) 
missing_count_ste <- sapply(pooled_raw_reftable_bees_stebbins, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_stebbins <- pooled_raw_reftable_bees_stebbins[,missing_count_ste < nrow(pooled_raw_reftable_bees_stebbins)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_stebbins <- pooled_reftable_bees_stebbins[,-c(123:124, # POPSelMean and POPSelSd
                                                                   #126,    # POPStrongSelMean
                                                                   127,     # POPStrongSelSd
                                                                   129:130, # SAMSelMean and SAMSelSd
                                                                   132:133, # SAMStrongSelMean and SAMStrongSelSd
                                                                   134:138, # FSTfdrNS
                                                                   139:167)]# LSS and WSSs 

# check it!
missing_count_ste <- sapply(pooled_reftable_bees_stebbins, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_stebbins) 

# remove remaining rows with missing data
pooled_reftable_bees_stebbins <- pooled_reftable_bees_stebbins[complete.cases(pooled_reftable_bees_stebbins), ]

# check it again
plot_missing(pooled_reftable_bees_stebbins)
table(missing_count_ste <- sapply(pooled_reftable_bees_stebbins, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_ste <- sapply(pooled_reftable_bees_stebbins, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_stebbins)
# 14121   287

#save(pooled_reftable_bees_stebbins, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stebbins",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_stebbins, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stebbins_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_stebbins_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_stebbins <- pooled_reftable_bees_stebbins[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_stebbins)
# 14121   162

#save(global_sumstats4training_stebbins, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_stebbins",".RData"))

## RIVERSIDE POPULATION
##-------------------------------------

# Take only the parameters and variables
pooled_raw_reftable_bees_riverside <- pooled_raw_reftable_bees_total[,-c(120:1559, 1848:2135)]

#save(pooled_raw_reftable_bees_riverside, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_riverside",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_riverside) 
missing_count_riv <- sapply(pooled_raw_reftable_bees_riverside, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_riverside <- pooled_raw_reftable_bees_riverside[,missing_count_riv < nrow(pooled_raw_reftable_bees_riverside)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_riverside <- pooled_reftable_bees_riverside[,-c(123:124, # POPSelMean and POPSelSd
                                                                     #126,     # POPStrongSelMean
                                                                     127,     # POPStrongSelSd
                                                                     129, # SAMSelMean and SAMSelSd
                                                                     131:132, # SAMStrongSelMean and SAMStrongSelSd
                                                                     133:137, # FSTfdrNS
                                                                     138:166)]# LSS and WSSs 

# check it!
missing_count_riv <- sapply(pooled_reftable_bees_riverside, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_riverside) 

# remove remaining rows with missing data
pooled_reftable_bees_riverside <- pooled_reftable_bees_riverside[complete.cases(pooled_reftable_bees_riverside), ]

# check it again
plot_missing(pooled_reftable_bees_riverside)
table(missing_count_riv <- sapply(pooled_reftable_bees_riverside, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_riv <- sapply(pooled_reftable_bees_riverside, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_riverside)
# 13930   287

#save(pooled_reftable_bees_riverside, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_riverside",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_riverside, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_riverside_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_riverside_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_riverside <- pooled_reftable_bees_riverside[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_riverside)
# 13930   162

#save(global_sumstats4training_riverside, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_riverside",".RData"))

## PLACERITA POPULATION
##-------------------------------------

# Take only the parameters and variables
#pooled_raw_reftable_bees_total[, grepl("^_Pla", names(pooled_raw_reftable_bees_total))]
pooled_raw_reftable_bees_placerita <- pooled_raw_reftable_bees_total[,-c(120:1847)]

#save(pooled_raw_reftable_bees_placerita, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_raw_reftable_bees_placerita",".RData"))

# Check missing data
plot_missing(pooled_raw_reftable_bees_placerita) 
missing_count_pla <- sapply(pooled_raw_reftable_bees_placerita, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_bees_placerita <- pooled_raw_reftable_bees_placerita[,missing_count_pla < nrow(pooled_raw_reftable_bees_placerita)/2]

# remove also POPSelSd, SAMSelSd, FSTfdr* and locus-specific summary stats columns
pooled_reftable_bees_placerita <- pooled_reftable_bees_placerita[,-c(123:124, # POPSelMean and POPSelSd
                                                                     #126,     # POPStrongSelMean
                                                                     127,     # POPStrongSelSd
                                                                     129, # SAMSelMean and SAMSelSd
                                                                     131:132, # SAMStrongSelMean and SAMStrongSelSd
                                                                     133:137, # FSTfdrNS
                                                                     138:166)]# LSS and WSSs 

# check it!
missing_count_pla <- sapply(pooled_reftable_bees_placerita, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_bees_placerita) 

# remove remaining rows with missing data
pooled_reftable_bees_placerita <- pooled_reftable_bees_placerita[complete.cases(pooled_reftable_bees_placerita), ]

# check it again
plot_missing(pooled_reftable_bees_placerita)
table(missing_count_pla <- sapply(pooled_reftable_bees_placerita, function(x) sum(is.na(x))))

# Check != numeric values
table(infinite_count_pla <- sapply(pooled_reftable_bees_placerita, function(x) sum(is.infinite(x))))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_bees_placerita)
# 14125   287

#save(pooled_reftable_bees_placerita, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_placerita",".RData"))

## with POPStrongSelMean - USE THIS ##
#save(pooled_reftable_bees_placerita, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_placerita_new",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/pooled_reftable_bees_placerita_new",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats4training_placerita <- pooled_reftable_bees_placerita[, -c(1:126)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats4training_placerita)
# 14125   162

#save(global_sumstats4training_placerita, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/global_sumstats4training_placerita",".RData"))

## List with all global reftable used for training
list.global.SumStats4Training <- list(Ava=global_sumstats4training_avalon, Hum=global_sumstats4training_humboldt,
                                      Dav=global_sumstats4training_davis, Sta=global_sumstats4training_stanislaus,
                                      Ste=global_sumstats4training_stebbins, Riv=global_sumstats4training_riverside,
                                      Pla=global_sumstats4training_placerita)

#save(list.global.SumStats4Training, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/list_global_SumStats4Training",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/list_global_SumStats4Training",".RData"))
```

#### Prepare the DATA reftable
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

## AVALON POPULATION
##-----------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/avalon_globalStats_reftable.RData")

global_Obssumstats_avalon <- data2globalStats

global_Obssumstats_avalon <- global_Obssumstats_avalon[, names(global_Obssumstats_avalon) %in% names(global_sumstats4training_avalon), drop=FALSE]

table(missing_count_ava <- sapply(global_Obssumstats_avalon, function(x) sum(is.na(x))))

global_Obssumstats_avalon$GSSp_D1_Ava <- 0

#save(global_Obssumstats_avalon, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_avalon",".RData"))

## HUMBOLDT POPULATION
##-------------------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/humboldt_globalStats_reftable.RData")

global_Obssumstats_humboldt <- data2globalStats

global_Obssumstats_humboldt <- global_Obssumstats_humboldt[, names(global_Obssumstats_humboldt) %in% names(global_sumstats4training_humboldt), drop=FALSE]

table(missing_count_ava <- sapply(global_Obssumstats_humboldt, function(x) sum(is.na(x))))

#save(global_Obssumstats_humboldt, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_humboldt",".RData"))

## DAVIS POPULATION
##-----------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/davis_globalStats_reftable.RData")

global_Obssumstats_davis <- data2globalStats

global_Obssumstats_avalon <- global_Obssumstats_davis[, names(global_Obssumstats_davis) %in% names(global_sumstats4training_davis), drop=FALSE]

table(missing_count_dav <- sapply(global_Obssumstats_davis, function(x) sum(is.na(x))))

global_Obssumstats_davis[,c(2,30,35,53,58,76,81,97,102)] <- 0

#save(global_Obssumstats_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_davis",".RData"))

#save(global_Obssumstats_davis, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_davis_mod",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_davis_mod",".RData"))

## STANISLAUS POPULATION
##-------------------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/stanislaus_globalStats_reftable.RData")

global_Obssumstats_stanislaus <- data2globalStats

global_Obssumstats_stanislaus <- global_Obssumstats_stanislaus[, names(global_Obssumstats_stanislaus) %in% names(global_sumstats4training_stanislaus), drop=FALSE]

table(missing_count_ava <- sapply(global_Obssumstats_stanislaus, function(x) sum(is.na(x))))

#save(global_Obssumstats_stanislaus, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_stanislaus",".RData"))

## STEBBINS POPULATION
##-----------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/stebbins_globalStats_reftable.RData")

global_Obssumstats_stebbins <- data2globalStats

global_Obssumstats_stebbins <- global_Obssumstats_stebbins[, names(global_Obssumstats_stebbins) %in% names(global_sumstats4training_stebbins), drop=FALSE]

table(missing_count_ste <- sapply(global_Obssumstats_stebbins, function(x) sum(is.na(x))))

#save(global_Obssumstats_stebbins, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_stebbins",".RData"))

## RIVERSIDE POPULATION
##-------------------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/riverside_globalStats_reftable.RData")

global_Obssumstats_riverside <- data2globalStats

global_Obssumstats_riverside <- global_Obssumstats_riverside[, names(global_Obssumstats_riverside) %in% names(global_sumstats4training_riverside), drop=FALSE]

table(missing_count_ava <- sapply(global_Obssumstats_riverside, function(x) sum(is.na(x))))

#save(global_Obssumstats_riverside, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_riverside",".RData"))

## PLACERITA POPULATION
##-----------------------------

# global summary stats reftable
load("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/placerita_globalStats_reftable.RData")

global_Obssumstats_placerita <- data2globalStats

global_Obssumstats_placerita <- global_Obssumstats_placerita[, names(global_Obssumstats_placerita) %in% names(global_sumstats4training_placerita), drop=FALSE]

table(missing_count_pla <- sapply(global_Obssumstats_placerita, function(x) sum(is.na(x))))

#save(global_Obssumstats_placerita, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/global_Obssumstats_placerita",".RData"))

## List of the observed summary statistics of all populations
list.ObsSumStats <- list(Ava=global_Obssumstats_avalon, Hum=global_Obssumstats_humboldt, 
                         Dav=global_Obssumstats_davis, Sta=global_Obssumstats_stanislaus, 
                         Ste=global_Obssumstats_stebbins, Riv=global_Obssumstats_riverside,
                         Pla=global_Obssumstats_placerita)

#save(list.ObsSumStats, 
#     file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/list_ObsSumStats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/list_ObsSumStats",".RData"))
```

## Sampling period inference

### ABC-RF classification for selection: growing trees of for short-term evolution inference

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

## AVALON POPULATION
##-----------------------------
#selection_avalon <- ifelse(pooled_reftable_bees_avalon[, "POPPrStrongMSel_Ava"] == 0, "qNeutral", "sSel")
#table(selection_avalon)
#
## rf-classification
#class_selection_avalon <- abcrf(formula = selection_avalon~.,
#                                data    = data.frame(selection_avalon, 
#                                                     global_sumstats4training_avalon[,-c(19,22,25,120)]
#                                                     ),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
#save(class_selection_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_avalon",".RData"))
#
#(class_selection_avalon)
#Number of simulations: 13953
#Out-of-bag prior error rate: 23.878%
#
#Confusion matrix:
#         qNeutral sSel class.error
#qNeutral     2931 1904   0.3937952
#sSel         1649 7469   0.1808511
#
#same as:
#table(class_selection_avalon, class_selection_avalon$model.rf$predictions)
#
# GLOBAL ERROR
#sum(as.character(class_selection_avalon$model.rf$predictions)!=selection_avalon_subset)/length(selection_avalon_subset)
#class_selection_avalon$model.rf$confusion.matrix
#
## error rate plot
#err.abcrf(object   = class_selection_avalon,
#          training = data.frame(selection_avalon_subset, global_sumstats4training_avalon[,-c(19,22,25,120)]),
#          paral    = T,
#         ncores   = 6)
#
#plot(class_selection_avalon, 
#     training = data.frame(selection_avalon, global_sumstats4training_avalon[,-c(19,22,25,120)]),
#     obs=NULL, 
#     n.var=10)
#
## Classification as a function of theta*PS
#
# theta * P_S 
#-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_ava <- pooled_reftable_bees_avalon[, "PrGWSel"] * pooled_reftable_bees_avalon[, "PrMSel"]
#  
#logthetaPS_ava <- log10(4 * pooled_reftable_bees_avalon[, "Ncs"] * (pooled_reftable_bees_avalon[, "mu"] * prRSel_ava) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_avalon, 
#                             pred=class_selection_avalon$model.rf$predictions, 
#                             logthetaPS=logthetaPS_ava) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_ava <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
#save(obs_pred_class_ava, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_ava",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_ava",".RData"))
#
# simple plot
#plot(obs_pred_class_ava$logthetaPS,
#     obs_pred_class_ava$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-7, 7),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
## HUMBOLDT POPULATION
##-------------------------------------
#selection_humboldt <- ifelse(pooled_reftable_bees_humboldt[, "POPPrStrongMSel_Hum"] == 0, "qNeutral", "sSel")
#table(selection_humboldt)
#
## rf-classification
#class_selection_humboldt <- abcrf(formula = selection_humboldt~.,
#                                  data    = data.frame(selection_humboldt, #global_sumstats4training_humboldt[,-c(19,22,25,120,121)]),
#                                  lda     = TRUE, 
#                                  ntree   = 1000,
#                                  paral   = T,
#                                  ncores  = 6)
#
#save(class_selection_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_humboldt",".RData"))
#
#(class_selection_humboldt)
#Number of simulations: 14216
#Out-of-bag prior error rate: 26.6812%
#
#Confusion matrix:
#         qNeutral sSel class.error
#qNeutral     3727 1664   0.3086626
#sSel         2129 6696   0.2412465
#
# GLOBAL ERROR
#sum(as.character(class_selection_humboldt$model.rf$predictions)!=selection_humboldt_subset)/length(selection_humboldt_subset)
#class_selection_humboldt$model.rf$confusion.matrix
#0.2418846
#
## error rate plot
#err.abcrf(object   = class_selection_humboldt,
#          training = data.frame(selection_humboldt_subset, gss_humboldt_subset[,-c(19,22,25,120,121)]),
#          paral    = T,
#         ncores   = 6)
#
#plot(class_selection_humboldt, 
#     training = data.frame(selection_humboldt, global_sumstats4training_humboldt[,-c(19,22,25,120,121)]),
#     obs=NULL, 
#     n.var=10)
#
#variableImpPlot(class_selection_humboldt,
#                n.var = 20)
#
## Classification as a function of theta*PS
#
## theta * P_S 
##-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_hum <- pooled_reftable_bees_humboldt[, "PrGWSel"] * pooled_reftable_bees_humboldt[, "PrMSel"]
#  
#logthetaPS_hum <- log10(4 * pooled_reftable_bees_humboldt[, "Ncs"] * (pooled_reftable_bees_humboldt[, "mu"] * prRSel_hum) * #genomeS)
#
#obs_pred_class <- data.frame(obs=selection_humboldt, 
#                             pred=class_selection_humboldt$model.rf$predictions, 
#                             logthetaPS=logthetaPS_hum) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_hum <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
#save(obs_pred_class_hum, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_hum",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_hum",".RData"))
#
# simple plot
#plot(obs_pred_class_hum$logthetaPS,
#     obs_pred_class_hum$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-6, 6),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### DAVIS POPULATION
###-----------------------------
#selection_davis <- ifelse(pooled_reftable_bees_davis[, "POPPrStrongMSel_Dav"] == 0, "qNeutral", "sSel")
#table(selection_davis)
#
### rf-classification
#class_selection_davis <- abcrf(formula = selection_davis~.,
#                                data    = data.frame(selection_davis, global_sumstats4training_davis[,-c(19,22,25,120)]),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
##save(class_selection_davis, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_davis",".RData#"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_davis",".RData")#)
#
#(class_selection_davis)
##Number of simulations: 13970
##Out-of-bag prior error rate: 27.8525%
##
##Confusion matrix:
##        qNeutral sSel class.error
##qNeutral     3269 1969   0.3759068
##sSel         1922 6810   0.2201099
#
## GLOBAL ERROR
#sum(as.character(class_selection_davis$model.rf$predictions)!=selection_davis_subset)/length(selection_davis_subset)
#class_selection_davis$model.rf$confusion.matrix
#
#
### error rate plot
##err.abcrf(object   = class_selection_davis,
##          training = data.frame(selection_davis_subset, gss_davis_subset[,-c(19,22,25,120,121)]),
##          paral    = T,
##         ncores   = 6)
#
#plot(class_selection_davis, 
#     training = data.frame(selection_davis, global_sumstats4training_davis[,-c(19,22,25,120)]),
#     obs=NULL, 
#     n.var=20)
#
#variableImpPlot(class_selection_davis,
#                n.var = 10)
#
### Classification as a function of theta*PS
#
### theta * P_S 
###-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_dav <- pooled_reftable_bees_davis[, "PrGWSel"] * pooled_reftable_bees_davis[, "PrMSel"]
#  
#logthetaPS_dav <- log10(4 * pooled_reftable_bees_davis[, "Ncs"] * (pooled_reftable_bees_davis[, "mu"] * prRSel_dav) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_davis, 
#                             pred=class_selection_davis$model.rf$predictions, 
#                             logthetaPS=logthetaPS_dav) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_dav <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
##save(obs_pred_class_dav, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_dav",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_dav",".RData"))
#
### simple plot
#plot(obs_pred_class_dav$logthetaPS,
#     obs_pred_class_dav$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-6, 6),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### STANISLAUS POPULATION
###-------------------------------------
#selection_stanislaus <- ifelse(pooled_reftable_bees_stanislaus[, "POPPrStrongMSel_Sta"] == 0, "qNeutral", "sSel")
#table(selection_stanislaus)
#
### rf-classification
#class_selection_stanislaus <- abcrf(formula = selection_stanislaus~.,
#                                data    = data.frame(selection_stanislaus, 
#                                                     global_sumstats4training_stanislaus[,-c(19,24,120)]),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
##save(class_selection_stanislaus, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_stanislaus",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_stanislaus",".RData"))
#
#(class_selection_stanislaus)
##Number of simulations: 13956
##Out-of-bag prior error rate: 27.9235%
##
##Confusion matrix:
##         qNeutral sSel class.error
##qNeutral     3404 1929   0.3617101
##sSel         1968 6655   0.2282268
#
## GLOBAL ERROR
#sum(as.character(class_selection_stanislaus$model.rf$predictions)!=selection_stanislaus_subset)/length(selection_stanislaus_subset)
#class_selection_stanislaus$model.rf$confusion.matrix
#
#
### error rate plot
##err.abcrf(object   = class_selection_stanislaus,
##          training = data.frame(selection_stanislaus_subset, gss_stanislaus_subset[,-c(19,24,120)]),
##          paral    = T,
##         ncores   = 6)
#
#plot(class_selection_stanislaus, 
#     training = data.frame(selection_stanislaus, global_sumstats4training_stanislaus[,-c(19,24,120)]),
#     obs=NULL, 
#     n.var=20)
#
#variableImpPlot(class_selection_stanislaus,
#                n.var = 20)
#
### Classification as a function of theta*PS
#
## theta * P_S 
##-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_sta <- pooled_reftable_bees_stanislaus[, "PrGWSel"] * pooled_reftable_bees_stanislaus[, "PrMSel"]
#  
#logthetaPS_sta <- log10(4 * pooled_reftable_bees_stanislaus[, "Ncs"] * (pooled_reftable_bees_stanislaus[, "mu"] * prRSel_sta) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_stanislaus, 
#                             pred=class_selection_stanislaus$model.rf$predictions, 
#                             logthetaPS=logthetaPS_sta) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_sta <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
##save(obs_pred_class_sta, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_sta",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_sta",".RData"))
#
## simple plot
#plot(obs_pred_class_sta$logthetaPS,
#     obs_pred_class_sta$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-6, 6),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### STEBBINS POPULATION
###-----------------------------
#selection_stebbins <- ifelse(pooled_reftable_bees_stebbins[, "POPPrStrongMSel_Ste"] == 0, "qNeutral", "sSel")
#table(selection_stebbins)
#
### rf-classification
#class_selection_stebbins <- abcrf(formula = selection_stebbins~.,
#                                data    = data.frame(selection_stebbins, global_sumstats4training_stebbins),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
##save(class_selection_stebbins, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_stebbins",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_stebbins",".RData"))
#
#(class_selection_stebbins)
##Number of simulations: 14121
##Out-of-bag prior error rate: 28.8931%
##
##Confusion matrix:
##         qNeutral sSel class.error
##qNeutral     3800 1904   0.3338008
##sSel         2176 6241   0.2585244
#
## GLOBAL ERROR
#sum(as.character(class_selection_stebbins$model.rf$predictions)!=selection_stebbins_subset)/length(selection_stebbins_subset)
#class_selection_stebbins$model.rf$confusion.matrix
##0.2805926
#
### error rate plot
#err.abcrf(object   = class_selection_stebbins,
#          training = data.frame(selection_stebbins, global_sumstats4training_stebbins),
#          paral    = T,
#         ncores   = 6)
#
#plot(class_selection_stebbins, 
#     training = data.frame(selection_stebbins, global_sumstats4training_stebbins),
#     obs=NULL, 
#     n.var=20)
#
#variableImpPlot(class_selection_stebbins,
#                n.var = 10)
#
### Classification as a function of theta*PS
#
## theta * P_S 
##-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_ste <- pooled_reftable_bees_stebbins[, "PrGWSel"] * pooled_reftable_bees_stebbins[, "PrMSel"]
#  
#logthetaPS_ste <- log10(4 * pooled_reftable_bees_stebbins[, "Ncs"] * (pooled_reftable_bees_stebbins[, "mu"] * prRSel_ste) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_stebbins, 
#                             pred=class_selection_stebbins$model.rf$predictions, 
#                             logthetaPS=logthetaPS_ste) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_ste <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
#save(obs_pred_class_ste, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_ste",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_ste",".RData"))
#
## simple plot
#plot(obs_pred_class_ste$logthetaPS,
#     obs_pred_class_ste$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-7, 7),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### RIVERSIDE POPULATION
###-------------------------------------
#selection_riverside <- ifelse(pooled_reftable_bees_riverside[, "POPPrStrongMSel_Riv"] == 0, "qNeutral", "sSel")
#table(selection_riverside)
#
### rf-classification
#class_selection_riverside <- abcrf(formula = selection_riverside~.,
#                                data    = data.frame(selection_riverside, global_sumstats4training_riverside),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
##save(class_selection_riverside, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_riverside",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_riverside",".RData"))
#
#(class_selection_riverside)
##Number of simulations: 13930
##Out-of-bag prior error rate: 29.9641%
##
##Confusion matrix:
##         qNeutral sSel class.error
##qNeutral     3448 2170   0.3862585
##sSel         2004 6308   0.2410972
#
## GLOBAL ERROR
#sum(as.character(class_selection_riverside$model.rf$predictions)!=selection_riverside_subset)/length(selection_riverside_subset)
#class_selection_riverside$model.rf$confusion.matrix
##0.2996618
#
### error rate plot
#err.abcrf(object   = class_selection_riverside,
#          training = data.frame(selection_riverside, global_sumstats4training_riverside),
#          paral    = T,
#         ncores   = 6)
#
#plot(class_selection_riverside, 
#     training = data.frame(selection_riverside, global_sumstats4training_riverside),
#     obs=NULL, 
#     n.var=10)
#
#variableImpPlot(class_selection_riverside,
#                n.var = 20)
#
### Classification as a function of theta*PS
#
## theta * P_S 
##-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_riv <- pooled_reftable_bees_riverside[, "PrGWSel"] * pooled_reftable_bees_riverside[, "PrMSel"]
#  
#logthetaPS_riv <- log10(4 * pooled_reftable_bees_riverside[, "Ncs"] * (pooled_reftable_bees_riverside[, "mu"] * prRSel_riv) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_riverside, 
#                             pred=class_selection_riverside$model.rf$predictions, 
#                             logthetaPS=logthetaPS_riv) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_riv <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
##save(obs_pred_class_riv, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_riv",".RData"))
##load(file=pastev0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_riv",".RData"))
#
## simple plot
#plot(obs_pred_class_riv$logthetaPS,
#     obs_pred_class_riv$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-7, 7),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### PLACERITA POPULATION
###-----------------------------
#selection_placerita <- ifelse(pooled_reftable_bees_placerita[, "POPPrStrongMSel_Pla"] == 0, "qNeutral", "sSel")
#table(selection_placerita)
#
### rf-classification
#class_selection_placerita <- abcrf(formula = selection_placerita~.,
#                                data    = data.frame(selection_placerita, global_sumstats4training_placerita),
#                                lda     = TRUE, 
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 6)
#
##save(class_selection_placerita, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_placerita",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/class_selection_placerita",".RData"))
#
#(class_selection_placerita)
#  #Number of simulations: 14125
##Out-of-bag prior error rate: 29.6%
##
##Confusion matrix:
##         qNeutral sSel class.error
##qNeutral     3862 1896   0.3292810
##sSel         2285 6082   0.2730967
#
## GLOBAL ERROR
#sum(as.character(class_selection_placerita$model.rf$predictions)!=selection_placerita_subset)/length(selection_placerita_subset)
#class_selection_placerita$model.rf$confusion.matrix
#
### error rate plot
#err.abcrf(object   = class_selection_placerita,
#          training = data.frame(selection_placerita, global_sumstats4training_placerita),
#          paral    = T,
#         ncores   = 6)
#
#plot(class_selection_placerita, 
#     training = data.frame(selection_placerita, global_sumstats4training_placerita),
#     obs=NULL, 
#     n.var=20)
#
#variableImpPlot(class_selection_placerita,
#                n.var = 10)
#
### Classification as a function of theta*PS
#
## theta * P_S 
##-----------------------------------------------------------
#genomeS = 250e+6
#prRSel_pla <- pooled_reftable_bees_placerita[, "PrGWSel"] * pooled_reftable_bees_placerita[, "PrMSel"]
#  
#logthetaPS_pla <- log10(4 * pooled_reftable_bees_placerita[, "Ncs"] * (pooled_reftable_bees_placerita[, "mu"] * prRSel_pla) * genomeS)
#
#obs_pred_class <- data.frame(obs=selection_placerita, 
#                             pred=class_selection_placerita$model.rf$predictions, 
#                             logthetaPS=logthetaPS_pla) 
#
#error <- (obs_pred_class$obs!=obs_pred_class$pred)
#
#tol<-0.2
#local_error <- array(NA,nrow(obs_pred_class))
#for (i in seq_len(nrow(obs_pred_class))){
#  
#    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
#  
#  # calculate weigths from epachnikov kernel
#  nacc <- ceiling(length(distance) * tol)
#  ds   <- sort(distance)[nacc]
#  weights <- 1 - (distance/ds)^2
#  weights[which(weights<0)]<-0
#
#  # calculated weighthed proportion of error
#  local_error[i]<-sum(error*weights)/sum(weights)
#}
#
#obs_pred_class["error"] <- local_error
#
#obs_pred_class_pla <- obs_pred_class[order(obs_pred_class$logthetaPS),]
#
##save(obs_pred_class_pla, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_pla",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/obs_pred_class_error_pla",".RData"))
#
## simple plot
#plot(obs_pred_class_pla$logthetaPS,
#     obs_pred_class_pla$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     xlim=c(-7, 7),
#     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")
#
### Lis of the vectors of observations used to train the RFs
#list.classSelection <- list(Ava=selection_avalon, Hum=selection_humboldt, 
#                            Dav=selection_davis, Sta=selection_stanislaus, 
#                            Ste=selection_stebbins, Riv=selection_riverside,
#                            Pla=selection_placerita)
#
##save(list.classSelection, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_classSelection",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_classSelection",".RData"))
#
### List of RF
#list.rfclass.selection <- list(Ava=class_selection_avalon,Hum=class_selection_humboldt, 
#                                Dav=class_selection_davis, Sta=class_selection_stanislaus, 
#                                Ste=class_selection_stebbins,Riv=class_selection_riverside,
#                                Pla=class_selection_placerita)
#
##save(list.rfclass.selection, 
##    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_rfclass_selection",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_rfclass_selection",".RData"))
#
#list.global.SumStats4Training.class <- list(Ava=global_sumstats4training_avalon[,-c(19,22,25,120)], 
#                                            Hum=global_sumstats4training_humboldt[,-c(19,22,25,120,121)], 
#                                            Dav=global_sumstats4training_davis[,-c(19,22,25,120)], 
#                                            Sta=global_sumstats4training_stanislaus[,-c(19,24,120)], 
#                                            Ste=global_sumstats4training_stebbins,
#                                            Riv=global_sumstats4training_riverside,
#                                            Pla=global_sumstats4training_placerita)
#
##save(list.global.SumStats4Training.class, 
##    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_class",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_class",".RData"))
```

### ABC-RF regression for selection: growing trees for short-term evolution inference

#### Average genetic load
```{r regression genetic load, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------

averageGenLoad_avalon <- pooled_reftable_bees_avalon[, "averageGenLoad_Ava"]
hist(averageGenLoad_avalon, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_avalon <- which(averageGenLoad_avalon == 0)

# Neutral simulations
averageGenLoad_load_zero_avalon <- averageGenLoad_avalon[load_zero_avalon]
global_sumstats_averageGenLoad_load_zero_avalon <- global_sumstats4training_avalon[load_zero_avalon,]

# Non-neutral simulations
averageGenLoad_avalon_2 <- averageGenLoad_avalon[-load_zero_avalon]
global_sumstats4training_avalon_averageGenLoad <- global_sumstats4training_avalon[-load_zero_avalon,]

# Logit transformation
logitaverageGenload_avalon <- log(averageGenLoad_avalon_2/(1-averageGenLoad_avalon_2))
hist(logitaverageGenload_avalon, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_avalon_2 <- regAbcrf(formula = logitaverageGenload_avalon~.,
                                        data    = data.frame(logitaverageGenload_avalon, 
                                                             global_sumstats4training_avalon_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_avalon_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_avalon_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_avalon_2",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_avalon_2, n.var = 20)

## prediction error
reg_averageGenLoad_avalon_2$model.rf$prediction.error
# 10.36159
inv.logit(reg_averageGenLoad_avalon_2$model.rf$prediction.error)
#  0.9999684

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_avalon_2,
#             training = data.frame(logitaverageGenload_avalon, global_sumstats4training_avalon_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

## HUMBOLDT POPULATION
##-------------------------------------
averageGenLoad_humboldt <- pooled_reftable_bees_humboldt[, "averageGenLoad_Hum"]
hist(averageGenLoad_humboldt, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_humboldt <- which(averageGenLoad_humboldt <= 0)

# Neutral simulations
averageGenLoad_load_zero_humboldt <- averageGenLoad_humboldt[load_zero_humboldt]
global_sumstats_averageGenLoad_load_zero_humboldt <- global_sumstats4training_humboldt[load_zero_humboldt,]

# Non-neutral simulations
averageGenLoad_humboldt_2 <- averageGenLoad_humboldt[-load_zero_humboldt]
global_sumstats4training_humboldt_averageGenLoad <- global_sumstats4training_humboldt[-load_zero_humboldt,]

# Logit transformation
logitaverageGenload_humboldt <- log(averageGenLoad_humboldt_2/(1-averageGenLoad_humboldt_2))
hist(logitaverageGenload_humboldt, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_humboldt_2 <- regAbcrf(formula = logitaverageGenload_humboldt~.,
                                        data    = data.frame(logitaverageGenload_humboldt, 
                                                             global_sumstats4training_humboldt_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_humboldt_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_humboldt_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_humboldt_2",".RData"))

## variable Importance plot
#plot(x = reg_averageGenLoad_humboldt_2, n.var = 10)

## prediction error
reg_averageGenLoad_humboldt_2$model.rf$prediction.error
# 11.41886
inv.logit(reg_averageGenLoad_humboldt_2$model.rf$prediction.error)
#  0.999989

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_humboldt_2,
#             training = data.frame(logitaverageGenload_humboldt, global_sumstats4training_humboldt_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

### DAVIS POPULATION
###-----------------------------------------------------------
averageGenLoad_davis <- pooled_reftable_bees_davis[, "averageGenLoad_Dav"]
hist(averageGenLoad_davis, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_davis <- which(averageGenLoad_davis <= 0)

# Neutral simulations
averageGenLoad_load_zero_davis <- averageGenLoad_davis[load_zero_davis]
global_sumstats_averageGenLoad_load_zero_davis <- global_sumstats4training_davis[load_zero_davis,]

# Non-neutral simulations
averageGenLoad_davis_2 <- averageGenLoad_davis[-load_zero_davis]
global_sumstats4training_davis_averageGenLoad <- global_sumstats4training_davis[-load_zero_davis,]

logitaverageGenload_davis <- log(averageGenLoad_davis_2/(1-averageGenLoad_davis_2))
hist(logitaverageGenload_davis, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_davis_2 <- regAbcrf(formula = logitaverageGenload_davis~.,
                                        data    = data.frame(logitaverageGenload_davis, 
                                                             global_sumstats4training_davis_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_davis_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_davis_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_davis_2",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_davis_2, n.var = 10)

## prediction error
reg_averageGenLoad_davis_2$model.rf$prediction.error
# 12.38065
inv.logit(reg_averageGenLoad_davis_2$model.rf$prediction.error)
#  0.9999958

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_davis_2,
#             training = data.frame(logitaverageGenload_davis, global_sumstats4training_davis_averageGenLoad),
#             paral    = T,
#             ncores   = 8)


## STANISLAUS POPULATION
##-------------------------------------
averageGenLoad_stanislaus <- pooled_reftable_bees_stanislaus[, "averageGenLoad_Sta"]
hist(averageGenLoad_stanislaus, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_stanislaus <- which(averageGenLoad_stanislaus <= 0)

# Neutral simulations
averageGenLoad_load_zero_stanislaus <- averageGenLoad_stanislaus[load_zero_stanislaus]
global_sumstats_averageGenLoad_load_zero_stanislaus <- global_sumstats4training_stanislaus[load_zero_stanislaus,]

# Non-neutral simulations
averageGenLoad_stanislaus_2 <- averageGenLoad_stanislaus[-load_zero_stanislaus]
global_sumstats4training_stanislaus_averageGenLoad <- global_sumstats4training_stanislaus[-load_zero_stanislaus,]

logitaverageGenload_stanislaus <- log(averageGenLoad_stanislaus_2/(1-averageGenLoad_stanislaus_2))
hist(logitaverageGenload_stanislaus, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_stanislaus_2 <- regAbcrf(formula = logitaverageGenload_stanislaus~.,
                                        data    = data.frame(logitaverageGenload_stanislaus, 
                                                             global_sumstats4training_stanislaus_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_stanislaus_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_stanislaus_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_stanislaus_2",".RData"))

## variable Importance plot
#plot(x = reg_averageGenLoad_stanislaus_2, n.var = 10)

## prediction error
reg_averageGenLoad_stanislaus_2$model.rf$prediction.error
# 12.50297
inv.logit(reg_averageGenLoad_stanislaus_2$model.rf$prediction.error)
#  0.9999963

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_stanislaus_2,
#             training = data.frame(logitaverageGenload_stanislaus, global_sumstats4training_stanislaus_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

### STEBBINS POPULATION
###-----------------------------------------------------------
averageGenLoad_stebbins <- pooled_reftable_bees_stebbins[, "averageGenLoad_Ste"]
hist(averageGenLoad_stebbins, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_stebbins <- which(averageGenLoad_stebbins <= 0)

# Neutral simulations
averageGenLoad_load_zero_stebbins <- averageGenLoad_stebbins[load_zero_stebbins]
global_sumstats_averageGenLoad_load_zero_stebbins <- global_sumstats4training_stebbins[load_zero_stebbins,]

# Non-neutral simulations
averageGenLoad_stebbins_2 <- averageGenLoad_stebbins[-load_zero_stebbins]
global_sumstats4training_stebbins_averageGenLoad <- global_sumstats4training_stebbins[-load_zero_stebbins,]

logitaverageGenload_stebbins <- log(averageGenLoad_stebbins_2/(1-averageGenLoad_stebbins_2))
hist(logitaverageGenload_stebbins, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_stebbins_2 <- regAbcrf(formula = logitaverageGenload_stebbins~.,
                                        data    = data.frame(logitaverageGenload_stebbins, 
                                                             global_sumstats4training_stebbins_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_stebbins_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_stebbins_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_stebbins_2",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_stebbins_2, n.var = 10)

## prediction error
reg_averageGenLoad_stebbins_2$model.rf$prediction.error
# 13.41465
inv.logit(reg_averageGenLoad_stebbins_2$model.rf$prediction.error)
#  0.9999985

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_stebbins_2,
#             training = data.frame(logitaverageGenload_stebbins, global_sumstats4training_stebbins_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

## RIVERSIDE POPULATION
##-------------------------------------
averageGenLoad_riverside <- pooled_reftable_bees_riverside[, "averageGenLoad_Riv"]
hist(averageGenLoad_riverside, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_riverside <- which(averageGenLoad_riverside <= 0)

# Neutral simulations
averageGenLoad_load_zero_riverside <- averageGenLoad_riverside[load_zero_riverside]
global_sumstats_averageGenLoad_load_zero_riverside <- global_sumstats4training_riverside[load_zero_riverside,]

# Non-neutral simulations
averageGenLoad_riverside_2 <- averageGenLoad_riverside[-load_zero_riverside]
global_sumstats4training_riverside_averageGenLoad <- global_sumstats4training_riverside[-load_zero_riverside,]

logitaverageGenload_riverside <- log(averageGenLoad_riverside_2/(1-averageGenLoad_riverside_2))
hist(logitaverageGenload_riverside, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_riverside_2 <- regAbcrf(formula = logitaverageGenload_riverside~.,
                                        data    = data.frame(logitaverageGenload_riverside, 
                                                             global_sumstats4training_riverside_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_riverside_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_riverside_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_riverside_2",".RData"))

## variable Importance plot
#plot(x = reg_averageGenLoad_riverside_2, n.var = 10)

## prediction error
reg_averageGenLoad_riverside_2$model.rf$prediction.error
# 14.8087
inv.logit(reg_averageGenLoad_riverside_2$model.rf$prediction.error)
#  0.9999996

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_riverside_2,
#             training = data.frame(logitaverageGenload_riverside, global_sumstats4training_riverside_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

### PLACERITA POPULATION
###-----------------------------------------------------------
averageGenLoad_placerita <- pooled_reftable_bees_placerita[, "averageGenLoad_Pla"]
hist(averageGenLoad_placerita, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero_placerita <- which(averageGenLoad_placerita <= 0) #1e-10 [tried 02-05-2020]

# Neutral simulations
averageGenLoad_load_zero_placerita <- averageGenLoad_placerita[load_zero_placerita]
global_sumstats_averageGenLoad_load_zero_placerita <- global_sumstats4training_placerita[load_zero_placerita,]

# Non-neutral simulations
averageGenLoad_placerita_2 <- averageGenLoad_placerita[-load_zero_placerita]
global_sumstats4training_placerita_averageGenLoad <- global_sumstats4training_placerita[-load_zero_placerita,]

logitaverageGenload_placerita <- log(averageGenLoad_placerita_2/(1-averageGenLoad_placerita_2))
hist(logitaverageGenload_placerita, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_placerita_2 <- regAbcrf(formula = logitaverageGenload_placerita~.,
                                        data    = data.frame(logitaverageGenload_placerita, 
                                                             global_sumstats4training_placerita_averageGenLoad),
                                        ntree   = 1000,
                                        paral   = T,
                                        ncores  = 8)

#save(reg_averageGenLoad_placerita_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_placerita_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_averageGenLoad_placerita_2",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_placerita_2, n.var = 10)

## prediction error
reg_averageGenLoad_placerita_2$model.rf$prediction.error
# 14.05361
inv.logit(reg_averageGenLoad_placerita_2$model.rf$prediction.error)
#  0.9999992

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_placerita_2,
#             training = data.frame(logitaverageGenload_placerita, global_sumstats4training_placerita_averageGenLoad),
#             paral    = T,
#             ncores   = 8)

## List of the reftable of summary statistics used for training the RFs
list.SumStats4Training.averageGenLoad<- list(Ava=global_sumstats4training_avalon_averageGenLoad, Hum=global_sumstats4training_humboldt_averageGenLoad,
                                             Dav=global_sumstats4training_davis_averageGenLoad, Sta=global_sumstats4training_stanislaus_averageGenLoad,
                                             Ste=global_sumstats4training_stebbins_averageGenLoad, Riv=global_sumstats4training_riverside_averageGenLoad,
                                             Pla=global_sumstats4training_placerita_averageGenLoad)


#save(list.SumStats4Training.averageGenLoad, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_averageGenLoad",".RData"))

## Lis of the vectors of observations used to train the RFs
list.averageGenLoad <- list(Ava=logitaverageGenload_avalon, Hum=logitaverageGenload_humboldt, 
                            Dav=logitaverageGenload_davis, Sta=logitaverageGenload_stanislaus, 
                            Ste=logitaverageGenload_stebbins, Riv=logitaverageGenload_riverside,
                            Pla=logitaverageGenload_placerita)

#save(list.averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_averageGenLoad",".RData"))

## List of RF
list.reg.averageGenLoad <- list(Ava=reg_averageGenLoad_avalon_2,Hum=reg_averageGenLoad_humboldt_2, 
                                Dav=reg_averageGenLoad_davis_2, Sta=reg_averageGenLoad_stanislaus_2, 
                                Ste=reg_averageGenLoad_stebbins_2,Riv=reg_averageGenLoad_riverside_2,
                                Pla=reg_averageGenLoad_placerita_2)

#save(list.reg.averageGenLoad, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_averageGenLoad",".RData"))


## List of vector with zero load
list.zero.averageGenLoad <- list(Ava=averageGenLoad_load_zero_avalon, Hum=averageGenLoad_load_zero_humboldt, 
                                 Dav=averageGenLoad_load_zero_davis, Sta=averageGenLoad_load_zero_stanislaus, 
                                 Ste=averageGenLoad_load_zero_stebbins, Riv=averageGenLoad_load_zero_riverside,
                                 Pla=averageGenLoad_load_zero_placerita)

#save(list.zero.averageGenLoad, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_averageGenLoad",".RData"))

## List of the reftable of summary statistics of zero load simulations
list.zero.averageGenLoad.summstats <- list(Ava=global_sumstats_averageGenLoad_load_zero_avalon, Hum=global_sumstats_averageGenLoad_load_zero_humboldt, 
                                           Dav=global_sumstats_averageGenLoad_load_zero_davis, Sta=global_sumstats_averageGenLoad_load_zero_stanislaus, 
                                           Ste=global_sumstats_averageGenLoad_load_zero_stebbins, Riv=global_sumstats_averageGenLoad_load_zero_riverside,
                                           Pla=global_sumstats_averageGenLoad_load_zero_placerita)

#save(list.zero.averageGenLoad.summstats, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_averageGenLoad_summstats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_averageGenLoad_summstats",".RData"))

## PREDICTION - Neutral simulations
##---------------------------------

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_averageGenLoad_summstats",".RData"))
 
list.posterior.zero.averageGenLoad <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                           Ste=NULL,Riv=NULL, Pla=NULL)
for (i in 2:7){
  
  reg_averageGenLoad = list.reg.averageGenLoad[[i]]
  ObsSumStats.zero = list.zero.averageGenLoad.summstats[[i]]
  averageGenLoad = list.averageGenLoad[[i]]
  SumStats4Training.load = list.SumStats4Training.averageGenLoad[[i]]
  
  posterior.zero.averageGenLoad <- predict(object     = reg_averageGenLoad,
                                           obs        = ObsSumStats.zero,
                                           training   = data.frame(averageGenLoad, 
                                                                   SumStats4Training.load),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 8,
                                           rf.weights = T)
  
  list.posterior.zero.averageGenLoad[[i]] <- posterior.zero.averageGenLoad
}

#save(list.posterior.zero.averageGenLoad, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_averageGenLoad",".RData"))
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r regression strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
prPOPStrongMSel_avalon <- pooled_reftable_bees_avalon[, "POPPrStrongMSel_Ava"]
hist(prPOPStrongMSel_avalon, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_avalon <- which(prPOPStrongMSel_avalon == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_avalon <- prPOPStrongMSel_avalon[neutralsims_avalon]
global_sumstats_popstrongmsel_neutralsims_avalon <- global_sumstats4training_avalon[neutralsims_avalon,]

# Non-neutral simulations
prPOPStrongMSel_avalon_2 <- prPOPStrongMSel_avalon[-neutralsims_avalon]
global_sumstats4training_avalon_popstrongmsel <- global_sumstats4training_avalon[-neutralsims_avalon,]

hist(prPOPStrongMSel_avalon_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# # Logit transformation
logitpopstrongmsel_avalon <- log(prPOPStrongMSel_avalon_2/(1-prPOPStrongMSel_avalon_2))
hist(logitpopstrongmsel_avalon, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_avalon <- regAbcrf(formula = logitpopstrongmsel_avalon~.,
                                            data    = data.frame(logitpopstrongmsel_avalon, global_sumstats4training_avalon_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_avalon",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel_avalon, n.var = 20)

#head(sort(reg_logpopstrongmsel_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_avalon$model.rf$prediction.error
# 1.53131

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_avalon,
#             training = data.frame(logitpopstrongmsel, global_sumstats4training_avalon_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

## HUMBOLDT POPULATION
##-------------------------------------
prPOPStrongMSel_humboldt <- pooled_reftable_bees_humboldt[, "POPPrStrongMSel_Hum"]
hist(prPOPStrongMSel_humboldt, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_humboldt <- which(prPOPStrongMSel_humboldt == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_humboldt <- prPOPStrongMSel_humboldt[neutralsims_humboldt]
global_sumstats_popstrongmsel_neutralsims_humboldt <- global_sumstats4training_humboldt[neutralsims_humboldt,]

# Non-neutral simulations
prPOPStrongMSel_humboldt_2 <- prPOPStrongMSel_humboldt[-neutralsims_humboldt]
global_sumstats4training_humboldt_popstrongmsel <- global_sumstats4training_humboldt[-neutralsims_humboldt,]

hist(prPOPStrongMSel_humboldt_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_humboldt <- log(prPOPStrongMSel_humboldt_2/(1-prPOPStrongMSel_humboldt_2))
hist(logitpopstrongmsel_humboldt, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_humboldt <- regAbcrf(formula = logitpopstrongmsel_humboldt~.,
                                            data    = data.frame(logitpopstrongmsel_humboldt, global_sumstats4training_humboldt_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_humboldt",".RData"))

## variable Importance plot
#plot(x = reg_logitpopstrongmsel_humboldt, n.var = 10)

#head(sort(reg_logpopstrongmsel_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_humboldt$model.rf$prediction.error
# 1.470658

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_humboldt,
#             training = data.frame(logitpopstrongmsel_humboldt, global_sumstats4training_humboldt_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

### DAVIS POPULATION
###-----------------------------------------------------------
prPOPStrongMSel_davis <- pooled_reftable_bees_davis[, "POPPrStrongMSel_Dav"]
hist(prPOPStrongMSel_davis, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_davis <- which(prPOPStrongMSel_davis == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_davis <- prPOPStrongMSel_davis[neutralsims_davis]
global_sumstats_popstrongmsel_neutralsims_davis <- global_sumstats4training_davis[neutralsims_davis,]

# Non-neutral simulations
prPOPStrongMSel_davis_2 <- prPOPStrongMSel_davis[-neutralsims_davis]
global_sumstats4training_davis_popstrongmsel <- global_sumstats4training_davis[-neutralsims_davis,]

hist(prPOPStrongMSel_davis_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_davis <- log(prPOPStrongMSel_davis_2/(1-prPOPStrongMSel_davis_2))
hist(logitpopstrongmsel_davis, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_davis <- regAbcrf(formula = logitpopstrongmsel_davis~.,
                                            data    = data.frame(logitpopstrongmsel_davis, global_sumstats4training_davis_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_davis",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel_davis, n.var = 10)

#head(sort(reg_logpopstrongmsel_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_davis$model.rf$prediction.error
# 1.637508

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_davis,
#             training = data.frame(logitpopstrongmsel_davis, global_sumstats4training_davis_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

## STANISLAUS POPULATION
##-------------------------------------
prPOPStrongMSel_stanislaus <- pooled_reftable_bees_stanislaus[, "POPPrStrongMSel_Sta"]
hist(prPOPStrongMSel_stanislaus, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_stanislaus <- which(prPOPStrongMSel_stanislaus == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_stanislaus <- prPOPStrongMSel_stanislaus[neutralsims_stanislaus]
global_sumstats_popstrongmsel_neutralsims_stanislaus <- global_sumstats4training_stanislaus[neutralsims_stanislaus,]

# Non-neutral simulations
prPOPStrongMSel_stanislaus_2 <- prPOPStrongMSel_stanislaus[-neutralsims_stanislaus]
global_sumstats4training_stanislaus_popstrongmsel <- global_sumstats4training_stanislaus[-neutralsims_stanislaus,]

hist(prPOPStrongMSel_stanislaus_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_stanislaus <- log(prPOPStrongMSel_stanislaus_2/(1-prPOPStrongMSel_stanislaus_2))
hist(logitpopstrongmsel_stanislaus, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_stanislaus <- regAbcrf(formula = logitpopstrongmsel_stanislaus~.,
                                            data    = data.frame(logitpopstrongmsel_stanislaus, global_sumstats4training_stanislaus_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_stanislaus",".RData"))

## variable Importance plot
#plot(x = reg_logitpopstrongmsel_stanislaus, n.var = 10)

#head(sort(reg_logpopstrongmsel_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_stanislaus$model.rf$prediction.error
  # 1.638098

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_stanislaus,
#             training = data.frame(logitpopstrongmsel_stanislaus, global_sumstats4training_stanislaus_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

### STEBBINS POPULATION
###-----------------------------------------------------------
prPOPStrongMSel_stebbins <- pooled_reftable_bees_stebbins[, "POPPrStrongMSel_Ste"]
hist(prPOPStrongMSel_stebbins, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_stebbins <- which(prPOPStrongMSel_stebbins == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_stebbins <- prPOPStrongMSel_stebbins[neutralsims_stebbins]
global_sumstats_popstrongmsel_neutralsims_stebbins <- global_sumstats4training_stebbins[neutralsims_stebbins,]

# Non-neutral simulations
prPOPStrongMSel_stebbins_2 <- prPOPStrongMSel_stebbins[-neutralsims_stebbins]
global_sumstats4training_stebbins_popstrongmsel <- global_sumstats4training_stebbins[-neutralsims_stebbins,]

hist(prPOPStrongMSel_stebbins_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_stebbins <- log(prPOPStrongMSel_stebbins_2/(1-prPOPStrongMSel_stebbins_2))
hist(logitpopstrongmsel_stebbins, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_stebbins <- regAbcrf(formula = logitpopstrongmsel_stebbins~.,
                                            data    = data.frame(logitpopstrongmsel_stebbins, global_sumstats4training_stebbins_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_stebbins",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel_stebbins, n.var = 10)

#head(sort(reg_logpopstrongmsel_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_stebbins$model.rf$prediction.error
# 1.661701

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_stebbins,
#             training = data.frame(logitpopstrongmsel_stebbins, global_sumstats4training_stebbins_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

## RIVERSIDE POPULATION
##-------------------------------------
prPOPStrongMSel_riverside <- pooled_reftable_bees_riverside[, "POPPrStrongMSel_Riv"]
hist(prPOPStrongMSel_riverside, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_riverside <- which(prPOPStrongMSel_riverside == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_riverside <- prPOPStrongMSel_riverside[neutralsims_riverside]
global_sumstats_popstrongmsel_neutralsims_riverside <- global_sumstats4training_riverside[neutralsims_riverside,]

# Non-neutral simulations
prPOPStrongMSel_riverside_2 <- prPOPStrongMSel_riverside[-neutralsims_riverside]
global_sumstats4training_riverside_popstrongmsel <- global_sumstats4training_riverside[-neutralsims_riverside,]

hist(prPOPStrongMSel_riverside_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_riverside <- log(prPOPStrongMSel_riverside_2/(1-prPOPStrongMSel_riverside_2))
hist(logitpopstrongmsel_riverside, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_riverside <- regAbcrf(formula = logitpopstrongmsel_riverside~.,
                                            data    = data.frame(logitpopstrongmsel_riverside, global_sumstats4training_riverside_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_riverside",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel_riverside, n.var = 10)

#head(sort(reg_logpopstrongmsel_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_riverside$model.rf$prediction.error
# 1.904825

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_riverside,
#             training = data.frame(logitpopstrongmsel_riverside, global_sumstats4training_riverside_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

### PLACERITA POPULATION
###-----------------------------------------------------------
prPOPStrongMSel_placerita <- pooled_reftable_bees_placerita[, "POPPrStrongMSel_Pla"]
hist(prPOPStrongMSel_placerita, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## removing "quasi-neutral" simulations
neutralsims_placerita <- which(prPOPStrongMSel_placerita == 0)

## Neutral simulations
prPOPStrongMSel_neutralsims_placerita <- prPOPStrongMSel_placerita[neutralsims_placerita]
global_sumstats_popstrongmsel_neutralsims_placerita <- global_sumstats4training_placerita[neutralsims_placerita,]

# Non-neutral simulations
prPOPStrongMSel_placerita_2 <- prPOPStrongMSel_placerita[-neutralsims_placerita]
global_sumstats4training_placerita_popstrongmsel <- global_sumstats4training_placerita[-neutralsims_placerita,]

hist(prPOPStrongMSel_placerita_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel_placerita <- log(prPOPStrongMSel_placerita_2/(1-prPOPStrongMSel_placerita_2))
hist(logitpopstrongmsel_placerita, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel_placerita <- regAbcrf(formula = logitpopstrongmsel_placerita~.,
                                            data    = data.frame(logitpopstrongmsel_placerita, global_sumstats4training_placerita_popstrongmsel),
                                            ntree   = 1000,
                                            paral   = T,
                                            ncores  = 8)

#save(reg_logitpopstrongmsel_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logitpopstrongmsel_placerita",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel_placerita, n.var = 10)

#head(sort(reg_logpopstrongmsel_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel_placerita$model.rf$prediction.error
# 1.728943

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_placerita,
#             training = data.frame(logitpopstrongmsel_placerita, global_sumstats4training_placerita_popstrongmsel),
#             paral    = T,
#            ncores   = 8)

## List of the reftable of summary statistics used for training the RFs
list.SumStats4Training.popstrongmsel <- list(Ava=global_sumstats4training_avalon_popstrongmsel, Hum=global_sumstats4training_humboldt_popstrongmsel,
                                             Dav=global_sumstats4training_davis_popstrongmsel, Sta=global_sumstats4training_stanislaus_popstrongmsel,
                                             Ste=global_sumstats4training_stebbins_popstrongmsel, Riv=global_sumstats4training_riverside_popstrongmsel,
                                             Pla=global_sumstats4training_placerita_popstrongmsel)


#save(list.SumStats4Training.popstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongmsel",".RData"))

## Lis of the vectors of observations used to train the RFs
list.logitpopstrongmsel <- list(Ava=logitpopstrongmsel_avalon, Hum=logitpopstrongmsel_humboldt, 
                                Dav=logitpopstrongmsel_davis, Sta=logitpopstrongmsel_stanislaus, 
                                Ste=logitpopstrongmsel_stebbins, Riv=logitpopstrongmsel_riverside,
                                Pla=logitpopstrongmsel_placerita)

#save(list.logitpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logitpopstrongmsel",".RData"))

## List of RF
list.reg.logitpopstrongmsel <- list(Ava=reg_logitpopstrongmsel_avalon, Hum=reg_logitpopstrongmsel_humboldt, 
                                    Dav=reg_logitpopstrongmsel_davis, Sta=reg_logitpopstrongmsel_stanislaus, 
                                    Ste=reg_logitpopstrongmsel_stebbins ,Riv=reg_logitpopstrongmsel_riverside,
                                    Pla=reg_logitpopstrongmsel_placerita)

#save(list.reg.logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logitpopstrongmsel",".RData"))

## List of vector with zero popstrongmsel
list.zero.popstrongmsel <- list(Ava=prPOPStrongMSel_neutralsims_avalon, Hum=prPOPStrongMSel_neutralsims_humboldt, 
                                Dav=prPOPStrongMSel_neutralsims_davis, Sta=prPOPStrongMSel_neutralsims_stanislaus, 
                                Ste=prPOPStrongMSel_neutralsims_stebbins, Riv=prPOPStrongMSel_neutralsims_riverside,
                                Pla=prPOPStrongMSel_neutralsims_placerita)

#save(list.zero.popstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongmsel",".RData"))

## List of the reftable of summary statistics of zero popstrongmsel simulations
list.zero.popstrongmsel.summstats <- list(Ava=global_sumstats_popstrongmsel_neutralsims_avalon, Hum=global_sumstats_popstrongmsel_neutralsims_humboldt, 
                                           Dav=global_sumstats_popstrongmsel_neutralsims_davis, Sta=global_sumstats_popstrongmsel_neutralsims_stanislaus, 
                                           Ste=global_sumstats_popstrongmsel_neutralsims_stebbins, Riv=global_sumstats_popstrongmsel_neutralsims_riverside,
                                           Pla=global_sumstats_popstrongmsel_neutralsims_placerita)

#save(list.zero.popstrongmsel.summstats, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongmsel_summstats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongmsel_summstats",".RData"))

## PREDICTION - Neutral simulations
##---------------------------------

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongmsel_summstats",".RData"))
 
list.posterior.zero.popstrongmsel <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                           Ste=NULL,Riv=NULL, Pla=NULL)
for (i in 2:7){
  
  reg_popstrongmsel               = list.reg.logitpopstrongmsel[[i]]
  ObsSumStats.popstrongmsel.zero  = list.zero.popstrongmsel.summstats[[i]]
  popstrongmsel                   = list.logitpopstrongmsel[[i]]
  SumStats4Training.popstrongmsel = list.SumStats4Training.popstrongmsel[[i]]
  
  posterior.zero.popstrongmsel <- predict(object     = reg_popstrongmsel,
                                           obs        = ObsSumStats.popstrongmsel.zero,
                                           training   = data.frame(popstrongmsel, 
                                                                   SumStats4Training.popstrongmsel),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 8,
                                           rf.weights = T)
  
  list.posterior.zero.popstrongmsel[[i]] <- posterior.zero.popstrongmsel
}

#save(list.posterior.zero.popstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_popstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_popstrongmsel",".RData"))
```

#### Theta selected mutations
```{r regression thetaS, echo=TRUE, eval=FALSE, include=TRUE}
genomeS = 250e+6

### AVALON POPULATION
###-----------------------------------------------------------
prRSel_ava <- pooled_reftable_bees_avalon[, "PrGWSel"] * pooled_reftable_bees_avalon[, "PrMSel"]
logthetaPS_ava <- log10(4 * pooled_reftable_bees_avalon[, "Ncs"] * (pooled_reftable_bees_avalon[, "mu"] * prRSel_ava) * genomeS)

hist(logthetaPS_ava, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_avalon <- regAbcrf(formula = logthetaPS_ava~.,
                                 data    = data.frame(logthetaPS_ava, global_sumstats4training_avalon),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_avalon",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS_avalon, n.var = 20)

#head(sort(reg_logthetaPS_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_avalon$model.rf$prediction.error
# 1.579821

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_avalon,
#             training = data.frame(logthetaPS_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)

## HUMBOLDT POPULATION
##-------------------------------------
prRSel_hum <- pooled_reftable_bees_humboldt[, "PrGWSel"] * pooled_reftable_bees_humboldt[, "PrMSel"]
logthetaPS_hum <- log10(4 * pooled_reftable_bees_humboldt[, "Ncs"] * (pooled_reftable_bees_humboldt[, "mu"] * prRSel_hum) * genomeS)

hist(logthetaPS_hum, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_humboldt <- regAbcrf(formula = logthetaPS_hum~.,
                                 data    = data.frame(logthetaPS_hum, global_sumstats4training_humboldt),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_humboldt",".RData"))

## variable Importance plot
#plot(x = reg_logthetaPS_humboldt, n.var = 10)

#head(sort(reg_logthetaPS_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_humboldt$model.rf$prediction.error
# 1.589853

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_humboldt,
#             training = data.frame(logthetaPS_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)

### DAVIS POPULATION
###-----------------------------------------------------------
prRSel_dav <- pooled_reftable_bees_davis[, "PrGWSel"] * pooled_reftable_bees_davis[, "PrMSel"]
logthetaPS_dav <- log10(4 * pooled_reftable_bees_davis[, "Ncs"] * (pooled_reftable_bees_davis[, "mu"] * prRSel_dav) * genomeS)

hist(logthetaPS_dav, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_davis <- regAbcrf(formula = logthetaPS_dav~.,
                                 data    = data.frame(logthetaPS_dav, global_sumstats4training_davis),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_davis",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS_davis, n.var = 10)

#head(sort(reg_logthetaPS_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_davis$model.rf$prediction.error
# 1.693215

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_davis,
#             training = data.frame(logthetaPS_dav, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)

## STANISLAUS POPULATION
##-------------------------------------
prRSel_sta <- pooled_reftable_bees_stanislaus[, "PrGWSel"] * pooled_reftable_bees_stanislaus[, "PrMSel"]
logthetaPS_sta <- log10(4 * pooled_reftable_bees_stanislaus[, "Ncs"] * (pooled_reftable_bees_stanislaus[, "mu"] * prRSel_sta) * genomeS)

hist(logthetaPS_sta, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_stanislaus <- regAbcrf(formula = logthetaPS_sta~.,
                                 data    = data.frame(logthetaPS_sta, global_sumstats4training_stanislaus),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_stanislaus",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS_stanislaus, n.var = 10)

#head(sort(reg_logthetaPS_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_stanislaus$model.rf$prediction.error
# 1.684667

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_stanislaus,
#             training = data.frame(logthetaPS_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)

### STEBBINS POPULATION
###-----------------------------------------------------------
prRSel_ste <- pooled_reftable_bees_stebbins[, "PrGWSel"] * pooled_reftable_bees_stebbins[, "PrMSel"]
logthetaPS_ste <- log10(4 * pooled_reftable_bees_stebbins[, "Ncs"] * (pooled_reftable_bees_stebbins[, "mu"] * prRSel_ste) * genomeS)

hist(logthetaPS_ste, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_stebbins <- regAbcrf(formula = logthetaPS_ste~.,
                                 data    = data.frame(logthetaPS_ste, global_sumstats4training_stebbins),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_stebbins",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS_stebbins, n.var = 10)

#head(sort(reg_logthetaPS_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_stebbins$model.rf$prediction.error
# 1.72105

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_stebbins,
#             training = data.frame(logthetaPS_ste, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)

## RIVERSIDE POPULATION
##-------------------------------------
prRSel_riv <- pooled_reftable_bees_riverside[, "PrGWSel"] * pooled_reftable_bees_riverside[, "PrMSel"]
logthetaPS_riv <- log10(4 * pooled_reftable_bees_riverside[, "Ncs"] * (pooled_reftable_bees_riverside[, "mu"] * prRSel_riv) * genomeS)

hist(logthetaPS_riv, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_riverside <- regAbcrf(formula = logthetaPS_riv~.,
                                 data    = data.frame(logthetaPS_riv, global_sumstats4training_riverside),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_riverside",".RData"))

## variable Importance plot
#plot(x = reg_logthetaPS_riverside, n.var = 10)

#head(sort(reg_logthetaPS_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_riverside$model.rf$prediction.error
# 1.850934

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_riverside,
#             training = data.frame(logthetaPS_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)

### PLACERITA POPULATION
###-----------------------------------------------------------
prRSel_pla <- pooled_reftable_bees_placerita[, "PrGWSel"] * pooled_reftable_bees_placerita[, "PrMSel"]
logthetaPS_pla <- log10(4 * pooled_reftable_bees_placerita[, "Ncs"] * (pooled_reftable_bees_placerita[, "mu"] * prRSel_pla) * genomeS)

hist(logthetaPS_pla, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS_placerita <- regAbcrf(formula = logthetaPS_pla~.,
                                 data    = data.frame(logthetaPS_pla, global_sumstats4training_placerita),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_logthetaPS_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logthetaPS_placerita",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS_placerita, n.var = 10)

#head(sort(reg_logthetaPS_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS_placerita$model.rf$prediction.error
# 1.735243

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS_placerita,
#             training = data.frame(logthetaPS_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)

## Lis of the vectors of observations used to train the RFs
list.logthetaPS <- list(Ava=logthetaPS_ava, Hum=logthetaPS_hum, 
                        Dav=logthetaPS_dav, Sta=logthetaPS_sta, 
                        Ste=logthetaPS_ste, Riv=logthetaPS_riv,
                        Pla=logthetaPS_pla)

#save(list.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logthetaPS",".RData"))

## List of RF
list.reg.logthetaPS <- list(Ava=reg_logthetaPS_avalon,Hum=reg_logthetaPS_humboldt, 
                            Dav=reg_logthetaPS_davis, Sta=reg_logthetaPS_stanislaus, 
                            Ste=reg_logthetaPS_stebbins,Riv=reg_logthetaPS_riverside,
                            Pla=reg_logthetaPS_placerita)

#save(list.reg.logthetaPS, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logthetaPS",".RData"))
```

#### gamma mean - parameter
```{r regression gamma mean parameter, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
loggammamean_ava <- log10(pooled_reftable_bees_avalon[, "gammaMean"])

hist(loggammamean_ava, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_avalon <- regAbcrf(formula = loggammamean_ava~.,
                                  data    = data.frame(loggammamean_ava, global_sumstats4training_avalon),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_avalon",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_avalon, n.var = 20)
#
#head(sort(reg_loggammamean_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_avalon$model.rf$prediction.error
# 0.6225528
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_avalon,
#             training = data.frame(loggammamean_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)

### HUMBOLDT POPULATION
###-----------------------------------------------------------
loggammamean_hum <- log10(pooled_reftable_bees_humboldt[, "gammaMean"])

hist(loggammamean_hum, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_humboldt <- regAbcrf(formula = loggammamean_hum~.,
                                  data    = data.frame(loggammamean_hum, global_sumstats4training_humboldt),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_humboldt",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_humboldt, n.var = 20)
#
#head(sort(reg_loggammamean_humboldt$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_humboldt$model.rf$prediction.error
# 0.628008
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_humboldt,
#             training = data.frame(loggammamean_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)
#
### DAVIS POPULATION
###-----------------------------------------------------------
loggammamean_dav <- log10(pooled_reftable_bees_davis[, "gammaMean"])

hist(loggammamean_dav, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_davis <- regAbcrf(formula = loggammamean_dav~.,
                                  data    = data.frame(loggammamean_dav, global_sumstats4training_davis),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_davis",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_davis, n.var = 20)
#
#head(sort(reg_loggammamean_davis$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_davis$model.rf$prediction.error
# 0.6330641
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_davis,
#             training = data.frame(loggammamean_dav, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)
#

### STANISLAUS POPULATION
###-----------------------------------------------------------
loggammamean_sta <- log10(pooled_reftable_bees_stanislaus[, "gammaMean"])

hist(loggammamean_sta, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_stanislaus <- regAbcrf(formula = loggammamean_sta~.,
                                  data    = data.frame(loggammamean_sta, global_sumstats4training_stanislaus),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_stanislaus",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_stanislaus, n.var = 20)
#
#head(sort(reg_loggammamean_stanislaus$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_stanislaus$model.rf$prediction.error
  # 0.6277625
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_stanislaus,
#             training = data.frame(loggammamean_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)
#

### STEBBINS POPULATION
###-----------------------------------------------------------
loggammamean_ste <- log10(pooled_reftable_bees_stebbins[, "gammaMean"])

hist(loggammamean_ste, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_stebbins <- regAbcrf(formula = loggammamean_ste~.,
                                  data    = data.frame(loggammamean_ste, global_sumstats4training_stebbins),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_stebbins",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_stebbins, n.var = 20)
#
#head(sort(reg_loggammamean_stebbins$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_stebbins$model.rf$prediction.error
# 0.6290713
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_stebbins,
#             training = data.frame(loggammamean_ste, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)
#


### RIVERSIDE POPULATION
###-----------------------------------------------------------
loggammamean_riv <- log10(pooled_reftable_bees_riverside[, "gammaMean"])

hist(loggammamean_riv, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_riverside <- regAbcrf(formula = loggammamean_riv~.,
                                  data    = data.frame(loggammamean_riv, global_sumstats4training_riverside),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_riverside",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_riverside, n.var = 20)
#
#head(sort(reg_loggammamean_riverside$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_riverside$model.rf$prediction.error
# 0.6323848
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_riverside,
#             training = data.frame(loggammamean_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)
#

### PLACERITA POPULATION
###-----------------------------------------------------------
loggammamean_pla <- log10(pooled_reftable_bees_placerita[, "gammaMean"])

hist(loggammamean_pla, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean_placerita <- regAbcrf(formula = loggammamean_pla~.,
                                  data    = data.frame(loggammamean_pla, global_sumstats4training_placerita),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_loggammamean_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_loggammamean_placerita",".RData"))
#
### variable Importance plot
#plot(x = reg_loggammamean_placerita, n.var = 20)
#
#head(sort(reg_loggammamean_placerita$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_loggammamean_placerita$model.rf$prediction.error
# 0.6305172
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean_placerita,
#             training = data.frame(loggammamean_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = loggammamean_pla,
#     y    = reg_loggammamean_placerita$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     main = expression(log[10](gamma)),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.loggammamean.pla <- data.frame(x = loggammamean_pla,
#                                   y = reg_loggammamean_placerita$model.rf$predictions)
#
#save(oob.loggammamean.pla, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.loggammamean.pla",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.loggammamean.pla",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.loggammamean.pla, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ) * italic(P)[S]))),
#       ylab = expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(OOB prediction)")),
#       xlim = c(-7,5),
#       ylim = c(-7,5),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## Lis of the vectors of observations used to train the RFs
list.loggammamean <- list(Ava=loggammamean_ava, Hum=loggammamean_hum, 
                          Dav=loggammamean_dav, Sta=loggammamean_sta, 
                          Ste=loggammamean_ste, Riv=loggammamean_riv,
                          Pla=loggammamean_pla)

#save(list.loggammamean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_loggammamean",".RData"))

## List of RF
list.reg.loggammamean <- list(Ava=reg_loggammamean_avalon,Hum=reg_loggammamean_humboldt, 
                              Dav=reg_loggammamean_davis, Sta=reg_loggammamean_stanislaus, 
                              Ste=reg_loggammamean_stebbins,Riv=reg_loggammamean_riverside,
                              Pla=reg_loggammamean_placerita)

#save(list.reg.loggammamean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_loggammamean",".RData"))
```

#### Proportion of beneficial mutation - P_RP_B - parameter
```{r regression PrPs, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
logPrPs_ava <- log10(pooled_reftable_bees_avalon[, "PrGWSel"] * pooled_reftable_bees_avalon[, "PrMSel"])

hist(logPrPs_ava, freq = TRUE, xlab = expression(log[10](italic(P)[R] * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_avalon <- regAbcrf(formula = logPrPs_ava~.,
                                  data    = data.frame(logPrPs_ava, global_sumstats4training_avalon),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_avalon",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_avalon, n.var = 20)
#
#head(sort(reg_logPrPs_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_avalon$model.rf$prediction.error
# 1.414491
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_avalon,
#             training = data.frame(logPrPs_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)
#

### HUMBOLDT POPULATION
###-----------------------------------------------------------
logPrPs_hum <- log10(pooled_reftable_bees_humboldt[, "PrGWSel"] * pooled_reftable_bees_humboldt[, "PrMSel"])

hist(logPrPs_hum, freq = TRUE, xlab = expression(log[10]((italic(P)[R] * italic(P)[S]))), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_humboldt <- regAbcrf(formula = logPrPs_hum~.,
                                  data    = data.frame(logPrPs_hum, global_sumstats4training_humboldt),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_humboldt",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_humboldt, n.var = 20)
#
#head(sort(reg_logPrPs_humboldt$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_humboldt$model.rf$prediction.error
# 1.450421
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_humboldt,
#             training = data.frame(logPrPs_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)
#

### DAVIS POPULATION
###-----------------------------------------------------------
logPrPs_dav <- log10(pooled_reftable_bees_davis[, "PrGWSel"] * pooled_reftable_bees_davis[, "PrMSel"])

hist(logPrPs_dav, freq = TRUE, xlab = expression(log[10]((italic(P)[R] * italic(P)[S]))), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_davis <- regAbcrf(formula = logPrPs_dav~.,
                                  data    = data.frame(logPrPs_dav, global_sumstats4training_davis),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_davis",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_davis, n.var = 20)
#
#head(sort(reg_logPrPs_davis$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_davis$model.rf$prediction.error
# 1.501988
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_davis,
#             training = data.frame(logPrPs_dav, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)

### STANISLAUS POPULATION
###-----------------------------------------------------------
logPrPs_sta <- log10(pooled_reftable_bees_stanislaus[, "PrGWSel"] * pooled_reftable_bees_stanislaus[, "PrMSel"])

hist(logPrPs_sta, freq = TRUE, xlab = expression(log[10]((italic(P)[R] * italic(P)[S]))), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_stanislaus <- regAbcrf(formula = logPrPs_sta~.,
                                  data    = data.frame(logPrPs_sta, global_sumstats4training_stanislaus),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_stanislaus",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_stanislaus, n.var = 20)
#
#head(sort(reg_logPrPs_stanislaus$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_stanislaus$model.rf$prediction.error
# 1.512934
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_stanislaus,
#             training = data.frame(logPrPs_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)
#

### STEBBINS POPULATION
###-----------------------------------------------------------
logPrPs_ste <- log10(pooled_reftable_bees_stebbins[, "PrGWSel"] * pooled_reftable_bees_stebbins[, "PrMSel"])

hist(logPrPs_ste, freq = TRUE, xlab = expression(log[10]((italic(P)[R] * italic(P)[S]))), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_stebbins <- regAbcrf(formula = logPrPs_ste~.,
                                  data    = data.frame(logPrPs_ste, global_sumstats4training_stebbins),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_stebbins",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_stebbins, n.var = 20)
#
#head(sort(reg_logPrPs_stebbins$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_stebbins$model.rf$prediction.error
# 1.568533
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_stebbins,
#             training = data.frame(logPrPs_ste, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)
#

### RIVERSIDE POPULATION
###-----------------------------------------------------------
logPrPs_riv <- log10(pooled_reftable_bees_riverside[, "PrGWSel"] * pooled_reftable_bees_riverside[, "PrMSel"])

hist(logPrPs_riv, freq = TRUE, xlab = expression(log[10]((italic(P)[R] * italic(P)[S]))), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_riverside <- regAbcrf(formula = logPrPs_riv~.,
                                  data    = data.frame(logPrPs_riv, global_sumstats4training_riverside),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_riverside",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_riverside, n.var = 20)
#
#head(sort(reg_logPrPs_riverside$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_riverside$model.rf$prediction.error
# 1.643795
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_riverside,
#             training = data.frame(logPrPs_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)
#

### PLACERITA POPULATION
###-----------------------------------------------------------
logPrPs_pla <- log10(pooled_reftable_bees_placerita[, "PrGWSel"] * pooled_reftable_bees_placerita[, "PrMSel"])

hist(logPrPs_pla, freq = TRUE, xlab = expression(log[10](italic(P)[R] * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs_placerita <- regAbcrf(formula = logPrPs_pla~.,
                                  data    = data.frame(logPrPs_pla, global_sumstats4training_placerita),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logPrPs_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logPrPs_placerita",".RData"))
#
### variable Importance plot
#plot(x = reg_logPrPs_placerita, n.var = 20)
#
#head(sort(reg_logPrPs_placerita$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs_placerita$model.rf$prediction.error
# 1.577978
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs_placerita,
#             training = data.frame(logPrPs_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)
#

## Lis of the vectors of observations used to train the RFs
list.logPrPs <- list(Ava=logPrPs_ava, Hum=logPrPs_hum, 
                     Dav=logPrPs_dav, Sta=logPrPs_sta, 
                     Ste=logPrPs_ste, Riv=logPrPs_riv,
                     Pla=logPrPs_pla)

#save(list.logPrPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logPrPs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logPrPs",".RData"))

## List of RF
list.reg.logPrPs <- list(Ava=reg_logPrPs_avalon,Hum=reg_logPrPs_humboldt, 
                         Dav=reg_logPrPs_davis, Sta=reg_logPrPs_stanislaus, 
                         Ste=reg_logPrPs_stebbins,Riv=reg_logPrPs_riverside,
                         Pla=reg_logPrPs_placerita)

#save(list.reg.logPrPs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logPrPs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logPrPs",".RData"))
```

#### gamma mean - as latent variable
```{r regression gamma mean latent variable, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_ava_1 <- pooled_reftable_bees_avalon[, "POPStrongSelMean_Ava"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_ava <- which(popstrongselmean_ava_1 == 0)

## Neutral simulations
popstrongselmean_zero_avalon <- popstrongselmean_ava_1[zero_popstrongselmean_ava]
global_sumstats_popstrongselmean_zero_avalon <- global_sumstats4training_avalon[zero_popstrongselmean_ava,]

# Non-neutral simulations
popstrongselmean_ava_2 <- popstrongselmean_ava_1[-zero_popstrongselmean_ava]
global_sumstats4training_avalon_popstrongselmean <- global_sumstats4training_avalon[-zero_popstrongselmean_ava,]

logpopStrongSelMean_ava <- log10(popstrongselmean_ava_2)

hist(logpopStrongSelMean_ava, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_avalon <- regAbcrf(formula = logpopStrongSelMean_ava~.,
                                           data    = data.frame(logpopStrongSelMean_ava, 
                                                                global_sumstats4training_avalon_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_avalon",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_avalon, n.var = 20)

## prediction error
reg_logpopstrongselmean_avalon$model.rf$prediction.error
# 0.1109994

## HUMBOLDT POPULATION
##-------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_hum_1 <- pooled_reftable_bees_humboldt[, "POPStrongSelMean_Hum"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_hum <- which(popstrongselmean_hum_1 == 0)

## Neutral simulations
popstrongselmean_zero_humboldt <- popstrongselmean_hum_1[zero_popstrongselmean_hum]
global_sumstats_popstrongselmean_zero_humboldt <- global_sumstats4training_humboldt[zero_popstrongselmean_hum,]

# Non-neutral simulations
popstrongselmean_hum_2 <- popstrongselmean_hum_1[-zero_popstrongselmean_hum]
global_sumstats4training_humboldt_popstrongselmean <- global_sumstats4training_humboldt[-zero_popstrongselmean_hum,]

logpopStrongSelMean_hum <- log10(popstrongselmean_hum_2)

hist(logpopStrongSelMean_hum, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_humboldt <- regAbcrf(formula = logpopStrongSelMean_hum~.,
                                           data    = data.frame(logpopStrongSelMean_hum, 
                                                                global_sumstats4training_humboldt_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_humboldt",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_humboldt, n.var = 20)

## prediction error
reg_logpopstrongselmean_humboldt$model.rf$prediction.error
# 0.1278229

### DAVIS POPULATION
###-----------------------------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_dav_1 <- pooled_reftable_bees_davis[, "POPStrongSelMean_Dav"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_dav <- which(popstrongselmean_dav_1 == 0)

## Neutral simulations
popstrongselmean_zero_davis <- popstrongselmean_dav_1[zero_popstrongselmean_dav]
global_sumstats_popstrongselmean_zero_davis <- global_sumstats4training_davis[zero_popstrongselmean_dav,]

# Non-neutral simulations
popstrongselmean_dav_2 <- popstrongselmean_dav_1[-zero_popstrongselmean_dav]
global_sumstats4training_davis_popstrongselmean <- global_sumstats4training_davis[-zero_popstrongselmean_dav,]

logpopStrongSelMean_dav <- log10(popstrongselmean_dav_2)

hist(logpopStrongSelMean_dav, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_davis <- regAbcrf(formula = logpopStrongSelMean_dav~.,
                                           data    = data.frame(logpopStrongSelMean_dav, 
                                                                global_sumstats4training_davis_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_davis",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_davis, n.var = 20)

## prediction error
reg_logpopstrongselmean_davis$model.rf$prediction.error
# 0.1109994

## STANISLAUS POPULATION
##-------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_sta_1 <- pooled_reftable_bees_stanislaus[, "POPStrongSelMean_Sta"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_sta <- which(popstrongselmean_sta_1 == 0)

## Neutral simulations
popstrongselmean_zero_stanislaus <- popstrongselmean_sta_1[zero_popstrongselmean_sta]
global_sumstats_popstrongselmean_zero_stanislaus <- global_sumstats4training_stanislaus[zero_popstrongselmean_sta,]

# Non-neutral simulations
popstrongselmean_sta_2 <- popstrongselmean_sta_1[-zero_popstrongselmean_sta]
global_sumstats4training_stanislaus_popstrongselmean <- global_sumstats4training_stanislaus[-zero_popstrongselmean_sta,]

logpopStrongSelMean_sta <- log10(popstrongselmean_sta_2)

hist(logpopStrongSelMean_sta, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_stanislaus <- regAbcrf(formula = logpopStrongSelMean_sta~.,
                                           data    = data.frame(logpopStrongSelMean_sta, 
                                                                global_sumstats4training_stanislaus_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_stanislaus",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_stanislaus, n.var = 20)

## prediction error
reg_logpopstrongselmean_stanislaus$model.rf$prediction.error
# 0.1109994

### STEBBINS POPULATION
###-----------------------------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_ste_1 <- pooled_reftable_bees_stebbins[, "POPStrongSelMean_Ste"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_ste <- which(popstrongselmean_ste_1 == 0)

## Neutral simulations
popstrongselmean_zero_stebbins <- popstrongselmean_ste_1[zero_popstrongselmean_ste]
global_sumstats_popstrongselmean_zero_stebbins <- global_sumstats4training_stebbins[zero_popstrongselmean_ste,]

# Non-neutral simulations
popstrongselmean_ste_2 <- popstrongselmean_ste_1[-zero_popstrongselmean_ste]
global_sumstats4training_stebbins_popstrongselmean <- global_sumstats4training_stebbins[-zero_popstrongselmean_ste,]

logpopStrongSelMean_ste <- log10(popstrongselmean_ste_2)

hist(logpopStrongSelMean_ste, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_stebbins <- regAbcrf(formula = logpopStrongSelMean_ste~.,
                                           data    = data.frame(logpopStrongSelMean_ste, 
                                                                global_sumstats4training_stebbins_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_stebbins",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_stebbins, n.var = 20)

## prediction error
reg_logpopstrongselmean_stebbins$model.rf$prediction.error
# 0.1395018

## RIVERSIDE POPULATION
##-------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_riv_1 <- pooled_reftable_bees_riverside[, "POPStrongSelMean_Riv"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_riv <- which(popstrongselmean_riv_1 == 0)

## Neutral simulations
popstrongselmean_zero_riverside <- popstrongselmean_riv_1[zero_popstrongselmean_riv]
global_sumstats_popstrongselmean_zero_riverside <- global_sumstats4training_riverside[zero_popstrongselmean_riv,]

# Non-neutral simulations
popstrongselmean_riv_2 <- popstrongselmean_riv_1[-zero_popstrongselmean_riv]
global_sumstats4training_riverside_popstrongselmean <- global_sumstats4training_riverside[-zero_popstrongselmean_riv,]

logpopStrongSelMean_riv <- log10(popstrongselmean_riv_2)

hist(logpopStrongSelMean_riv, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_riverside <- regAbcrf(formula = logpopStrongSelMean_riv~.,
                                           data    = data.frame(logpopStrongSelMean_riv, 
                                                                global_sumstats4training_riverside_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_riverside",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_riverside, n.var = 20)

## prediction error
reg_logpopstrongselmean_riverside$model.rf$prediction.error
# 0.1109994

### PLACERITA POPULATION
###-----------------------------------------------------------

## obtain the vector with values of the population proportion of segragating beneficial mutations
popstrongselmean_pla_1 <- pooled_reftable_bees_placerita[, "POPStrongSelMean_Pla"]

## removing simulations with POPSelMean == 0
zero_popstrongselmean_pla <- which(popstrongselmean_pla_1 == 0)

## Neutral simulations
popstrongselmean_zero_placerita <- popstrongselmean_pla_1[zero_popstrongselmean_pla]
global_sumstats_popstrongselmean_zero_placerita <- global_sumstats4training_placerita[zero_popstrongselmean_pla,]

# Non-neutral simulations
popstrongselmean_pla_2 <- popstrongselmean_pla_1[-zero_popstrongselmean_pla]
global_sumstats4training_placerita_popstrongselmean <- global_sumstats4training_placerita[-zero_popstrongselmean_pla,]

logpopStrongSelMean_pla <- log10(popstrongselmean_pla_2)

hist(logpopStrongSelMean_pla, freq = TRUE, xlab = expression(italic(bar(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean_placerita <- regAbcrf(formula = logpopStrongSelMean_pla~.,
                                           data    = data.frame(logpopStrongSelMean_pla, 
                                                                global_sumstats4training_placerita_popstrongselmean),
                                           ntree   = 1000,
                                           paral   = T,
                                           ncores  = 8)

#save(reg_logpopstrongselmean_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logpopstrongselmean_placerita",".RData"))

## variable Importance plot
plot(x = reg_logpopstrongselmean_placerita, n.var = 20)

## prediction error
reg_logpopstrongselmean_placerita$model.rf$prediction.error
# 0.1372501

## List of the reftable of summary statistics used for training the RFs
list.SumStats4Training.popstrongselmean <- list(Ava=global_sumstats4training_avalon_popstrongselmean, Hum=global_sumstats4training_humboldt_popstrongselmean,
                                                Dav=global_sumstats4training_davis_popstrongselmean, Sta=global_sumstats4training_stanislaus_popstrongselmean,
                                                Ste=global_sumstats4training_stebbins_popstrongselmean, Riv=global_sumstats4training_riverside_popstrongselmean,
                                                Pla=global_sumstats4training_placerita_popstrongselmean)




#save(list.SumStats4Training.popstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongselmean",".RData"))

## Lis of the vectors of observations used to train the RFs
list.logpopstrongselmean  <- list(Ava=logpopStrongSelMean_ava, Hum=logpopStrongSelMean_hum, 
                                  Dav=logpopStrongSelMean_dav, Sta=logpopStrongSelMean_sta, 
                                  Ste=logpopStrongSelMean_ste, Riv=logpopStrongSelMean_riv,
                                  Pla=logpopStrongSelMean_pla)

#save(list.logpopstrongselmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logpopstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logpopstrongselmean",".RData"))

## List of RF
list.reg.logpopstrongselmean <- list(Ava=reg_logpopstrongselmean_avalon,   Hum=reg_logpopstrongselmean_humboldt, 
                                    Dav=reg_logpopstrongselmean_davis,    Sta=reg_logpopstrongselmean_stanislaus, 
                                    Ste=reg_logpopstrongselmean_stebbins, Riv=reg_logpopstrongselmean_riverside,
                                    Pla=reg_logpopstrongselmean_placerita)

#save(list.reg.logpopstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logpopstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logpopstrongselmean",".RData"))

## List of vector with zero popstrongselmean
list.zero.popstrongselmean <- list(Ava=popstrongselmean_zero_avalon,  Hum=popstrongselmean_zero_humboldt, 
                                   Dav=popstrongselmean_zero_davis,   Sta=popstrongselmean_zero_stanislaus, 
                                   Ste=popstrongselmean_zero_stebbins,Riv=popstrongselmean_zero_riverside,
                                   Pla=popstrongselmean_zero_placerita)

#save(list.zero.popstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongselmean",".RData"))

## List of the reftable of summary statistics of zero popstrongselmean simulations
list.zero.popstrongselmean.summstats <- list(Ava=global_sumstats_popstrongselmean_zero_avalon,   Hum=global_sumstats_popstrongselmean_zero_humboldt, 
                                             Dav=global_sumstats_popstrongselmean_zero_davis,    Sta=global_sumstats_popstrongselmean_zero_stanislaus, 
                                             Ste=global_sumstats_popstrongselmean_zero_stebbins, Riv=global_sumstats_popstrongselmean_zero_riverside,
                                             Pla=global_sumstats_popstrongselmean_zero_placerita)
#save(list.zero.popstrongselmean.summstats, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongselmean_summstats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongselmean_summstats",".RData"))

## Neutral simulations
##--------------------

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_zero_popstrongselmean_summstats",".RData"))
 
list.posterior.zero.popstrongselmean <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                             Ste=NULL,Riv=NULL, Pla=NULL)
for (i in 2:7){
  
  reg_popstrongselmean               = list.reg.logpopstrongselmean[[i]]
  ObsSumStats.popstrongselmean.zero  = list.zero.popstrongselmean.summstats [[i]]
  logpopstrongselmean                = list.logpopstrongselmean[[i]]
  SumStats4Training.popstrongselmean = list.SumStats4Training.popstrongselmean[[i]]
  
  posterior.zero.popstrongselmean <- predict(object      = reg_popstrongselmean ,
                                              obs        = ObsSumStats.popstrongselmean.zero,
                                              training   = data.frame(logpopstrongselmean, 
                                                                      SumStats4Training.popstrongselmean),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 8,
                                              rf.weights = T)
  
  list.posterior.zero.popstrongselmean[[i]] <- posterior.zero.popstrongselmean
}

#save(list.posterior.zero.popstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_popstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_pods/list_posterior_zero_popstrongselmean",".RData"))
```

### ABC-RF regression for demography: growing trees for short-term evolution inference

#### Harmonic mean of the effective population sizes of period 2
```{r regression meanNe2, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
logmeanNe2_ava <- log10(pooled_reftable_bees_avalon[, "meanNe2_Ava"])
hist(logmeanNe2_ava, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_avalon <- regAbcrf(formula = logmeanNe2_ava~.,
                                  data    = data.frame(logmeanNe2_ava, global_sumstats4training_avalon),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_avalon",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_avalon, n.var = 20)

#head(sort(reg_logmeanNe2_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_avalon$model.rf$prediction.error
# 0.05146832

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_ava,
#             training = data.frame(logmeanNe2_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 8)

## Comparison with the NE calculation based on the temporal FST
globalFSTNe <- function(x, tau){
  fst  <- x
  ne <- (tau*(1-fst))/(4*fst)
  return(ne)
}

logfstne2.ava <- log10(globalFSTNe(x=global_sumstats4training_avalon$GSS_WCst, tau=104))

estimated.fstNe2.ava <- data.frame(x = logmeanNe2_ava,
                                   y = logfstne2.ava)

#save(estimated.fstNe2.ava, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.ava",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.ava",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.ava, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## HUMBOLDT POPULATION
##-------------------------------------
logmeanNe2_hum <- log10(pooled_reftable_bees_humboldt[, "meanNe2_Hum"])
hist(logmeanNe2_hum, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_humboldt <- regAbcrf(formula = logmeanNe2_hum~.,
                                  data    = data.frame(logmeanNe2_hum, global_sumstats4training_humboldt),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_humboldt",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2_humboldt, n.var = 10)

#head(sort(reg_logmeanNe2_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_humboldt$model.rf$prediction.error
# 0.03242845

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_hum,
#             training = data.frame(logmeanNe2_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 8)

## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.hum <- log10(globalFSTNe(x=global_sumstats4training_humboldt$GSS_WCst, tau=49))

estimated.fstNe2.hum <- data.frame(x = logmeanNe2_hum,
                                   y = logfstne2.hum)

#save(estimated.fstNe2.hum, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.hum",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.hum",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.hum, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

### DAVIS POPULATION
###-----------------------------------------------------------
logmeanNe2_dav <- log10(pooled_reftable_bees_davis[, "meanNe2_Dav"])
hist(logmeanNe2_dav, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_davis <- regAbcrf(formula = logmeanNe2_dav~.,
                                  data    = data.frame(logmeanNe2_dav, global_sumstats4training_davis),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_davis",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_davis, n.var = 10)

#head(sort(reg_logmeanNe2_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_davis$model.rf$prediction.error
# 0.04975271

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_dav,
#             training = data.frame(logmeanNe2_dav, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 8)

## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.dav <- log10(globalFSTNe(x=global_sumstats4training_davis$GSS_WCst, tau=47))

estimated.fstNe2.dav <- data.frame(x = logmeanNe2_dav,
                                   y = logfstne2.dav)

#save(estimated.fstNe2.dav, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.dav",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.dav",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.dav, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## STANISLAUS POPULATION
##-------------------------------------
logmeanNe2_sta <- log10(pooled_reftable_bees_stanislaus[, "meanNe2_Sta"])
hist(logmeanNe2_sta, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_stanislaus <- regAbcrf(formula = logmeanNe2_sta~.,
                                  data    = data.frame(logmeanNe2_sta, global_sumstats4training_stanislaus),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_stanislaus",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_stanislaus, n.var = 10)

#head(sort(reg_logmeanNe2_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_stanislaus$model.rf$prediction.error
# 0.04716766

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_sta,
#             training = data.frame(logmeanNe2_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 8)


## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.sta <- log10(globalFSTNe(x=global_sumstats4training_stanislaus$GSS_WCst, tau=38))

estimated.fstNe2.sta <- data.frame(x = logmeanNe2_sta,
                                   y = logfstne2.sta)

#save(estimated.fstNe2.sta, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.sta",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.sta",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.sta, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

### STEBBINS POPULATION
###-----------------------------------------------------------
logmeanNe2_ste <- log10(pooled_reftable_bees_stebbins[, "meanNe2_Ste"])
hist(logmeanNe2_ste, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_stebbins <- regAbcrf(formula = logmeanNe2_ste~.,
                                  data    = data.frame(logmeanNe2_ste, global_sumstats4training_stebbins),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_stebbins",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_stebbins, n.var = 10)

#head(sort(reg_logmeanNe2_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_stebbins$model.rf$prediction.error
# 0.03960857

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_ste,
#             training = data.frame(logmeanNe2_pla, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 8)


## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.ste <- log10(globalFSTNe(x=global_sumstats4training_stebbins$GSS_WCst, tau=18))

estimated.fstNe2.ste <- data.frame(x = logmeanNe2_ste,
                                   y = logfstne2.ste)

#save(estimated.fstNe2.ste, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.ste",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.ste",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.ste, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## RIVERSIDE POPULATION
##-------------------------------------
logmeanNe2_riv <- log10(pooled_reftable_bees_riverside[, "meanNe2_Riv"])
hist(logmeanNe2_riv, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_riverside <- regAbcrf(formula = logmeanNe2_riv~.,
                                  data    = data.frame(logmeanNe2_riv, global_sumstats4training_riverside),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_riverside",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_riverside, n.var = 10)

#head(sort(reg_logmeanNe2_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_riverside$model.rf$prediction.error
# 0.05523614

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_riv,
#             training = data.frame(logmeanNe2_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 8)

## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.riv <- log10(globalFSTNe(x=global_sumstats4training_riverside$GSS_WCst, tau=15))

estimated.fstNe2.riv <- data.frame(x = logmeanNe2_riv,
                                   y = logfstne2.riv)

#save(estimated.fstNe2.riv, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.riv",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.riv",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.riv, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

### PLACERITA POPULATION
###-----------------------------------------------------------

logmeanNe2_pla <- log10(pooled_reftable_bees_placerita[, "meanNe2_Pla"])
hist(logmeanNe2_pla, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2_placerita <- regAbcrf(formula = logmeanNe2_pla~.,
                                  data    = data.frame(logmeanNe2_pla, global_sumstats4training_placerita),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 8)

#save(reg_logmeanNe2_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2_placerita",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2_placerita, n.var = 10)

#head(sort(reg_logmeanNe2_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2_placerita$model.rf$prediction.error
# 0.04208454

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2_pla,
#             training = data.frame(logmeanNe2_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 8)

## Comparison with the NE calculation based on the temporal FST
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

logfstne2.pla <- log10(globalFSTNe(x=global_sumstats4training_placerita$GSS_WCst, tau=15))

estimated.fstNe2.pla <- data.frame(x = logmeanNe2_pla,
                                   y = logfstne2.pla)

#save(estimated.fstNe2.pla, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.pla",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/estimated.fstNe2.pla",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.pla, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,4),
       ylim = c(-0.5,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Lis of the vectors of observations used to train the RFs
list.logmeanNe2 <- list(Ava=logmeanNe2_ava, Hum=logmeanNe2_hum, 
                        Dav=logmeanNe2_dav, Sta=logmeanNe2_sta, 
                        Ste=logmeanNe2_ste, Riv=logmeanNe2_riv,
                        Pla=logmeanNe2_pla)

#save(list.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2",".RData"))

## List of RF
list.reg.logmeanNe2 <- list(Ava=reg_logmeanNe2_avalon,Hum=reg_logmeanNe2_humboldt, 
                            Dav=reg_logmeanNe2_davis, Sta=reg_logmeanNe2_stanislaus, 
                            Ste=reg_logmeanNe2_stebbins,Riv=reg_logmeanNe2_riverside,
                            Pla=reg_logmeanNe2_placerita)

#save(list.reg.logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2",".RData"))
```

#### Population size of period 2 - census size Ncs
```{r regression Ncs, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON
###-----------------------------------------------------------
logncs_ava <- log10(pooled_reftable_bees_avalon[, "Ncs"])
hist(logncs_ava, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_avalon <- regAbcrf(formula = logncs_ava~.,
                                 data = data.frame(logncs_ava, global_sumstats4training_avalon),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_avalon",".RData"))

## Variable Importance plot
plot(x = reg_logncs_avalon, n.var = 20)

#head(sort(reg_logn_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_avalon$model.rf$prediction.error
# 0.1083586

## error rate plot
#err.regAbcrf(object   = reg_logncs_avalon,
#             training = data.frame(logncs_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)

## HUMBOLDT POPULATION
##-------------------------------------
logncs_hum <- log10(pooled_reftable_bees_humboldt[, "Ncs"])
hist(logncs_hum, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_humboldt <- regAbcrf(formula = logncs_hum~.,
                                 data = data.frame(logncs_hum, global_sumstats4training_humboldt),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_humboldt",".RData"))

## Variable Importance plot
#plot(x = reg_logncs_humboldt, n.var = 10)

#head(sort(reg_logn_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_humboldt$model.rf$prediction.error
# 0.08789872

## error rate plot
#err.regAbcrf(object   = reg_logncs_humboldt,
#             training = data.frame(logncs_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)

### DAVIS POPULATION
###-----------------------------------------------------------
logncs_dav <- log10(pooled_reftable_bees_davis[, "Ncs"])
hist(logncs_dav, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_davis <- regAbcrf(formula = logncs_dav~.,
                                 data = data.frame(logncs_dav, global_sumstats4training_davis),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_davis",".RData"))

## Variable Importance plot
#plot(x = reg_logncs_davis, n.var = 10)

#head(sort(reg_logn_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_davis$model.rf$prediction.error
# 0.1151657

## STANISLAUS POPULATION
##-------------------------------------
logncs_sta <- log10(pooled_reftable_bees_stanislaus[, "Ncs"])
hist(logncs_sta, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_stanislaus <- regAbcrf(formula = logncs_sta~.,
                                 data = data.frame(logncs_sta, global_sumstats4training_stanislaus),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_stanislaus",".RData"))

## Variable Importance plot
#plot(x = reg_logncs_stanislaus, n.var = 10)

#head(sort(reg_logn_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_stanislaus$model.rf$prediction.error
# 0.09975026

## error rate plot
#err.regAbcrf(object   = reg_logncs_stanislaus,
#             training = data.frame(logncs_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)

### STEBBINS	 POPULATION
###-----------------------------------------------------------
logncs_ste <- log10(pooled_reftable_bees_stebbins[, "Ncs"])
hist(logncs_ste, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_stebbins <- regAbcrf(formula = logncs_ste~.,
                                 data = data.frame(logncs_ste, global_sumstats4training_stebbins),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_stebbins",".RData"))

## Variable Importance plot
#plot(x = reg_logncs_stebbins, n.var = 10)

#head(sort(reg_logn_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_stebbins$model.rf$prediction.error
# 0.08374849

## error rate plot
#err.regAbcrf(object   = reg_logncs_stebbins,
#             training = data.frame(logncs_ste, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)

## RIVERSIDE POPULATION
##-------------------------------------
logncs_riv <- log10(pooled_reftable_bees_riverside[, "Ncs"])
hist(logncs_riv, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_riverside <- regAbcrf(formula = logncs_riv~.,
                                 data = data.frame(logncs_riv, global_sumstats4training_riverside),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_riverside",".RData"))

## Variable Importance plot
#plot(x = reg_logncs_riverside, n.var = 10)

#head(sort(reg_logn_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_riverside$model.rf$prediction.error
# 0.1103547

## error rate plot
#err.regAbcrf(object   = reg_logncs_riverside,
#             training = data.frame(logncs_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)

### PLACERITA POPULATION
###-----------------------------------------------------------
logncs_pla <- log10(pooled_reftable_bees_placerita[, "Ncs"])
hist(logncs_pla, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs_placerita <- regAbcrf(formula = logncs_pla~.,
                                 data = data.frame(logncs_pla, global_sumstats4training_placerita),
                                ntree = 1000,
                                paral = T,
                               ncores = 8)

#save(reg_logncs_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logncs_placerita",".RData"))

## Variable Importance plot
plot(x = reg_logncs_placerita, n.var = 10)

#head(sort(reg_logn_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs_placerita$model.rf$prediction.error
# 0.0859845

## error rate plot
#err.regAbcrf(object   = reg_logncs_placerita,
#             training = data.frame(logncs_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)

## Lis of the vectors of observations used to train the RFs
list.logncs <- list(Ava=logncs_ava, Hum=logncs_hum, 
                    Dav=logncs_dav, Sta=logncs_sta, 
                    Ste=logncs_ste, Riv=logncs_riv,
                    Pla=logncs_pla)

#save(list.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logncs",".RData"))

## List of RF
list.reg.logncs <- list(Ava=reg_logncs_avalon,Hum=reg_logncs_humboldt, 
                        Dav=reg_logncs_davis, Sta=reg_logncs_stanislaus, 
                        Ste=reg_logncs_stebbins,Riv=reg_logncs_riverside,
                        Pla=reg_logncs_placerita)

#save(list.reg.logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logncs",".RData"))
```

Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r regression MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
logmeanNe2ncs_ava <- log10(pooled_reftable_bees_avalon[, "meanNe2_Ava"]/pooled_reftable_bees_avalon[, "Ncs"])

hist(logmeanNe2ncs_ava, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_avalon <- regAbcrf(formula = logmeanNe2ncs_ava~.,
                                 data = data.frame(logmeanNe2ncs_ava, global_sumstats4training_avalon),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_avalon",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2ncs_avalon, n.var = 20, main=expression(log[10](italic(N)[e]/italic(N)[cs])))

#head(sort(reg_logmeanNe2ncs_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_avalon$model.rf$prediction.error
# 0.05099813

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_avalon,
#             training = data.frame(logmeanNe2ncs_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)

## HUMBOLDT POPULATION
##-------------------------------------
logmeanNe2ncs_hum <- log10(pooled_reftable_bees_humboldt[, "meanNe2_Hum"]/pooled_reftable_bees_humboldt[, "Ncs"])

hist(logmeanNe2ncs_hum, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_humboldt <- regAbcrf(formula = logmeanNe2ncs_hum~.,
                                 data = data.frame(logmeanNe2ncs_hum, global_sumstats4training_humboldt),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_humboldt",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2ncs_humboldt, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_humboldt$model.rf$prediction.error
# 0.03078422

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_humboldt,
#             training = data.frame(logmeanNe2ncs_hum, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)

### DAVIS POPULATION
###-----------------------------------------------------------
logmeanNe2ncs_dav <- log10(pooled_reftable_bees_davis[, "meanNe2_Dav"]/pooled_reftable_bees_davis[, "Ncs"])

hist(logmeanNe2ncs_dav, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_davis <- regAbcrf(formula = logmeanNe2ncs_dav~.,
                                 data = data.frame(logmeanNe2ncs_dav, global_sumstats4training_davis),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_davis",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2ncs_davis, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_davis$model.rf$prediction.error
# 0.03544379

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_davis,
#             training = data.frame(logmeanNe2ncs_dav, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)

## STANISLAUS POPULATION
##-------------------------------------
logmeanNe2ncs_sta <- log10(pooled_reftable_bees_stanislaus[, "meanNe2_Sta"]/pooled_reftable_bees_stanislaus[, "Ncs"])

hist(logmeanNe2ncs_sta, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_stanislaus <- regAbcrf(formula = logmeanNe2ncs_sta~.,
                                 data = data.frame(logmeanNe2ncs_sta, global_sumstats4training_stanislaus),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_stanislaus",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2ncs_stanislaus, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_stanislaus$model.rf$prediction.error
# 0.03342334

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_stanislaus,
#             training = data.frame(logmeanNe2ncs_sta, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)

### STEBBINS POPULATION
###-----------------------------------------------------------
logmeanNe2ncs_ste <- log10(pooled_reftable_bees_stebbins[, "meanNe2_Ste"]/pooled_reftable_bees_stebbins[, "Ncs"])

hist(logmeanNe2ncs_ste, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_stebbins <- regAbcrf(formula = logmeanNe2ncs_ste~.,
                                 data = data.frame(logmeanNe2ncs_ste, global_sumstats4training_stebbins),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_stebbins",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2ncs_stebbins, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_stebbins$model.rf$prediction.error
# 0.02974864

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_stebbins,
#             training = data.frame(logmeanNe2ncs_ste, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)

## RIVERSIDE POPULATION
##-------------------------------------
logmeanNe2ncs_riv <- log10(pooled_reftable_bees_riverside[, "meanNe2_Riv"]/pooled_reftable_bees_riverside[, "Ncs"])

hist(logmeanNe2ncs_riv, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_riverside <- regAbcrf(formula = logmeanNe2ncs_riv~.,
                                 data = data.frame(logmeanNe2ncs_riv, global_sumstats4training_riverside),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_riverside",".RData"))

## Variable Importance plot
#plot(x = reg_logmeanNe2ncs_riverside, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_riverside$model.rf$prediction.error
# 0.03525277

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_riverside,
#             training = data.frame(logmeanNe2ncs_riv, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)

### PLACERITA POPULATION
###-----------------------------------------------------------
logmeanNe2ncs_pla <- log10(pooled_reftable_bees_placerita[, "meanNe2_Pla"]/pooled_reftable_bees_placerita[, "Ncs"])

hist(logmeanNe2ncs_pla, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs_placerita <- regAbcrf(formula = logmeanNe2ncs_pla~.,
                                 data = data.frame(logmeanNe2ncs_pla, global_sumstats4training_placerita),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmeanNe2ncs_placerita",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2ncs_placerita, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N))))

#head(sort(reg_logmeanNe2ncs_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs_placerita$model.rf$prediction.error
# 0.03123464

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs_placerita,
#             training = data.frame(logmeanNe2ncs_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)

## Lis of the vectors of observations used to train the RFs
list.logmeanNe2ncs <- list(Ava=logmeanNe2ncs_ava, Hum=logmeanNe2ncs_hum, 
                           Dav=logmeanNe2ncs_dav, Sta=logmeanNe2ncs_sta, 
                           Ste=logmeanNe2ncs_ste, Riv=logmeanNe2ncs_riv,
                           Pla=logmeanNe2ncs_pla)

#save(list.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2ncs",".RData"))

## List of RF
list.reg.logmeanNe2ncs <- list(Ava=reg_logmeanNe2ncs_avalon,Hum=reg_logmeanNe2ncs_humboldt, 
                               Dav=reg_logmeanNe2ncs_davis, Sta=reg_logmeanNe2ncs_stanislaus, 
                               Ste=reg_logmeanNe2ncs_stebbins,Riv=reg_logmeanNe2ncs_riverside,
                               Pla=reg_logmeanNe2ncs_placerita)

#save(list.reg.logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2ncs",".RData"))
```

#### Per site mutation rate mu
```{r regression site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}
### AVALON POPULATION
###-----------------------------------------------------------
logmu_avalon <- log10(pooled_reftable_bees_avalon[, "mu"])

hist(logmu_avalon, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_avalon <- regAbcrf(formula = logmu_avalon~.,
                             data    = data.frame(logmu_avalon, global_sumstats4training_avalon),
                             ntree   = 1000,
                             paral   = T,
                             ncores  = 8)

#save(reg_logmu_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_avalon",".RData"))

## variable Importance plot
plot(x = reg_logmu_avalon, n.var = 10, main=expression(log[10](italic(mu))))

#head(sort(reg_logmu_avalon$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_avalon$model.rf$prediction.error
# 0.01451834
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_avalon,
#             training = data.frame(logmu, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)

## HUMBOLDT POPULATION
##-------------------------------------
logmu_humboldt <- log10(pooled_reftable_bees_humboldt[, "mu"])

hist(logmu_humboldt, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_humboldt <- regAbcrf(formula = logmu_humboldt~.,
                                data    = data.frame(logmu_humboldt, global_sumstats4training_humboldt),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_humboldt",".RData"))

## variable Importance plot
#plot(x = reg_logmu_humboldt, n.var = 10, #main=expression(log[10](italic(mu)))
#     )

#head(sort(reg_logmu_humboldt$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_humboldt$model.rf$prediction.error
# 0.01169842
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_humboldt,
#             training = data.frame(logmu_humboldt, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)

### DAVIS POPULATION
###-----------------------------------------------------------
logmu_davis <- log10(pooled_reftable_bees_davis[, "mu"])

hist(logmu_davis, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_davis <- regAbcrf(formula = logmu_davis~.,
                                data    = data.frame(logmu_davis, global_sumstats4training_davis),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_davis",".RData"))

## variable Importance plot
#plot(x = reg_logmu_davis, n.var = 10, #main=expression(log[10](italic(mu)))
#     )

#head(sort(reg_logmu_davis$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_davis$model.rf$prediction.error
# 0.01564271
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_davis,
#             training = data.frame(logmu_davis, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)

## STANISLAUS POPULATION
##-------------------------------------
logmu_stanislaus <- log10(pooled_reftable_bees_stanislaus[, "mu"])

hist(logmu_stanislaus, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_stanislaus <- regAbcrf(formula = logmu_stanislaus~.,
                                data    = data.frame(logmu_stanislaus, global_sumstats4training_stanislaus),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_stanislaus",".RData"))

## variable Importance plot
#plot(x = reg_logmu_stanislaus, n.var = 10, #main=expression(log[10](italic(mu)))
#     )

#head(sort(reg_logmu_stanislaus$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_stanislaus$model.rf$prediction.error
# 0.01590015
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_stanislaus,
#             training = data.frame(logmu_stanislaus, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)

### STEBBINS POPULATION
###-----------------------------------------------------------
logmu_stebbins <- log10(pooled_reftable_bees_stebbins[, "mu"])

hist(logmu_stebbins, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_stebbins <- regAbcrf(formula = logmu_stebbins~.,
                                data    = data.frame(logmu_stebbins, global_sumstats4training_stebbins),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_stebbins",".RData"))

## variable Importance plot
#plot(x = reg_logmu_stebbins, n.var = 10, #main=expression(log[10](italic(mu)))
#     )

#head(sort(reg_logmu_stebbins$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_stebbins$model.rf$prediction.error
# 0.01418736
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_stebbins,
#             training = data.frame(logmu_stebbins, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)

## RIVERSIDE POPULATION
##-------------------------------------
logmu_riverside <- log10(pooled_reftable_bees_riverside[, "mu"])

hist(logmu_riverside, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_riverside <- regAbcrf(formula = logmu_riverside~.,
                                data    = data.frame(logmu_riverside, global_sumstats4training_riverside),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_riverside",".RData"))

## variable Importance plot
#plot(x = reg_logmu_riverside, n.var = 10, #main=expression(log[10](italic(mu)))
#     )

#head(sort(reg_logmu_riverside$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_riverside$model.rf$prediction.error
# 0.02149933
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_riverside,
#             training = data.frame(logmu_riverside, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)

### PLACERITA POPULATION
###-----------------------------------------------------------
logmu_placerita <- log10(pooled_reftable_bees_placerita[, "mu"])

hist(logmu_placerita, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu_placerita <- regAbcrf(formula = logmu_placerita~.,
                                data    = data.frame(logmu_placerita, global_sumstats4training_placerita),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logmu_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logmu_placerita",".RData"))

## variable Importance plot
plot(x = reg_logmu_placerita, n.var = 10, #main=expression(log[10](italic(mu)))
     )

#head(sort(reg_logmu_placerita$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmu_placerita$model.rf$prediction.error
# 0.0150412
#
## error rate plot
#err.regAbcrf(object   = reg_logmu_placerita,
#             training = data.frame(logmu_placerita, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)

## Lis of the vectors of observations used to train the RFs
list.logmu <- list(Ava=logmu_avalon, Hum=logmu_humboldt, 
                   Dav=logmu_davis, Sta=logmu_stanislaus, 
                   Ste=logmu_stebbins, Riv=logmu_riverside,
                   Pla=logmu_placerita)

#save(list.logmu, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmu",".RData"))

## List of RF
list.reg.logmu <- list(Ava=reg_logmu_avalon,Hum=reg_logmu_humboldt, 
                       Dav=reg_logmu_davis, Sta=reg_logmu_stanislaus, 
                       Ste=reg_logmu_stebbins,Riv=reg_logmu_riverside,
                       Pla=reg_logmu_placerita)

#save(list.reg.logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmu",".RData"))
```

#### recombination rate rr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON POPULATION
###-----------------------------------------------------------
logrr_avalon <- log10(pooled_reftable_bees_avalon[, "rr"])

hist(logrr_avalon, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_avalon <- regAbcrf(formula = logrr_avalon~.,
                             data    = data.frame(logrr_avalon, global_sumstats4training_avalon),
                             ntree   = 1000,
                             paral   = T,
                             ncores  = 8)

#save(reg_logrr_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_avalon",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_avalon, n.var = 10, main=expression(log[10](italic(mu))))
#
#head(sort(reg_logrr_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_avalon$model.rf$prediction.error
# 0.71183
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_avalon,
#             training = data.frame(logrr, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)
#

## HUMBOLDT POPULATION
##-------------------------------------
logrr_humboldt <- log10(pooled_reftable_bees_humboldt[, "rr"])

hist(logrr_humboldt, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_humboldt <- regAbcrf(formula = logrr_humboldt~.,
                                data    = data.frame(logrr_humboldt, global_sumstats4training_humboldt),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logrr_humboldt, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_humboldt",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_humboldt",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_humboldt, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_humboldt$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_humboldt$model.rf$prediction.error
# 0.7836431
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_humboldt,
#             training = data.frame(logrr_humboldt, global_sumstats4training_humboldt),
#             paral    = T,
#             ncores   = 28)
#

### DAVIS POPULATION
###-----------------------------------------------------------
logrr_davis <- log10(pooled_reftable_bees_davis[, "rr"])

hist(logrr_davis, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_davis <- regAbcrf(formula = logrr_davis~.,
                            data    = data.frame(logrr_davis, global_sumstats4training_davis),
                            ntree   = 1000,
                            paral   = T,
                            ncores  = 8)

#save(reg_logrr_davis, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_davis",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_davis",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_davis, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_davis$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_davis$model.rf$prediction.error
# 0.7918476
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_davis,
#             training = data.frame(logrr_davis, global_sumstats4training_davis),
#             paral    = T,
#             ncores   = 28)
#

## STANISLAUS POPULATION
##-------------------------------------
logrr_stanislaus <- log10(pooled_reftable_bees_stanislaus[, "rr"])

hist(logrr_stanislaus, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_stanislaus <- regAbcrf(formula = logrr_stanislaus~.,
                                data    = data.frame(logrr_stanislaus, global_sumstats4training_stanislaus),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logrr_stanislaus, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_stanislaus",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_stanislaus",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_stanislaus, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_stanislaus$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_stanislaus$model.rf$prediction.error
# 0.7878458
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_stanislaus,
#             training = data.frame(logrr_stanislaus, global_sumstats4training_stanislaus),
#             paral    = T,
#             ncores   = 28)

### STEBBINS POPULATION
###-----------------------------------------------------------
logrr_stebbins <- log10(pooled_reftable_bees_stebbins[, "rr"])

hist(logrr_stebbins, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_stebbins <- regAbcrf(formula = logrr_stebbins~.,
                                data    = data.frame(logrr_stebbins, global_sumstats4training_stebbins),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logrr_stebbins, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_stebbins",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_stebbins",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_stebbins, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_stebbins$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_stebbins$model.rf$prediction.error
# 0.8044892
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_stebbins,
#             training = data.frame(logrr_stebbins, global_sumstats4training_stebbins),
#             paral    = T,
#             ncores   = 28)

## RIVERSIDE POPULATION
##-------------------------------------
logrr_riverside <- log10(pooled_reftable_bees_riverside[, "rr"])

hist(logrr_riverside, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_riverside <- regAbcrf(formula = logrr_riverside~.,
                                data    = data.frame(logrr_riverside, global_sumstats4training_riverside),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logrr_riverside, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_riverside",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_riverside",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_riverside, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_riverside$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_riverside$model.rf$prediction.error
# 0.8069428
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_riverside,
#             training = data.frame(logrr_riverside, global_sumstats4training_riverside),
#             paral    = T,
#             ncores   = 28)

### PLACERITA POPULATION
###-----------------------------------------------------------
logrr_placerita <- log10(pooled_reftable_bees_placerita[, "rr"])

hist(logrr_placerita, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr_placerita <- regAbcrf(formula = logrr_placerita~.,
                                data    = data.frame(logrr_placerita, global_sumstats4training_placerita),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 8)

#save(reg_logrr_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logrr_placerita",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr_placerita, n.var = 10, #main=expression(log[10](italic(mu)))
#     )
#
#head(sort(reg_logrr_placerita$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logrr_placerita$model.rf$prediction.error
# 0.8072566
#
## error rate plot
#err.regAbcrf(object   = reg_logrr_placerita,
#             training = data.frame(logrr_placerita, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 28)

## Lis of the vectors of observations used to train the RFs
list.logrr <- list(Ava=logrr_avalon, Hum=logrr_humboldt, 
                   Dav=logrr_davis, Sta=logrr_stanislaus, 
                   Ste=logrr_stebbins, Riv=logrr_riverside,
                   Pla=logrr_placerita)

#save(list.logrr, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logrr",".RData"))

## List of RF
list.reg.logrr <- list(Ava=reg_logrr_avalon,Hum=reg_logrr_humboldt, 
                       Dav=reg_logrr_davis, Sta=reg_logrr_stanislaus, 
                       Ste=reg_logrr_stebbins,Riv=reg_logrr_riverside,
                       Pla=reg_logrr_placerita)

#save(list.reg.logrr, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logrr",".RData"))
```

### ABC-RF regression: growing trees for long-term evolution inference

#### Ns
```{r regression Ns, echo=TRUE, eval=FALSE, include=TRUE}

## AVALON POPULATION
##-------------------------------------
#
#logNs_ava <- log10(pooled_reftable_bees_avalon[, "meanNe2_Ava"] * pooled_reftable_bees_avalon[, "gammaMean"])
#
#hist(logNs_ava, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(s))), main = "", col = "#bdbdbd")
#
# abf-rf regression
#reg_logNs_avalon <- regAbcrf(formula = logNs_ava~.,
#                      data    = data.frame(logNs_ava, global_sumstats4training_avalon),
#                      ntree   = 1000,
#                      paral   = T,
#                      ncores  = 8)
#
#save(reg_logNs_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logNs_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logNs_avalon",".RData"))
#
# variable Importance plot
#plot(x = reg_logNs_avalon, n.var = 20, main=expression(log[10](italic(N)[e] * italic(s))))
#
#head(sort(reg_logNs_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
# prediction error
#reg_logNs_avalon$model.rf$prediction.error
# 0.6980215
#
# error rate plot
#err.regAbcrf(object   = reg_logNs_avalon,
#             training = data.frame(logNs_ava, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 8)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logNs_ava,
#     y    = reg_logNs_avalon$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-4,4),
#     ylim = c(-4,4),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logNs.ava <- data.frame(x = logNs_ava,
#                            y = reg_logNs_avalon$model.rf$predictions)
#
#save(oob.logNs.ava, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logNs.ava",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logNs.ava",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logNs.ava, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(s)))),
#       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(OOB prediction)")),
#       xlim = c(-4,4),
#       ylim = c(-4,4),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## PLACERITA POPULATION
##-------------------------------------
#
#logNs_pla <- log10(pooled_reftable_bees_placerita[, "meanNe2_Pla"] * pooled_reftable_bees_placerita[, "gammaMean"])
#
#hist(logNs_pla, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(s))), main = "", col = "#bdbdbd")
#
# abf-rf regression
#reg_logNs_placerita <- regAbcrf(formula = logNs_pla~.,
#                      data    = data.frame(logNs_pla, global_sumstats4training_placerita),
#                      ntree   = 1000,
#                      paral   = T,
#                      ncores  = 8)
#
#save(reg_logNs_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logNs_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logNs_placerita",".RData"))
#
# variable Importance plot
#plot(x = reg_logNs_placerita, n.var = 20, main=expression(log[10](italic(N)[e] * italic(s))))
#
#head(sort(reg_logNs_placerita$model.rf$variable.importance, decreasing = T), n=20)
#
# prediction error
#reg_logNs_placerita$model.rf$prediction.error
# 0.6888039
#
# error rate plot
#err.regAbcrf(object   = reg_logNs_placerita,
#             training = data.frame(logNs_pla, global_sumstats4training_placerita),
#             paral    = T,
#             ncores   = 8)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logNs_pla,
#     y    = reg_logNs_placerita$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-4,4),
#     ylim = c(-4,4),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logNs.pla <- data.frame(x = logNs_pla,
#                            y = reg_logNs_placerita$model.rf$predictions)
#
#save(oob.logNs.pla, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logNs.pla",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logNs.pla",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logNs.pla, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(s)))),
#       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(OOB prediction)")),
#       xlim = c(-4,4),
#       ylim = c(-4,4),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Theta of perid 2
```{r regression theta 2, echo=TRUE, eval=FALSE, include=TRUE}
#genomeS =  250e+6
#
### AVALON POPULATION
###--------------------------------
#logtheta2_ava <- log10(4 * pooled_reftable_bees_avalon[, "meanNe2_Ava"] * (pooled_reftable_bees_avalon[, "mu"]) * genomeS)
#
#hist(logtheta2_ava, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")
#
#reg_logtheta2_avalon <- regAbcrf(formula = logtheta2_ava~.,
#                                 data    = data.frame(logtheta2_ava, global_sumstats4training_avalon),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
##save(reg_logtheta2_avalon, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_avalon",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_avalon",".RData"))
#
### variable Importance plot
#plot(x = reg_logtheta2_avalon, n.var = 20, main=expression(log[10](italic(θ))))
#
##head(sort(reg_logtheta2_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
### prediction error
#reg_logtheta2_avalon$model.rf$prediction.error
## 0.03717215
#
### error rate plot
##err.regAbcrf(object   = reg_logtheta2_avalon,
##             training = data.frame(logtheta2_ava, global_sumstats4training_avalon),
##             paral    = T,
##             ncores   = 28)
#
### oob predictions vs true values
## diagnostic plot
#plot(x    = logtheta2_ava,
#     y    = reg_logtheta2_avalon$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-2,6),
#     ylim = c(-2,6),
#     main = expression(log[10](italic(theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## Manuscript plot
#oob.logtheta2.ava <- data.frame(x = logtheta2_ava,
#                                y = reg_logtheta2_avalon$model.rf$predictions)
#
##save(oob.logtheta2.ava, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.ava",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.ava",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logtheta2.ava, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ)))),
#       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
### DAVIS POPULATION
###--------------------------------
#logtheta2_dav <- log10(4 * pooled_reftable_bees_davis[, "meanNe2_Dav"] * (pooled_reftable_bees_davis[, "mu"]) * genomeS)
#
#hist(logtheta2_dav, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")
#
#reg_logtheta2_davis <- regAbcrf(formula = logtheta2_dav~.,
#                                 data    = data.frame(logtheta2_dav, global_sumstats4training_davis),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
##save(reg_logtheta2_davis, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_davis",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_davis",".RData"))
#
### variable Importance plot
##plot(x = reg_logtheta2_davis, n.var = 10, main=expression(log[10](italic(θ))))
#
##head(sort(reg_logtheta2_davis$model.rf$variable.importance, decreasing = T), n=20)
#
### prediction error
#reg_logtheta2_davis$model.rf$prediction.error
## 0.03183593
#
### error rate plot
##err.regAbcrf(object   = reg_logtheta2_davis,
##             training = data.frame(logtheta2_dav, global_sumstats4training_davis),
##             paral    = T,
##             ncores   = 28)
#
### oob predictions vs true values
## diagnostic plot
##plot(x    = logtheta2_dav,
##     y    = reg_logtheta2_davis$model.rf$predictions, 
##     xlab = "True value",
##     ylab = "OOB predictions",
##     xlim = c(-2,6),
##     ylim = c(-2,6),
##     main = expression(log[10](italic(theta))),
##     cex.axis = 1.2,
##     cex.lab  = 1.5)
##abline(a=0, b=1, col = "green")
#
## Manuscript plot
#oob.logtheta2.dav <- data.frame(x = logtheta2_dav,
#                                y = reg_logtheta2_davis$model.rf$predictions)
#
##save(oob.logtheta2.dav, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.dav",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.dav",".RData"))
#
##par(mar=c(5,5,4,1)+.1)
##hist2d(oob.logtheta2.dav, nbins=100, 
##       col=viridis::viridis(32), 
##       FUN=function(x) log(length(x)),
##       xlab = expression(paste("true", " ", log[10](italic(θ)))),
##       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
##       xlim = c(-1.5,6),
##       ylim = c(-1.5,6),
##       cex.axis = 1.2,
##       cex.lab  = 1.2)
##abline(a=0, b=1, col = "black", lty = 3)
#
### STEBBINS POPULATION
###--------------------------------
#logtheta2_ste <- log10(4 * pooled_reftable_bees_stebbins[, "meanNe2_Ste"] * (pooled_reftable_bees_stebbins[, "mu"]) * genomeS)
#
#hist(logtheta2_ste, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")
#
#reg_logtheta2_stebbins <- regAbcrf(formula = logtheta2_ste~.,
#                                 data    = data.frame(logtheta2_ste, global_sumstats4training_stebbins),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
##save(reg_logtheta2_stebbins, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_stebbins",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_stebbins",".RData"))
#
### variable Importance plot
##plot(x = reg_logtheta2_stebbins, n.var = 10, main=expression(log[10](italic(θ))))
#
##head(sort(reg_logtheta2_stebbins$model.rf$variable.importance, decreasing = T), n=20)
#
### prediction error
#reg_logtheta2_stebbins$model.rf$prediction.error
## 0.02548177
#
### error rate plot
##err.regAbcrf(object   = reg_logtheta2_stebbins,
##             training = data.frame(logtheta2_ste, global_sumstats4training_stebbins),
##             paral    = T,
##             ncores   = 28)
#
### oob predictions vs true values
## diagnostic plot
##plot(x    = logtheta2_ste,
##     y    = reg_logtheta2_stebbins$model.rf$predictions, 
##     xlab = "True value",
##     ylab = "OOB predictions",
##     xlim = c(-2,6),
##     ylim = c(-2,6),
##     main = expression(log[10](italic(theta))),
##     cex.axis = 1.2,
##     cex.lab  = 1.5)
##abline(a=0, b=1, col = "green")
#
## Manuscript plot
#oob.logtheta2.ste <- data.frame(x = logtheta2_ste,
#                                y = reg_logtheta2_stebbins$model.rf$predictions)
#
##save(oob.logtheta2.ste, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.ste",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.ste",".RData"))
#
##par(mar=c(5,5,4,1)+.1)
##hist2d(oob.logtheta2.ste, nbins=100, 
##       col=viridis::viridis(32), 
##       FUN=function(x) log(length(x)),
##       xlab = expression(paste("true", " ", log[10](italic(θ)))),
##       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
##       xlim = c(-1.5,6),
##       ylim = c(-1.5,6),
##       cex.axis = 1.2,
##       cex.lab  = 1.2)
##abline(a=0, b=1, col = "black", lty = 3)
#
### PLACERITA POPULATION
###--------------------------------
#logtheta2_pla <- log10(4 * pooled_reftable_bees_placerita[, "meanNe2_Pla"] * (pooled_reftable_bees_placerita[, "mu"]) * genomeS)
#
#hist(logtheta2_pla, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")
#
#reg_logtheta2_placerita <- regAbcrf(formula = logtheta2_pla~.,
#                                 data    = data.frame(logtheta2_pla, global_sumstats4training_placerita),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
##save(reg_logtheta2_placerita, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_placerita",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/reg_logtheta2_placerita",".RData"))
#
### variable Importance plot
#plot(x = reg_logtheta2_placerita, n.var = 10, main=expression(log[10](italic(θ))))
#
##head(sort(reg_logtheta2_placerita$model.rf$variable.importance, decreasing = T), n=20)
#
### prediction error
#reg_logtheta2_placerita$model.rf$prediction.error
## 0.02539776
#
### error rate plot
##err.regAbcrf(object   = reg_logtheta2_placerita,
##             training = data.frame(logtheta2_pla, global_sumstats4training_placerita),
##             paral    = T,
##             ncores   = 28)
#
### oob predictions vs true values
## diagnostic plot
#plot(x    = logtheta2_pla,
#     y    = reg_logtheta2_placerita$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-2,6),
#     ylim = c(-2,6),
#     main = expression(log[10](italic(theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## Manuscript plot
#oob.logtheta2.pla <- data.frame(x = logtheta2_pla,
#                                y = reg_logtheta2_placerita$model.rf$predictions)
#
##save(oob.logtheta2.pla, 
##     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.pla",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/oob.logtheta2.pla",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logtheta2.pla, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ)))),
#       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Rho = Nr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON
###-----------------------------------------------------------
#
#logrho_avalon <- log10(pooled_reftable_bees_avalon[, "meanNe2_Ava"] * pooled_reftable_bees_avalon[, "rr"])
#
#hist(logrho_avalon, freq = TRUE, xlab = expression(log[10](italic(rho))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logrho_avalon <- regAbcrf(formula = logrho_avalon~.,
#                                 data = data.frame(logrho_avalon, global_sumstats4training_avalon),
#                                ntree = 1000,
#                                paral = T,
#                               ncores = 8)
#save(reg_logrho_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/regression/reg_logrho_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/regression/reg_logrho_avalon",".RData"))
#
#
## variable Importance plot
#plot(x = reg_logrho_avalon, n.var = 20)
#
#head(sort(reg_logrho_avalon$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logrho_avalon$model.rf$prediction.error
#  0.5835657
#
## error rate plot
#err.regAbcrf(object   = reg_logrho_avalon,
#             training = data.frame(logrho_avalon, global_sumstats4training_avalon),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logrho_avalon,
#     y    = reg_logrho_avalon$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-8,-2),
#     ylim = c(-8,-2),
#     main = expression(log[10](italic(rho))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#df.logrho.ava <- data.frame(x = logrho_avalon,
#                            y = reg_logrho_avalon$model.rf$predictions)
#
#pdf(file="~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/regression/oob_plots/reg_logrho_avalon.pdf", 
#    width=6, height=6)
#par(mar=c(5,5,4,1)+.1)
#hist2d(df.logrho.ava, nbins=70, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(rho)))),
#       ylab = expression(paste(log[10](italic(hat(rho))), " ","(OOB prediction)")),
#       xlim = c(-8,-2),
#       ylim = c(-8,-2),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#dev.off()
```

## Sampling period inference

#### Load the necessary data for the predictions
```{r necessary data for prediction, echo=TRUE, eval=FALSE, include=TRUE}

## Reference table with the observed data global summary statistics
#load(file=paste0("~/My_repositories/Tracking-selection/data/ApisMellifera/globalStats_reftable/list_ObsSumStats",".RData"))

## List with all global reftable used for training for most of the parameters (except genetic load and prop strong selection)
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/list_global_SumStats4Training",".RData"))
```

### ABC-RF classification for selection: prediction for short-term evolution

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_rfclass_selection",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_classSelection",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_class",".RData"))

## Data Set
##--------------------
global_Obssumstats_avalon <- list.ObsSumStats[[1]]
posterior.classification.avalon <- predict(object       = class_selection_avalon,
                                             obs        = global_Obssumstats_avalon,
                                             training   = data.frame(selection_avalon, 
                                                                     global_sumstats4training_avalon),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_humboldt <- list.ObsSumStats[[2]]
posterior.classification.humboldt <- predict(object       = class_selection_humboldt,
                                             obs        = global_Obssumstats_humboldt,
                                             training   = data.frame(selection_humboldt, 
                                                                     global_sumstats4training_humboldt),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_davis <- list.ObsSumStats[[3]]
posterior.classification.davis <- predict(object       = class_selection_davis,
                                             obs        = global_Obssumstats_davis,
                                             training   = data.frame(selection_davis, 
                                                                     global_sumstats4training_davis),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_Stanislaus <- list.ObsSumStats[[4]]
posterior.classification.stanislaus <- predict(object   = class_selection_stanislaus,
                                             obs        = global_Obssumstats_Stanislaus,
                                             training   = data.frame(selection_stanislaus, 
                                                                     global_sumstats4training_stanislaus),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_stebbins <- list.ObsSumStats[[5]]
posterior.classification.stebbins <- predict(object   = class_selection_stebbins,
                                             obs        = global_Obssumstats_stebbins,
                                             training   = data.frame(selection_stebbins, 
                                                                     global_sumstats4training_stebbins),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_riverside <- list.ObsSumStats[[6]]
posterior.classification.riverside <- predict(object   = class_selection_riverside,
                                             obs        = global_Obssumstats_riverside,
                                             training   = data.frame(selection_riverside, 
                                                                     global_sumstats4training_riverside),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)

global_Obssumstats_placerita <- list.ObsSumStats[[7]]
posterior.classification.placerita <- predict(object   = class_selection_placerita,
                                             obs        = global_Obssumstats_placerita,
                                             training   = data.frame(selection_placerita, 
                                                                     global_sumstats4training_placerita),
                                             ntree      = 1000,
                                             paral      = TRUE,
                                             paral.predict = TRUE,
                                             ncores     = 2)



list.posterior.classSelection <- list(Ava=posterior.classification.avalon, Hum=posterior.classification.humboldt, 
                                      Dav=posterior.classification.davis, Sta=posterior.classification.stanislaus, 
                                      Ste=posterior.classification.stebbins, Riv=posterior.classification.riverside, 
                                      Pla=posterior.classification.placerita)


#save(list.posterior.classSelection, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_classSelection",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_classSelection",".RData"))
```

### ABC-RF regression for selection: predictions for short-term evolution

#### Average genetic load
```{r prediction genetic load, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs 
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_averageGenLoad",".RData"))

## Data Set
##--------------------
list.posterior.averageGenLoad <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                      Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 1:7){
  
  reg_averageGenLoad = list.reg.averageGenLoad[[i]]
  ObsSumStats = list.ObsSumStats[[i]]
  averageGenLoad = list.averageGenLoad[[i]]
  SumStats4Training.load = list.SumStats4Training.averageGenLoad[[i]]
  
  posterior.averageGenLoad <- predict(object     = reg_averageGenLoad,
                                      obs        = ObsSumStats,
                                      training   = data.frame(averageGenLoad, 
                                                              SumStats4Training.load),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 8,
                                      rf.weights = T)
  
  list.posterior.averageGenLoad[[i]] <- posterior.averageGenLoad
}

#save(list.posterior.averageGenLoad, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_averageGenLoad",".RData"))

for (i in 1:7){
  print(inv.logit(list.posterior.averageGenLoad[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.averageGenLoad[[i]]$expectation))
}
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r prediction strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs 
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongmsel",".RData"))

## Data Set
##--------------------
list.posterior.popstrongmsel <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                      Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  
  reg_popstrongmsel               = list.reg.logitpopstrongmsel[[i]]
  ObsSumStats                     = list.ObsSumStats[[i]]
  popstrongmsel                   = list.logitpopstrongmsel[[i]]
  SumStats4Training.popstrongmsel = list.SumStats4Training.popstrongmsel[[i]]
  
  posterior.popstrongmsel <- predict(object     = reg_popstrongmsel,
                                      obs        = ObsSumStats,
                                      training   = data.frame(popstrongmsel, 
                                                              SumStats4Training.popstrongmsel),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 8,
                                      rf.weights = T)
  
  list.posterior.popstrongmsel[[i]] <- posterior.popstrongmsel
}

#save(list.posterior.popstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_popstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_popstrongmsel",".RData"))

for (i in 1:7){
  print(inv.logit(list.posterior.popstrongmsel[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.popstrongmsel[[i]]$expectation))
}
```

#### Theta selected mutations
```{r prediction thetaPS, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logthetaPS",".RData"))

## Data Set
##--------------------
list.posterior.logthetaPS <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                  Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  reg_logthetaPS    = list.reg.logthetaPS[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logthetaPS        = list.logthetaPS[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logthetaPS <- predict(object     = reg_logthetaPS,
                                  obs        = ObsSumStats,
                                  training   = data.frame(logthetaPS, 
                                                          SumStats4Training),
                                  quantiles  = c(0.025,0.5,0.975),
                                  paral      = T,
                                  ncores     = 8,
                                  rf.weights = T)
  
  list.posterior.logthetaPS[[i]] <- posterior.logthetaPS
}

#save(list.posterior.logthetaPS, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logthetaPS",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logthetaPS[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logthetaPS[[i]]$expectation))
}
```

#### gamma mean - parameter
```{r prediction gammamean, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_loggammamean",".RData"))

## Data Set
##--------------------
list.posterior.loggammamean <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                    Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 1:7){
  
  reg_loggammamean    = list.reg.loggammamean[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  loggammamean        = list.loggammamean[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.loggammamean <- predict(object     = reg_loggammamean,
                                    obs        = ObsSumStats,
                                    training   = data.frame(loggammamean, 
                                                            SumStats4Training),
                                    quantiles  = c(0.025,0.5,0.975),
                                    paral      = T,
                                    ncores     = 8,
                                    rf.weights = T)
  
  list.posterior.loggammamean[[i]] <- posterior.loggammamean
}

#save(list.posterior.loggammamean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_loggammamean",".RData"))

for (i in 1:7){
  print(10^(list.posterior.loggammamean[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.loggammamean[[i]]$expectation))
}
```

#### Proportion of beneficial mutation - PrPs - parameter
```{r prediction PrPs, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logPrPs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logPrPs",".RData"))

## Data Set
##--------------------
list.posterior.logPrPs <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                               Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 1:7){
  
  reg_logPrPs       = list.reg.logPrPs[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logPrPs           = list.logPrPs[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logPrPs <- predict(object     = reg_logPrPs,
                               obs        = ObsSumStats,
                               training   = data.frame(logPrPs, 
                                                       SumStats4Training),
                               quantiles  = c(0.025,0.5,0.975),
                               paral      = T,
                               ncores     = 8,
                               rf.weights = T)
  
  list.posterior.logPrPs[[i]] <- posterior.logPrPs
}

#save(list.posterior.logPrPs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logPrPs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logPrPs",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logPrPs[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logPrPs[[i]]$expectation))
}
```

#### gamma mean - as latent variable
```{r prediction amma mean latent variable, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs 
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logpopstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logpopstrongselmean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_SumStats4Training_popstrongselmean",".RData"))

## Data Set
##--------------------
list.posterior.popstrongselmean <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                       Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  reg_popstrongselmean               = list.reg.logpopstrongselmean[[i]]
  ObsSumStats                        = list.ObsSumStats[[i]]
  logpopstrongselmean                = list.logpopstrongselmean[[i]]
  SumStats4Training.popstrongselmean = list.SumStats4Training.popstrongselmean[[i]]
  
  posterior.popstrongselmean <- predict(object      = reg_popstrongselmean ,
                                         obs        = ObsSumStats,
                                         training   = data.frame(logpopstrongselmean, 
                                                                 SumStats4Training.popstrongselmean),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 8,
                                         rf.weights = T)
  
  
  
  list.posterior.popstrongselmean[[i]] <- posterior.popstrongselmean
}

#save(list.posterior.popstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_popstrongselmean_",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_popstrongselmean",".RData"))

for (i in 1:7){
  print(10^(list.posterior.popstrongselmean[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.popstrongselmean[[i]]$expectation))
}
```

### ABC-RF regression for demography: predictions for short-term evolution

#### Harmonic mean of the effective population sizes of period 2 - meanNe2
```{r prediction MeanNe2, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2",".RData"))

## Data Set
##--------------------
list.posterior.logmeanNe2 <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                  Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  reg_logmeanNe2    = list.reg.logmeanNe2[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logmeanNe2        = list.logmeanNe2[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logmeanNe2 <- predict(object     = reg_logmeanNe2,
                                  obs        = ObsSumStats,
                                  training   = data.frame(logmeanNe2, 
                                                          SumStats4Training),
                                  quantiles  = c(0.025,0.5,0.975),
                                  paral      = T,
                                  ncores     = 8,
                                  rf.weights = T)
  
  list.posterior.logmeanNe2[[i]] <- posterior.logmeanNe2
}

#save(list.posterior.logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmeanNe2",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logmeanNe2[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logmeanNe2[[i]]$expectation))
}

tau = c(104,49,47,38,18,15,15)
for (i in 1:7){
  print(globalFSTNe(x=list.ObsSumStats[[i]][1], tau = tau[i]))
}
```

#### Population size of period 2 - census size Ncs
```{r predition Ncs, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logncs",".RData"))

## Data Set
##--------------------
list.posterior.logncs <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                  Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  reg_logncs        = list.reg.logncs[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logncs            = list.logncs[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logncs <- predict(object     = reg_logncs,
                              obs        = ObsSumStats,
                              training   = data.frame(logncs, 
                                                      SumStats4Training),
                              quantiles  = c(0.025,0.5,0.975),
                              paral      = T,
                              ncores     = 8,
                              rf.weights = T)
  
  list.posterior.logncs[[i]] <- posterior.logncs
}

#save(list.posterior.logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logncs",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logncs[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logncs[[i]]$expectation))
}
```

#### Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r predition MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmeanNe2ncs",".RData"))

## Data Set
##--------------------
list.posterior.logmeanNe2ncs <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                                     Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 2:7){
  
  reg_logmeanNe2ncs = list.reg.logmeanNe2ncs[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logmeanNe2ncs     = list.logmeanNe2ncs[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
                                     obs        = ObsSumStats,
                                     training   = data.frame(logmeanNe2ncs, 
                                                             SumStats4Training),
                                     quantiles  = c(0.025,0.5,0.975),
                                     paral      = T,
                                     ncores     = 8,
                                     rf.weights = T)
  
  list.posterior.logmeanNe2ncs[[i]] <- posterior.logmeanNe2ncs
}

#save(list.posterior.logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmeanNe2ncs",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logmeanNe2ncs[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logmeanNe2ncs[[i]]$expectation))
}
```

#### Per site mutation rate mu
```{r predition site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logmu",".RData"))

## Data Set
##--------------------
list.posterior.logmu <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                             Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 1:7){
  
  reg_logmu         = list.reg.logmu[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logmu             = list.logmu[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logmu <- predict(object     = reg_logmu,
                             obs        = ObsSumStats,
                             training   = data.frame(logmu, 
                                                     SumStats4Training),
                             quantiles  = c(0.025,0.5,0.975),
                             paral      = T,
                             ncores     = 8,
                             rf.weights = T)
  
  list.posterior.logmu[[i]] <- posterior.logmu
}

#save(list.posterior.logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logmu",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logmu[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logmu[[i]]$expectation))
}
```

#### recombination rate rr
```{r predition site recombination rate, echo=TRUE, eval=FALSE, include=TRUE}

## Load the LISTs
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_reg_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/random_forests/list_vector_logrr",".RData"))

## Data Set
##--------------------
list.posterior.logrr <- list(Ava=NULL, Hum=NULL, Dav=NULL, Sta=NULL, 
                             Ste=NULL,Riv=NULL, Pla=NULL)

for (i in 1:7){
  
  reg_logrr         = list.reg.logrr[[i]]
  ObsSumStats       = list.ObsSumStats[[i]]
  logrr             = list.logrr[[i]]
  SumStats4Training = list.global.SumStats4Training[[i]]
  
  posterior.logrr <- predict(object     = reg_logrr,
                             obs        = ObsSumStats,
                             training   = data.frame(logrr, 
                                                     SumStats4Training),
                             quantiles  = c(0.025,0.5,0.975),
                             paral      = T,
                             ncores     = 8,
                             rf.weights = T)
  
  list.posterior.logrr[[i]] <- posterior.logrr
}

#save(list.posterior.logrr, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/list_posterior_logrr",".RData"))

for (i in 1:7){
  print(10^(list.posterior.logrr[[i]]$expectation))
}

for (i in 1:7){
  print((list.posterior.logrr[[i]]$expectation))
}
```

### ABC-RF regression: predictions for long-term evolution

#### Ns
```{r prediction Ns, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON
###-----------------------------------------------------------
#posterior_logNs_avalon <- predict(object     = reg_logNs_avalon,
#                                  obs        = global_Obssumstats_avalon,
#                                  training   = data.frame(logNs_ava, global_sumstats4training_avalon),
#                                  quantiles  = c(0.025,0.5,0.975),
#                                  paral      = T,
#                                  ncores     = 8,
#                                  rf.weights = T)
#
#save(posterior_logNs_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logNs_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logNs_avalon",".RData"))
#
#(posterior_logNs_avalon)
#
#10^(posterior_logNs_avalon$expectation)
# 0.846396
#
#10^(posterior_logNs_avalon$med)
# 0.6348757
#
#10^(posterior_logNs_avalon$quantiles)
#quantile=0.025 quantile=0.5 quantile=0.975
#   0.02535777    0.6348757       56.33912
#
#hist(x      = logNs_ava,
#     breaks = seq(-3,4,0.5),
#     col    = "#969696",
#     freq   = FALSE,
#     main   = "",
#     xlab   = expression(log[10](italic(N)[e] * italic(s))),
#     ylab   = "probability density",
#     ylim   = c(0,0.5))
#wtd.hist(x      = logNs_ava,
#         breaks = seq(-3,4,0.5),
#         col    = adjustcolor( "#41b6c4", alpha.f = 0.5), freq=FALSE, add=TRUE,
#         weight = posterior_logNs_avalon$weights)
#abline(v=c(posterior_logNs_avalon$med,
#           posterior_logNs_avalon$quantiles[c(1,3)]),
#       col="red",
#       lty=c(1,3,3))
#
### PLACERITA
###-----------------------------------------------------------
#posterior_logNs_placerita <- predict(object     = reg_logNs_placerita,
#                                  obs        = global_Obssumstats_placerita,
#                                  training   = data.frame(logNs_pla, global_sumstats4training_placerita),
#                                  quantiles  = c(0.025,0.5,0.975),
#                                  paral      = T,
#                                  ncores     = 8,
#                                  rf.weights = T)
#
#save(posterior_logNs_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logNs_placerita",".RData"))
##load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logNs_placerita",".RData"))
#
#(posterior_logNs_placerita)
#
#10^(posterior_logNs_placerita$expectation)
# 3.254165
#
#10^(posterior_logNs_placerita$med)
# 2.564882
#
#10^(posterior_logNs_placerita$quantiles)
#quantile=0.025 quantile=0.5 quantile=0.975
#   0.07202465     2.564882       373.5629
#
#hist(x      = logNs_pla,
#     breaks = seq(-3,4,0.5),
#     col    = "#969696",
#     freq   = FALSE,
#     main   = "",
#     xlab   = expression(log[10](italic(N)[e] * italic(s))),
#     ylab   = "probability density",
#     ylim   = c(0,0.5))
#wtd.hist(x      = logNs_pla,
#         breaks = seq(-3,4,0.5),
#         col    = adjustcolor( "#41b6c4", alpha.f = 0.5), freq=FALSE, add=TRUE,
#         weight = posterior_logNs_placerita$weights)
#abline(v=c(posterior_logNs_placerita$med,
#           posterior_logNs_placerita$quantiles[c(1,3)]),
#       col="red",
#       lty=c(1,3,3))
```

#### Theta of period 2
```{r predition Theta2, echo=TRUE, eval=FALSE, include=TRUE}

### AVALON
###-----------------------------------------------------------
posterior_logtheta2_avalon <- predict(object     = reg_logtheta2_avalon,
                                      obs        = global_Obssumstats_avalon,
                                      training   = data.frame(logtheta2_ava, global_sumstats4training_avalon),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 8,
                                      rf.weights = T)

#save(posterior_logtheta2_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logtheta2_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logtheta2_avalon",".RData"))

(posterior_logtheta2_avalon)

10^(posterior_logtheta2_avalon$expectation)
# 2420.534

10^(posterior_logtheta2_avalon$med)
# 1925.017

10^(posterior_logtheta2_avalon$quantiles)
# quantile=0.025 quantile=0.5 quantile=0.975
#       131.1239     1925.017       54793.19

# given theta and the Ne, estimate mu
muCalc <- function(theta=theta, ne=ne, genome_size=genome_size){
        theta_ = theta/genome_size
        mu = theta_/(4*ne)
        return(mu)
}

# Estimating the per site mutation rate  - mu
muCalc(theta=c(131.1239, 1925.017, 54793.19),
       ne=100.8206, genome_size = genomeS)
# 1.300567e-09 1.909349e-08 5.434722e-07

muCalc(theta=c(131.1239, 1925.017, 54793.19),
       ne=22.05633 , genome_size = genomeS)
# 5.944955e-09 8.727730e-08 2.484239e-06

muCalc(theta=c(131.1239, 1925.017, 54793.19),
       ne=82.98198, genome_size = genomeS)
# 1.580149e-09 2.319801e-08 6.603023e-07

muCalc(theta=c(131.1239, 1925.017, 54793.19),
       ne=958.5587, genome_size = genomeS)
# 1.367928e-10 2.008241e-09 5.716206e-08

hist(x      = logtheta2_ava,
     breaks = seq(-1,6,0.1),
     col    = "#969696",
     freq   = FALSE,
     main   = "",
     xlab   = expression(log[10](italic(θ))),
     ylab   = "probability density",
     ylim   = c(0,1.5))
wtd.hist(x      = logtheta2_ava,
         breaks = seq(-1,6,0.1),
         col    = adjustcolor( "#41b6c4", alpha.f = 0.5), freq=FALSE, add=TRUE,
         weight = posterior_logtheta2_avalon$weights)
abline(v=c(posterior_logtheta2_avalon$med,
           posterior_logtheta2_avalon$quantiles[c(1,3)]),
       col="red",
       lty=c(1,3,3))

### PLACERITA
###-----------------------------------------------------------
posterior_logtheta2_placerita <- predict(object     = reg_logtheta2_placerita,
                                      obs        = global_Obssumstats_placerita,
                                      training   = data.frame(logtheta2_pla, global_sumstats4training_placerita),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 8,
                                      rf.weights = T)

#save(posterior_logtheta2_placerita, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logtheta2_placerita",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logtheta2_placerita",".RData"))

(posterior_logtheta2_placerita)

10^(posterior_logtheta2_placerita$expectation)
# 32191.51

10^(posterior_logtheta2_placerita$med)
# 29545.17

10^(posterior_logtheta2_placerita$quantiles)
# quantile=0.025 quantile=0.5 quantile=0.975
#       5355.317     29545.17         171315

# Estimating the per site mutation rate  - mu
muCalc(theta=c(5355.317, 29545.17 , 29545.17),
       ne=143.6135, genome_size = genomeS)
# 3.728979e-08 2.057270e-07 2.057270e-07

muCalc(theta=c(5355.317, 29545.17 , 29545.17),
       ne=4.57491, genome_size = genomeS)
# 1.170584e-06 6.458088e-06 6.458088e-06

muCalc(theta=c(5355.317, 29545.17 , 29545.17),
       ne=146.0324 , genome_size = genomeS)
# 3.667212e-08 2.023193e-07 2.023193e-07

muCalc(theta=c(5355.317, 29545.17 , 29545.17),
       ne=1145.739, genome_size = genomeS)
# 4.674116e-09 2.578700e-08 2.578700e-08

hist(x      = logtheta2_pla,
     breaks = seq(-1,6,0.1),
     col    = "#969696",
     freq   = FALSE,
     main   = "",
     xlab   = expression(log[10](italic(θ))),
     ylab   = "probability density",
     ylim   = c(0,1.5))
wtd.hist(x      = logtheta2_pla,
         breaks = seq(-1,6,0.1),
         col    = adjustcolor( "#41b6c4", alpha.f = 0.5), freq=FALSE, add=TRUE,
         weight = posterior_logtheta2_placerita$weights)
abline(v=c(posterior_logtheta2_placerita$med,
           posterior_logtheta2_placerita$quantiles[c(1,3)]),
       col="red",
       lty=c(1,3,3))
```

#### Rho = Nr
```{r predition site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}
### AVALON
###-----------------------------------------------------------
#posterior_logrho_avalon <- predict(object     = reg_logrho_avalon,
#                                  obs        = global_Obssumstats_avalon,
#                                  training   = data.frame(logrho_avalon, global_sumstats4training_avalon),
#                                  quantiles  = c(0.025,0.5,0.975),
#                                  paral      = T,
#                                  ncores     = 8,
#                                  rf.weights = T)
#
#
#save(posterior_logrho_avalon, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logrho_avalon",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v6_bees/posterior_obs/posterior_logrho_avalon",".RData"))
#
#(posterior_logrho_avalon)
#
#hist(x      = logrho_avalon,
#     #breaks = seq(-10,-7,0.1),
#     col    = "#969696",
#     freq   = FALSE,
#     main   = "",
#     xlab   = expression(log[10](italic(rho))),
#     ylab   = "probability density",
#     ylim   = c(0,1.0))
#wtd.hist(x      = logrho_avalon,
#         #breaks = seq(-10,-7,0.1),
#         col    = adjustcolor( "#41b6c4", alpha.f = 0.5), freq=FALSE, add=TRUE,
#         weight = posterior_logrho_avalon$weights)
```