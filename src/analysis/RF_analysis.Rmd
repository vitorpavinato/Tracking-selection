---
title: "Tracking Selection with ABC-RF"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean cache, echo=TRUE, eval=FALSE, include=TRUE}
rm(list=ls())
ls()
```

## ABC Random Forests Analysis

#### Install required packages
```{r install packages, echo=TRUE}
#install.packages(c("DataExplorer", 
#                   "dplyr",
#                   "abcrf",
#                   "weights",
#                   "grDevices"),
#                 dependencies = T)
```

#### Load packages and source file
```{r load packages, echo=TRUE, eval=FALSE, include=TRUE}
library(DataExplorer)
library(dplyr)
library(abcrf)
library(weights)
library(gtools)
library(ROCR)
library(grDevices)
library(foreach)    #
library(parallel)   # -> fo    r simulating in parallel
library(doParallel)

source("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_fun.R")
```

#### Upload the RF training reference table files
```{r load superbatch 1, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 1
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_1_genotoul/results/pooled_reftable_1.RData")
pooled_raw_reftable_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 2, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 2
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_2_genotoul/results/pooled_reftable_2.RData")
pooled_raw_reftable_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 3, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 3
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_3_genotoul/results/pooled_reftable_3.RData")
pooled_raw_reftable_3 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 4, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 4
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_4_cbgp/results/pooled_reftable_4.RData")
pooled_raw_reftable_4 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

#### Pool together the reftables from super-batches
```{r pooling reftable, echo=TRUE, eval=FALSE, include=TRUE}
pooled_raw_reftable_total <- rbind(pooled_raw_reftable_1,
                                   pooled_raw_reftable_2,
                                   pooled_raw_reftable_3,
                                   pooled_raw_reftable_4)

rm(pooled_raw_reftable_1)
rm(pooled_raw_reftable_2)
rm(pooled_raw_reftable_3)
rm(pooled_raw_reftable_4)

#save(pooled_raw_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))

#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))
```

#### RANDOM PODS
```{r load randompods, echo=TRUE, eval=FALSE, include=TRUE}

# random PODs 1
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_1_genotoul/results/pooled_reftable_pods_1.RData")
pooled_raw_reftable_pods_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_1[which(is.na(pooled_raw_reftable_pods_1[, "meanNe2"])), "sim"]
# 38  39 126 165 175 251 281 681 720 735 737 917

# random PODs 2
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_2_genotoul/results/pooled_reftable_pods_2.RData")
pooled_raw_reftable_pods_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_2[which(is.na(pooled_raw_reftable_pods_2[, "meanNe2"])), "sim"]
# 1481 1716

pooled_raw_reftable_pods <- rbind(pooled_raw_reftable_pods_1,
                                  pooled_raw_reftable_pods_2)

rm(pooled_raw_reftable_pods_1)
rm(pooled_raw_reftable_pods_2)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_pods)
# 1999 713

# save pooled_raw_reftable_pods as pooled_raw_reftable_pods
#save(pooled_raw_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))

#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))
```

#### FIXED PODS
```{r load fixedpods, echo=TRUE, eval=FALSE, include=TRUE}

# fixed PODs 1 - neutral
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/reference_table.RData")
raw_reftable_neutral_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 2 - mutation limited
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/reference_table.RData")
raw_reftable_limited_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 3 - mutation unlimited
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/reference_table.RData")
raw_reftable_unlimited_pods <- raw_reftable
rm(raw_reftable)

pooled_raw_reftable_fixedpods <- rbind(raw_reftable_neutral_pods,
                                       raw_reftable_limited_pods,
                                       raw_reftable_unlimited_pods)

rm(raw_reftable_neutral_pods)
rm(raw_reftable_limited_pods)
rm(raw_reftable_unlimited_pods)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_fixedpods)
# 300 713

# save pooled_raw_reftable_pods as pooled_raw_reftable_pods
#save(pooled_raw_reftable_fixedpods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))

```

#### Prepare the training RF reftable
```{r training data preparation, echo=TRUE, eval=FALSE, include=TRUE}

# Check missing data
plot_missing(pooled_raw_reftable_total) 
missing_count <- sapply(pooled_raw_reftable_total, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_total <- pooled_raw_reftable_total[,missing_count < nrow(pooled_raw_reftable_total)/10]

# remove also POPSelSd and SAMSelSd columns
pooled_reftable_total <- pooled_reftable_total[,-c(31,37)]

# check it!
missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_total) 

# remove remaining rows with missing data
pooled_reftable_total <- pooled_reftable_total[complete.cases(pooled_reftable_total), ]

# check it again
plot_missing(pooled_reftable_total)
table(missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x))))

# Check != numeric values
infinite_count <- sapply(pooled_reftable_total, function(x) sum(is.infinite(x)))

#save(pooled_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats <- pooled_reftable_total[, -c(1:104)]

#save(global_sumstats, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
```

#### Prepare the RANDOM PODs reftable
```{r randompods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_pods <- pooled_raw_reftable_pods[, names(pooled_raw_reftable_pods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_pods <- pooled_reftable_pods[complete.cases(pooled_reftable_pods), ]

#save(pooled_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_pods <- pooled_reftable_pods[, -c(1:104)]

#save(global_sumstats_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
```

#### Prepare the FIXED PODs reftable
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_fixedpods <- pooled_raw_reftable_fixedpods[, names(pooled_raw_reftable_fixedpods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_fixedpods <- pooled_reftable_fixedpods[complete.cases(pooled_reftable_fixedpods), ]

#save(pooled_reftable_fixedpods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_fixedpods <- pooled_reftable_fixedpods[, -c(1:104)]

#save(global_sumstats_fixedpods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
```

### ABC-RF Classification - Neutral vs Selection: Growing Trees
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

## Classification 1
selection_1 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1)

class_selection_1 <- abcrf(formula = selection_1~.,
                           data    = data.frame(selection_1, global_sumstats[,-c(117)]),
                           lda     = TRUE, 
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

(class_selection_1)

#save(class_selection_1, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_5/random_forests/class_selection_1",".RData"))

# error rate plot
err.abcrf(object   = class_selection_1,
          training = data.frame(selection_1, global_sumstats[,-c(117)]),
          paral    = T,
         ncores   = 28)

plot(class_selection_1, 
     training = data.frame(selection_1, global_sumstats[,-c(117)]),
     obs=NULL, 
     n.var=20)

#Number of simulations: 1
#Out-of-bag prior error rate: 19.3556%
#
#Confusion matrix:
#         qNeutral  sSel class.error
#qNeutral    20922  4575   0.1794329
#sSel         5830 22430   0.2062987

## Classification 2
#selection_2 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0 & pooled_reftable_total[, "averageGeneticLoad"] < 0.3, "qNeutral", "sSel")
#table(selection_2)
#
#class_selection_2 <- abcrf(formula = selection_2~.,
#                           data    = data.frame(selection_2, global_sumstats[,-c(117)]),
#                           lda     = TRUE, 
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(class_selection_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#
#(class_selection_2)
#
#plot(class_selection_2, 
#     training = data.frame(selection_2, global_sumstats[,-c(117)]),
#     obs=NULL, 
#     n.var=20)
```

### ABC-RF Regression for Selection: Growing Trees

#### Genetic Load
```{r regression genetic load, echo=TRUE, eval=FALSE, include=TRUE}
averageGenLoad <- pooled_reftable_total[, "averageGeneticLoad"]
hist(averageGenLoad, freq = TRUE, xlab = expression(italic(bar(L))), main = "", col = "#bdbdbd")

logaverageGenload <- -log10(1-averageGenLoad)
hist(logaverageGenload, freq = TRUE, xlab = expression(-log[10](1 - italic(bar(L)))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_averageGenLoad <- regAbcrf(formula = logaverageGenload~.,
                               data    = data.frame(logaverageGenload, global_sumstats),
                               ntree   = 1000,
                               paral   = T,
                               ncores  = 28)

#save(reg_averageGenLoad, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))

# variable Importance plot
plot(x = reg_averageGenLoad, n.var = 20)

#head(sort(reg_averageGenLoad$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_averageGenLoad$model.rf$prediction.error
# 0.01902606

# error rate plot
#err.regAbcrf(object   = reg_averageGenLoad,
#             training = data.frame(logaverageGenload, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = logaverageGenload,
     y    = reg_averageGenLoad$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,3),
     ylim = c(0,3),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(-log[10](1 - italic(bar(L)))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")

#identify(x = logaverageGenload,
#         y = reg_averageGenLoad$model.rf$predictions)
# example: simulation row 28263
# meanNe2 super small because of a lot of selection
#
#hist(averageGenLoad[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100, 
#     freq = TRUE, xlab = expression(italic(bar(L))), main = "", col = "#bdbdbd")
#
#hist(logaverageGenload[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100,
#     freq = TRUE, xlab = expression(-log[10](1 - italic(bar(L)))), main = "", col = "#bdbdbd")

# logit transformation
# removing "quasi-neutral" simulations
load_zero <- which(averageGenLoad == 0)
averageGenLoad_2 <- averageGenLoad[-load_zero]
global_sumstats_averageGenLoad <- global_sumstats[-load_zero,]

logitaverageGenload <- log(averageGenLoad_2/(1-averageGenLoad_2))
hist(logitaverageGenload, freq = TRUE, xlab = expression(-log[10](1 - italic(bar(L)))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_averageGenLoad_2 <- regAbcrf(formula = logitaverageGenload~.,
                                 data    = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 28)

#save(reg_logitaverageGenLoad, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitaverageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitaverageGenLoad",".RData"))

# variable Importance plot
plot(x = reg_averageGenLoad, n.var = 20)

#head(sort(reg_averageGenLoad$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_averageGenLoad$model.rf$prediction.error
# 0.01902606

# error rate plot
#err.regAbcrf(object   = reg_averageGenLoad,
#             training = data.frame(logaverageGenload, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = logaverageGenload,
     y    = reg_averageGenLoad$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,3),
     ylim = c(0,3),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(-log[10](1 - italic(bar(L)))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")
```

#### Proportion of strongly selected regions
```{r regression strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

# correlation between the the calculated PrPOPStrongMSel and PrSAMStrongMSel
cor(pooled_reftable_total$POPPrStrongMSel, pooled_reftable_total$SAMPrStrongMSel)

plot(x = pooled_reftable_total$POPPrStrongMSel, 
     y = pooled_reftable_total$SAMPrStrongMSel, 
     xlab = "POPPrStrongMSel",
     ylab = "SAMPrStrongMSel")
abline(lm(pooled_reftable_total$SAMPrStrongMSel ~ pooled_reftable_total$POPPrStrongMSel), col="#cb181d")

# PrPOPStrongMSel
prPOPStrongMSel <- pooled_reftable_total[, "POPPrStrongMSel"]
hist(prPOPStrongMSel, freq = TRUE, xlab = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

# abf-rf regression
reg_prPOPStrongMSel <- regAbcrf(formula = prPOPStrongMSel~.,
                                data    = data.frame(prPOPStrongMSel, global_sumstats),
                                ntree   = 1000,
                                paral   = T,
                                ncores  = 28)

#save(reg_prPOPStrongMSel, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))

# variable Importance plot
plot(x = reg_prPOPStrongMSel, n.var = 20)

#head(sort(reg_prPOPStrongMSel$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_prPOPStrongMSel$model.rf$prediction.error
# 0.001121995

# error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel,
#             training = data.frame(prPOPStrongMSel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = prPOPStrongMSel,
     y    = reg_prPOPStrongMSel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(italic(P[strong])),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")

# removing "quasi-neutral" simulations
neutralsims <- which(prPOPStrongMSel == 0)
prPOPStrongMSel_2 <- prPOPStrongMSel[-neutralsims]
global_sumstats_popstrongmsel <- global_sumstats[-neutralsims,]

hist(prPOPStrongMSel_2, freq = TRUE, xlab = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

# abf-rf regression
reg_prPOPStrongMSel_2 <- regAbcrf(formula = prPOPStrongMSel_2~.,
                                  data    = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
                                  ntree   = 1000,
                                  paral   = T,
                                  ncores  = 28)

#save(reg_prPOPStrongMSel_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel_2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))

# variable Importance plot
plot(x = reg_prPOPStrongMSel_2, n.var = 20)

#head(sort(reg_prPOPStrongMSel_2$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_prPOPStrongMSel_2$model.rf$prediction.error
# 0.001584579

# error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel_2,
#             training = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = prPOPStrongMSel_2,
     y    = reg_prPOPStrongMSel_2$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     main = expression(italic(P[strong])),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

## log10 transformation PrPOPStrongMSel
logpopstrongmsel <- log10(prPOPStrongMSel_2)

hist(logpopstrongmsel, freq = TRUE, xlab = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

reg_logpopstrongmsel <- regAbcrf(formula = logpopstrongmsel~.,
                                 data    = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 28)

#save(reg_logpopstrongmsel, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))

# variable Importance plot
plot(x = reg_logpopstrongmsel, n.var = 20)

#head(sort(reg_logpopstrongmsel$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logpopstrongmsel$model.rf$prediction.error
# 0.2933011

# error rate plot
#err.regAbcrf(object   = reg_logpopstrongmsel,
#             training = data.frame(logpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

# oob predictions vs true values
plot(x    = logpopstrongmsel,
     y    = reg_logpopstrongmsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-7,0),
     ylim = c(-7,0),
     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
     main = expression(log[10](italic(P[strong]))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)


## log10 logit transformation PrPOPStrongMSel
logitpopstrongmsel <- log(prPOPStrongMSel_2/(1-prPOPStrongMSel_2))

hist(logitpopstrongmsel, freq = TRUE, xlab = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

reg_logitpopstrongmsel <- regAbcrf(formula = logitpopstrongmsel~.,
                                   data    = data.frame(logitpopstrongmsel, global_sumstats_popstrongmsel),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logitpopstrongmsel, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))

# variable Importance plot
plot(x = reg_logitpopstrongmsel, n.var = 20)

#head(sort(reg_logpopstrongmsel$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logitpopstrongmsel$model.rf$prediction.error
# 1.608456

# error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel,
#             training = data.frame(logitpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

# oob predictions vs true values
plot(x    = logitpopstrongmsel,
     y    = reg_logitpopstrongmsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-15,2),
     ylim = c(-15,2),
     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
     main = expression(log(italic(P[strong])/(1-italic(P[strong])))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)
```

#### FDR 1% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
fstfdrNs01 <- pooled_reftable_total[, "FSTfdrNS01"]
hist(fstfdrNs01, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")

# abf-rf regression
reg_fstfdrNs01 <- regAbcrf(formula = fstfdrNs01~.,
                           data    = data.frame(fstfdrNs01, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

#save(reg_fstfdrNs01, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))

# variable Importance plot
plot(x = reg_fstfdrNs01, n.var = 20)

#head(sort(reg_fstfdrNs01$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_fstfdrNs01$model.rf$prediction.error
#  0.004060022

# error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01,
#             training = data.frame(fstfdrNs01, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = fstfdrNs01,
     y    = reg_fstfdrNs01$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")

# removing "quasi-neutral" simulations
#fstfdrNs01_2 <- fstfdrNs01[-neutralsims]
#hist(fstfdrNs01_2, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")

# abf-rf regression
#reg_fstfdrNs01_2 <- regAbcrf(formula = fstfdrNs01_2~.,
#                           data    = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
# variable Importance plot
#plot(x = reg_fstfdrNs01_2, n.var = 20)
#
#head(sort(reg_fstfdrNs01_2$model.rf$variable.importance, decreasing = T), n=20)
#
# prediction error
#reg_fstfdrNs01_2$model.rf$prediction.error
# 0.00575472
#
# error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01_2,
#             training = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
# oob predictions vs true values
#plot(x    = fstfdrNs01_2,
#     y    = reg_fstfdrNs01_2$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "#cb181d")
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
fstfdrNs05 <- pooled_reftable_total[, "FSTfdrNS05"]
hist(fstfdrNs05, freq = TRUE, xlab = "5% FST FDR Ns>1", main = "", col = "#bdbdbd")

# abf-rf regression
reg_fstfdrNs05 <- regAbcrf(formula = fstfdrNs05~.,
                           data    = data.frame(fstfdrNs05, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

#save(reg_fstfdrNs05, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))

# variable Importance plot
plot(x = reg_fstfdrNs05, n.var = 20)

#head(sort(reg_fstfdrNs05$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_fstfdrNs05$model.rf$prediction.error
#  0.004149811

# error rate plot
#err.regAbcrf(object   = reg_fstfdrNs05,
#             training = data.frame(fstfdrNs05, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = fstfdrNs05,
     y    = reg_fstfdrNs05$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")
```

#### ThetaS 
```{r regression thetaS, echo=TRUE, eval=FALSE, include=TRUE}
genomeS = 100e+6

prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
  
logthetaS <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)

hist(logthetaS, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logthetaS <- regAbcrf(formula = logthetaS~.,
                          data    = data.frame(logthetaS, global_sumstats),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 28)

#save(reg_logthetaS, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))

# variable Importance plot
plot(x = reg_logthetaS, n.var = 20)

#head(sort(reg_logthetaS$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logthetaS$model.rf$prediction.error
# 1.431425

# error rate plot
#err.regAbcrf(object   = reg_logthetaS,
#             training = data.frame(logthetaS, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logthetaS,
     y    = reg_logthetaS$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-7,5),
     ylim = c(-7,5),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")

```

#### DFE Gamma mean
```{r regression gamma mean, echo=TRUE, eval=FALSE, include=TRUE}

loggammamean <- log10(pooled_reftable_total[, "gammaMean"])

hist(loggammamean, freq = TRUE, xlab = expression(log[10](paste("gamma ", kappa, theta))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_loggammamean <- regAbcrf(formula = loggammamean~.,
                             data    = data.frame(loggammamean, global_sumstats),
                             ntree   = 1000,
                             paral   = T,
                             ncores  = 28)

#save(reg_loggammamean, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))

# variable Importance plot
plot(x = reg_loggammamean, n.var = 20)

#head(sort(reg_loggammamean$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_loggammamean$model.rf$prediction.error
# 0.6123305

# error rate plot
#err.regAbcrf(object   = reg_loggammamean,
#             training = data.frame(loggammamean, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = loggammamean,
     y    = reg_loggammamean$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-3,0),
     ylim = c(-3,0),
     main = expression(log[10](paste("gamma ", kappa, theta))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

### ABC-RF Regression for Demography: Growing Trees

#### Effective Population Size of Phase 2 - Sampling phase
```{r regression meanNe2, echo=TRUE, eval=FALSE, include=TRUE}
logmeanNe2 <- log10(pooled_reftable_total[, "meanNe2"])

hist(logmeanNe2, freq = TRUE, xlab = expression(log[10](italic(bar(N[e])))), main = "", col = "#bdbdbd")

reg_logmeanNe2 <- regAbcrf(formula = logmeanNe2~.,
                                   data    = data.frame(logmeanNe2, global_sumstats),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logmeanNe2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))

# Variable Importance plot
plot(x = reg_logmeanNe2, n.var = 20)

#head(sort(reg_logmeanNe2$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logmeanNe2$model.rf$prediction.error
# 0.02328446

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2,
#             training = data.frame(logmeanNe2, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = logmeanNe2,
     y    = reg_logmeanNe2$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-2,4),
     ylim = c(-2,4),
     main = expression(log[10](italic(bar(N[e])))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Population Census Size for the Sampling Phase - Ncs
```{r regression Ncs, echo=TRUE, eval=FALSE, include=TRUE}
logncs <- log10(pooled_reftable_total[, "Ncs"])

hist(logncs, freq = TRUE, xlab = expression(log[10](italic(N[cs]))), main = "", col = "#bdbdbd")

reg_logncs <- regAbcrf(formula = logncs~.,
                        data = data.frame(logncs, global_sumstats),
                       ntree = 1000,
                       paral = T,
                      ncores = 28)

#save(reg_logncs, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))

# Variable Importance plot
plot(x = reg_logncs, n.var = 20)

#head(sort(reg_logn$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logncs$model.rf$prediction.error
# 0.03197194

# error rate plot
#err.regAbcrf(object   = reg_logncs,
#             training = data.frame(logncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = logncs,
     y    = reg_logncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,4),
     ylim = c(0,4),
     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(log[10](italic(N[cs]))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Theta1 - equilibrium phase
```{r regression theta, echo=TRUE, eval=FALSE, include=TRUE}
logtheta1 <- log10(4 * pooled_reftable_total[, "meanNe1"] * (pooled_reftable_total[, "mu"]) * genomeS)

hist(logtheta1, freq = TRUE, xlab = expression(log[10](italic(theta[1]))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logtheta1 <- regAbcrf(formula = logtheta1~.,
                          data    = data.frame(logtheta1, global_sumstats),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 28)

#save(reg_logtheta1, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))

# variable Importance plot
plot(x = reg_logtheta1, n.var = 20)

#head(sort(reg_logtheta1$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logtheta1$model.rf$prediction.error
# 0.02243393

# error rate plot
#err.regAbcrf(object   = reg_logtheta1,
#             training = data.frame(logtheta1, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logtheta1,
     y    = reg_logtheta1$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-1,6),
     ylim = c(-1,6),
     main = expression(log[10](italic(theta[1]))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Ratio Effective Size / Census Size for the Sampling Phase - MeanNe2/Ncs
```{r regression MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

logmeanNe2ncs <- log10(pooled_reftable_total[, "meanNe2"]/pooled_reftable_total[, "Ncs"])

hist(logmeanNe2ncs, freq = TRUE, xlab = expression(log[10](italic(bar(N[e]))/italic(N[cs]))), main = "", col = "#bdbdbd")

reg_logmeanNe2ncs <- regAbcrf(formula = logmeanNe2ncs~.,
                                 data = data.frame(logmeanNe2ncs, global_sumstats),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))

# Variable Importance plot
plot(x = reg_logmeanNe2ncs, n.var = 20)

#head(sort(reg_logmeanNe2ncs$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logmeanNe2ncs$model.rf$prediction.error
# 0.02523953

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs,
#             training = data.frame(logmeanNe2ncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

# oob predictions vs true values
plot(x    = logmeanNe2ncs,
     y    = reg_logmeanNe2ncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-5,1),
     ylim = c(-5,1),
     main = expression(log[10](italic(bar(N[e]))/italic(N[cs]))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Per site mutation rate mu
```{r regression site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}

logmu <- log10(pooled_reftable_total[, "mu"])

hist(logmu, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logmu <- regAbcrf(formula = logmu~.,
                      data    = data.frame(logmu, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 28)

#save(reg_logmu, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))

# variable Importance plot
plot(x = reg_logmu, n.var = 20)

#head(sort(reg_logmu$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logmu$model.rf$prediction.error
# 0.007331174

# error rate plot
#err.regAbcrf(object   = reg_logmu,
#             training = data.frame(logmu, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logmu,
     y    = reg_logmu$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-10,-6),
     ylim = c(-10,-6),
     main = expression(log[10](italic(mu))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Rho = Nr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}
logrho <- log10(pooled_reftable_total[, "meanNe2"] * pooled_reftable_total[, "rr"])

hist(logrho, freq = TRUE, xlab = expression(log[10](italic(rho))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logrho <- regAbcrf(formula = logrho~.,
                       data    = data.frame(logrho, global_sumstats),
                       ntree   = 1000,
                       paral   = T,
                       ncores  = 28)

#save(reg_logrho, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))

# variable Importance plot
plot(x = reg_logrho, n.var = 20)

#head(sort(reg_logrho$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logrho$model.rf$prediction.error
#  0.399973

# error rate plot
#err.regAbcrf(object   = reg_logrho,
#             training = data.frame(logrho, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logrho,
     y    = reg_logrho$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-10,-2),
     ylim = c(-10,-2),
     main = expression(log[10](italic(rho))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

#### Combined plot
```{r combined OOB plots, echo=TRUE, eval=FALSE, include=TRUE}

# selection: average genetic load and Pr mutations with Ns >1
# demography: mean Ne2 and Ncs
#par(mfrow=c(3,3))
#plot(x    = logaverageGenload,
#     y    = reg_averageGenLoad$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     main = expression(-log[10](1 - italic(bar(L))))
#    #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#bline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logpopstrongmsel,
#     y    = reg_logpopstrongmsel$model.rf$predictions, 
#    xlab = "True value",
#    ylab = "OOB predictions",
#    xlim = c(-7,0),
#     ylim = c(-7,0),
#     main = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1"))
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#    )
#abline(a=0, b=1, col = "#cb181d")
#
#plot(x    = fstfdrNs05,
#     y    = reg_fstfdrNs05$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1"))
#     #,
#     #cex.axis = 1.2,
#    #cex.lab  = 1.5
#    )
#bline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logthetaS,
#     y    = reg_logthetaS$model.rf$predictions, 
#    xlab = "True value",
#    ylab = "OOB predictions",
#     xlim = c(-7,5),
#    ylim = c(-7,5),
#    main = expression(log[10](italic(theta[S])))
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logmeanNe2,
#     y    = reg_logmeanNe2$model.rf$predictions,
#     xlab = "True value",
#    ylab = "OOB predictions",
#     xlim = c(-2,4),
#    ylim = c(-2,4),
#     main = expression(log[10](italic(bar(N[e]))))
#     #,
#    #cex.axis = 1.2,
#     #cex.lab  = 1.5
#    )
#bline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logncs,
#     y    = reg_logncs$model.rf$predictions,
#     xlab = "True value",
#    ylab = "OOB predictions",
#    xlim = c(0,4),
#    ylim = c(0,4),
#    main = expression(log[10](italic(N[cs])))
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#    )
#bline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logmeanNe2ncs,
#     y    = reg_logmeanNe2ncs$model.rf$predictions,
#    xlab = "True value",
#    ylab = "OOB predictions",
#     xlim = c(-5,1),
#     ylim = c(-5,1),
#     main = expression(log[10](italic(bar(N[e]))/italic(N[cs])))
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
#plot(x    = logmu,
#     y    = reg_logmu$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-5),
#     ylim = c(-10,-5),
#     main = expression(log[10](italic(mu)))
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
```

### ABC-RF Classification - Neutral vs Selection: Growing Trees
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

### RANDOM PODS

## Classification 1
selection_1_pods <- ifelse(pooled_reftable_pods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_pods)

posterior_class_selection_1 <- predict(object     = class_selection_1,
                                       obs        = global_sumstats_pods[,-c(117)],
                                       training   = data.frame(selection_1, global_sumstats[,-c(117)]),
                                       ntree      = 1000,
                                       paral      = TRUE,
                                       paral.predict = TRUE,
                                       ncores     = 2)

#(posterior_class_selection_1)

#save(posterior_class_selection_1, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))

class_selection_1_table <- data.frame(obs=selection_1_pods, pred=posterior_class_selection_1$allocation)

table(class_selection_1_table)

#Confusion matrix: classification
#           pred
#obs        qNeutral sSel class.error
#qNeutral      709  164   0.187858 = 164/(164+709)
#sSel          201  803   0.2001992 = 201/(201+803)

class_sel_1_global_error <- ifelse(class_selection_1_table$obs == class_selection_1_table$pred, 0, 1)

sum(class_sel_1_global_error)/length(class_sel_1_global_error)
# global error = 0.1944592


## Random PODs ThetaS obs value (TRUE) ##
prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]

log_radnompods_thetaS <- log10(4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS)

hist(log_radnompods_thetaS, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")


#write.table(data.frame(logthetaS=log_radnompods_thetaS, obs=selection_1_pods, infer=posterior_class_selection_1$allocation),
#            file = "/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/thetaS_Pstrong_class_table.txt",
#            quote = FALSE, sep = "\t")

# discrete groups of theta 1
mutation_lim_1 <- ifelse(log_radnompods_thetaS > 1, "unlimited", "limited")

table(class_selection_1_table[which(mutation_lim_1 == "unlimited"), ])

#Confusion matrix: classification thetaS unlimited
#           pred
#obs        qNeutral sSel  class.error
#qNeutral          6    0  0 = 0/(0+6)
#sSel             46  400  0.103139 = 46/(46+400)

sum(class_sel_1_global_error[which(mutation_lim_1 == "unlimited")])/length(class_sel_1_global_error[which(mutation_lim_1 == "unlimited")])
# global error = 0.1017699

table(class_selection_1_table[which(mutation_lim_1 == "limited"), ])

#Confusion matrix: classification thetaS unlimited
#           pred
#obs        qNeutral sSel  class.error
#qNeutral        703  164  0.189158
#sSel            155  403  0.2777778

sum(class_sel_1_global_error[which(mutation_lim_1 == "limited")])/length(class_sel_1_global_error[which(mutation_lim_1 == "limited")])
# global error = 0.2238596


mutation_lim_1_error <- data.frame(class=c("unlimited","limited"), 
                                   errqN=c(0,0.189158), 
                                   errsS=c(0.103139,0.2777778),
                                   errGl=c(0.1017699, 0.2238596))

plot(mutation_lim_1_error$class, mutation_lim_1_error$errqN,
     ylim = c(0,0.5),
     ylab = "error",
     xlab = expression(paste(italic(theta[S]), " classification")),
     type = 'n'
     )


# discrete groups of thetaS 2 - quantile
quantile(log_radnompods_thetaS, probs = c(0.20,0.40,0.60,0.80))

hist(log_radnompods_thetaS, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
abline(v = c(-2.286008, -1.010994, 0.183353, 1.266610), col="blue", lty=1)

mutation_lim_2 <- ifelse(log_radnompods_thetaS <= -2.286008, 1, 
                         ifelse(log_radnompods_thetaS > -2.286008 & log_radnompods_thetaS <= -1.010994, 2, 
                                ifelse(log_radnompods_thetaS >-1.010994 & log_radnompods_thetaS <= 0.183353, 3, 
                                       ifelse(log_radnompods_thetaS >0.183353 & log_radnompods_thetaS <= 1.266610, 4, 5))))

table(class_selection_1_table[which(mutation_lim_2 == 1), ])
#Confusion matrix: classification thetaS quantile 1
#           pred
#obs        qNeutral sSel  class.error
#qNeutral       334    24  
#sSel             9    9   
sum(class_sel_1_global_error[which(mutation_lim_2 == 1)])/length(class_sel_1_global_error[which(mutation_lim_2 == 1)])
# global error = 0.08776596

table(class_selection_1_table[which(mutation_lim_2 == 2), ])
#Confusion matrix: classification thetaS quantile 1
#           pred
#obs        qNeutral sSel  class.error
#qNeutral        229   64  
#sSel            26    56  
sum(class_sel_1_global_error[which(mutation_lim_2 == 2)])/length(class_sel_1_global_error[which(mutation_lim_2 == 2)])
# global error = 0.24

table(class_selection_1_table[which(mutation_lim_2 == 3), ])
#Confusion matrix: classification thetaS quantile 1
#           pred
#obs        qNeutral sSel  class.error
#qNeutral        118   56  
#sSel             65  136  
sum(class_sel_1_global_error[which(mutation_lim_2 == 3)])/length(class_sel_1_global_error[which(mutation_lim_2 == 3)])
# global error = 0.3226667

table(class_selection_1_table[which(mutation_lim_2 == 4), ])
#Confusion matrix: classification thetaS quantile 1
#           pred
#obs        qNeutral sSel  class.error
#qNeutral         27   20  
#sSel             67  261  
sum(class_sel_1_global_error[which(mutation_lim_2 == 4)])/length(class_sel_1_global_error[which(mutation_lim_2 == 4)])
# global error = 0.232

table(class_selection_1_table[which(mutation_lim_2 == 5), ])
#Confusion matrix: classification thetaS quantile 1
#           pred
#obs        qNeutral sSel  class.error
#qNeutral         1    0   
#sSel            34   341  
sum(class_sel_1_global_error[which(mutation_lim_2 == 5)])/length(class_sel_1_global_error[which(mutation_lim_2 == 5)])
# global error = 0.09042553

plot(c(1,2,3,4,5), c(0.08776596,0.24,0.3226667,0.232,0.09042553), 
     pch=19, col="red", ylim = c(0, 0.5), xlab = "class", ylab = "error", type="b")
legend("topleft", legend = c("global error"),
       col = ("red"), pch = 19, bty = "n")

### FIXED PODS

posterior_class_selection_1_fixedpods <- predict(object        = class_selection_1,
                                                 obs           = global_sumstats_fixedpods[,-c(117)],
                                                 training      = data.frame(selection_1, global_sumstats[,-c(117)]),
                                                 ntree         = 1000,
                                                 paral         = TRUE,
                                                 paral.predict = TRUE,
                                                 ncores        = 28)

#(posterior_class_selection_1_fixedpods)

#save(posterior_class_selection_1_fixedpods, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))


selection_1_fixedpods <- ifelse(pooled_reftable_fixedpods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_fixedpods)

class_selection_1_table_fixedpods <- data.frame(obs=selection_1_fixedpods, pred=posterior_class_selection_1_fixedpods$allocation)

table(class_selection_1_table_fixedpods[1:100, ])
#Confusion matrix: classification
#          pred
#obs        qNeutral sSel
#  qNeutral      100    0
#  sSel            0    0

table(class_selection_1_table_fixedpods[101:200, ])
#         pred
#obs        qNeutral sSel
#  qNeutral        0    0
#  sSel            8   92

table(class_selection_1_table_fixedpods[201:300, ])
#          pred
#obs        qNeutral sSel
#  qNeutral        0    0
#  sSel            0  100
```

### ABC-RF Regression for Selection: Prediction

#### ThetaS
```{r prediction thetaS, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
posterior_radnompods_logthetaS <- predict(object     = reg_logthetaS,
                                          obs        = global_sumstats_pods,
                                          training   = data.frame(logthetaS, global_sumstats),
                                          quantiles  = c(0.025,0.5,0.975),
                                          paral      = T,
                                          ncores     = 28,
                                          rf.weights = T)

#(posterior_radnompods_logthetaS)

#save(posterior_radnompods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))

#theta_palette <- c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99")

#palette(theta_palette)

# Expected True vs estimated
plot(x    = log_radnompods_thetaS, 
     y    = posterior_radnompods_logthetaS$expectation,
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(theta[s]), 
     ylab = expression(tilde(theta[s])),
     #main = expression(log10(italic(theta[s]))),
     pch  = 1,
     #col  = mutation_lim_2,
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
#legend("topleft", legend = c(expression(italic(q[1])),expression(italic(q[2])),expression(italic(q[3])),
#                             expression(italic(q[4])),expression(italic(q[5]))),
#       col = theta_palette, pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")

## FIXED PODs 

prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]

log_fixedpods_thetaS <- log10(4 * pooled_reftable_fixedpods[, "meanNe2"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS)

posterior_fixedpods_logthetaS <- predict(object     = reg_logthetaS,
                                         obs        = global_sumstats_fixedpods,
                                         training   = data.frame(logthetaS, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 28,
                                         rf.weights = T)

(posterior_fixedpods_logthetaS)

#save(posterior_fixedpods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/posterior_fixedpods_logthetaS",".RData"))

fixedpods_palette <- c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))

# Expected True vs estimated
plot(x    = log_fixedpods_thetaS, 
     y    = posterior_fixedpods_logthetaS$expectation,
     xlim = c(-1,2),
     ylim = c(-1,2),
     xlab = expression(theta[s]), 
     ylab = expression(hat(theta[s])),
     pch  = 1,
     col  = fixedpods_palette,
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
legend("topleft", legend = c("mutation limited", "mutation unlimited"),
       col = c("#ff7f00","#e31a1c"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")
```

#### Genetic Load
```{r prediction genetic load, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
log_radnompods_averageGenLoad <- -log10(1-pooled_reftable_pods[, "averageGeneticLoad"])

posterior_radnompods_averageGenLoad <- predict(object     = reg_averageGenLoad,
                                               obs        = global_sumstats_pods,
                                               training   = data.frame(logaverageGenload, global_sumstats),
                                               quantiles  = c(0.025,0.5,0.975),
                                               paral      = T,
                                               ncores     = 2,
                                               rf.weights = T)
#(posterior_radnompods_averageGenLoad)

#save(posterior_radnompods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))

# Expected True vs estimated
plot(x    = log_radnompods_averageGenLoad, 
     y    = posterior_radnompods_averageGenLoad$expectation,
     xlim = c(0,3),
     ylim = c(0,3),
     xlab = expression(italic(L)), 
     ylab = expression(hat(italic(L))),
     main = expression(-log[10](1 - italic(bar(L)))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

# get randompods popstrongmsel
log_radnompods_popstrongmsel <- log10(pooled_reftable_pods[, "POPPrStrongMSel"])

logit_radnompods_popstrongmsel <- log(pooled_reftable_pods[, "POPPrStrongMSel"]/(1-pooled_reftable_pods[, "POPPrStrongMSel"]))

# coloring wiht the Proportion of Strongly Selected Mutations 
genload_table <- data.frame(est=posterior_radnompods_averageGenLoad$expectation,
                            obs=log_radnompods_averageGenLoad, 
                            prstrong=log_radnompods_popstrongmsel)

ggplot(genload_table, aes(x=obs , y=est, color=prstrong)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "black", high = "red")+
  xlab(expression(italic(L))) +
  ylab(expression(hat(italic(L))))+
  xlim(0, 3) +
  ylim(0, 3) +
  geom_abline(intercept = 0, slope = 1, color = "blue")

# Median True vs estimated
plot(x    = log_radnompods_averageGenLoad, 
     y    = posterior_radnompods_averageGenLoad$med,
     xlim = c(0,3),
     ylim = c(0,3),
     xlab = expression(italic(L)), 
     ylab = expression(tilde(italic(L))),
     main = expression(-log[10](1 - italic(bar(L)))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

## Fixed PODs 

log_fixedpods_averageGenLoad <- -log10(1-pooled_reftable_fixedpods[, "averageGeneticLoad"])

posterior_fixedpods_averageGenLoad <- predict(object     = reg_averageGenLoad,
                                              obs        = global_sumstats_fixedpods,
                                              training   = data.frame(logaverageGenload, global_sumstats),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 28,
                                              rf.weights = T)
#(posterior_fixedpods_averageGenLoad)

#save(posterior_fixedpods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))

# Expected True vs estimated
plot(x    = log_fixedpods_averageGenLoad, 
     y    = posterior_fixedpods_averageGenLoad$expectation,
     xlim = c(0,2),
     ylim = c(0,2),
     xlab = expression(italic(L)), 
     ylab = expression(hat(italic(L))),
     pch  = 1,
     col  = fixedpods_palette,
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
legend("topleft", legend = c("neutral","mutation limited", "mutation unlimited"),
       col = c("#1f78b4","#ff7f00","#e31a1c"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")
```

#### Proportion of strongly selected mutations
```{r prediction strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
qneutral_qneutral <- which(selection_1_pods == "qNeutral" & posterior_class_selection_1$allocation == "qNeutral")

log_radnompods_popstrongmsel[which(log_radnompods_popstrongmsel == -Inf)] <- -7

posterior_radnompods_logpopstrongmsel <- predict(object        = reg_logpopstrongmsel,
                                                    obs        = global_sumstats_pods[-qneutral_qneutral,],
                                                    training   = data.frame(logpopstrongmsel,global_sumstats_popstrongmsel),
                                                    quantiles  = c(0.025,0.5,0.975),
                                                    paral      = T,
                                                    ncores     = 28,
                                                    rf.weights = T)
#(posterior_radnompods_logpopstrongmsel)

#save(posterior_radnompods_logpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))

logit_radnompods_popstrongmsel[which(logit_radnompods_popstrongmsel == -Inf)] <- -15

posterior_radnompods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_pods[-qneutral_qneutral,],
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 28,
                                                   rf.weights = T)
#(posterior_radnompods_logitpopstrongmsel)

#save(posterior_radnompods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))

class_selection_1_table_mod <- class_selection_1_table[-qneutral_qneutral,]


class_selection_1_table_mod$col_classi<- ifelse(class_selection_1_table_mod$obs == "qNeutral" & class_selection_1_table_mod$pred == "sSel", "red",
                                                ifelse(class_selection_1_table_mod$obs == "sSel" & class_selection_1_table_mod$pred == "qNeutral", "green", "black"))


# Expected True vs estimated
plot(x    = log_radnompods_popstrongmsel[-qneutral_qneutral], 
     y    = posterior_radnompods_logpopstrongmsel$expectation,
     xlim = c(-7,0),
     ylim = c(-7,0),
     xlab = expression(log[10](italic(P[strong]))), 
     ylab = expression(tilde(log[10](italic(P[strong])))),
     col  = class_selection_1_table_mod$col_classi,
     pch  = 1,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
legend("bottomright", legend = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel"), col = c("red", "green","black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")

# Expected True vs estimated
plot(x    = logit_radnompods_popstrongmsel[-qneutral_qneutral], 
     y    = posterior_radnompods_logitpopstrongmsel$expectation,
     xlim = c(-15,2),
     ylim = c(-15,2),
     xlab = expression(logit(italic(P[strong]))), 
     ylab = expression(tilde(logit(italic(P[strong])))),
     col  = class_selection_1_table_mod$col_classi,
     pch  = 1,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
legend("topleft", legend = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel"), col = c("red", "green","black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")


popstrongmsel_applic_data = data.frame(pooled_reftable_pods[-qneutral_qneutral, c("sim", "meanNe2")], 
                                       True_popstrongmsel=pooled_reftable_pods[-qneutral_qneutral,"POPPrStrongMSel"], 
                                       Infe_popstrongmsel = inv.logit(posterior_radnompods_logpopstrongmsel$expectation))

cl <- makeCluster(5)
registerDoParallel(cl)
#clusterEvalQ(cl)
  
## PARALLEL PROCESSING
#------------------------------------------
popstrongmsel_calc <- foreach(i=1:length(popstrongmsel_applic_data$sim),
                              .combine=rbind, 
                              .errorhandling="pass", .verbose = TRUE) %dopar% { library(ROCR)
                                                                                selstrongthreshold(x = popstrongmsel_applic_data[i,], tau = 10)}
stopCluster(cl)



## Fixed PODs 
#
# Low Selection PODs
#log_dnlselpods_popstrongmsel <- log10(dnlsel_pods_reftable[, "PrPOPStrongMSel"])
#
#posterior_dnlselpods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                 obs        = global_sumstats_dnlselpods,
#                                                 training   = data.frame(logpopstrongmsel, global_sumstats_logpopstrongmsel),
#                                                 quantiles  = c(0.025,0.5,0.975),
#                                                 paral      = T,
#                                                 ncores     = 28,
#                                                 rf.weights = T)
#(posterior_dnlselpods_logpopstrongmsel)
#
# High Selection PODs
#log_dnhselpods_popstrongmsel <- log10(dnhsel_pods_reftable[, "PrPOPStrongMSel"])
#
#posterior_dnhselpods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                 obs        = global_sumstats_dnhselpods,
#                                                 training   = data.frame(logpopstrongmsel, global_sumstats_logpopstrongmsel),
#                                                 quantiles  = c(0.025,0.5,0.975),
#                                                 paral      = T,
#                                                 ncores     = 28,
#                                                 rf.weights = T)
#(posterior_dnhselpods_logpopstrongmsel)
#
# Expected True vs estimated
#plot(x    = c(log_dnlselpods_popstrongmsel, log_dnhselpods_popstrongmsel), 
#     y    = c(posterior_dnlselpods_logpopstrongmsel$expectation, posterior_dnhselpods_logpopstrongmsel$expectation),
#     xlim = c(-6,1),
#     ylim = c(-6,1),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(log_dnlselpods_popstrongmsel, log_dnhselpods_popstrongmsel), 
#     y    = c(posterior_dnlselpods_logpopstrongmsel$med, posterior_dnhselpods_logpopstrongmsel$med),
#     xlim = c(-6,1),
#    ylim = c(-6,1),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Median Fixed PODs",
#     col  = c(rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Boxplot
#
## boxplot
#pred_logpopstrongmsel <- data.frame(model  = c(rep("Low_selection", 300), rep("High_selection", 300)), 
#                                    type   = c(rep("True",100), rep("Expected",100), rep("Median",100),
#                                              rep("True",100), rep("Expected",100), rep("Median",100)),
#                                    values = c(log_dnlselpods_popstrongmsel, posterior_dnlselpods_logpopstrongmsel$expectation, posterior_dnlselpods_logpopstrongmsel$med,
#                                               log_dnhselpods_popstrongmsel, posterior_dnhselpods_logpopstrongmsel$expectation, posterior_dnhselpods_logpopstrongmsel$med))
#
#boxplot(pred_logpopstrongmsel$values ~ pred_logpopstrongmsel$type * pred_logpopstrongmsel$model,
#        lwd = 2,
#        ylim = c(-4,0),
#        ylab = expression(log[10]*("Pr Strongly selected mutations")),
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3)))
#legend("topright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:6, labels = FALSE)
#text(x = 1:6, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#     srt=90, 
#     adj=1, 
#     xpd=TRUE, 
#     labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r prediction fdrFST, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
radnompods_fstfdrNs05 <- pooled_reftable_pods[, "FSTfdrNS05"]

posterior_radnompods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
                                           obs        = global_sumstats_pods,
                                           training   = data.frame(fstfdrNs05, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 28,
                                           rf.weights = T)
#(posterior_radnompods_fstfdrNs05)

#save(posterior_radnompods_fstfdrNs05, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))

# Expected True vs estimated
plot(x    = radnompods_fstfdrNs05, 
     y    = posterior_radnompods_fstfdrNs05$expectation,
     xlim = c(0,1),
     ylim = c(0,1),
     xlab = expression(eta[3]), 
     ylab = expression(tilde(eta[3])),
     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

# Median True vs estimated
plot(x    = radnompods_fstfdrNs05, 
     y    = posterior_radnompods_fstfdrNs05$med,
     xlim = c(0,1),
     ylim = c(0,1),
     xlab = expression(eta[3]), 
     ylab = expression(tilde(eta[3])),
     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

# Apply the threshold
fstfdrNs05_applic_data = data.frame(sim=pooled_reftable_pods[,"sim"], meanNe2=pooled_reftable_pods[,"meanNe2"], 
                                    True_fdr05=pooled_reftable_pods[,"FSTfdrNS05"], Infe_fdr05 = posterior_radnompods_fstfdrNs05$expectation)

fstfdrNs05_applic_data <- fstfdrNs05_applic_data[1:6,]

#fstfdrNs05_calc = NULL
#for (i in 1:length(fstfdrNs05_applic_data$sim)){
#  t <- fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)
#  fstfdrNs05_calc = rbind(fstfdrNs05_calc, t)
#}

cl <- makeCluster(18)
registerDoParallel(cl)
#clusterEvalQ(cl)
  
## PARALLEL PROCESSING
#------------------------------------------
fstfdrNs05_calc <- foreach(i=1:length(fstfdrNs05_applic_data$sim),.combine=rbind, 
                                                                  .errorhandling="pass", .verbose = TRUE) %dopar% {
                                                                                                                   fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)}
stopCluster(cl)

## Fixed PODs 
#
# Neutral PODs
#neutralpods_fstfdrNs05 <- neutral_pods_reftable[, "FSTfdrNS05"]
#
#posterior_neutralpods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
#                                            obs        = global_sumstats_neutralpods,
#                                            training   = data.frame(fstfdrNs05, global_sumstats),
#                                            quantiles  = c(0.025,0.5,0.975),
#                                            paral      = T,
#                                            ncores     = 28,
#                                            rf.weights = T)
#(posterior_neutralpods_fstfdrNs05)
#
# Low Selection PODs
#dnlselpods_fstfdrNs05 <- dnlsel_pods_reftable[, "FSTfdrNS05"]
#
#posterior_dnlselpods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
#                                           obs        = global_sumstats_dnlselpods,
#                                           training   = data.frame(fstfdrNs05, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 28,
#                                           rf.weights = T)
#(posterior_dnlselpods_fstfdrNs05)
#
# High Selection PODs
#dnhselpods_fstfdrNs05 <- dnhsel_pods_reftable[, "FSTfdrNS05"]
#
#posterior_dnhselpods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
#                                           obs        = global_sumstats_dnhselpods,
#                                           training   = data.frame(fstfdrNs05, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 28,
#                                           rf.weights = T)
#(posterior_dnhselpods_fstfdrNs05)
#
# Expected True vs estimated
#plot(x    = c(neutralpods_fstfdrNs05,dnlselpods_fstfdrNs05, dnhselpods_fstfdrNs05), 
#     y    = c(posterior_neutralpods_fstfdrNs05$expectation, posterior_dnlselpods_fstfdrNs05$expectation, posterior_dnhselpods_fstfdrNs05$expectation),
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(neutralpods_fstfdrNs05,dnlselpods_fstfdrNs05, dnhselpods_fstfdrNs05), 
#     y    = c(posterior_neutralpods_fstfdrNs05$med, posterior_dnlselpods_fstfdrNs05$med, posterior_dnhselpods_fstfdrNs05$med),
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Median Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch  = 1,
#     cex.axis = 1.2,
#    cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
## boxplot
#pred_fstfdrNs05 <- data.frame(model  = c(rep("Neutral", 300), rep("Low_selection", 300), rep("High_selection", 300)), 
#                              type   = c(rep("True",100), rep("Expected",100), rep("Median",100), 
#                                         rep("True",100), rep("Expected",100), rep("Median",100),
#                                        rep("True",100), rep("Expected",100), rep("Median",100)),
#                              values = c(neutralpods_fstfdrNs05, posterior_neutralpods_fstfdrNs05$expectation, posterior_neutralpods_fstfdrNs05$med,
#                                         dnlselpods_fstfdrNs05, posterior_dnlselpods_fstfdrNs05$expectation, posterior_dnlselpods_fstfdrNs05$med,
#                                         dnhselpods_fstfdrNs05, posterior_dnhselpods_fstfdrNs05$expectation, posterior_dnhselpods_fstfdrNs05$med))
#
#boxplot(pred_fstfdrNs05$values ~ pred_fstfdrNs05$type * pred_fstfdrNs05$model,
#        lwd = 2,
#        ylim = c(0,1),
#        ylab = "FDR 5% of the FST hypothesis of Ns>1",
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3),rep("#969696",3)))
#legend("topright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:9, labels = FALSE)
#ext(x = 1:9, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#    srt=90, 
#    adj=1, 
#    xpd=TRUE, 
#    labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
```

### ABC-RF Regression for Demography: Prediction

#### Effective Population Size of Phase 2 - Sampling Phase
```{r prediction MeanNe2, echo=TRUE, eval=FALSE, include=TRUE}
## Random PODs
log_radnompods_meanNe2 <- log10(pooled_reftable_pods[, "meanNe2"])


posterior_radnompods_logmeanNe2 <- predict(object     = reg_logmeanNe2,
                                           obs        = global_sumstats_pods,
                                           training   = data.frame(logmeanNe2, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 2,
                                           rf.weights = T)
#(posterior_radnompods_logmeanNe2)

#save(posterior_radnompods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))

# Expected True vs estimated
plot(x    = log_radnompods_meanNe2, 
     y    = posterior_radnompods_logmeanNe2$expectation,
     xlim = c(-2,4),
     ylim = c(-2,4),
     xlab = expression(italic(N[e])), 
     ylab = expression(tilde(italic(N[e]))),
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# coloring wiht the Proportion of Strongly Selected Mutations 
meanNe2_table <- data.frame(est=posterior_radnompods_logmeanNe2$expectation,
                            obs=log_radnompods_meanNe2, 
                            prstrong=log_radnompods_popstrongmsel,
                            logthetas=log_radnompods_thetaS)

ggplot(meanNe2_table, aes(x=obs , y=est, color=prstrong)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "black", high = "red")+
  xlab(expression(italic(N[e]))) +
  ylab(expression(tilde(italic(N[e]))))+
  xlim(-2, 6) +
  ylim(-2, 6) +
  geom_abline(intercept = 0, slope = 1, color = "blue")

ggplot(meanNe2_table, aes(x=obs , y=est, color=logthetas)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "blue", high = "red")+
  xlab(expression(italic(N[e]))) +
  ylab(expression(tilde(italic(N[e]))))+
  xlim(-2, 6) +
  ylim(-2, 6) +
  geom_abline(intercept = 0, slope = 1, color = "black")

# Median True vs estimated
plot(x    = log_radnompods_meanNe2, 
     y    = posterior_radnompods_logmeanNe2$med,
     xlim = c(-2,4),
     ylim = c(-2,4),
     xlab = expression(italic(N[e])), 
     ylab = expression(tilde(italic(N[e]))),
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# comparison with WFABC Ne estimates
wfabc_raw_ne2 <- read.table(file="/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods/results/wfabc_1_output_pods_mod.txt",header=TRUE)

wfabc_ne2 <- wfabc_raw_ne2[complete.cases(wfabc_raw_ne2), ]
wfabc_ne2 <- wfabc_ne2[wfabc_ne2$sim %in% pooled_reftable_pods$sim, ]

wfabc_ne2 <- merge(pooled_reftable_pods[,c("sim","meanNe2")], wfabc_ne2, by.x = 1, by.y = 1, all = TRUE)

wfabc_ne2$wfabc_ne <- wfabc_ne2$wfabc_ne/2

# RMSE
sqrt(mean((wfabc_ne2$wfabc_ne-wfabc_ne2$meanNe2)^2))

# SSE
sum((wfabc_ne2$wfabc_ne-wfabc_ne2$meanNe2)^2) 


plot(x    = log10(wfabc_ne2[, "meanNe2"]), 
     y    = log10(wfabc_ne2[, "wfabc_ne"]),
     xlim = c(-2,6),
     ylim = c(-2,6),
     xlab = expression(italic(N[e])), 
     ylab = expression(tilde(italic(wfabc_N[e]))),
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

wfabc_meanNe2_table <- data.frame(obs=log10(wfabc_ne2[, "meanNe2"]),
                                  est=log10(wfabc_ne2[, "wfabc_ne"]), 
                                  prstrong=log_radnompods_popstrongmsel,
                                  logthetas=log_radnompods_thetaS)

ggplot(wfabc_meanNe2_table, aes(x=obs , y=est, color=prstrong)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "black", high = "red")+
  xlab(expression(italic(N[e]))) +
  ylab(expression(hat(italic(wfabc_N[e]))))+
  xlim(-2, 6) +
  ylim(-2, 6) +
  geom_abline(intercept = 0, slope = 1, color = "blue")

ggplot(wfabc_meanNe2_table, aes(x=obs , y=est, color=logthetas)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "blue", high = "red")+
  xlab(expression(italic(N[e]))) +
  ylab(expression(hat(italic(wfabc_N[e]))))+
  xlim(-2, 6) +
  ylim(-2, 6) +
  geom_abline(intercept = 0, slope = 1, color = "black")


plot(x    = log_radnompods_averageGenLoad, 
     y    = ((wfabc_ne2$wfabc_ne-wfabc_ne2$meanNe2)/wfabc_ne2$meanNe2)^2,
     #xlim = c(-2,6),
     #ylim = c(-2,6),
     #xlab = expression(italic(N[e])), 
     #ylab = expression(tilde(italic(wfabc_N[e]))),,
     #pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
#abline(a=0, b=1, col = "#cb181d")


## Fixed PODs 
#
# Neutral PODs
#log_neutralpods_pedigreeNetotal <- log10(neutral_pods_reftable[, "PedigreeNetotal"])
#
#posterior_neutralpods_logpedigreeNetotal <- predict(object     = reg_logpedigreeNetotal,
#                                                    obs        = global_sumstats_neutralpods,
#                                                    training   = data.frame(logpedigreeNetotal, global_sumstats),
#                                                    quantiles  = c(0.025,0.5,0.975),
#                                                    paral      = T,
#                                                    ncores     = 28,
#                                                    rf.weights = T)
#(posterior_neutralpods_logpedigreeNetotal)
#
# Low Selection PODs
#log_dnlselpods_pedigreeNetotal <- log10(dnlsel_pods_reftable[, "PedigreeNetotal"])
#
#posterior_dnlselpods_logpedigreeNetotal <- predict(object     = reg_logpedigreeNetotal,
#                                                   obs        = global_sumstats_dnlselpods,
#                                                   training   = data.frame(logpedigreeNetotal, global_sumstats),
#                                                   quantiles  = c(0.025,0.5,0.975),
#                                                   paral      = T,
#                                                   ncores     = 28,
#                                                   rf.weights = T)
#(posterior_dnlselpods_logpedigreeNetotal)
#
# High Selection PODs
#log_dnhselpods_pedigreeNetotal <- log10(dnhsel_pods_reftable[, "PedigreeNetotal"])
#
#posterior_dnhselpods_logpedigreeNetotal <- predict(object     = reg_logpedigreeNetotal,
#                                                   obs        = global_sumstats_dnhselpods,
#                                                   training   = data.frame(logpedigreeNetotal, global_sumstats),
#                                                   quantiles  = c(0.025,0.5,0.975),
#                                                   paral      = T,
#                                                   ncores     = 28,
#                                                   rf.weights = T)
#(posterior_dnhselpods_logpedigreeNetotal)
#
# Expected True vs estimated
#plot(x    = c(log_neutralpods_pedigreeNetotal,log_dnlselpods_pedigreeNetotal, log_dnhselpods_pedigreeNetotal), 
#     y    = c(posterior_neutralpods_logpedigreeNetotal$expectation, posterior_dnlselpods_logpedigreeNetotal$expectation, posterior_dnhselpods_logpedigreeNetotal$expectation),
#     xlim = c(1,3),
#     ylim = c(1,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(log_neutralpods_pedigreeNetotal,log_dnlselpods_pedigreeNetotal, log_dnhselpods_pedigreeNetotal), 
#     y    = c(posterior_neutralpods_logpedigreeNetotal$med, posterior_dnlselpods_logpedigreeNetotal$med, posterior_dnhselpods_logpedigreeNetotal$med),
#     xlim = c(1,3),
#     ylim = c(1,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Median Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch  = 1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
## boxplot
#pred_logpedigreeNetotal <- data.frame(model  = c(rep("Neutral", 300), rep("Low_selection", 300), rep("High_selection", 300)), 
#                                  type   = c(rep("True",100), rep("Expected",100), rep("Median",100), 
#                                             rep("True",100), rep("Expected",100), rep("Median",100),
#                                             rep("True",100), rep("Expected",100), rep("Median",100)),
#                                  values = c(log_neutralpods_pedigreeNetotal, posterior_neutralpods_logpedigreeNetotal$expectation, posterior_neutralpods_logpedigreeNetotal$med,
#                                             log_dnlselpods_pedigreeNetotal, posterior_dnlselpods_logpedigreeNetotal$expectation, posterior_dnlselpods_logpedigreeNetotal$med,
#                                             log_dnhselpods_pedigreeNetotal, posterior_dnhselpods_logpedigreeNetotal$expectation, posterior_dnhselpods_logpedigreeNetotal$med))
#
#boxplot(pred_logpedigreeNetotal$values ~ pred_logpedigreeNetotal$type * pred_logpedigreeNetotal$model,
#        lwd = 2,
#        ylim = c(1,3),
#        ylab = expression(log[10]*("N"[e])),
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3),rep("#969696",3)))
#abline(h=log10(500), col = "green", lty = 3)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:9, labels = FALSE)
#text(x = 1:9, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#     srt=90, 
#     adj=1, 
#     xpd=TRUE, 
#     labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
```

#### Population Census Size for the Sampling Phase - Ncs
```{r predition Ncs, echo=TRUE, eval=FALSE, include=TRUE}

# RANDOM PODS
log_radnompods_ncs <- log10(pooled_reftable_pods[, "Ncs"])

posterior_radnompods_logncs <- predict(object     = reg_logncs,
                                       obs        = global_sumstats_pods,
                                       training   = data.frame(logncs, global_sumstats),
                                       quantiles  = c(0.025,0.5,0.975),
                                       paral      = T,
                                       ncores     = 28,
                                       rf.weights = T)
#(posterior_radnompods_logncs)

#save(posterior_radnompods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))

# Expected True vs estimated
plot(x    = log_radnompods_ncs, 
     y    = posterior_radnompods_logncs$expectation,
     xlim = c(0,4),
     ylim = c(0,4),
     xlab = expression(italic(N[cs])), 
     ylab = expression(hat(italic(N[cs]))),
     main = "Expected",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# coloring wiht the Proportion of Strongly Selected Mutations 
ncs_table <- data.frame(est=posterior_radnompods_logncs$expectation,
                        obs=log_radnompods_ncs, 
                        prstrong=log_radnompods_popstrongmsel,
                        logthetas=log_radnompods_thetaS)

ggplot(ncs_table, aes(x=obs , y=est, color=prstrong)) + 
  geom_point(size=3, shape=1) + 
  scale_color_gradient(low = "black", high = "red")+
  xlab(expression(italic(N[cs]))) +
  ylab(expression(tilde(italic(N[cs]))))+
  xlim(0, 4) +
  ylim(0, 4) +
  geom_abline(intercept = 0, slope = 1, color = "blue")

# Median True vs estimated
plot(x    = log_radnompods_ncs, 
     y    = posterior_radnompods_logncs$med,
     xlim = c(0,4),
     ylim = c(0,4),
     xlab = expression(italic(N[cs])), 
     ylab = expression(hat(italic(N[cs]))),
     main = "Expected",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## Fixed PODs 
#
# Neutral PODs
#log_neutralpods_n <- log10(neutral_pods_reftable[, "N"])
#
#posterior_neutralpods_logn <- predict(object     = reg_logn,
#                                      obs        = global_sumstats_neutralpods,
#                                      training   = data.frame(logn, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#(posterior_neutralpods_logn)
#
# Low Selection PODs
#log_dnlselpods_n <- log10(dnlsel_pods_reftable[, "N"])
#
#posterior_dnlselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnlselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnlselpods_logn)
#
# High Selection PODs
#log_dnhselpods_n <- log10(dnhsel_pods_reftable[, "N"])
#
#posterior_dnhselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnhselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnhselpods_logpn)
#
# Expected True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$expectation, posterior_dnlselpods_logn$expectation, posterior_dnhselpods_logn$expectation),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$med, posterior_dnlselpods_logn$med, posterior_dnhselpods_logn$med),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#    main = "Median Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch  = 1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
## boxplot
#pred_logn <- data.frame(model  = c(rep("Neutral", 300), rep("Low_selection", 300), rep("High_selection", 300)), 
#                                  type   = c(rep("True",100), rep("Expected",100), rep("Median",100), 
#                                             rep("True",100), rep("Expected",100), rep("Median",100),
#                                             rep("True",100), rep("Expected",100), rep("Median",100)),
#                                  values = c(log_neutralpods_n, posterior_neutralpods_logn$expectation, posterior_neutralpods_logn$med,
#                                             log_dnlselpods_n, posterior_dnlselpods_logn$expectation, posterior_dnlselpods_logn$med,
#                                             log_dnhselpods_n, posterior_dnhselpods_logn$expectation, posterior_dnhselpods_logn$med))
#
#boxplot(pred_logn$values ~ pred_logn$type * pred_logn$model,
#        lwd = 2,
#        ylim = c(1,3),
#        ylab = expression(log[10]*("N"[c])),
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3),rep("#969696",3)))
#abline(h=log10(500), col = "green", lty = 3)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:9, labels = FALSE)
#text(x = 1:9, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#     srt=90, 
#     adj=1, 
#     xpd=TRUE, 
#     labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
#
#
```

#### Ratio Effective Size / Census Size for the Sampling Phase - MeanNe2/Ncs
```{r predition MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

log_randompods_meanNe2ncs <- log10(pooled_reftable_model_1[random_pods, "meanNe2"]/pooled_reftable_model_1[random_pods, "Ncs"])

posterior_radnompods_logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
                                              obs        = global_sumstats_randompods,
                                              training   = data.frame(logmeanNe2ncs, global_sumstats),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 28,
                                              rf.weights = T)
#(posterior_radnompods_logncs)

# Expected True vs estimated
plot(x    = log_randompods_meanNe2ncs, 
     y    = posterior_radnompods_logmeanNe2ncs$expectation,
     xlim = c(-5,1),
     ylim = c(-5,1),
     xlab = expression(psi[5]), 
     ylab = expression(tilde(psi[5])),
     main = "Expected",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# Median True vs estimated
plot(x = log_randompods_meanNe2ncs, 
     y = posterior_radnompods_logmeanNe2ncs$expectation,
     xlim = c(-5,1),
     ylim = c(-5,1),
     xlab = expression(psi[5]), 
     ylab = expression(tilde(psi[5])),
     main = "Median",
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## Fixed PODs 
#
# Neutral PODs
#log_neutralpods_n <- log10(neutral_pods_reftable[, "N"])
#
#posterior_neutralpods_logn <- predict(object     = reg_logn,
#                                      obs        = global_sumstats_neutralpods,
#                                      training   = data.frame(logn, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#(posterior_neutralpods_logn)
#
# Low Selection PODs
#log_dnlselpods_n <- log10(dnlsel_pods_reftable[, "N"])
#
#posterior_dnlselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnlselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnlselpods_logn)
#
# High Selection PODs
#log_dnhselpods_n <- log10(dnhsel_pods_reftable[, "N"])
#
#posterior_dnhselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnhselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnhselpods_logpn)
#
# Expected True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$expectation, posterior_dnlselpods_logn$expectation, posterior_dnhselpods_logn$expectation),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$med, posterior_dnlselpods_logn$med, posterior_dnhselpods_logn$med),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#    main = "Median Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch  = 1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
## boxplot
#pred_logn <- data.frame(model  = c(rep("Neutral", 300), rep("Low_selection", 300), rep("High_selection", 300)), 
#                                  type   = c(rep("True",100), rep("Expected",100), rep("Median",100), 
#                                             rep("True",100), rep("Expected",100), rep("Median",100),
#                                             rep("True",100), rep("Expected",100), rep("Median",100)),
#                                  values = c(log_neutralpods_n, posterior_neutralpods_logn$expectation, posterior_neutralpods_logn$med,
#                                             log_dnlselpods_n, posterior_dnlselpods_logn$expectation, posterior_dnlselpods_logn$med,
#                                             log_dnhselpods_n, posterior_dnhselpods_logn$expectation, posterior_dnhselpods_logn$med))
#
#boxplot(pred_logn$values ~ pred_logn$type * pred_logn$model,
#        lwd = 2,
#        ylim = c(1,3),
#        ylab = expression(log[10]*("N"[c])),
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3),rep("#969696",3)))
#abline(h=log10(500), col = "green", lty = 3)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:9, labels = FALSE)
#text(x = 1:9, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#     srt=90, 
#     adj=1, 
#     xpd=TRUE, 
#     labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
#
#
```

#### Per site mutation rate mu
```{r site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}
log_radnompods_mu <- log10(pooled_reftable_model_1[random_pods, "mu"])

posterior_radnompods_logmu <- predict( object     = reg_logmu,
                                       obs        = global_sumstats_randompods,
                                       training   = data.frame(logmu, global_sumstats),
                                       quantiles  = c(0.025,0.5,0.975),
                                       paral      = T,
                                       ncores     = 28,
                                       rf.weights = T)
#(posterior_radnompods_logncs)

# Expected True vs estimated
plot(x    = log_radnompods_mu, 
     y    = posterior_radnompods_logmu$expectation,
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     xlab = expression(psi[4]), 
     ylab = expression(tilde(psi[4])),
     main = "Expected",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# Median True vs estimated
plot(x = log_radnompods_mu, 
     y = posterior_radnompods_logmu$med,
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     xlab = expression(psi[4]), 
     ylab = expression(tilde(psi[4])),
     main = "Median",
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## Fixed PODs 
#
# Neutral PODs
#log_neutralpods_n <- log10(neutral_pods_reftable[, "N"])
#
#posterior_neutralpods_logn <- predict(object     = reg_logn,
#                                      obs        = global_sumstats_neutralpods,
#                                      training   = data.frame(logn, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#(posterior_neutralpods_logn)
#
# Low Selection PODs
#log_dnlselpods_n <- log10(dnlsel_pods_reftable[, "N"])
#
#posterior_dnlselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnlselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnlselpods_logn)
#
# High Selection PODs
#log_dnhselpods_n <- log10(dnhsel_pods_reftable[, "N"])
#
#posterior_dnhselpods_logn <- predict(object     = reg_logn,
#                                     obs        = global_sumstats_dnhselpods,
#                                     training   = data.frame(logn, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#(posterior_dnhselpods_logpn)
#
# Expected True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$expectation, posterior_dnlselpods_logn$expectation, posterior_dnhselpods_logn$expectation),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#     main = "Expected Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch=1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = c(log_neutralpods_n,log_dnlselpods_n, log_dnhselpods_n), 
#     y    = c(posterior_neutralpods_logn$med, posterior_dnlselpods_logn$med, posterior_dnhselpods_logn$med),
#     xlim = c(0,3),
#     ylim = c(0,3),
#     xlab = "True values", 
#     ylab = "Estimated values",
#    main = "Median Fixed PODs",
#     col  = c(rep("#969696",100), rep("#08519c",100), rep("#a50f15",100)),
#     pch  = 1,
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
#abline(a=0, b=1, col = "#cb181d")
#
## boxplot
#pred_logn <- data.frame(model  = c(rep("Neutral", 300), rep("Low_selection", 300), rep("High_selection", 300)), 
#                                  type   = c(rep("True",100), rep("Expected",100), rep("Median",100), 
#                                             rep("True",100), rep("Expected",100), rep("Median",100),
#                                             rep("True",100), rep("Expected",100), rep("Median",100)),
#                                  values = c(log_neutralpods_n, posterior_neutralpods_logn$expectation, posterior_neutralpods_logn$med,
#                                             log_dnlselpods_n, posterior_dnlselpods_logn$expectation, posterior_dnlselpods_logn$med,
#                                             log_dnhselpods_n, posterior_dnhselpods_logn$expectation, posterior_dnhselpods_logn$med))
#
#boxplot(pred_logn$values ~ pred_logn$type * pred_logn$model,
#        lwd = 2,
#        ylim = c(1,3),
#        ylab = expression(log[10]*("N"[c])),
#        xlab = "",
#        xaxt = "n",
#        cex.axis = 1.2,
#        cex.lab  = 1.2,
#        col = c(rep("#a50f15",3),rep("#08519c",3),rep("#969696",3)))
#abline(h=log10(500), col = "green", lty = 3)
#legend("bottomright", legend = c("Neutral", "1.0% Selection", "2.5% Selection"), col = c("#969696", "#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
#axis(side = 1, at = 1:9, labels = FALSE)
#text(x = 1:9, 
#     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
#     srt=90, 
#     adj=1, 
#     xpd=TRUE, 
#     labels = paste(rep(c("Expected", "Median", "True"),3)),
#     cex = 1.2)
#
#
```

#### Combined plot
```{r combined prediction plots, echo=TRUE, eval=FALSE, include=TRUE}

# selection: average genetic load and Pr mutations with Ns >1
# demography: mean Ne2 and Ncs

par(mfrow=c(3,3))
plot(x    = log_radnompods_averageGenLoad, 
     y    = posterior_radnompods_averageGenLoad$expectation,
     xlim = c(0,3),
     ylim = c(0,3),
     xlab = expression(eta[1]), 
     ylab = expression(tilde(eta[1])),
     main = expression(-log[10](1 - italic(bar(L)))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_radnompods_popstrongmsel, 
     y    = posterior_radnompods_logpopstrongmsel$expectation,
     xlim = c(-7,0),
     ylim = c(-7,0),
     xlab = expression(eta[2]), 
     ylab = expression(tilde(eta[2])),
     main = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = radnompods_fstfdrNs05, 
     y    = posterior_radnompods_fstfdrNs05$expectation,
     xlim = c(0,1),
     ylim = c(0,1),
     xlab = expression(eta[3]), 
     ylab = expression(tilde(eta[3])),
     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_radnompods_thetaS, 
     y    = posterior_radnompods_logthetaS$expectation,
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(psi[1]), 
     ylab = expression(tilde(psi[1])),
     main = expression(log10(italic(theta[s]))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_radnompods_meanNe2, 
     y    = posterior_radnompods_logmeanNe2$expectation,
     xlim = c(-2,4),
     ylim = c(-2,4),
     xlab = expression(eta[4]), 
     ylab = expression(tilde(eta[4])),
     main = expression(log[10](italic(bar(N[e])))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_radnompods_ncs, 
     y    = posterior_radnompods_logncs$expectation,
     xlim = c(0,4),
     ylim = c(0,4),
     xlab = expression(X[1]), 
     ylab = expression(tilde(X[1])),
     main = expression(log[10](italic(N[cs]))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_randompods_meanNe2ncs, 
     y    = posterior_radnompods_logmeanNe2ncs$expectation,
     xlim = c(-5,1),
     ylim = c(-5,1),
     xlab = expression(psi[2]), 
     ylab = expression(tilde(psi[2])),
     main = expression(log[10](italic(bar(N[e]))/italic(N[cs]))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")

plot(x    = log_radnompods_mu, 
     y    = posterior_radnompods_logmu$expectation,
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     xlab = expression(X[2]), 
     ylab = expression(tilde(X[2])),
     main = expression(log[10](italic(mu))),
     pch  = 1
     #,
     #cex.axis = 1.2,
     #cex.lab  = 1.5
     )
abline(a=0, b=1, col = "#cb181d")
```

##Things that has the potential to work - for the First version of the Manuscript

### ABC-RF Regression for Selection: Growing Trees

#### Proportion of selected regions
```{r regression selected regions, echo=TRUE, eval=FALSE, include=TRUE}

## proportion of selected regions
prRSel <- pooled_reftable_model_1$PrGWSel[-random_pods] * pooled_reftable_model_1$PrMSel[-random_pods]

# PrRsel = prior (PrGWSel * PrMSel)
#hist(prRSel, freq = TRUE, xlab = "proportion of selected regions", main = "", col = "#bdbdbd")

# correlation between the compound parameter PrRSel and the calculated PrPOPMSel
cor(prRSel, pooled_reftable_model_1$PrPOPMSel[-random_pods])

plot(prRSel, pooled_reftable_model_1$PrPOPMSel[-random_pods], 
     xlab = "proportion of selected regions",
     ylab = "PrPOPMSel")
abline(lm(pooled_reftable_model_1$PrPOPMSel[-random_pods] ~ prRSel), col="#cb181d")

# correlation between the compound parameter PrRSel and the calculated PrSAMMSel
cor(prRSel, pooled_reftable_model_1$PrSAMMSel[-random_pods])

plot(prRSel, pooled_reftable_model_1$PrSAMMSel[-random_pods], 
     xlab = "proportion of selected regions",
     ylab = "PrSAMMSel")
abline(lm(pooled_reftable_model_1$PrSAMMSel[-random_pods] ~ prRSel), col="#cb181d")

# correlation between the the calculated PrPOPMSel and PrSAMMSel
cor(pooled_reftable_model_1$PrPOPMSel[-random_pods], pooled_reftable_model_1$PrSAMMSel[-random_pods])

plot(pooled_reftable_model_1$PrPOPMSel[-random_pods], pooled_reftable_model_1$PrSAMMSel[-random_pods], 
     xlab = "PrPOPMSel",
     ylab = "PrSAMMSel")
abline(lm(pooled_reftable_model_1$PrSAMMSel[-random_pods] ~ pooled_reftable_model_1$PrPOPMSel[-random_pods]), col="#cb181d")

# abf-rf regression
reg_prRSel <- regAbcrf(formula = prRSel~.,
                       data    = data.frame(prRSel, global_sumstats),
                       ntree   = 1000,
                       paral   = T,
                       ncores  = 28)

save(reg_prRSel, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_prRSel",".RData"))

# variable Importance plot
plot(x = reg_prRSel, n.var = 20)

#head(sort(reg_prRSel$model.rf$variable.importance, decreasing = T), n=10)

# prediction error
reg_prRSel$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_prRSel,
#             training = data.frame(prRSel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = prRSel,
     y    = reg_prRSel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## log prRSel
logrsel <- log10(prRSel)

# PrRsel = log prior (PrGWSel * PrMSel)
#hist(logrsel, freq = TRUE, xlab = expression(log[10]("proportion of selected regions")), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logrsel <- regAbcrf(formula = logrsel~.,
                        data    = data.frame(logrsel, global_sumstats),
                        ntree   = 1000,
                        paral   = T,
                        ncores  = 28)

save(reg_logrsel, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_logrsel",".RData"))

# variable Importance plot
plot(x = reg_logrsel, n.var = 20)

#head(sort(reg_logrsel$model.rf$variable.importance, decreasing = T), n=10)

# prediction error
reg_logrsel$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_logrsel,
#             training = data.frame(logrsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logrsel,
     y    = reg_logrsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-5,0),
     ylim = c(-5,0),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## PrPOPMSel
prPOPMSel <- pooled_reftable_model_1[-random_pods, "PrPOPMSel"]

#hist(prPOPMSel, freq = TRUE, xlab = "PrPOPMSel", main = "", col = "#bdbdbd")

# abf-rf regression
reg_prPOPMSel <- regAbcrf(formula = prPOPMSel~.,
                          data    = data.frame(prPOPMSel, global_sumstats),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 28)

save(reg_prPOPMSel, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_prPOPMSel",".RData"))

# variable Importance plot
plot(x = reg_prPOPMSel, n.var = 20)

#head(sort(reg_prPOPMSel$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_prPOPMSel$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_prPOPMSel,
#             training = data.frame(prPOPMSel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = prPOPMSel,
     y    = reg_prPOPMSel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## log PrPOPMSel
logpopmsel <- log10(prPOPMSel) 

#hist(logpopmsel, freq = TRUE, xlab = expression(log[10]("PrPOPMSel")), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logpopmsel <- regAbcrf(formula = logpopmsel~.,
                           data    = data.frame(logpopmsel, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

save(reg_logpopmsel, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_logpopmsel",".RData"))

# variable Importance plot
plot(x = reg_logpopmsel, n.var = 20)

#head(sort(reg_logpopmsel$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logpopmsel$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_logpopmsel,
#             training = data.frame(logpopmsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logpopmsel,
     y    = reg_logpopmsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-5,0),
     ylim = c(-5,0),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

```

#### Ns
```{r regression Ns, echo=TRUE, eval=FALSE, include=TRUE}
logNs <- log10(pooled_reftable_model_1$PedigreeNetotal[-random_pods] * pooled_reftable_model_1[-random_pods, "gammaMean"])

#hist(logNs, freq = TRUE, xlab = expression(log[10](N[s])), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logNs <- regAbcrf(formula = logNs~.,
                      data    = data.frame(logNs, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 28)

save(reg_logNs, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_logNs",".RData"))

# variable Importance plot
plot(x = reg_logNs, n.var = 20)

#head(sort(reg_logNs$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNs$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_logNs,
#             training = data.frame(logNs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logNs,
     y    = reg_logNs$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-3,3),
     ylim = c(-3,3),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")
```

### ABC-RF Regression for Demography: Growing Trees

#### Per site recombination rate
```{r regression site recombination rate, echo=TRUE, eval=FALSE, include=TRUE}

logrr <- log10(pooled_reftable_model_1$rr[-random_pods])

#hist(logrr, freq = TRUE, xlab = expression(log[10](r)), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logrr <- regAbcrf(formula = logrr~.,
                      data    = data.frame(logrr, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 28)

save(reg_logrr, file = paste0("/home/pavinato/My_repositories/Tracking-selection/src/analysis/RF_analysis_files/reg_logrr",".RData"))

# variable Importance plot
plot(x = reg_logrr, n.var = 20)

#head(sort(reg_logmu$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logrr$model.rf$prediction.error

# error rate plot
#err.regAbcrf(object   = reg_logrr,
#             training = data.frame(logrr, global_sumstats),
#             paral    = T,
#             ncores   = 28)

plot(x    = logrr,
     y    = reg_logrr$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-7,-4),
     ylim = c(-7,-4),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

```

#### Proportion of selected mutations
```{r prediction selected mutations, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
log_radnompods_popmsel <- log10(pooled_reftable_model_1[random_pods, "PrPOPMSel"])

posterior_radnompods_logpopmsel <- predict(object     = reg_logpopmsel,
                                           obs        = global_sumstats_randompods,
                                           training   = data.frame(logpopmsel, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 28,
                                           rf.weights = T)
(posterior_radnompods_logpopmsel)

# Expected True vs estimated
plot(x    = log_radnompods_popmsel, 
     y    = posterior_radnompods_logpopmsel$expectation,
     xlim = c(-5,0),
     ylim = c(-5,0),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Expected Random PODs",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# Median True vs estimated
plot(x = log_radnompods_popmsel, 
     y = posterior_radnompods_logpopmsel$med,
     xlim = c(-5,0),
     ylim = c(-5,0),
     xlab="True values", 
     ylab="Estimated values",
     main="Median Random PODs",
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

## Fixed PODs 

# Low Selection PODs
log_dnlselpods_popmsel <- log10(dnlsel_pods_reftable[, "PrPOPMSel"])

posterior_dnlselpods_logpopmsel <- predict(object     = reg_logpopmsel,
                                           obs        = global_sumstats_dnlselpods,
                                           training   = data.frame(logpopmsel, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 28,
                                           rf.weights = T)
(posterior_dnlselpods_logpopmsel)

# High Selection PODs
log_dnhselpods_popmsel <- log10(dnhsel_pods_reftable[, "PrPOPMSel"])

posterior_dnhselpods_logpopmsel <- predict(object     = reg_logpopmsel,
                                           obs        = global_sumstats_dnhselpods,
                                           training   = data.frame(logpopmsel, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 28,
                                           rf.weights = T)
(posterior_dnhselpods_logpopmsel)

# Expected True vs estimated
plot(x    = c(log_dnlselpods_popmsel, log_dnhselpods_popmsel), 
     y    = c(posterior_dnlselpods_logpopmsel$expectation, posterior_dnhselpods_logpopmsel$expectation),
     xlim = c(-5,0),
     ylim = c(-5,0),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Expected Fixed PODs",
     col  = c(rep("#08519c",100), rep("#a50f15",100)),
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
abline(a=0, b=1, col = "#cb181d")


# Median True vs estimated
plot(x    = c(log_dnlselpods_popmsel, log_dnhselpods_popmsel), 
     y    = c(posterior_dnlselpods_logpopmsel$med, posterior_dnhselpods_logpopmsel$med),
     xlim = c(-5,0),
     ylim = c(-5,0),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Median Fixed PODs",
     col  = c(rep("#08519c",100), rep("#a50f15",100)),
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
abline(a=0, b=1, col = "#cb181d")

## boxplot
pred_logpopmsel <- data.frame(model  = c(rep("Low_selection", 300), rep("High_selection", 300)), 
                              type   = c(rep("True",100), rep("Expected",100), rep("Median",100),
                                         rep("True",100), rep("Expected",100), rep("Median",100)),
                              values = c(log_dnlselpods_popmsel, posterior_dnlselpods_logpopmsel$expectation, posterior_dnlselpods_logpopmsel$med,
                                         log_dnhselpods_popmsel, posterior_dnhselpods_logpopmsel$expectation, posterior_dnhselpods_logpopmsel$med))

boxplot(pred_logpopmsel$values ~ pred_logpopmsel$type * pred_logpopmsel$model,
        lwd = 2,
        ylab = expression(-log[10]*("Pr Selected mutations")),
        xlab = "",
        xaxt = "n",
        cex.axis = 1.2,
        cex.lab  = 1.2,
        col = c(rep("#a50f15",3),rep("#08519c",3)))
legend("topright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
axis(side = 1, at = 1:6, labels = FALSE)
text(x = 1:6, 
     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
     srt=90, 
     adj=1, 
     xpd=TRUE, 
     labels = paste(rep(c("Expected", "Median", "True"),3)),
     cex = 1.2)
```

#### Ns
```{r prediction Ns, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
log_radnompods_Ns <- log10(pooled_reftable_model_1$PedigreeNetotal[random_pods] * pooled_reftable_model_1$gammaMean[random_pods])


posterior_radnompods_logNs <- predict(object     = reg_logNs,
                                      obs        = global_sumstats_randompods,
                                      training   = data.frame(logNs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 28,
                                      rf.weights = T)

(posterior_radnompods_logNs)

# Expected True vs estimated
plot(x    = log_radnompods_Ns, 
     y    = posterior_radnompods_logNs$expectation,
     xlim = c(-3,3),
     ylim = c(-3,3),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Expected Random PODs",
     pch  = 1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")

# Median True vs estimated
plot(x = log_radnompods_Ns, 
     y = posterior_radnompods_logNs$med,
     xlim = c(-3,3),
     ylim = c(-3,3),
     xlab="True values", 
     ylab="Estimated values",
     main="Median Random PODs",
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "#cb181d")


## Fixed PODs 

# Low Selection PODs
log_dnlselpods_Ns <- log10(dnlsel_pods_reftable$PedigreeNetotal * dnlsel_pods_reftable$gammaMean)

posterior_dnlselpods_logNs <- predict(object     = reg_logNs,
                                      obs        = global_sumstats_dnlselpods,
                                      training   = data.frame(logNs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 28,
                                      rf.weights = T)
(posterior_dnlselpods_logNs)

# High Selection PODs
log_dnhselpods_Ns <- log10(dnhsel_pods_reftable$PedigreeNetotal * dnhsel_pods_reftable$gammaMean)

posterior_dnhselpods_logNs <- predict(object     = reg_logNs,
                                      obs        = global_sumstats_dnhselpods,
                                      training   = data.frame(logNs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 28,
                                      rf.weights = T)

(posterior_dnhselpods_logNs)

# Expected True vs estimated
plot(x    = c(log_dnlselpods_Ns, log_dnhselpods_Ns), 
     y    = c(posterior_dnlselpods_logNs$expectation, posterior_dnhselpods_logNs$expectation),
     xlim = c(-3,3),
     ylim = c(-3,3),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Expected Fixed PODs",
     col  = c(rep("#08519c",100), rep("#a50f15",100)),
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
abline(a=0, b=1, col = "#cb181d")


# Median True vs estimated
plot(x    = c(log_dnlselpods_Ns, log_dnhselpods_Ns), 
     y    = c(posterior_dnlselpods_logNs$med, posterior_dnhselpods_logNs$med),
     xlim = c(-3,3),
     ylim = c(-3,3),
     xlab = "True values", 
     ylab = "Estimated values",
     main = "Median Fixed PODs",
     col  = c(rep("#08519c",100), rep("#a50f15",100)),
     pch=1,
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 1, bty = "n", cex = 1.2)
abline(a=0, b=1, col = "#cb181d")

## boxplot
pred_logNs <- data.frame(model  = c(rep("Low_selection", 300), rep("High_selection", 300)), 
                         type   = c(rep("True",100), rep("Expected",100), rep("Median",100),
                                    rep("True",100), rep("Expected",100), rep("Median",100)),
                                    values = c(log_dnlselpods_Ns, posterior_dnlselpods_logNs$expectation, posterior_dnlselpods_logNs$med,
                                               log_dnhselpods_Ns, posterior_dnhselpods_logNs$expectation, posterior_dnhselpods_logNs$med))

boxplot(pred_logNs$values ~ pred_logNs$type * pred_logNs$model,
        lwd = 2,
        ylim = c(0,3),
        ylab = expression(log[10]*(Ns)),
        xlab = "",
        xaxt = "n",
        cex.axis = 1.2,
        cex.lab  = 1.2,
        col = c(rep("#a50f15",3),rep("#08519c",3)))
legend("topright", legend = c("1.0% Selection", "2.5% Selection"), col = c("#08519c", "#a50f15"), pch = 15, bty = "n", cex = 1.2)
axis(side = 1, at = 1:6, labels = FALSE)
text(x = 1:6, 
     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
     srt=90, 
     adj=1, 
     xpd=TRUE, 
     labels = paste(rep(c("Expected", "Median", "True"),3)),
     cex = 1.2)
```




