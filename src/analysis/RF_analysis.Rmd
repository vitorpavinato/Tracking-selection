---
title: "Tracking Selection with ABC-RF"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean cache, echo=TRUE, eval=FALSE, include=TRUE}
rm(list=ls())
ls()
```

## ABC random forests analysis

#### Install required packages
```{r install packages, echo=TRUE}
#install.packages(c("DataExplorer", 
#                   "dplyr",
#                   "abcrf",
#                   "weights",
#                   "grDevices"),
#                 dependencies = T)
```

#### Load packages and source file
```{r load packages, echo=TRUE, eval=FALSE, include=TRUE}
library(DataExplorer)
library(dplyr)
library(abcrf)
library(ggplot2)
library(viridis)
library(weights)
library(gtools)
library(ROCR)
library(boot)
library(grDevices)
library(foreach)     # ->
library(parallel)    # -> for simulating in parallel
library(doParallel)  # ->

source("~/My_repositories/Tracking-selection/src/analysis/RF_analysis_fun.R")
```

#### Upload the RF training reference table files
```{r load superbatch 1, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 1
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_1_genotoul/results/pooled_reftable_1.RData")
pooled_raw_reftable_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 2, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 2
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_2_genotoul/results/pooled_reftable_2.RData")
pooled_raw_reftable_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 3, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 3
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_3_genotoul/results/pooled_reftable_3.RData")
pooled_raw_reftable_3 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 4, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 4
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_4_cbgp/results/pooled_reftable_4.RData")
pooled_raw_reftable_4 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

#### Pool together the reftables from super-batches
```{r pooling reftable, echo=TRUE, eval=FALSE, include=TRUE}
pooled_raw_reftable_total <- rbind(pooled_raw_reftable_1,
                                   pooled_raw_reftable_2,
                                   pooled_raw_reftable_3,
                                   pooled_raw_reftable_4)

rm(pooled_raw_reftable_1)
rm(pooled_raw_reftable_2)
rm(pooled_raw_reftable_3)
rm(pooled_raw_reftable_4)

#save(pooled_raw_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))
```

#### RANDOM PODS
```{r load randompods, echo=TRUE, eval=FALSE, include=TRUE}

# random PODs 1
load("~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_1_genotoul/results/pooled_reftable_pods_1.RData")
pooled_raw_reftable_pods_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_1[which(is.na(pooled_raw_reftable_pods_1[, "meanNe2"])), "sim"]
# 38 39 126 165 175 251 281 681 720 735 737 917 # ==> these simulations crashed but produced rows with NA in the reference table.


# random PODs 2
load("~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_2_genotoul/results/pooled_reftable_pods_2.RData")
pooled_raw_reftable_pods_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_2[which(is.na(pooled_raw_reftable_pods_2[, "meanNe2"])), "sim"]
# 1438 is missing # ==> this simulation crashed before produce rows in the reference table.
# 1481 1716 # ==> these simulations crashed but produced rows with NA in the reference table.

pooled_raw_reftable_pods <- rbind(pooled_raw_reftable_pods_1,
                                  pooled_raw_reftable_pods_2)

rm(pooled_raw_reftable_pods_1)
rm(pooled_raw_reftable_pods_2)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_pods)
# 1999 713

# save pooled_raw_reftable_pods as pooled_raw_reftable_pods
#save(pooled_raw_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))
```

#### FIXED PODS
```{r load fixedpods, echo=TRUE, eval=FALSE, include=TRUE}

# fixed PODs 1 - neutral
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/reference_table.RData")
raw_reftable_neutral_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 2 - mutation limited
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/original_s0.1/reference_table.RData")
raw_reftable_limited_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 3 - mutation unlimited
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/original_s0.1/reference_table.RData")
raw_reftable_unlimited_pods <- raw_reftable
rm(raw_reftable)

pooled_raw_reftable_fixedpods <- rbind(raw_reftable_neutral_pods,
                                       raw_reftable_limited_pods,
                                       raw_reftable_unlimited_pods)

rm(raw_reftable_neutral_pods)
rm(raw_reftable_limited_pods)
rm(raw_reftable_unlimited_pods)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_fixedpods)
# 300 713

# save pooled_raw_reftable_fixedpods as pooled_raw_reftable_fixedpods
#save(pooled_raw_reftable_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))
```

#### ADDITIONAL FIXED PODS
```{r load fixedpods, echo=TRUE, eval=FALSE, include=TRUE}

# fixed PODs 4 - mutation limited s=0.01
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.01/reference_table.RData")
raw_reftable_limitedAdd1_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 5 - mutation limited s=0.25
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.25/reference_table.RData")
raw_reftable_limitedAdd2_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 6 - mutation unlimited s=0.01
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.01/reference_table.RData")
raw_reftable_unlimitedAdd1_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 7 - mutation unlimited s=0.25
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.25/reference_table.RData")
raw_reftable_unlimitedAdd2_pods <- raw_reftable
rm(raw_reftable)

pooled_raw_reftable_fixedpods_add <- rbind(raw_reftable_limitedAdd1_pods,
                                           raw_reftable_limitedAdd2_pods,
                                           raw_reftable_unlimitedAdd1_pods,
                                           raw_reftable_unlimitedAdd2_pods)
rm(raw_reftable_limitedAdd1_pods)
rm(raw_reftable_limitedAdd2_pods)
rm(raw_reftable_unlimitedAdd1_pods)
rm(raw_reftable_unlimitedAdd2_pods)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_fixedpods_add)
# 400 713

# save pooled_raw_reftable_fixedpods_add as pooled_raw_reftable_fixedpods_add
#save(pooled_raw_reftable_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods_add",".RData"))
```

#### Prepare the training RF reftable
```{r training data preparation, echo=TRUE, eval=FALSE, include=TRUE}

# Check missing data
plot_missing(pooled_raw_reftable_total) 
missing_count <- sapply(pooled_raw_reftable_total, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_total <- pooled_raw_reftable_total[,missing_count < nrow(pooled_raw_reftable_total)/10]

# remove also POPSelSd and SAMSelSd columns
pooled_reftable_total <- pooled_reftable_total[,-c(31,37)]

# check it!
missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_total) 

# remove remaining rows with missing data
pooled_reftable_total <- pooled_reftable_total[complete.cases(pooled_reftable_total), ]

# check it again
plot_missing(pooled_reftable_total)
table(missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x))))

# Check != numeric values
infinite_count <- sapply(pooled_reftable_total, function(x) sum(is.infinite(x)))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_total)
# 53757   509

#save(pooled_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats <- pooled_reftable_total[, -c(1:104)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats)
# 53757   405

#save(global_sumstats, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
```

#### Prepare the RANDOM PODS reftable
```{r randompods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_pods <- pooled_raw_reftable_pods[, names(pooled_raw_reftable_pods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_pods <- pooled_reftable_pods[complete.cases(pooled_reftable_pods), ]

#save(pooled_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_pods <- pooled_reftable_pods[, -c(1:104)]

#save(global_sumstats_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
```

#### Prepare the FIXED PODS reftable
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_fixedpods <- pooled_raw_reftable_fixedpods[, names(pooled_raw_reftable_fixedpods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_fixedpods <- pooled_reftable_fixedpods[complete.cases(pooled_reftable_fixedpods), ]

#save(pooled_reftable_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_fixedpods <- pooled_reftable_fixedpods[, -c(1:104)]

#save(global_sumstats_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
```

#### Prepare the FIXED PODS reftable - ADDITIONAL
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_fixedpods_add <- pooled_raw_reftable_fixedpods_add[, names(pooled_raw_reftable_fixedpods_add) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_fixedpods_add <- pooled_reftable_fixedpods_add[complete.cases(pooled_reftable_fixedpods_add), ]

#save(pooled_reftable_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods_add",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_fixedpods_add <- pooled_reftable_fixedpods_add[, -c(1:104)]

#save(global_sumstats_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods_add",".RData"))
```


## Sampling period inference

### ABC-RF classification for selection: growing trees

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

## Classification 1
selection_1 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1)

## rf-classification
class_selection_1 <- abcrf(formula = selection_1~.,
                           data    = data.frame(selection_1, global_sumstats[,-c(117)]),
                           lda     = TRUE, 
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

#save(class_selection_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1",".RData"))

(class_selection_1)
##Number of simulations: 1
#Out-of-bag prior error rate: 19.3556%
#
#Confusion matrix:
#         qNeutral  sSel class.error
#qNeutral    20922  4575   0.1794329
#sSel         5830 22430   0.2062987

#TPR = 20922/(20922+5830) = 0.7820724 #sensitivity, recall
#TNR = 22430/(22430+4575) = 0.8305869 #specificity, selectivity
#PPV = 20922/(20922+4575) = 0.8205671 # precision
#NPV = 22430/(5830+22430) = 0.7937013

#same as:
#table(selection_1, class_selection_1$model.rf$predictions)

# GLOBAL ERROR
sum(as.character(class_selection_1$model.rf$predictions)!=selection_1)/length(selection_1)
class_selection_1$model.rf$confusion.matrix
#0.1935562
#         qNeutral  sSel class.error
#qNeutral    20922  4575   0.1794329
#sSel         5830 22430   0.2062987

## error rate plot
err.abcrf(object   = class_selection_1,
          training = data.frame(selection_1, global_sumstats[,-c(117)]),
          paral    = T,
         ncores   = 28)

plot(class_selection_1, 
     training = data.frame(selection_1, global_sumstats[,-c(117)]),
     obs=NULL, 
     n.var=20)

## Classification as a function of theta*PS

# theta * P_S 
#-----------------------------------------------------------
#genomeS = 100e+6
#prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
#  
#logthetaPS <- log10(4 * pooled_reftable_total[, "Ncs"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)

obs_pred_class <- data.frame(obs=selection_1, pred=class_selection_1$model.rf$predictions, logthetaPS=logthetaPS) 

error <- (obs_pred_class$obs!=obs_pred_class$pred)

tol<-0.2
local_error <- array(NA,nrow(obs_pred_class))
for (i in seq_len(nrow(obs_pred_class))){
  
    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
  
  # calculate weigths from epachnikov kernel
  nacc <- ceiling(length(distance) * tol)
  ds   <- sort(distance)[nacc]
  weights <- 1 - (distance/ds)^2
  weights[which(weights<0)]<-0

  # calculated weighthed proportion of error
  local_error[i]<-sum(error*weights)/sum(weights)
}

obs_pred_class["error"] <- local_error

obs_pred_class <- obs_pred_class[order(obs_pred_class$logthetaPS),]

#save(obs_pred_class, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error",".RData"))

# simple plot
#plot(obs_pred_class$logthetaPS,
#     obs_pred_class$error,
#     xlab=expression(log[10](italic(θ) * italic(P)[S])),
#     ylab="error rate",
#     type="l",lwd=2,col="red")
#abline(v=0)

# manuscript plot
class_theta <- ggplot(obs_pred_class , aes(x=logthetaPS, y=error, colour=logthetaPS))
class_theta_g <- class_theta + 
                 geom_line(size = 1.2) + 
                 scale_colour_gradientn(colours=viridis::plasma(32),name="",
                                      breaks = c(-4,0,4),labels = c(-4,0,4)) +
                 xlab(expression(log[10](italic(θ)*italic(P)[S]))) +
                 ylab("error rate") +
                 geom_vline(xintercept = 0, color = "black") + 
                 geom_segment(x = 0.05, y = 0.34, xend = 5, yend = 0.34, color="black",
                              arrow = arrow(length = unit(0.5, "cm"))) +
                 geom_segment(x = 0.05, y = 0.34, xend = -6, yend = 0.34, color="black",
                              arrow = arrow(length = unit(0.5, "cm"))) +
                 annotate("text", x = 2.5, y = 0.33, label = "mutation unlimited",color = "black", fontface = 1) +
                 annotate("text", x = -3, y = 0.33, label = "mutation limited",color = "black", fontface = 1) +
                 theme_bw() + 
                 theme(panel.border = element_rect(colour = "black", fill=NA), 
                 panel.grid.major = element_blank(),
                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                 legend.position = "top", axis.text = element_text(size = 12),
                 axis.title=element_text(size=12))
class_theta_g 

### Classification 2
#selection_2 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0 & pooled_reftable_total[, "averageGeneticLoad"] < 0.3, "qNeutral", "sSel")
#table(selection_2)
#
#class_selection_2 <- abcrf(formula = selection_2~.,
#                           data    = data.frame(selection_2, global_sumstats[,-c(117)]),
#                           lda     = TRUE, 
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(class_selection_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#
#(class_selection_2)
#
#plot(class_selection_2, 
#     training = data.frame(selection_2, global_sumstats[,-c(117)]),
#     obs=NULL, 
#     n.var=20)
```

### ABC-RF regression for selection: growing trees

#### Average genetic load
```{r regression genetic load, echo=TRUE, eval=FALSE, include=TRUE}

averageGenLoad <- pooled_reftable_total[, "averageGeneticLoad"]
hist(averageGenLoad, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

#logaverageGenload <- -log10(1-averageGenLoad)
#hist(logaverageGenload, freq = TRUE, xlab = expression(-log[10](1 - italic(L))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_averageGenLoad <- regAbcrf(formula = logaverageGenload~.,
#                               data    = data.frame(logaverageGenload, global_sumstats),
#                               ntree   = 1000,
#                               paral   = T,
#                               ncores  = 28)
#
#save(reg_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))
#
## variable Importance plot
#plot(x = reg_averageGenLoad, n.var = 20)
#
#head(sort(reg_averageGenLoad$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_averageGenLoad$model.rf$prediction.error
# 0.01902606
#
## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad,
#             training = data.frame(logaverageGenload, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# basic plot for diagnostic
#plot(x    = logaverageGenload,
#     y    = reg_averageGenLoad$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(-log[10](1 - italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
#identify(x = logaverageGenload,
#         y = reg_averageGenLoad$model.rf$predictions)
# example: simulation row 28263
# meanNe2 super small because of a lot of selection
#
#hist(averageGenLoad[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100, 
#     freq = TRUE, xlab = expression(italic(bar(L))), main = "", col = "#bdbdbd")
#
#hist(logaverageGenload[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100,
#     freq = TRUE, xlab = expression(-log[10](1 - italic(bar(L)))), main = "", col = "#bdbdbd")
#
# manuscript plot
#oob.loggl <- data.frame(x = logaverageGenload,
#                        y = reg_averageGenLoad$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.loggl, nbins=70, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       show = T,
#       xlab = expression(paste("true", " ", -log[10](1- italic(L)))),
#       ylab = expression(paste(-log[10](1- italic(hat(L))), " ","(OOB prediction)")),
#       xlim = c(0,3),
#       ylim = c(0,3),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero <- which(averageGenLoad == 0)
averageGenLoad_2 <- averageGenLoad[-load_zero]
global_sumstats_averageGenLoad <- global_sumstats[-load_zero,]

logitaverageGenload <- log(averageGenLoad_2/(1-averageGenLoad_2))
hist(logitaverageGenload, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_2 <- regAbcrf(formula = logitaverageGenload~.,
                                 data    = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 28)

#save(reg_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_2",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_2, n.var = 20, main=expression(logit(italic(L))))

#head(sort(reg_averageGenLoad_2$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_averageGenLoad_2$model.rf$prediction.error
# 2.474618
inv.logit(reg_averageGenLoad_2$model.rf$prediction.error)
# 0.9223432

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_2,
#             training = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# basic plot for diagnostic
plot(x    = logitaverageGenload,
     y    = reg_averageGenLoad_2$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.lgtgl <- data.frame(x = logitaverageGenload,
                        y = reg_averageGenLoad_2$model.rf$predictions)

#save(oob.lgtgl, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtgl",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtgl",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.lgtgl, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(L)))),
       ylab = expression(paste(logit(italic(hat(L))), " ","(OOB prediction)")),
       xlim = c(-8,6),
       ylim = c(-8,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## logit transformation II:
# substitute 0 for 10e-1 * lowest-before-0-value
#averageGenLoad_3 <- replace(averageGenLoad, averageGenLoad== 0, (5.4186e-09*1e-1))
#
#logitaverageGenload_2 <- log(averageGenLoad_3/(1-averageGenLoad_3))
#hist(logitaverageGenload_2, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_averageGenLoad_3 <- regAbcrf(formula = logitaverageGenload_2~.,
#                                 data    = data.frame(logitaverageGenload_2, global_sumstats),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
#save(reg_averageGenLoad_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_3",".RData"))
#
## variable Importance plot
#plot(x = reg_averageGenLoad_3, n.var = 20)
#
#head(sort(reg_averageGenLoad_3$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_averageGenLoad_3$model.rf$prediction.error
# 52.70968
#
## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_3,
#             training = data.frame(logitaverageGenload_2, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnistic plot
#plot(x    = logitaverageGenload_2,
#     y    = reg_averageGenLoad_3$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-22,7),
#     ylim = c(-22,7),
#     main = expression(logit(italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r regression strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

## correlation between the the calculated PrPOPStrongMSel and PrSAMStrongMSel
#cor(pooled_reftable_total$POPPrStrongMSel, pooled_reftable_total$SAMPrStrongMSel)
#0.9843608
#
#plot(x = pooled_reftable_total$POPPrStrongMSel, 
#     y = pooled_reftable_total$SAMPrStrongMSel, 
#     xlab = "POPPrStrongMSel",
#     ylab = "SAMPrStrongMSel")
#abline(lm(pooled_reftable_total$SAMPrStrongMSel ~ pooled_reftable_total$POPPrStrongMSel), col="#cb181d")
#
## correlation between the calculated POPPrMSel and POPPrStrongMSel
#cor(pooled_reftable_total$POPPrMSel, pooled_reftable_total$POPPrStrongMSel)
#0.7035794
#
#plot(x = pooled_reftable_total$POPPrMSel, 
#     y = pooled_reftable_total$POPPrStrongMSel,
#     xlab = "POPPrMSel",
#     ylab = "POPPrStrongMSel",
#     xlim = c(0,1),
#     ylim = c(0,1))
#abline(lm(pooled_reftable_total$POPPrStrongMSel ~ pooled_reftable_total$POPPrMSel), col="#cb181d")

## PrPOPStrongMSel
##-----------------------------------------------------------
prPOPStrongMSel <- pooled_reftable_total[, "POPPrStrongMSel"]
hist(prPOPStrongMSel, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_prPOPStrongMSel <- regAbcrf(formula = prPOPStrongMSel~.,
#                                data    = data.frame(prPOPStrongMSel, global_sumstats),
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 28)
#
#save(reg_prPOPStrongMSel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))
#
## variable Importance plot
#plot(x = reg_prPOPStrongMSel, n.var = 20)
#
#head(sort(reg_prPOPStrongMSel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_prPOPStrongMSel$model.rf$prediction.error
# 0.001121995
#
## error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel,
#             training = data.frame(prPOPStrongMSel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = prPOPStrongMSel,
#     y    = reg_prPOPStrongMSel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(italic(P)),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")

## removing "quasi-neutral" simulations
##-----------------------------------------------------------
neutralsims <- which(prPOPStrongMSel == 0)
prPOPStrongMSel_2 <- prPOPStrongMSel[-neutralsims]
global_sumstats_popstrongmsel <- global_sumstats[-neutralsims,]

hist(prPOPStrongMSel_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## rf-regression
#reg_prPOPStrongMSel_2 <- regAbcrf(formula = prPOPStrongMSel_2~.,
#                                  data    = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
#                                  ntree   = 1000,
#                                  paral   = T,
#                                  ncores  = 28)
#
#save(reg_prPOPStrongMSel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_prPOPStrongMSel_2, n.var = 20)
#
#head(sort(reg_prPOPStrongMSel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_prPOPStrongMSel_2$model.rf$prediction.error
# 0.001584579
#
## error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel_2,
#             training = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = prPOPStrongMSel_2,
#     y    = reg_prPOPStrongMSel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     main = expression(italic(P)),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")

## log10 transformation PrPOPStrongMSel
##-----------------------------------------------------------
#logpopstrongmsel <- log10(prPOPStrongMSel_2)
#
#hist(logpopstrongmsel, freq = TRUE, xlab = expression(log[10](italic(P))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logpopstrongmsel <- regAbcrf(formula = logpopstrongmsel~.,
#                                 data    = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 28)
#
#save(reg_logpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))
#
## variable Importance plot
#plot(x = reg_logpopstrongmsel, n.var = 20)
#
#head(sort(reg_logpopstrongmsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logpopstrongmsel$model.rf$prediction.error
# 0.2933011
#
## error rate plot
#err.regAbcrf(object   = reg_logpopstrongmsel,
#             training = data.frame(logpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

## oob predictions vs true values
# diagnostic plot
#plot(x    = logpopstrongmsel,
#     y    = reg_logpopstrongmsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
#     main = expression(log[10](italic(P))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)

## logit transformation I: 
# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel <- log(prPOPStrongMSel_2/(1-prPOPStrongMSel_2))
hist(logitpopstrongmsel, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel <- regAbcrf(formula = logitpopstrongmsel~.,
                                   data    = data.frame(logitpopstrongmsel, global_sumstats_popstrongmsel),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logitpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))

## variable Importance plot
plot(x = reg_logitpopstrongmsel, n.var = 20, main=expression(logit(italic(P))))

#head(sort(reg_logpopstrongmsel$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopstrongmsel$model.rf$prediction.error
# 1.608456
inv.logit(reg_logitpopstrongmsel$model.rf$prediction.error)
#0.8331969

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel,
#             training = data.frame(logitpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logitpopstrongmsel,
     y    = reg_logitpopstrongmsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-15,2),
     ylim = c(-15,2),
     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)

## Relationship between logpopstrongmsel and logaverageGenload
#
#plot(logpopstrongmsel, logaverageGenload[-neutralsims],
#     xlab = expression(log10(italic(P[strong]))),
#     ylab = expression(-log10(1-italic(L)))
#     )

## Relationship between logitpopstrongmsel and logitaverageGenload 
#
#logitaverageGenload <- log(averageGenLoad/(1-averageGenLoad))
#plot(logitpopstrongmsel, logitaverageGenload[-neutralsims],
#     xlab = expression(log(italic(P[strong])/1-italic(P[strong]))),
#     ylab = expression(log(italic(L)/1-italic(L))))

# manuscript plot
oob.lgtps <- data.frame(x = logitpopstrongmsel,
                          y = reg_logitpopstrongmsel$model.rf$predictions)

#save(oob.lgtps, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtps",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtps",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.lgtps, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(P)))),
       ylab = expression(paste(logit(italic(hat(P))), " ","(OOB prediction)")),
       xlim = c(-15,2),
       ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## logit transformation II: 
# PrPOPStrongMSel - with all simulations
# substitute 0 for 10e-1 * lowest-before-0-value
#prPOPStrongMSel_3 <- replace(prPOPStrongMSel, prPOPStrongMSel== 0, (2.638936e-07*1e-1))
#
#logitpopstrongmsel_2 <- log(prPOPStrongMSel_3/(1-prPOPStrongMSel_3))
#hist(logitpopstrongmsel_2, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logitpopstrongmsel_2 <- regAbcrf(formula = logitpopstrongmsel_2~.,
#                                     data    = data.frame(logitpopstrongmsel_2, global_sumstats),
#                                     ntree   = 1000,
#                                     paral   = T,
#                                     ncores  = 8)
#
#save(reg_logitpopstrongmsel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_logitpopstrongmsel_2, n.var = 20)
#
#head(sort(reg_logpopstrongmsel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logitpopstrongmsel_2$model.rf$prediction.error
# 1.608456
#
## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_2,
#             training = data.frame(logitpopstrongmsel_2, global_sumstats),
#             paral    = T,
#            ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logitpopstrongmsel_2,
#     y    = reg_logitpopstrongmsel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-18,2),
#     ylim = c(-18,2),
#     main = expression(log(italic(P[strong])/(1-italic(P[strong])))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### Theta selected mutations
```{r regression thetaS, echo=TRUE, eval=FALSE, include=TRUE}
genomeS = 100e+6

<<<<<<< HEAD
## theta * P_S 
##-----------------------------------------------------------
prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
  
logthetaPS <- log10(4 * pooled_reftable_total[, "Ncs"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)

hist(logthetaPS, freq = TRUE, xlab = expression(log[10](italic(θ) * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS <- regAbcrf(formula = logthetaPS~.,
                           data    = data.frame(logthetaPS, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 8)

#save(reg_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaPS",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS, n.var = 20, main=expression(log[10](italic(θ) * italic(P)[S])))

#head(sort(reg_logthetaPS$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logthetaPS$model.rf$prediction.error
# 1.487941

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS,
#             training = data.frame(reg_logthetaPS, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
## diagnostic plot
plot(x    = logthetaPS,
     y    = reg_logthetaPS$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-8,6),
     ylim = c(-8,6),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logthetaPS <- data.frame(x = logthetaPS,
                             y = reg_logthetaPS$model.rf$predictions)

#save(oob.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logthetaPS",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logthetaPS, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(θ) * italic(P)[S]))),
       ylab = expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(OOB prediction)")),
       xlim = c(-8,6),
       ylim = c(-8,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## ThetaS (original with meanNe2)
=======
## thetaS
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
##-----------------------------------------------------------
#prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
#  
#logthetaS <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)
#
#hist(logthetaS, freq = TRUE, xlab = expression(log[10](italic(theta)*italic(P)[S])), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS <- regAbcrf(formula = logthetaS~.,
#                          data    = data.frame(logthetaS, global_sumstats),
#                          ntree   = 1000,
#                          paral   = T,
#                          ncores  = 28)
#
#save(reg_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS, n.var = 20)
#
#head(sort(reg_logthetaS$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS$model.rf$prediction.error
# 1.431425
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS,
#             training = data.frame(logthetaS, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS,
#     y    = reg_logthetaS$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logthetaS <- data.frame(x = logthetaS,
#                            y = reg_logthetaS$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logthetaS, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(theta) * italic(P)[S]))),
#       ylab = expression(paste(log[10](italic(hat(theta)) * italic(P)[S]), " ","(OOB prediction)")),
#       xlim = c(-8,6),
#       ylim = c(-8,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## ThetaS_2 - Proportion of selected mutations POPPrMSel
##-----------------------------------------------------------
#prPOPPrMSel <- pooled_reftable_total[, "POPPrMSel"]
#
## removing simulations with POPPrMSel == 0
#zero_prmsel <- which(prPOPPrMSel == 0)
#prPOPPrMSel_2 <- prPOPPrMSel[-zero_prmsel]
#global_sumstats_popmsel <- global_sumstats[-zero_prmsel,]
#
#logthetaS_2 <- log10(4 * pooled_reftable_total[-zero_prmsel, "meanNe2"] * (pooled_reftable_total[-zero_prmsel, "mu"] * prPOPPrMSel_2) * genomeS)
#
#hist(logthetaS_2, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_2 <- regAbcrf(formula = logthetaS_2~.,
#                            data    = data.frame(logthetaS_2, global_sumstats_popmsel),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 2)
#
#save(reg_logthetaS_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_2",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_2, n.var = 20)
#
#head(sort(reg_logthetaS_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_2$model.rf$prediction.error
# 0.5463858
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_2,
#             training = data.frame(logthetaS_2, global_sumstats_popmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_2,
#     y    = reg_logthetaS_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,6),
#     ylim = c(-7,6),
#     col  = ifelse(selection_1[-zero_prmsel] == "qNeutral", "red", "black"),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
## ThetaS_3 - Proportion of strongly selecte mutations POPPrMSel
##----------------------------------------------------------- 
#neutralsims <- which(prPOPStrongMSel == 0)
#prPOPStrongMSel_2 <- prPOPStrongMSel[-neutralsims]
#global_sumstats_popstrongmsel <- global_sumstats[-neutralsims,]
#
#logthetaS_3 <- log10(4 * pooled_reftable_total[-neutralsims, "meanNe2"] * (pooled_reftable_total[-neutralsims, "mu"] * prPOPStrongMSel_2) * genomeS)
#
#hist(logthetaS_3, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_3 <- regAbcrf(formula = logthetaS_3~.,
#                            data    = data.frame(logthetaS_3, global_sumstats_popstrongmsel),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 4)
#
#save(reg_logthetaS_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_3",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_3, n.var = 20)
#
#head(sort(reg_logthetaS_3$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_3$model.rf$prediction.error
# 0.3136867
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_3,
#             training = data.frame(logthetaS_3, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_3,
#     y    = reg_logthetaS_3$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,6),
#     ylim = c(-7,6),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## Relationship between logthetaS_3 and logpopstrongmsel
#
#logthetaS_3 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * pooled_reftable_total[, "POPPrStrongMSel"]) * genomeS)
#plot(logthetaS_3[-neutralsims], logpopstrongmsel,
#     xlab = expression(log(italic(theta[s]))),
#     ylab = expression(log10(italic(P[strong]))))
#
## Relationship between logthetaS_3 and logaverageGenLoad
#
#plot(logthetaS_3, logaverageGenload,
#     xlab = expression(log(italic(theta[s]))),
#     ylab = expression(-log10(1-italic(L)))
#     )
#
## ThetaS_4 - Calculated with the probability of having strongly selected mutations give Ne and gammashape
##-------------------------------------------------------------------------------------------------------- 
#invNe2 <- 1/pooled_reftable_total[, "meanNe2"]
#gammashape <- pooled_reftable_total[, "gammaShape"]
#likelystrongMsel <- pgamma(invNe2,shape=gammashape,rate=1,lower.tail=FALSE)
#
#logthetaS_4 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * likelystrongMsel) * genomeS)
#
#hist(logthetaS_4, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_4 <- regAbcrf(formula = logthetaS_4~.,
#                            data    = data.frame(logthetaS_4, global_sumstats),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 8)
#
#save(reg_logthetaS_4, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_4",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_4",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_4, n.var = 20)
#
#head(sort(reg_logthetaS_4$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_4$model.rf$prediction.error
# 0.6459325
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_4,
#             training = data.frame(logthetaS_4, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_4,
#     y    = reg_logthetaS_4$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-42,6),
#     ylim = c(-42,6),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### Ns
```{r regression Ns, echo=TRUE, eval=FALSE, include=TRUE}
logNs <- log10(pooled_reftable_total[, "meanNe2"] * pooled_reftable_total[, "gammaMean"])

<<<<<<< HEAD
hist(logNs, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(s))), main = "", col = "#bdbdbd")
=======
hist(logNs, freq = TRUE, xlab = expression(log[10](N[s])), main = "", col = "#bdbdbd")
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

# abf-rf regression
reg_logNs <- regAbcrf(formula = logNs~.,
                      data    = data.frame(logNs, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 28)

#save(reg_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs",".RData"))

# variable Importance plot
<<<<<<< HEAD
plot(x = reg_logNs, n.var = 20, main=expression(log[10](italic(N)[e] * italic(s))))
=======
plot(x = reg_logNs, n.var = 20)
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

#head(sort(reg_logNs$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNs$model.rf$prediction.error
# 0.6397764

# error rate plot
#err.regAbcrf(object   = reg_logNs,
#             training = data.frame(logNs, global_sumstats),
#             paral    = T,
#             ncores   = 8)

<<<<<<< HEAD
## oob predictions vs true values
## diagnostic plot
=======
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
plot(x    = logNs,
     y    = reg_logNs$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-4,4),
     ylim = c(-4,4),
     cex.axis = 1.2,
<<<<<<< HEAD
     cex.lab  = 1.2)
=======
     cex.lab  = 1.5)
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
abline(a=0, b=1, col = "green")
```

<<<<<<< HEAD
# manuscript plot
oob.logNs <- data.frame(x = logNs,
                        y = reg_logNs$model.rf$predictions)

#save(oob.logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(s)))),
       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(OOB prediction)")),
       xlim = c(-4,4),
       ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### DFE gamma mean
```{r regression gamma mean, echo=TRUE, eval=FALSE, include=TRUE}
#loggammamean <- log10(pooled_reftable_total[, "gammaMean"])
#
#hist(loggammamean, freq = TRUE, xlab = expression(log[10](italic(kappa * theta))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_loggammamean <- regAbcrf(formula = loggammamean~.,
#                             data    = data.frame(loggammamean, global_sumstats),
#                             ntree   = 1000,
#                             paral   = T,
#                             ncores  = 28)
#
#save(reg_loggammamean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
#
## variable Importance plot
#plot(x = reg_loggammamean, n.var = 20)
#
#head(sort(reg_loggammamean$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_loggammamean$model.rf$prediction.error
# 0.6123305
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean,
#             training = data.frame(loggammamean, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = loggammamean,
#     y    = reg_loggammamean$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-3,0),
#     ylim = c(-3,0),
#     main = expression(log[10](italic(kappa * theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.loggammamean <- data.frame(x = loggammamean,
#                              y = reg_loggammamean$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.loggammamean, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(kappa * theta)))),
#       ylab = expression(paste(log[10](italic(hat(kappa * theta))), " ","(OOB prediction)")),
#       xlim = c(-3,0),
#       ylim = c(-3,0),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Likelihood of having strongly selected mutations given the Ne and s mean (gamma shape) of sampling period
```{r regression likelihoods strong selection, echo=TRUE, eval=FALSE, include=TRUE}
#
#invNe2 <- 1/pooled_reftable_total[, "meanNe2"]
#gammashape <- pooled_reftable_total[, "gammaShape"]
#likelystrongMsel <- pgamma(invNe2,shape=gammashape,rate=1,lower.tail=FALSE)
#
#hist(likelystrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), #main = "", col = "#bdbdbd")
#
## rf-regression
#reg_likelystrongMsel <- regAbcrf(formula = likelystrongMsel~.,
#                                 data    = data.frame(likelystrongMsel, global_sumstats),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
#save(reg_likelystrongMsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))
#
## variable Importance plot
#plot(x = reg_likelystrongMsel, n.var = 20)
#
#head(sort(reg_likelystrongMsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_likelystrongMsel$model.rf$prediction.error
#0.07389625
#
## error rate plot
#err.regAbcrf(object   = reg_likelystrongMsel,
#             training = data.frame(likelystrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = likelystrongMsel,
#     y    = reg_likelystrongMsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     main = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## logit transformation of the likelihood
##-----------------------------------------------------------
#logitlikelyhoodstrongMsel <- log(likelystrongMsel/(1-likelystrongMsel))
#
#hist(logitlikelyhoodstrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logitlikelyhoodstrongMsel <- regAbcrf(formula = logitlikelyhoodstrongMsel~.,
#                                          data    = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
#                                          ntree   = 1000,
#                                          paral   = T,
#                                          ncores  = 8)
#save(reg_logitlikelyhoodstrongMsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))
#
## variable Importance plot
#plot(x = reg_logitlikelyhoodstrongMsel, n.var = 20)
#
#head(sort(reg_logitlikelyhoodstrongMsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logitlikelyhoodstrongMsel$model.rf$prediction.error
#5.519425
#
## error rate plot
#err.regAbcrf(object   = reg_logitlikelyhoodstrongMsel,
#             training = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logitlikelyhoodstrongMsel,
#     y    = reg_logitlikelyhoodstrongMsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-40,10),
#     ylim = c(-40,10),
#     main = expression(paste("Logit Pr mutations with"," ", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```
=======
#### DFE gamma mean
```{r regression gamma mean, echo=TRUE, eval=FALSE, include=TRUE}

loggammamean <- log10(pooled_reftable_total[, "gammaMean"])

hist(loggammamean, freq = TRUE, xlab = expression(log[10](paste("gamma ", kappa, theta))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean <- regAbcrf(formula = loggammamean~.,
                             data    = data.frame(loggammamean, global_sumstats),
                             ntree   = 1000,
                             paral   = T,
                             ncores  = 28)

#save(reg_loggammamean, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

#### FDR 1% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
#fstfdrNs01 <- pooled_reftable_total[, "FSTfdrNS01"]
#hist(fstfdrNs01, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## rf-regression
#reg_fstfdrNs01 <- regAbcrf(formula = fstfdrNs01~.,
#                           data    = data.frame(fstfdrNs01, global_sumstats),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs01, n.var = 20)
#
#head(sort(reg_fstfdrNs01$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs01$model.rf$prediction.error
#  0.004060022
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01,
#             training = data.frame(fstfdrNs01, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = fstfdrNs01,
#     y    = reg_fstfdrNs01$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
## removing "quasi-neutral" simulations
#fstfdrNs01_2 <- fstfdrNs01[-neutralsims]
#hist(fstfdrNs01_2, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## abf-rf regression
#reg_fstfdrNs01_2 <- regAbcrf(formula = fstfdrNs01_2~.,
#                           data    = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
## variable Importance plot
<<<<<<< HEAD
#plot(x = reg_fstfdrNs01_2, n.var = 20)
#
#head(sort(reg_fstfdrNs01_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs01_2$model.rf$prediction.error
# 0.00575472
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01_2,
#             training = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = fstfdrNs01_2,
#     y    = reg_fstfdrNs01_2$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
#fstfdrNs05 <- pooled_reftable_total[, "FSTfdrNS05"]
#hist(fstfdrNs05, freq = TRUE, xlab = "5% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## rf-regression
#reg_fstfdrNs05 <- regAbcrf(formula = fstfdrNs05~.,
#                           data    = data.frame(fstfdrNs05, global_sumstats),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs05, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs05, n.var = 20)
#
#head(sort(reg_fstfdrNs05$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs05$model.rf$prediction.error
#  0.004149811
#
=======
plot(x = reg_loggammamean, n.var = 20)

#head(sort(reg_loggammamean$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_loggammamean$model.rf$prediction.error
# 0.6123305

>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
## error rate plot
#err.regAbcrf(object   = reg_loggammamean,
#             training = data.frame(loggammamean, global_sumstats),
#             paral    = T,
#             ncores   = 28)
<<<<<<< HEAD
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = fstfdrNs05,
#     y    = reg_fstfdrNs05$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
```

#### Mean of the selection coefficients - based on POPSelMean and POPStrongSelMean
```{r regression gamma mean POPSelMean, echo=TRUE, eval=FALSE, include=TRUE}
#
## POPSelMean
##-----------------------------------------------------------
#meanPOPSel <- pooled_reftable_total[, "POPSelMean"]
#
## remove simulations with POPPrMSel == 0
#meanPOPSel_2 <- meanPOPSel[-zero_prmsel]
#
=======

plot(x    = loggammamean,
     y    = reg_loggammamean$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-3,0),
     ylim = c(-3,0),
     main = expression(log[10](paste("gamma ", kappa, theta))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")
```

#### Likelihood of having strongly selected mutations given the Ne and s mean (gamma shape) of sampling period
```{r regression likelihoods strong selection, echo=TRUE, eval=FALSE, include=TRUE}

invNe2 <- 1/pooled_reftable_total[, "meanNe2"]
gammashape <- pooled_reftable_total[, "gammaShape"]
likelystrongMsel <- pgamma(invNe2,shape=gammashape,rate=1,lower.tail=FALSE)

hist(likelystrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

## rf-regression
reg_likelystrongMsel <- regAbcrf(formula = likelystrongMsel~.,
                                 data    = data.frame(likelystrongMsel, global_sumstats),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

#save(reg_likelystrongMsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))

## variable Importance plot
plot(x = reg_likelystrongMsel, n.var = 20)

#head(sort(reg_likelystrongMsel$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
#reg_likelystrongMsel$model.rf$prediction.error
#0.07389625

## error rate plot
#err.regAbcrf(object   = reg_likelystrongMsel,
#             training = data.frame(likelystrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = likelystrongMsel,
     y    = reg_likelystrongMsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     main = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

## logit transformation of the likelihood
##-----------------------------------------------------------
logitlikelyhoodstrongMsel <- log(likelystrongMsel/(1-likelystrongMsel))

hist(logitlikelyhoodstrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")

## rf-regression
reg_logitlikelyhoodstrongMsel <- regAbcrf(formula = logitlikelyhoodstrongMsel~.,
                                          data    = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
                                          ntree   = 1000,
                                          paral   = T,
                                          ncores  = 8)
#save(reg_logitlikelyhoodstrongMsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))

## variable Importance plot
plot(x = reg_logitlikelyhoodstrongMsel, n.var = 20)

#head(sort(reg_logitlikelyhoodstrongMsel$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
#reg_logitlikelyhoodstrongMsel$model.rf$prediction.error
#5.519425

## error rate plot
#err.regAbcrf(object   = reg_logitlikelyhoodstrongMsel,
#             training = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = logitlikelyhoodstrongMsel,
     y    = reg_logitlikelyhoodstrongMsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-40,10),
     ylim = c(-40,10),
     main = expression(paste("Logit Pr mutations with"," ", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")
```

#### FDR 1% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
fstfdrNs01 <- pooled_reftable_total[, "FSTfdrNS01"]
hist(fstfdrNs01, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")

## rf-regression
reg_fstfdrNs01 <- regAbcrf(formula = fstfdrNs01~.,
                           data    = data.frame(fstfdrNs01, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

#save(reg_fstfdrNs01, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))

#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))

## variable Importance plot
plot(x = reg_fstfdrNs01, n.var = 20)

#head(sort(reg_fstfdrNs01$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_fstfdrNs01$model.rf$prediction.error
#  0.004060022

## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01,
#             training = data.frame(fstfdrNs01, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = fstfdrNs01,
     y    = reg_fstfdrNs01$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")

## removing "quasi-neutral" simulations
#fstfdrNs01_2 <- fstfdrNs01[-neutralsims]
#hist(fstfdrNs01_2, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")

## abf-rf regression
#reg_fstfdrNs01_2 <- regAbcrf(formula = fstfdrNs01_2~.,
#                           data    = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs01_2, n.var = 20)
#
#head(sort(reg_fstfdrNs01_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs01_2$model.rf$prediction.error
# 0.00575472
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01_2,
#             training = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
#plot(x    = fstfdrNs01_2,
#     y    = reg_fstfdrNs01_2$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
fstfdrNs05 <- pooled_reftable_total[, "FSTfdrNS05"]
hist(fstfdrNs05, freq = TRUE, xlab = "5% FST FDR Ns>1", main = "", col = "#bdbdbd")

## rf-regression
reg_fstfdrNs05 <- regAbcrf(formula = fstfdrNs05~.,
                           data    = data.frame(fstfdrNs05, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 28)

#save(reg_fstfdrNs05, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))

#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))

## variable Importance plot
plot(x = reg_fstfdrNs05, n.var = 20)

#head(sort(reg_fstfdrNs05$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_fstfdrNs05$model.rf$prediction.error
#  0.004149811

## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs05,
#             training = data.frame(fstfdrNs05, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = fstfdrNs05,
     y    = reg_fstfdrNs05$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,1),
     ylim = c(0,1),
     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
     cex.axis = 1.2,
     cex.lab  = 1.5)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
abline(a=0, b=1, col = "green")
```

#### Mean of the selection coefficients - based on POPSelMean and POPStrongSelMean
```{r regression gamma mean POPSelMean, echo=TRUE, eval=FALSE, include=TRUE}

## POPSelMean
##-----------------------------------------------------------
meanPOPSel <- pooled_reftable_total[, "POPSelMean"]

## remove simulations with POPPrMSel == 0
meanPOPSel_2 <- meanPOPSel[-zero_prmsel]

>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
## rf-regression
#reg_meanPOPSel_1 <- regAbcrf(formula = meanPOPSel_2~.,
#                              data    = data.frame(meanPOPSel_2, global_sumstats_popmsel),
#                              ntree   = 1000,
#                              paral   = T,
#                              ncores  = 20)
#
#save(reg_meanPOPSel_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_meanPOPSel_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_meanPOPSel_1",".RData"))
#
## variable Importance plot
#plot(x = reg_meanPOPSel_1, n.var = 20)
#
#head(sort(reg_meanPOPSel_1$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_meanPOPSel_1$model.rf$prediction.error
# 0.09618162
#
## error rate plot
#err.regAbcrf(object   = reg_meanPOPSel_1,
#             training = data.frame(meanPOPSel_2, global_sumstats_popmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = meanPOPSel_2,
#     y    = reg_meanPOPSel_1$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,6),
#     ylim = c(0,6),
#     main = expression(log[10](paste("gamma ", kappa, theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
## log POPSelMean
##-----------------------------------------------------------
#logmeanpopsel_1 <- log10(meanPOPSel_2)
#
#hist(logmeanpopsel_1, freq = TRUE, xlab = expression(log[10](paste("gamma ", kappa, theta))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logmeanpopsel_1 <- regAbcrf(formula = logmeanpopsel_1~.,
#                              data    = data.frame(logmeanpopsel_1, global_sumstats_popmsel),
#                              ntree   = 1000,
#                              paral   = T,
#                              ncores  = 2)
#
#save(reg_logmeanpopsel_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanpopsel_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanpopsel_1",".RData"))
#
## variable Importance plot
#plot(x = reg_logmeanpopsel_1, n.var = 20)
#
#head(sort(reg_logmeanpopsel_1$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logmeanpopsel_1$model.rf$prediction.error
# 32.33989
#
## error rate plot
#err.regAbcrf(object   = reg_logmeanpopsel_1,
#             training = data.frame(logmeanpopsel_1, global_sumstats_popmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logmeanpopsel_1,
#     y    = reg_logmeanpopsel_1$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-45,1),
#     ylim = c(-45,1),
#     main = expression(log[10](paste("gamma ", kappa, theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## POPStrongSelMean
##-----------------------------------------------------------
#meanstrongPOPSel <- pooled_reftable_total[, "POPStrongSelMean"]
#
## removing simulations with POPPrMSel == 0
#meanstrongPOPSel_2 <- meanstrongPOPSel[-neutralsims]
#
## rf-regression
#reg_meanPOPSel_2 <- regAbcrf(formula = meanstrongPOPSel_2~.,
#                              data    = data.frame(meanstrongPOPSel_2, global_sumstats_popstrongmsel),
#                              ntree   = 1000,
#                              paral   = T,
#                              ncores  = 20)
#
#save(reg_meanPOPSel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_meanPOPSel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_meanPOPSel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_meanPOPSel_2, n.var = 20)
#
#head(sort(reg_meanPOPSel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_meanPOPSel_2$model.rf$prediction.error
# 0.1667578
#
## error rate plot
#err.regAbcrf(object   = reg_meanPOPSel_2,
#             training = data.frame(meanstrongPOPSel_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = meanstrongPOPSel_2,
#     y    = reg_meanPOPSel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(12,0),
#     ylim = c(12,0),
#     main = expression(log[10](paste("gamma ", kappa, theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
## log POPStrongSelMean
##-----------------------------------------------------------
#logmeanpopsel_2 <- log10(meanstrongPOPSel_2)
#
#hist(logmeanpopsel_2, freq = TRUE, xlab = expression(log[10](paste("gamma ", kappa, theta))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logmeanpopsel_2 <- regAbcrf(formula = logmeanpopsel_2~.,
#                              data    = data.frame(logmeanpopsel_2, global_sumstats_popstrongmsel),
#                              ntree   = 1000,
#                              paral   = T,
#                              ncores  = 2)
#
#save(reg_logmeanpopsel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanpopsel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanpopsel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_logmeanpopsel_2, n.var = 20)
#
#head(sort(reg_logmeanpopsel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logmeanpopsel_2$model.rf$prediction.error
# 0.1166446
#
## error rate plot
#err.regAbcrf(object   = reg_logmeanpopsel_2,
#             training = data.frame(logmeanpopsel_1, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
<<<<<<< HEAD
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logmeanpopsel_2,
#     y    = reg_logmeanpopsel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-4,2),
#     ylim = c(-4,2),
#     main = expression(log[10](paste("gamma ", kappa, theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
=======

plot(x    = logmeanpopsel_2,
     y    = reg_logmeanpopsel_2$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-4,2),
     ylim = c(-4,2),
     main = expression(log[10](paste("gamma ", kappa, theta))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
```

### ABC-RF regression for demography: growing trees

#### Harmonic mean of the effective population sizes of period 2
```{r regression meanNe2, echo=TRUE, eval=FALSE, include=TRUE}
logmeanNe2 <- log10(pooled_reftable_total[, "meanNe2"])

<<<<<<< HEAD
hist(logmeanNe2, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")
=======
hist(logmeanNe2, freq = TRUE, xlab = expression(log[10](italic(bar(N[e])))), main = "", col = "#bdbdbd")
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

## rf-regression
reg_logmeanNe2 <- regAbcrf(formula = logmeanNe2~.,
                                   data    = data.frame(logmeanNe2, global_sumstats),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logmeanNe2, 
<<<<<<< HEAD
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))
=======
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2, n.var = 20, main=expression(log[10](italic(N)[e])))

#head(sort(reg_logmeanNe2$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2$model.rf$prediction.error
# 0.02328446

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2,
#             training = data.frame(logmeanNe2, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logmeanNe2,
     y    = reg_logmeanNe2$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-2,4),
     ylim = c(-2,4),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logmeanNe2 <- data.frame(x = logmeanNe2,
                            y = reg_logmeanNe2$model.rf$predictions)

#save(oob.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logmeanNe2, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(OOB prediction)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Comparison with the NE calculation based on the temporal FST
globalFSTNe <- function(x, tau){
  fst  <- x
  ne <- (tau*(1-fst))/(4*fst)
  return(ne)
}

logfstne2 <- log10(globalFSTNe(x=global_sumstats$GSS_WCst, tau=10))

estimated.fstNe2 <- data.frame(x = logmeanNe2,
                               y = logfstne2)

#save(estimated.fstNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/estimated.fstNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/estimated.fstNe2",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Population size of period 2 - census size Ncs
```{r regression Ncs, echo=TRUE, eval=FALSE, include=TRUE}
logncs <- log10(pooled_reftable_total[, "Ncs"])

hist(logncs, freq = TRUE, xlab = expression(log[10](italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs <- regAbcrf(formula = logncs~.,
                        data = data.frame(logncs, global_sumstats),
                       ntree = 1000,
                       paral = T,
                      ncores = 28)

#save(reg_logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))

## Variable Importance plot
plot(x = reg_logncs, n.var = 20, main=expression(log[10](italic(N)[cs])))

#head(sort(reg_logn$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logncs$model.rf$prediction.error
# 0.03197194

## error rate plot
#err.regAbcrf(object   = reg_logncs,
#             training = data.frame(logncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = logncs,
     y    = reg_logncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,4),
     ylim = c(0,4),
     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logncs <- data.frame(x = logncs,
                             y = reg_logncs$model.rf$predictions)

#save(oob.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logncs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logncs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[cs]))),
       ylab = expression(paste(log[10](italic(hat(N))[cs]), " ","(OOB prediction)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r regression MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

logmeanNe2ncs <- log10(pooled_reftable_total[, "meanNe2"]/pooled_reftable_total[, "Ncs"])

hist(logmeanNe2ncs, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs <- regAbcrf(formula = logmeanNe2ncs~.,
                                 data = data.frame(logmeanNe2ncs, global_sumstats),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2ncs, n.var = 20, main=expression(log[10](italic(N)[e]/italic(N)[cs])))

#head(sort(reg_logmeanNe2ncs$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logmeanNe2ncs$model.rf$prediction.error
# 0.02523953

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs,
#             training = data.frame(logmeanNe2ncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logmeanNe2ncs,
     y    = reg_logmeanNe2ncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-5,1),
     ylim = c(-5,1),
     main = expression(log[10](italic(N)[e]/italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logmeanNe2ncs <- data.frame(x = logmeanNe2ncs,
                                y = reg_logmeanNe2ncs$model.rf$predictions)

#save(oob.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logmeanNe2ncs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(OOB prediction)")),
       xlim = c(-3.5,0.5),
       ylim = c(-3.5,0.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Theta of perid 2
```{r regression theta 2, echo=TRUE, eval=FALSE, include=TRUE}
genomeS = 100e+6
logtheta2 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"]) * genomeS)

hist(logtheta2, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")

reg_logtheta2 <- regAbcrf(formula = logtheta2~.,
                          data    = data.frame(logtheta2, global_sumstats),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 28)

#save(reg_logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2",".RData"))

## variable Importance plot
plot(x = reg_logtheta2, n.var = 20, main=expression(log[10](italic(θ))))

#head(sort(reg_logtheta2$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logtheta2$model.rf$prediction.error
# 0.02097791

## error rate plot
#err.regAbcrf(object   = reg_logtheta2,
#             training = data.frame(logtheta1, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logtheta2,
     y    = reg_logtheta2$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-2,6),
     ylim = c(-2,6),
     main = expression(log[10](italic(theta))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

# Manuscript plot
oob.logtheta2 <- data.frame(x = logtheta2,
                                y = reg_logtheta2$model.rf$predictions)

#save(oob.logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logtheta2, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(θ)))),
       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
       xlim = c(-1.5,6),
       ylim = c(-1.5,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Theta of perid 1
```{r regression theta, echo=TRUE, eval=FALSE, include=TRUE}
#genomeS = 100e+6
#logtheta1 <- log10(4 * pooled_reftable_total[, "meanNe1"] * (pooled_reftable_total[, "mu"]) * genomeS)
#
#hist(logtheta1, freq = TRUE, xlab = expression(log[10](italic(theta[1]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logtheta1 <- regAbcrf(formula = logtheta1~.,
#                          data    = data.frame(logtheta1, global_sumstats),
#                          ntree   = 1000,
#                          paral   = T,
#                          ncores  = 28)
#
#save(reg_logtheta1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))
#
## variable Importance plot
#plot(x = reg_logtheta1, n.var = 20)
#
#head(sort(reg_logtheta1$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logtheta1$model.rf$prediction.error
# 0.02243393
#
## error rate plot
#err.regAbcrf(object   = reg_logtheta1,
#             training = data.frame(logtheta1, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logtheta1,
#     y    = reg_logtheta1$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     main = expression(log[10](italic(theta[1]))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# Manuscript plot
#oob.logtheta1 <- data.frame(x = logtheta1,
#                                y = reg_logtheta1$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logtheta1, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(theta[1])))),
#       ylab = expression(paste(log[10](italic(hat(theta[1]))), " ","(OOB prediction)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Per site mutation rate mu
```{r regression site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}
#logmu <- log10(pooled_reftable_total[, "mu"])
#
#hist(logmu, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logmu <- regAbcrf(formula = logmu~.,
#                      data    = data.frame(logmu, global_sumstats),
#                      ntree   = 1000,
#                      paral   = T,
#                      ncores  = 28)
#
#save(reg_logmu, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))
#
## variable Importance plot
#plot(x = reg_logmu, n.var = 20)
#
#head(sort(reg_logmu$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logmu$model.rf$prediction.error
# 0.007331174
#
## error rate plot
#err.regAbcrf(object   = reg_logmu,
#             training = data.frame(logmu, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logmu,
#     y    = reg_logmu$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-6),
#     ylim = c(-10,-6),
#     main = expression(log[10](italic(mu))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# Manuscript plot
#oob.logmu <- data.frame(x = logmu,
#                        y = reg_logmu$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logmu, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(mu)))),
#       ylab = expression(paste(log[10](italic(hat(mu))), " ","(OOB prediction)")),
#       xlim = c(-10,-6),
#       ylim = c(-10,-6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Rho = Nr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}
#logrho <- log10(pooled_reftable_total[, "meanNe2"] * pooled_reftable_total[, "rr"])
#
#hist(logrho, freq = TRUE, xlab = expression(log[10](italic(rho))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logrho <- regAbcrf(formula = logrho~.,
#                       data    = data.frame(logrho, global_sumstats),
#                       ntree   = 1000,
#                       paral   = T,
#                       ncores  = 28)
#
#save(reg_logrho, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))
#
## variable Importance plot
#plot(x = reg_logrho, n.var = 20)
#
#head(sort(reg_logrho$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logrho$model.rf$prediction.error
#  0.399973
#
## error rate plot
#err.regAbcrf(object   = reg_logrho,
#             training = data.frame(logrho, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logrho,
#     y    = reg_logrho$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-2),
#     ylim = c(-10,-2),
#     main = expression(log[10](italic(rho))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logrho <- data.frame(x = logrho,
#                         y = reg_logrho$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logrho, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(rho)))),
#       ylab = expression(paste(log[10](italic(hat(rho))), " ","(OOB prediction)")),
#       xlim = c(-9,-3),
#       ylim = c(-9,-3),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### recombination rate rr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}
#logrr <- log10(pooled_reftable_total[, "rr"])
#
#hist(logrr, freq = TRUE, xlab = expression(log[10](italic(r))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logrr <- regAbcrf(formula = logrr~.,
#                       data    = data.frame(logrr, global_sumstats),
#                       ntree   = 1000,
#                       paral   = T,
#                       ncores  = 8)
#
#save(reg_logrr, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrr",".RData"))
#
## variable Importance plot
#plot(x = reg_logrr, n.var = 20)
#
#head(sort(reg_logrr$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logrr$model.rf$prediction.error
#  0.3642414
#
## error rate plot
#err.regAbcrf(object   = reg_logrr,
#             training = data.frame(logrr, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logrr,
#     y    = reg_logrr$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-6),
#     ylim = c(-10,-6),
#     main = expression(log[10](italic(r))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logrr <- data.frame(x = logrr,
#                         y = reg_logrr$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logrr, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(r)))),
#       ylab = expression(paste(log[10](italic(hat(r))), " ","(OOB prediction)")),
#       xlim = c(-10,-6),
#       ylim = c(-10,-6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

## Sampling period inference

### ABC-RF classification for selection: prediction

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification neutral selection, echo=TRUE, eval=FALSE, include=TRUE}

### RANDOM PODS
###-----------------------------------------------------------

## rf-classification
posterior_class_selection_1 <- predict(object     = class_selection_1,
                                       obs        = global_sumstats_pods[,-c(117)],
                                       training   = data.frame(selection_1, global_sumstats[,-c(117)]),
                                       ntree      = 1000,
                                       paral      = TRUE,
                                       paral.predict = TRUE,
                                       ncores     = 2)

#save(posterior_class_selection_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))

#(posterior_class_selection_1)

## True Classification based on POPPrStrongMSel
selection_1_pods <- ifelse(pooled_reftable_pods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_pods)

class_selection_1_table <- data.frame(obs=selection_1_pods, pred=posterior_class_selection_1$allocation)
table(class_selection_1_table)

#Confusion matrix: classification of 1000 RANDOM PODs
#          pred
#obs        qNeutral sSel class.error
#  qNeutral      709  164 0.187858
#  sSel          201  803 0.2001992

#TPR = 709/(709+201) = 0.7791209 #sensitivity, recall
#TNR = 803/(803+164) = 0.8304033 #specificity, selectivity
#PPV = 709/(709+164) = 0.812142 # precision
#NPV = 803/(803+201) = 0.7998008

## Global error rate
class_sel_1_global_error <- ifelse(class_selection_1_table$obs == class_selection_1_table$pred, 0, 1)
sum(class_sel_1_global_error)/length(class_sel_1_global_error)
# global error = 0.1944592

## Keep 1000 random PODs and mark those that were classified as qNeutral
neutral_randompods <- which(posterior_class_selection_1$allocation == "qNeutral")

### FIXED PODS
###-----------------------------------------------------------

## rf-classification
posterior_class_selection_1_fixedpods <- predict(object        = class_selection_1,
                                                 obs           = global_sumstats_fixedpods[,-c(117)],
                                                 training      = data.frame(selection_1, global_sumstats[,-c(117)]),
                                                 ntree         = 1000,
                                                 paral         = TRUE,
                                                 paral.predict = TRUE,
                                                 ncores        = 28)

#save(posterior_class_selection_1_fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))

#(posterior_class_selection_1_fixedpods)

## True Classification based on POPPrStrongMSel
selection_1_fixedpods <- ifelse(pooled_reftable_fixedpods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_fixedpods)

class_selection_1_table_fixedpods <- data.frame(obs=selection_1_fixedpods, pred=posterior_class_selection_1_fixedpods$allocation)
table(class_selection_1_table_fixedpods)
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      164    6  0.03529412
#  sSel           30  100  0.2307692

## Global error rate
class_sel_1_global_error_fixedpods <- ifelse(class_selection_1_table_fixedpods$obs == class_selection_1_table_fixedpods$pred, 0, 1)
sum(class_sel_1_global_error_fixedpods)/length(class_sel_1_global_error_fixedpods)
# global error = 0.12

## NEUTRAL
table(class_selection_1_table_fixedpods[1:100, ])
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      100    0  0
#  sSel            0    0  0
#
#TPR = 100/(100+0) = 1 #sensitivity, recall
#TNR = 0/(0+0) = NaN #specificity, selectivity
#PPV = 100/(100+0) = 1 # precision
#NPV = 0/(0+0) = NaN

sum(class_sel_1_global_error_fixedpods[1:100])/length(class_sel_1_global_error_fixedpods[1:100])
# global error rate = 0

## MUTATION LIMITED s = 0.1
table(class_selection_1_table_fixedpods[101:200, ])
#          pred
#obs        qNeutral sSel error.rate
#  qNeutral       64    6 0.08571429
#  sSel           30    0 1
#
#TPR = 64/(64+30) = 0.6808511 #sensitivity, recall
#TNR = 0/(0+6) = 0 #specificity, selectivity
#PPV = 64/(64+6) = 0.9142857 # precision
#NPV = 0/(0+30) = 0

sum(class_sel_1_global_error_fixedpods[101:200])/length(class_sel_1_global_error_fixedpods[101:200])
# global error rate = 0.36

## MUTATION UNLIMITED s = 0.1
table(class_selection_1_table_fixedpods[201:300, ])
#          pred
#obs        qNeutral sSel class.error
#  qNeutral        0    0 0
#  sSel            0  100 0
#
#TPR = 0/(0+0) = NaN #sensitivity, recall
#TNR = 100/(100+0) = 1 #specificity, selectivity
#PPV = 0/(0+0) = NaN # precision
#NPV = 100/(100+0) = 1

sum(class_sel_1_global_error_fixedpods[201:300])/length(class_sel_1_global_error_fixedpods[201:300])
# global error rate = 0

### FIXED PODS ADDITIONAL
###-----------------------------------------------------------

## rf-classification
posterior_class_selection_1_fixedpods_add <- predict(object        = class_selection_1,
                                                     obs           = global_sumstats_fixedpods_add[,-c(117)],
                                                     training      = data.frame(selection_1, global_sumstats[,-c(117)]),
                                                     ntree         = 1000,
                                                     paral         = TRUE,
                                                     paral.predict = TRUE,
                                                     ncores        = 28)

#save(posterior_class_selection_1_fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add",".RData"))

#(posterior_class_selection_1_fixedpods_add)

## True Classification based on POPPrStrongMSel
selection_1_fixedpods_add <- ifelse(pooled_reftable_fixedpods_add[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_fixedpods_add)

class_selection_1_table_fixedpods_add <- data.frame(obs=selection_1_fixedpods_add, pred=posterior_class_selection_1_fixedpods_add$allocation)

## Global error rate
class_sel_1_global_error_fixedpods_add <- ifelse(class_selection_1_table_fixedpods_add$obs == class_selection_1_table_fixedpods_add$pred, 0, 1)

## MUTATION LIMITED s = 0.01
table(class_selection_1_table_fixedpods_add[1:100, ])
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      96    1   0.01030928
#  sSel           3    0   1
#
#TPR = 96/(96+3) = 0.969697 #sensitivity, recall
#TNR = 0/(0+1) = 0 #specificity, selectivity
#PPV = 96/(96+1) = 0.9896907 # precision
#NPV = 0/(0+3) = 0

sum(class_sel_1_global_error_fixedpods_add[1:100])/length(class_sel_1_global_error_fixedpods_add[1:100])
# global error rate = 0.04

## MUTATION LIMITED s = 0.25
table(class_selection_1_table_fixedpods_add[101:200, ])
#          pred
#obs        qNeutral sSel error.rate
#  qNeutral       39   11 0.2340426
#  sSel           36   14 0.72
#
#TPR = 39/(39+36) = 0.52 #sensitivity, recall
#TNR = 14/(14+11) = 0.56 #specificity, selectivity
#PPV = 39/(39+11) = 0.78 # precision
#NPV = 14/(14+36) = 0.28

sum(class_sel_1_global_error_fixedpods_add[101:200])/length(class_sel_1_global_error_fixedpods_add[101:200])
# global error rate = 0.47

## MUTATION UNLIMITED s = 0.01
table(class_selection_1_table_fixedpods_add[201:300, ])
#          pred
#obs        qNeutral sSel class.error
#  qNeutral        0    0 0
#  sSel            0  100 0
#
#TPR = 0/(0+0) = NaN #sensitivity, recall
#TNR = 100/(100+0) = 1 #specificity, selectivity
#PPV = 0/(0+0) = NaN # precision
#NPV = 100/(100+0) = 1

sum(class_sel_1_global_error_fixedpods_add[201:300])/length(class_sel_1_global_error_fixedpods_add[201:300])
# global error rate = 0

## MUTATION UNLIMITED s = 0.25
table(class_selection_1_table_fixedpods_add[301:400, ])
#          pred
#obs        qNeutral sSel class.error
#  qNeutral        0    0 0
#  sSel            0  100 0
#
#TPR = 0/(0+0) = NaN #sensitivity, recall
#TNR = 100/(100+0) = 1 #specificity, selectivity
#PPV = 0/(0+0) = NaN # precision
#NPV = 100/(100+0) = 1

sum(class_sel_1_global_error_fixedpods_add[301:400])/length(class_sel_1_global_error_fixedpods_add[301:400])
# global error rate = 0
```

### ABC-RF regression for selection: prediction

#### Average genetic load
```{r prediction genetic load, echo=TRUE, eval=FALSE, include=TRUE}
### RANDOM PODs
###-----------------------------------------------------------

#posterior_radnompods_averageGenLoad <- predict(object     = reg_averageGenLoad,
#                                               obs        = global_sumstats_pods,
#                                               training   = data.frame(logaverageGenload, global_sumstats),
#                                               quantiles  = c(0.025,0.5,0.975),
#                                               paral      = T,
#                                               ncores     = 2,
#                                               rf.weights = T)
#
#save(posterior_radnompods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))
#
## prepare the vector with the true values - transformed
#log_randompods_averageGenLoad <- -log10(1-pooled_reftable_pods[, "averageGeneticLoad"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = log_randompods_averageGenLoad[-neutral_randompods], 
#     y    = posterior_radnompods_averageGenLoad$expectation[-neutral_randompods],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     main = expression(log[10](italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation I:
posterior_radnompods_averageGenLoad_2 <- predict(object     = reg_averageGenLoad_2,
                                                 obs        = global_sumstats_pods,
                                                 training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                 quantiles  = c(0.025,0.5,0.975),
                                                 paral      = T,
                                                 ncores     = 6,
                                                 rf.weights = T)

#save(posterior_radnompods_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad_2",".RData"))

## prepare the vector with the true values - transformed
logitaverageGenload_randompods <- log(pooled_reftable_pods[, "averageGeneticLoad"]/(1-pooled_reftable_pods[, "averageGeneticLoad"]))

# -Inf for the lowest -1 value 
logitaverageGenload_randompods <- replace(logitaverageGenload_randompods,
                                          logitaverageGenload_randompods == -Inf, -17)
## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations ? 
plot(x    = logitaverageGenload_randompods, 
     y    = posterior_radnompods_averageGenLoad_2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-17,6),
     ylim = c(-17,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtgl <- data.frame(x = logitaverageGenload_randompods,
                         y = posterior_radnompods_averageGenLoad_2$expectation)
#save(pred.lgtgl, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.lgtgl, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(L)))),
       ylab = expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")),
       xlim = c(-17,6),
       ylim = c(-17,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

### FIXED PODs
###-----------------------------------------------------------

#posterior_fixedpods_averageGenLoad <- predict(object     = reg_averageGenLoad,
#                                              obs        = global_sumstats_fixedpods,
#                                              training   = data.frame(logaverageGenload, global_sumstats),
#                                              quantiles  = c(0.025,0.5,0.975),
#                                              paral      = T,
#                                              ncores     = 28,
#                                              rf.weights = T)
#
#save(posterior_fixedpods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))
#
## prepare the vector with the true values - transformed
#log_fixedpods_averageGenLoad <- -log10(1-pooled_reftable_fixedpods[, "averageGeneticLoad"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = log_fixedpods_averageGenLoad, 
#     y    = posterior_fixedpods_averageGenLoad$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     main = expression(log[10](italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation I:
posterior_fixedpods_averageGenLoad_2 <- predict(object     = reg_averageGenLoad_2,
                                                obs        = global_sumstats_fixedpods,
                                                training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                quantiles  = c(0.025,0.5,0.975),
                                                paral      = T,
                                                ncores     = 6,
                                                rf.weights = T)

#save(posterior_fixedpods_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2",".RData"))

## prepare the vector with the true values - transformed
logitaverageGenload_fixedpods <- log(pooled_reftable_fixedpods[, "averageGeneticLoad"]/(1-pooled_reftable_fixedpods[, "averageGeneticLoad"]))

# -Inf for the lowest -1 value 
logitaverageGenload_fixedpods <- replace(logitaverageGenload_fixedpods,
                                          logitaverageGenload_fixedpods == -Inf, -17)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitaverageGenload_fixedpods[-c(1:100)], 
     y    = posterior_fixedpods_averageGenLoad_2$expectation[-c(1:100)],
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-17,6),
     ylim = c(-17,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtgl.fixedpods <- data.frame(x = logitaverageGenload_fixedpods[-c(1:100)],
                                   y = posterior_fixedpods_averageGenLoad_2$expectation[-c(1:100)],
                                   c = c(rep("limited", 100), rep("unlimited", 100)))

#save(pred.lgtgl.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods",".RData"))

ggplot(pred.lgtgl.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(L))))) +
  ylab(expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")))+
  xlim(-17, 4) +
  ylim(-17, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

<<<<<<< HEAD
### FIXED PODs ADDITIONAL
###-----------------------------------------------------------
=======
#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r prediction strongly selected, echo=TRUE, eval=FALSE, include=TRUE}
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

## logit transformation I:
posterior_fixedpods_averageGenLoad_2_add <- predict(object     = reg_averageGenLoad_2,
                                                    obs        = global_sumstats_fixedpods_add,
                                                    training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                    quantiles  = c(0.025,0.5,0.975),
                                                    paral      = T,
                                                    ncores     = 6,
                                                    rf.weights = T)

#save(posterior_fixedpods_averageGenLoad_2_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add",".RData"))

## prepare the vector with the true values - transformed
logitaverageGenload_fixedpods_add <- log(pooled_reftable_fixedpods_add[, "averageGeneticLoad"]/(1-pooled_reftable_fixedpods_add[, "averageGeneticLoad"]))

# -Inf for the lowest -1 value 
logitaverageGenload_fixedpods_add <- replace(logitaverageGenload_fixedpods_add,
                                             logitaverageGenload_fixedpods_add == -Inf, -17)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitaverageGenload_fixedpods_add, 
     y    = posterior_fixedpods_averageGenLoad_2_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-17,6),
     ylim = c(-17,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

<<<<<<< HEAD
# manuscript plot
pred.lgtgl.fixedpods_add <- data.frame(x = logitaverageGenload_fixedpods_add,
                                       y = posterior_fixedpods_averageGenLoad_2_add$expectation,
                                       c = c(rep("limited", 200), rep("unlimited", 200)))

#save(pred.lgtgl.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add",".RData"))

ggplot(pred.lgtgl.fixedpods_add[c(101:200,301:400),], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(L))))) +
  ylab(expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")))+
  xlim(-17, 4) +
  ylim(-17, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r prediction strongly selected, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------

# log10 transformation
#posterior_radnompods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                 obs        = global_sumstats_pods,
#                                                 training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                                 quantiles  = c(0.025,0.5,0.975),
#                                                 paral      = T,
#                                                 ncores     = 20,
#                                                 rf.weights = T)
#
#save(posterior_radnompods_logpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#
## prepare the vector with the true values - transformed
#log_radnompods_popstrongmsel <- log10(pooled_reftable_pods[, "POPPrStrongMSel"])
#log_radnompods_popstrongmsel[which(log_radnompods_popstrongmsel == -Inf)] <- -7

## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_radnompods_popstrongmsel[-neutral_randompods], 
#     y    = posterior_radnompods_logpopstrongmsel$expectation[-neutral_randompods],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     main = expression(log[10](italic(P))), 
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation
##--------------------------------------

posterior_radnompods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_pods,
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 28,
                                                   rf.weights = T)

#save(posterior_radnompods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))

## prepare the vector with the true values - transformed
logitpopstrongmsel_radnompods <- log(pooled_reftable_pods[, "POPPrStrongMSel"]/(1-pooled_reftable_pods[, "POPPrStrongMSel"]))

# -Inf for the lowest -1 value 
logitpopstrongmsel_radnompods <- replace(logitpopstrongmsel_radnompods,
                                         logitpopstrongmsel_radnompods == -Inf, -15)

## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations 
plot(x    = logitpopstrongmsel_radnompods, 
     y    = posterior_radnompods_logitpopstrongmsel$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-15,2),
     ylim = c(-15,2),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtps <- data.frame(x = logitpopstrongmsel_radnompods,
                         y = posterior_radnompods_logitpopstrongmsel$expectation)
#save(pred.lgtps, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.lgtps, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(P)))),
       ylab = expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")),
       xlim = c(-15,2),
       ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

#popstrongmsel_applic_data = data.frame(pooled_reftable_pods[-qneutral_qneutral, c("sim", "meanNe2")], 
#                                       True_popstrongmsel=pooled_reftable_pods[-qneutral_qneutral,"POPPrStrongMSel"], 
#                                       Infe_popstrongmsel = inv.logit(posterior_radnompods_logpopstrongmsel$expectation))
#
#cl <- makeCluster(5)
#registerDoParallel(cl)
#clusterEvalQ(cl)
#  
## PARALLEL PROCESSING
#------------------------------------------
#popstrongmsel_calc <- foreach(i=1:length(popstrongmsel_applic_data$sim),
#                              .combine=rbind, 
#                              .errorhandling="pass", .verbose = TRUE) %dopar% { library(ROCR)
#                                                                                selstrongthreshold(x = popstrongmsel_applic_data[i,], tau = 10)}
#stopCluster(cl)
#
#save(popstrongmsel_calc, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))

=======
## get the random pods were truly classified as quasi-Neutral
qneutral_qneutral <- which(selection_1_pods == "qNeutral" & posterior_class_selection_1$allocation == "qNeutral")

# remove the correct qNeutral-qNeutral classification
class_selection_1_table_sSel <- class_selection_1_table[-qneutral_qneutral,]

# color code the remaining classification
class_selection_1_table_sSel$col_classi<- ifelse(class_selection_1_table_sSel$obs == "qNeutral" & class_selection_1_table_sSel$pred == "sSel", "#a50026",
                                                 ifelse(class_selection_1_table_sSel$obs == "sSel" & class_selection_1_table_sSel$pred == "qNeutral", "#fdae61", "#006837"))

## RANDOM PODs
##-----------------------------------------------------------

## log10 Pstrong
##--------------------------------------

posterior_radnompods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
                                                 obs        = global_sumstats_pods,
                                                 training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
                                                 quantiles  = c(0.025,0.5,0.975),
                                                 paral      = T,
                                                 ncores     = 20,
                                                 rf.weights = T)

#(posterior_radnompods_logpopstrongmsel)

#save(posterior_radnompods_logpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))

## log10 transformation
log_radnompods_popstrongmsel <- log10(pooled_reftable_pods[, "POPPrStrongMSel"])
log_radnompods_popstrongmsel[which(log_radnompods_popstrongmsel == -Inf)] <- -7

hist(log_radnompods_popstrongmsel, freq = TRUE, xlab = expression(log[10](italic(P[strong]))), main = "", col = "#bdbdbd")

## Expected True vs estimated
plot(x    = log_radnompods_popstrongmsel[-qneutral_qneutral], 
     y    = posterior_radnompods_logpopstrongmsel$expectation[-qneutral_qneutral],
     xlim = c(-7,0),
     ylim = c(-7,0),
     xlab = expression(log[10](italic(P[strong]))), 
     ylab = expression(hat(log[10](italic(P[strong])))),
     col  = class_selection_1_table_sSel$col_classi,
     pch  = 1
     )
legend("bottomright", legend = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel"), col = c("#a50026", "#f46d43","#006837"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")

## logit Pstrong
##--------------------------------------

posterior_radnompods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_pods,
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 28,
                                                   rf.weights = T)

#(posterior_radnompods_logitpopstrongmsel)

#save(posterior_radnompods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))

## logit transformation
logit_radnompods_popstrongmsel <- log(pooled_reftable_pods[, "POPPrStrongMSel"]/(1-pooled_reftable_pods[, "POPPrStrongMSel"]))
logit_radnompods_popstrongmsel[which(logit_radnompods_popstrongmsel == -Inf)] <- -15

hist(logit_radnompods_popstrongmsel, freq = TRUE, xlab = expression(log[10](italic(P[strong]))), main = "", col = "#bdbdbd")

## Expected True vs estimated
plot(x    = logit_radnompods_popstrongmsel[-qneutral_qneutral], 
     y    = posterior_radnompods_logitpopstrongmsel$expectation[-qneutral_qneutral],
     xlim = c(-15,2),
     ylim = c(-15,2),
     xlab = expression(logit(italic(P[strong]))), 
     ylab = expression(hat(logit(italic(P[strong])))),
     col  = class_selection_1_table_sSel$col_classi,
     pch  = 1
     )
legend("bottomright", legend = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel"), col = c("#a50026", "#f46d43","#006837"), pch = 1, bty = "n")
abline(a=0, b=1, col = "#cb181d")

## ggplot2 plots
# prepar the table for ggplot 
randompods_popstrongmsel_table <- data.frame(est_1=posterior_radnompods_logpopstrongmsel$expectation[-qneutral_qneutral],
                                             obs_1=log_radnompods_popstrongmsel[-qneutral_qneutral],
                                             est_2=posterior_radnompods_logitpopstrongmsel$expectation[-qneutral_qneutral],
                                             obs_2=logit_radnompods_popstrongmsel[-qneutral_qneutral],
                                             rfclass=ifelse(class_selection_1_table_sSel$obs == "qNeutral" & class_selection_1_table_sSel$pred == "sSel", "a",
                                                 ifelse(class_selection_1_table_sSel$obs == "sSel" & class_selection_1_table_sSel$pred == "qNeutral", "b", "c"))
                                             )

## Pstrong in log10 scale - color code by "true-predicted" classification
ggplot(randompods_popstrongmsel_table, aes(x=obs_1 , y=est_1, color=rfclass)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#a50026","#f46d43","#006837"),
                      name   = "True-Predicted",
                      breaks = c("a","b","c"),
                      labels = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel")) + 
  xlab(expression(log[10](italic(P[strong])))) +
  ylab(expression(hat(log[10](italic(P[strong])))))+
  xlim(-7,0) +
  ylim(-7,0) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                     legend.position = "right", axis.text = element_text(size = 12),
                     axis.title=element_text(size=14))

## Pstrong in logit scale - color code by the the "true-predicted" classification
ggplot(randompods_popstrongmsel_table, aes(x=obs_2 , y=est_2, color=rfclass)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#a50026","#f46d43","#006837"),
                      name   = "True-Predicted",
                      breaks = c("a","b","c"),
                      labels = c("qNeutral-sSel", "sSel-qNeutral", "sSel-sSel")) + 
  xlab(expression(paste("True"," ",logit(P[strong])))) +
  ylab(expression(paste("ABC-RF", " ",logit(P[strong])))) +
  xlim(-15,2) +
  ylim(-15,2) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                     legend.position = "right", axis.text = element_text(size = 11),
                     axis.title=element_text(size=12))

#popstrongmsel_applic_data = data.frame(pooled_reftable_pods[-qneutral_qneutral, c("sim", "meanNe2")], 
#                                       True_popstrongmsel=pooled_reftable_pods[-qneutral_qneutral,"POPPrStrongMSel"], 
#                                       Infe_popstrongmsel = inv.logit(posterior_radnompods_logpopstrongmsel$expectation))
#
#cl <- makeCluster(5)
#registerDoParallel(cl)
#clusterEvalQ(cl)
#  
## PARALLEL PROCESSING
#------------------------------------------
#popstrongmsel_calc <- foreach(i=1:length(popstrongmsel_applic_data$sim),
#                              .combine=rbind, 
#                              .errorhandling="pass", .verbose = TRUE) %dopar% { library(ROCR)
#                                                                                selstrongthreshold(x = popstrongmsel_applic_data[i,], tau = 10)}
#stopCluster(cl)
#
#save(popstrongmsel_calc, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))


## FIXED PODs
##-----------------------------------------------------------

## log10 Pstrong
##--------------------------------------

posterior_fixedpods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
                                                obs        = global_sumstats_fixedpods,
                                                training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
                                                quantiles  = c(0.025,0.5,0.975),
                                                paral      = T,
                                                ncores     = 20,
                                                rf.weights = T)

#(posterior_fixedpods_logpopstrongmsel)

#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))

log_fixedpods_popstrongmsel <- log10(pooled_reftable_fixedpods[, "POPPrStrongMSel"])
log_fixedpods_popstrongmsel[which(log_fixedpods_popstrongmsel == -Inf)] <- -7

## Expected True vs estimated
plot(x    = log_fixedpods_popstrongmsel[-c(1:100)], 
     y    = posterior_fixedpods_logpopstrongmsel$expectation[-c(1:100)],
     xlim = c(-7,0),
     ylim = c(-7,0),
     xlab = expression(log[10](italic(P[strong]))), 
     ylab = expression(hat(log[10](italic(P[strong])))),
     pch  = 1,
     col  = c(rep("#ff7f00",100), rep("#e31a1c",100))
     )
abline(a=0, b=1, col = "#cb181d")

## logit Pstrong
##--------------------------------------

posterior_fixedpods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_fixedpods,
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 28,
                                                   rf.weights = T)

#(posterior_fixedpods_logitpopstrongmsel)

#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))

logit_fixedpods_popstrongmsel <- log(pooled_reftable_fixedpods[, "POPPrStrongMSel"]/(1-pooled_reftable_fixedpods[, "POPPrStrongMSel"]))
logit_fixedpods_popstrongmsel[which(logit_fixedpods_popstrongmsel == -Inf)] <- -15

## Expected True vs estimated
plot(x    = logit_fixedpods_popstrongmsel[-c(1:100)], 
     y    = posterior_fixedpods_logitpopstrongmsel$expectation[-c(1:100)],
     xlim = c(-15,2),
     ylim = c(-15,2),
     xlab = expression(logit(italic(P[strong]))), 
     ylab = expression(hat(logit(italic(P[strong])))),
     pch  = 1,
     col  = c(rep("#ff7f00",100), rep("#e31a1c",100))
     )
abline(a=0, b=1, col = "#cb181d")

## prepar the table for ggplot 
fixedpods_popstrongmsel_table <- data.frame(est_1=posterior_fixedpods_logpopstrongmsel$expectation[-c(1:100)],
                                            obs_1=log_fixedpods_popstrongmsel[-c(1:100)],
                                            est_2=posterior_fixedpods_logitpopstrongmsel$expectation[-c(1:100)],
                                            obs_2=logit_fixedpods_popstrongmsel[-c(1:100)],
                                            scenario=c(rep("limited",100),rep("unlimited",100)))

## Pstrong in log10 scale - color code by the scenario
ggplot(fixedpods_popstrongmsel_table, aes(x=obs_1 , y=est_1, color=scenario)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#ff7f00","#e31a1c"),
                    name   = "Scenario",
                    breaks = c("limited", "unlimited"),
                    labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(log[10](italic(P[strong])))) +
  ylab(expression(hat(log[10](italic(P[strong])))))+
  xlim(-7, 0) +
  ylim(-7, 0) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                              legend.position = "right", axis.text = element_text(size = 12),
                              axis.title=element_text(size=14))

## Pstrong in logit scale - color code by the scenario
ggplot(fixedpods_popstrongmsel_table, aes(x=obs_2 , y=est_2, color=scenario)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#ff7f00","#e31a1c"),
                    name   = "Scenario",
                    breaks = c("limited", "unlimited"),
                    labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(logit(italic(P[strong])))) +
  ylab(expression(hat(logit(italic(P[strong])))))+
  xlim(-15, 2) +
  ylim(-15, 2) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                              legend.position = "right", axis.text = element_text(size = 12),
                              axis.title=element_text(size=14))

## boxplot
fixedpods_logitpopstrongmsel_data <- data.frame(model  = c(rep("A", 200), rep("B", 200)), 
                                                type   = c(rep("a",100), rep("b",100), 
                                                           rep("a",100), rep("b",100)),
                                                 values = c(logit_fixedpods_popstrongmsel[101:200], posterior_fixedpods_logitpopstrongmsel$expectation[101:200], 
                                                            logit_fixedpods_popstrongmsel[201:300], posterior_fixedpods_logitpopstrongmsel$expectation[201:300]))

boxplot(fixedpods_logitpopstrongmsel_data$values ~ fixedpods_logitpopstrongmsel_data$type * fixedpods_logitpopstrongmsel_data$model,
        lwd = 2,
        ylim = c(-11,0),
        ylab = expression(logit(P[strong])),
        xlab = "",
        xaxt = "n",
        cex.axis = 0.8,
        cex.lab  = 1,
        col = c(rep("#ff7f00",2),rep("#e31a1c",2)))
abline(h=c(-10.12411,-7.998965,-3.910197,-3.590937), col = c("blue","green3"), lty = 3)
legend("topleft", legend = c("mutation limited", "mutation unlimited", "true lower limit","true upper limit"), 
       col = c("#ff7f00","#e31a1c","blue","green3"), pch = c(15,15,26,26), lty = c(0,0,3,3), bty = "n")
axis(side = 1, at = 1:4, labels = FALSE)
text(x = 1:4, 
     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
     srt=90, 
     adj=1, 
     xpd=TRUE, 
     labels = paste(rep(c("True", "ABC-RF"),2)),
     cex = 1)

```

#### ThetaS - selected mutations
```{r prediction thetaS, echo=TRUE, eval=FALSE, include=TRUE}

# prepare a table with the true classification and the RF classification
load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))
selection_1_pods <- ifelse(pooled_reftable_pods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")

class_selection_1_table <- data.frame(pred=posterior_class_selection_1$allocation, obs=selection_1_pods)
table(class_selection_1_table)

rfclass <- ifelse(class_selection_1_table$obs == "qNeutral" & class_selection_1_table$pred == "qNeutral", "a",
                   ifelse(class_selection_1_table$obs == "qNeutral" & class_selection_1_table$pred == "sSel", "b", 
                           ifelse(class_selection_1_table$obs == "sSel" & class_selection_1_table$pred == "qNeutral", "c","d")))
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d


### ThetaS based on PrGWSel * PrMSel * mu
###--------------------------------------

## RANDOM PODs
##-----------------------------------------------------------
<<<<<<< HEAD

## log10 transformation
#posterior_fixedpods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                obs        = global_sumstats_fixedpods,
#                                                training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                                quantiles  = c(0.025,0.5,0.975),
#                                                paral      = T,
#                                                ncores     = 20,
#                                                rf.weights = T)
#
#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))
#
## prepare the vector with the true values - transformed
#log_fixedpods_popstrongmsel <- log10(pooled_reftable_fixedpods[, "POPPrStrongMSel"])
#log_fixedpods_popstrongmsel[which(log_fixedpods_popstrongmsel == -Inf)] <- -7
#
## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_fixedpods_popstrongmsel[-c(1:100)], 
#     y    = posterior_fixedpods_logpopstrongmsel$expectation[-c(1:100)],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     main = expression(log[10](italic(P))), 
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation
posterior_fixedpods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_fixedpods,
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 6,
                                                   rf.weights = T)

#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))

## prepare the vector with the true values - transformed
logitpopstrongmsel_fixedpods <- log(pooled_reftable_fixedpods[, "POPPrStrongMSel"]/(1-pooled_reftable_fixedpods[, "POPPrStrongMSel"]))

# -Inf for the lowest -1 value 
logitpopstrongmsel_fixedpods <- replace(logitpopstrongmsel_fixedpods,
                                        logitpopstrongmsel_fixedpods == -Inf, -15)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitpopstrongmsel_fixedpods[-c(1:100)], 
     y    = posterior_fixedpods_logitpopstrongmsel$expectation[-c(1:100)],
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-15,2),
     ylim = c(-15,2),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2
=======
posterior_radnompods_logthetaS <- predict(object     = reg_logthetaS,
                                          obs        = global_sumstats_pods,
                                          training   = data.frame(logthetaS, global_sumstats),
                                          quantiles  = c(0.025,0.5,0.975),
                                          paral      = T,
                                          ncores     = 28,
                                          rf.weights = T)

#(posterior_radnompods_logthetaS)

#save(posterior_radnompods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))

## prepare the vector with the true values
genomeS = 100e+06
prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]
randompods_thetaS <- 4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS
log_randompods_thetaS <- log10(randompods_thetaS)

hist(log_randompods_thetaS, freq = TRUE, xlab = expression(log[10](italic(theta[s[(2)]]))), main = "", col = "#bdbdbd")

## Expected True vs estimated
plot(x    = log_randompods_thetaS, 
     y    = posterior_radnompods_logthetaS$expectation,
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(log[10](italic(theta[s]))), 
     ylab = expression(hat(log[10](italic(theta[s])))),
     pch  = 1,
     cex.axis = 1
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
     )
abline(a=0, b=1, col = "green")

<<<<<<< HEAD
# manuscript plot
pred.lgtps.fixedpods <- data.frame(x = logitpopstrongmsel_fixedpods[-c(1:100)],
                                   y = posterior_fixedpods_logitpopstrongmsel$expectation[-c(1:100)],
                                   c = c(rep("limited", 100), rep("unlimited", 100)))

#save(pred.lgtps.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods",".RData"))
=======
## prepar the table for ggplot 
log_randompods_thetaS_table <- data.frame(est=posterior_radnompods_logthetaS$expectation,
                                          obs=log_randompods_thetaS,
                                          trueclass = ifelse(pooled_reftable_pods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel"),
                                          rfclass = rfclass,
                                          averagegenload = pooled_reftable_pods[, "averageGeneticLoad"],
                                          logprstrong = log10(pooled_reftable_pods[, "POPPrStrongMSel"]))

## color code by the true classification
ggplot(log_randompods_thetaS_table, aes(x=obs , y=est, color=trueclass)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#74add1","#f46d43"),
                    name   = "Classification",
                    breaks = c("qNeutral", "sSel"),
                    labels = c("quasi-Neutral", "strong-Selection")) + 
  xlab(expression(log[10](italic(theta[s])))) +
  ylab(expression(hat(log[10](italic(theta[s])))))+
  xlim(-7, 5) +
  ylim(-7, 5) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(#panel.border = element_blank(), 
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                     legend.position = "right", axis.text = element_text(size = 12),
                     axis.title=element_text(size=14))

## color code by the ABC-RF classification
ggplot(log_randompods_thetaS_table, aes(x=obs , y=est, color=rfclass)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#a6d96a", "#a50026", "#fdae61", "#006837"),
                    name   = "True-Predicted",
                    breaks = c("a","b","c","d"),
                    labels = c("qNeutral-qNeutral","qNeutral-sSel","sSel-qNeutral","sSel-sSel")) + 
  xlab(expression(paste("True", " ",log[10](italic(theta[s]))))) +
  ylab(expression(paste("ABC-RF"," ",log[10](italic(theta[s]))))) +
  xlim(-7, 5) +
  ylim(-7, 5) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                     legend.position = "right", axis.text = element_text(size = 11),
                     axis.title=element_text(size=12))

## color code by genetic load 
ggplot(log_randompods_thetaS_table, aes(x=obs , y=est, color=averagegenload)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_color_gradient(low = "blue", high = "red") +
  labs(colour="Genetic load") +
  xlab(expression(paste("True", " ",log[10](italic(theta[s]))))) +
  ylab(expression(paste("ABC-RF"," ",log[10](italic(theta[s]))))) +
  xlim(-7, 5) +
  ylim(-7, 5) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA),
                     panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                     legend.position = "right", axis.text = element_text(size = 11),
                     axis.title=element_text(size=12))

## FIXED PODs
##-----------------------------------------------------------
posterior_fixedpods_logthetaS <- predict(object     = reg_logthetaS,
                                         obs        = global_sumstats_fixedpods,
                                         training   = data.frame(logthetaS, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 28,
                                         rf.weights = T)

#(posterior_fixedpods_logthetaS)

#save(posterior_fixedpods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))

## prepare the vector with the true values
genomeS = 100e+06
prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]
fixedpods_thetaS <- 4 * pooled_reftable_fixedpods[, "meanNe2"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS
log_fixedpods_thetaS <- log10(fixedpods_thetaS)

## Expected True vs estimated
plot(x    = log_fixedpods_thetaS, 
     y    = posterior_fixedpods_logthetaS$expectation,
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(log[10](italic(theta[s]))), 
     ylab = expression(hat(log[10](italic(theta[s])))),
     pch  = 1,
     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
     )
abline(a=0, b=1, col = "#cb181d")

## prepar the table for ggplot 
log_fixedpods_thetaS_table <- data.frame(est=posterior_fixedpods_logthetaS$expectation[-c(1:100)],
                                         obs=log_fixedpods_thetaS[-c(1:100)],
                                         scenario=c(rep("limited",100),rep("unlimited",100)))

## color code by the scenario
ggplot(log_fixedpods_thetaS_table, aes(x=obs , y=est, color=scenario)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#ff7f00","#e31a1c"),
                    name   = "Scenario",
                    breaks = c("limited", "unlimited"),
                    labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(log[10](italic(theta[s])))) +
  ylab(expression(hat(log[10](italic(theta[s])))))+
  xlim(-7, 5) +
  ylim(-7, 5) +
  geom_abline(intercept = 0, slope = 1, color = "black") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                              legend.position = "right", axis.text = element_text(size = 12),
                              axis.title=element_text(size=14))

## boxplot
fixedpods_logthetaS_data <- data.frame(model  = c(rep("A", 200), rep("B", 200)), 
                                       type   = c(rep("a",100), rep("b",100), 
                                                  rep("a",100), rep("b",100)),
                                       values = c(log_fixedpods_thetaS[101:200], posterior_fixedpods_logthetaS$expectation[101:200], 
                                                  log_fixedpods_thetaS[201:300], posterior_fixedpods_logthetaS$expectation[201:300]))

boxplot(fixedpods_logthetaS_data$values ~ fixedpods_logthetaS_data$type * fixedpods_logthetaS_data$model,
        lwd = 2,
        ylim = c(-3,3),
        ylab = expression(log[10](theta[s])),
        xlab = "",
        xaxt = "n",
        cex.axis = 0.8,
        cex.lab  = 1,
        col = c(rep("#ff7f00",2),rep("#e31a1c",2)))
abline(h=c(-0.3069679,-0.2361743,1.490587,1.911508), col = c("blue","green3"), lty = 3)
legend("bottomleft", legend = c("mutation limited", "mutation unlimited", "true lower limit","true upper limit"), 
       col = c("#ff7f00","#e31a1c","blue","green3"), pch = c(15,15,26,26), lty = c(0,0,3,3), bty = "n")
axis(side = 1, at = 1:4, labels = FALSE)
text(x = 1:4, 
     y = par()$usr[3]-0.03*(par()$usr[4]-par()$usr[3]), 
     srt=90, 
     adj=1, 
     xpd=TRUE, 
     labels = paste(rep(c("True", "ABC-RF"),2)),
     cex = 1)

### ThetaS based on POPPrMSel * mu
###--------------------------------------

## RANDOM PODs
##-----------------------------------------------------------
posterior_radnompods_logthetaS_2 <- predict(object     = reg_logthetaS_2,
                                            obs        = global_sumstats_pods,
                                            training   = data.frame(logthetaS_2, global_sumstats_popmsel),
                                            quantiles  = c(0.025,0.5,0.975),
                                            paral      = T,
                                            ncores     = 20,
                                            rf.weights = T)
#save(posterior_radnompods_logthetaS_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS_2",".RData"))

## prepare the vector with the true values
genomeS = 100e+06
prPOPMSel_randompods <- pooled_reftable_pods[, "POPPrMSel"]
randompods_thetaS_2 <- 4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"] * prPOPMSel_randompods) * genomeS
log_randompods_thetaS_2 <- log10(randompods_thetaS_2)

hist(log_randompods_thetaS_2, freq = TRUE, xlab = expression(log[10](italic(theta[s(2)]))), main = "", col = "#bdbdbd")

## Expected True vs estimated
plot(x    = log_randompods_thetaS_2, 
     y    = posterior_radnompods_logthetaS_2$expectation,
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(log[10](italic(theta[s]))), 
     ylab = expression(hat(log[10](italic(theta[s])))),
     pch  = 1
     )
abline(a=0, b=1, col = "#cb181d")

## FIXED PODs
##-----------------------------------------------------------
posterior_fixedpods_logthetaS_2 <- predict(object     = reg_logthetaS_2,
                                           obs        = global_sumstats_fixedpods,
                                           training   = data.frame(logthetaS_2, global_sumstats_popmsel),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 20,
                                           rf.weights = T)

#save(posterior_fixedpods_logthetaS_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS_2",".RData"))

## prepare the vector with the true values
genomeS = 100e+06
prPOPMSel_fixedpods <- pooled_reftable_fixedpods[, "POPPrMSel"]
fixedpods_thetaS_2 <- 4 * pooled_reftable_fixedpods[, "meanNe2"] * (pooled_reftable_fixedpods[, "mu"] * prPOPMSel_fixedpods) * genomeS
log_fixedpods_thetaS_2 <- log10(fixedpods_thetaS_2)

## Expected True vs estimated
plot(x    = log_fixedpods_thetaS_2[-c(1:100)], 
     y    = posterior_fixedpods_logthetaS_2$expectation[-c(1:100)],
     xlim = c(-7,5),
     ylim = c(-7,5),
     xlab = expression(log[10](italic(theta[s]))), 
     ylab = expression(hat(log[10](italic(theta[s])))),
     pch  = 1,
     col  = c(rep("#ff7f00",100), rep("#e31a1c",100))
     )
abline(a=0, b=1, col = "#cb181d")

### ThetaS based on POPPrStrongMSel * mu
###--------------------------------------

## RANDOM PODs
##-----------------------------------------------------------
posterior_radnompods_logthetaS_3 <- predict(object     = reg_logthetaS_3,
                                            obs        = global_sumstats_pods,
                                            training   = data.frame(logthetaS_3, global_sumstats_popstrongmsel),
                                            quantiles  = c(0.025,0.5,0.975),
                                            paral      = T,
                                            ncores     = 20,
                                            rf.weights = T)

#save(posterior_radnompods_logthetaS_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS_3",".RData"))
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d

ggplot(pred.lgtps.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(P))))) +
  ylab(expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")))+
  xlim(-15, 0) +
  ylim(-15, 0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## FIXED PODs ADDITIONAL
##-----------------------------------------------------------

## logit transformation
posterior_fixedpods_logitpopstrongmsel_add <- predict(object     = reg_logitpopstrongmsel,
                                                      obs        = global_sumstats_fixedpods_add,
                                                      training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                      quantiles  = c(0.025,0.5,0.975),
                                                      paral      = T,
                                                      ncores     = 6,
                                                      rf.weights = T)

#save(posterior_fixedpods_logitpopstrongmsel_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add",".RData"))

## prepare the vector with the true values - transformed
logitpopstrongmsel_fixedpods_add <- log(pooled_reftable_fixedpods_add[, "POPPrStrongMSel"]/(1-pooled_reftable_fixedpods_add[, "POPPrStrongMSel"]))

# -Inf for the lowest -1 value 
logitpopstrongmsel_fixedpods_add <- replace(logitpopstrongmsel_fixedpods_add,
                                            logitpopstrongmsel_fixedpods_add == -Inf, -15)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitpopstrongmsel_fixedpods_add, 
     y    = posterior_fixedpods_logitpopstrongmsel_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-15,2),
     ylim = c(-15,2),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtps.fixedpods_add <- data.frame(x = logitpopstrongmsel_fixedpods_add,
                                       y = posterior_fixedpods_logitpopstrongmsel_add$expectation,
                                       c = c(rep("limited", 200), rep("unlimited", 200)))

#save(pred.lgtps.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add",".RData"))

ggplot(pred.lgtps.fixedpods_add[c(101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(P))))) +
  ylab(expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")))+
  xlim(-15, 0) +
  ylim(-15, 0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Theta - selected mutations
```{r prediction thetaS, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------

## theta * P_S 
##-----------------------------------------------------------
posterior_radnompods_logthetaPS <- predict(object     = reg_logthetaPS,
                                           obs        = global_sumstats_pods,
                                           training   = data.frame(logthetaPS, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

#save(posterior_radnompods_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaPS",".RData"))

## prepare the vector with the true values
genomeS = 100e+06
prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]
logthetaPS_randompods <- log10(4 * pooled_reftable_pods[, "Ncs"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logthetaPS_randompods, 
     y    = posterior_radnompods_logthetaPS$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(log[10](italic(θ) * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logthetaPS <- data.frame(x = logthetaPS_randompods,
                              y = posterior_radnompods_logthetaPS$expectation)
#save(pred.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logthetaPS, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(θ) * italic(P)[S]))),
       ylab = expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")),
       xlim = c(-8,6),
       ylim = c(-8,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## ThetaS (original with meanNe2)
##-----------------------------------------------------------
#posterior_radnompods_logthetaS <- predict(object     = reg_logthetaS,
#                                          obs        = global_sumstats_pods,
#                                          training   = data.frame(logthetaS, global_sumstats),
#                                          quantiles  = c(0.025,0.5,0.975),
#                                          paral      = T,
#                                          ncores     = 28,
#                                          rf.weights = T)
#
#save(posterior_radnompods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#
## prepare the vector with the true values
#genomeS = 100e+06
#prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]
#randompods_thetaS <- 4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS
#log_randompods_thetaS <- log10(randompods_thetaS)
#
## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_randompods_thetaS, 
#     y    = posterior_radnompods_logthetaS$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     main = expression(log[10](italic(θ) * italic(P)[S])), 
#      cex.axis = 1.2,
#      cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

<<<<<<< HEAD
## FIXED PODs
##-----------------------------------------------------------

## theta * P_S 
##-----------------------------------------------------------
posterior_fixedpods_logthetaPS <- predict(object     = reg_logthetaPS,
                                           obs        = global_sumstats_fixedpods,
                                           training   = data.frame(logthetaPS, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

#save(posterior_fixedpods_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS",".RData"))

## prepare the vector with the true values
#genomeS = 100e+06
prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]
logthetaPS_fixedpods <- log10(4 * pooled_reftable_fixedpods[, "Ncs"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logthetaPS_fixedpods[-c(1:100)], 
     y    = posterior_fixedpods_logthetaPS$expectation[-c(1:100)],
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(log[10](italic(θ) * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logthetaPS.fixedpods <- data.frame(x = logthetaPS_fixedpods[-c(1:100)],
                                        y = posterior_fixedpods_logthetaPS$expectation[-c(1:100)],
                                        c = c(rep("limited", 100), rep("unlimited", 100)))

#save(pred.logthetaPS.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods",".RData"))

ggplot(pred.logthetaPS.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ) * italic(P)[S])))) +
  ylab(expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")))+
  xlim(-4, 4) +
  ylim(-4, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## ThetaS (original with meanNe2)
##-----------------------------------------------------------
#posterior_fixedpods_logthetaS <- predict(object     = reg_logthetaS,
#                                         obs        = global_sumstats_fixedpods,
#                                         training   = data.frame(logthetaS, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 28,
#                                         rf.weights = T)
#
#save(posterior_fixedpods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#
## prepare the vector with the true values
#genomeS = 100e+06
#prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]
#fixedpods_thetaS <- 4 * pooled_reftable_fixedpods[, "meanNe2"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS
#log_fixedpods_thetaS <- log10(fixedpods_thetaS)

## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_fixedpods_thetaS, 
#     y    = posterior_fixedpods_logthetaS$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     main = expression(log[10](italic(θ) * italic(P)[S])), 
#      cex.axis = 1.2,
#      cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")


## FIXED PODs ADDITIONAL
##-----------------------------------------------------------

## theta * P_S 
##-----------------------------------------------------------
posterior_fixedpods_logthetaPS_add <- predict(object     = reg_logthetaPS,
                                              obs        = global_sumstats_fixedpods_add,
                                              training   = data.frame(logthetaPS, global_sumstats),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 6,
                                              rf.weights = T)

#save(posterior_fixedpods_logthetaPS_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add",".RData"))

## prepare the vector with the true values
#genomeS = 100e+06
prRSel_fixedpods_add <- pooled_reftable_fixedpods_add[, "PrGWSel"] * pooled_reftable_fixedpods_add[, "PrMSel"]
logthetaPS_fixedpods_add <- log10(4 * pooled_reftable_fixedpods_add[, "Ncs"] * (pooled_reftable_fixedpods_add[, "mu"] * prRSel_fixedpods_add) * genomeS)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logthetaPS_fixedpods_add, 
     y    = posterior_fixedpods_logthetaPS_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(log[10](italic(θ) * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logthetaPS.fixedpods_add <- data.frame(x = logthetaPS_fixedpods_add,
                                            y = posterior_fixedpods_logthetaPS_add$expectation,
                                            c = c(rep("limited", 200), rep("unlimited", 200)))

#save(pred.logthetaPS.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add",".RData"))

ggplot(pred.logthetaPS.fixedpods_add[c(101:200,301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ) * italic(P)[S])))) +
  ylab(expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")))+
  xlim(-4, 4) +
  ylim(-4, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Ns
```{r prediction Ns, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------

posterior_radnompods_logNs <- predict(object     = reg_logNs,
                                      obs        = global_sumstats_pods,
                                      training   = data.frame(logNs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 6,
                                      rf.weights = T)

#save(posterior_radnompods_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logNs",".RData"))

## prepare the vector with the true values - transformed
logNs_randompods <- log10(pooled_reftable_pods[, "meanNe2"] * pooled_reftable_pods[, "gammaMean"])

## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations 
plot(x    = logNs_randompods, 
     y    = posterior_radnompods_logNs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,4),
     ylim = c(-4,4),
     main = expression(log[10](italic(N)[e] * italic(s))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logNs <- data.frame(x = logNs_randompods,
                         y = posterior_radnompods_logNs$expectation)
#save(pred.logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logNs, nbins=30, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(N)[e]*italic(s)))),
       ylab = expression(paste(log[10](italic(hat(N))[e]*italic(s)), " ","(ABC-RF)")),
       xlim = c(-4,4),
       ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## FIXED PODs
##-----------------------------------------------------------
posterior_fixedpods_logNs <- predict(object     = reg_logNs,
                                     obs        = global_sumstats_fixedpods,
                                     training   = data.frame(logNs, global_sumstats),
                                     quantiles  = c(0.025,0.5,0.975),
                                     paral      = T,
                                     ncores     = 6,
                                     rf.weights = T)

#save(posterior_fixedpods_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs",".RData"))

## prepare the vector with the true values
logNs_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"] * pooled_reftable_fixedpods[, "gammaMean"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logNs_fixedpods[-c(1:100)], 
     y    = posterior_fixedpods_logNs$expectation[-c(1:100)],
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,4),
     ylim = c(-4,4),
     main = expression(log[10](italic(N)[e] * italic(s))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logNs.fixedpods <- data.frame(x = logNs_fixedpods[-c(1:100)],
                                   y = posterior_fixedpods_logNs$expectation[-c(1:100)],
                                   c = c(rep("A", 100), rep("B", 100)))

#save(pred.logNs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods",".RData"))

ggplot(pred.logNs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e] * italic(s))))) +
  ylab(expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(ABC-RF)")))+
  xlim(0, 2) +
  ylim(0, 2) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## FIXED PODs ADDITIONL
##-----------------------------------------------------------
posterior_fixedpods_logNs_add <- predict(object     = reg_logNs,
                                         obs        = global_sumstats_fixedpods_add,
                                         training   = data.frame(logNs, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 6,
                                         rf.weights = T)

#save(posterior_fixedpods_logNs_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs_add",".RData"))

## prepare the vector with the true values
logNs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"] * pooled_reftable_fixedpods_add[, "gammaMean"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logNs_fixedpods_add, 
     y    = posterior_fixedpods_logNs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,4),
     ylim = c(-4,4),
     main = expression(log[10](italic(N)[e] * italic(s))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logNs.fixedpods_add <- data.frame(x = logNs_fixedpods_add,
                                       y = posterior_fixedpods_logNs_add$expectation,
                                       c = c(rep("A", 200), rep("B", 200)))

#save(pred.logNs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods_add",".RData"))

ggplot(pred.logNs.fixedpods_add[c(101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e] * italic(s))))) +
  ylab(expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(ABC-RF)")))+
  xlim(0, 3) +
  ylim(0, 3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

=======
>>>>>>> e2660078bf0faa47d3366f755898d3b180071a6d
#### FDR 5% of the FST hypothesis of Ns>1
```{r prediction fdrFST, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
#radnompods_fstfdrNs05 <- pooled_reftable_pods[, "FSTfdrNS05"]
#
#posterior_radnompods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
#                                           obs        = global_sumstats_pods,
#                                           training   = data.frame(fstfdrNs05, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 28,
#                                           rf.weights = T)
#(posterior_radnompods_fstfdrNs05)
#
#save(posterior_radnompods_fstfdrNs05, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))
#
# Expected True vs estimated
#plot(x    = radnompods_fstfdrNs05, 
#     y    = posterior_radnompods_fstfdrNs05$expectation,
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = expression(eta[3]), 
#     ylab = expression(tilde(eta[3])),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     pch  = 1
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = radnompods_fstfdrNs05, 
#     y    = posterior_radnompods_fstfdrNs05$med,
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = expression(eta[3]), 
#     ylab = expression(tilde(eta[3])),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     pch  = 1
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
# Apply the threshold
#fstfdrNs05_applic_data = data.frame(sim=pooled_reftable_pods[,"sim"], meanNe2=pooled_reftable_pods[,"meanNe2"], 
#                                    True_fdr05=pooled_reftable_pods[,"FSTfdrNS05"], Infe_fdr05 = posterior_radnompods_fstfdrNs05$expectation)
#
#fstfdrNs05_applic_data <- fstfdrNs05_applic_data[1:6,]
#
#fstfdrNs05_calc = NULL
#for (i in 1:length(fstfdrNs05_applic_data$sim)){
#  t <- fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)
#  fstfdrNs05_calc = rbind(fstfdrNs05_calc, t)
#}
#
#cl <- makeCluster(18)
#registerDoParallel(cl)
#clusterEvalQ(cl)
#  
## PARALLEL PROCESSING
#------------------------------------------
#fstfdrNs05_calc <- foreach(i=1:length(fstfdrNs05_applic_data$sim),.combine=rbind, 
#                                                                  .errorhandling="pass", .verbose = TRUE) %dopar% {
#                                                                                                                   fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)}
#stopCluster(cl)
#
#save(fstfdrNs05_calc, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/fstfdrNs05_calc",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/fstfdrNs05_calc",".RData"))
#
```

### ABC-RF regression for demography: prediction

#### Harmonic mean of the effective population sizes of period 2 - meanNe2
```{r prediction MeanNe2, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
##-----------------------------------------------
posterior_radnompods_logmeanNe2 <- predict(object     = reg_logmeanNe2,
                                           obs        = global_sumstats_pods,
                                           training   = data.frame(logmeanNe2, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 2,
                                           rf.weights = T)

#save(posterior_radnompods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2_radnompods <- log10(pooled_reftable_pods[, "meanNe2"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmeanNe2_radnompods, 
     y    = posterior_radnompods_logmeanNe2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmeanNe2 <- data.frame(x = logmeanNe2_radnompods,
                              y = posterior_radnompods_logmeanNe2$expectation)
#save(pred.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logmeanNe2, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log(italic(hat(N))[e]), " ","(ABC-RF)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## comparison with WFABC Ne estimates
##---------------------------------------------------

wfabcNe_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods/results/wfabc_1_output_pods_mod.txt",header=TRUE)

# keep only same simulations
wfabcNe <- wfabcNe_raw[wfabcNe_raw$sim %in% pooled_reftable_pods$sim, ]

# merge random pods sim, meanNe2 and wfabc_Ne
wfabcNe_RFNe_table <- merge(pooled_reftable_pods[,c("sim","meanNe2")], wfabcNe, by.x = 1, by.y = 1, all = TRUE)

wfabcNe_RFNe_table$wfabc_ne <- wfabcNe_RFNe_table$wfabc_ne/2

# RMSE
sqrt(mean((wfabcNe_RFNe_table$wfabc_ne-wfabcNe_RFNe_table$meanNe2)^2))
# 2880.175

# basic plot for diagnostic
plot(x    = logmeanNe2_radnompods, 
     y    = log10(wfabcNe_RFNe_table$wfabc_ne),
     xlab = "True value", 
     ylab = "WF-ABC estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.wfabc.randompods <- data.frame(x = log10(wfabcNe_RFNe_table$meanNe2),
                                         y = log10(wfabcNe_RFNe_table$wfabc_ne))
#save(estimated.wfabc.randompods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.randompods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.randompods",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.wfabc.randompods, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log(italic(hat(N))[e]), " ","(WF-ABC)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## comparison with FST-based Ne estimates
##---------------------------------------------------
globalFSTNe <- function(x, tau){
  fst  <- x
  ne <- (tau*(1-fst))/(4*fst)
  return(ne)
}

fstne2_randompods <- globalFSTNe(x=global_sumstats_pods$GSS_WCst, tau=10)

# RMSE
sqrt(mean((fstne2_randompods-wfabcNe_RFNe_table$meanNe2)^2, na.rm = T))
# 15682.76

# basic plot for diagnostic
plot(x    = logmeanNe2_radnompods, 
     y    = log10(fstne2_randompods),
     xlab = "True value", 
     ylab = "FST-Ne estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.fstNe2.randompods <- data.frame(x = logmeanNe2_radnompods,
                                          y = log10(fstne2_randompods))
#save(estimated.fstNe2.randompods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.randompods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.randompods",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2.randompods, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Fixed PODs 
##-----------------------------------------------
posterior_fixedpods_logmeanNe2 <- predict(object      = reg_logmeanNe2,
                                           obs        = global_sumstats_fixedpods,
                                           training   = data.frame(logmeanNe2, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

#save(posterior_fixedpods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = posterior_fixedpods_logmeanNe2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmeanNe2.fixedpods <- data.frame(x = logmeanNe2_fixedpods,
                                        y = posterior_fixedpods_logmeanNe2$expectation,
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logmeanNe2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods",".RData"))

ggplot(pred.logmeanNe2.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))


## comparison with WFABC Ne estimates
##---------------------------------------------------

wfabcNe_neutral_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/wfabc_1_output_mutation_neutral.txt",header=TRUE)
wfabcNe_limited_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/original_s0.1/wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_unlimited_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/original_s0.1/wfabc_1_output_mutation_unlimited.txt",header=TRUE)

wfabcNe_fixedpods <- rbind(wfabcNe_neutral_raw , 
                           wfabcNe_limited_raw,
                           wfabcNe_unlimited_raw)

# combine fixed pods sim, meanNe2 and wfabc_Ne
wfabcNe_RFNe_table_fixedpods <- data.frame(pooled_reftable_fixedpods[,c("sim","meanNe2")],
                                           wfabcNe_fixedpods[,c("wfabc_ne","wfabc_sd")])

wfabcNe_RFNe_table_fixedpods$wfabc_ne <- wfabcNe_RFNe_table_fixedpods$wfabc_ne/2

# RMSE
sqrt(mean((wfabcNe_RFNe_table_fixedpods$wfabc_ne[201:300]-wfabcNe_RFNe_table_fixedpods$meanNe2[201:300])^2))
# neutral: 163.9951
# limited: 161.4271
# unlimited: 192.8862

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = log10(wfabcNe_RFNe_table_fixedpods$wfabc_ne),
     xlab = "True value", 
     ylab = "WF-ABC estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.wfabc.fixedpods <- data.frame(x = log10(wfabcNe_RFNe_table_fixedpods$meanNe2),
                                        y = log10(wfabcNe_RFNe_table_fixedpods$wfabc_ne),
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(estimated.wfabc.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods",".RData"))

ggplot(estimated.wfabc.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(WF-ABC)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## comparison with FST-based Ne estimates
##---------------------------------------------------
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

fstne2_fixedpods <- globalFSTNe(x=global_sumstats_fixedpods$GSS_WCst, tau=10)

# RMSE
sqrt(mean((fstne2_fixedpods-wfabcNe_RFNe_table_fixedpods$meanNe2)^2, na.rm = T))
# 167.4939

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = log10(fstne2_fixedpods),
     xlab = "True value", 
     ylab = "FST-Ne estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.fstNe2.fixedpods <- data.frame(x = logmeanNe2_fixedpods,
                                        y = log10(fstne2_fixedpods),
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(estimated.fstNe2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods",".RData"))

ggplot(estimated.fstNe2.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## Fixed PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logmeanNe2_add <- predict(object      = reg_logmeanNe2,
                                               obs        = global_sumstats_fixedpods_add,
                                               training   = data.frame(logmeanNe2, global_sumstats),
                                               quantiles  = c(0.025,0.5,0.975),
                                               paral      = T,
                                               ncores     = 6,
                                               rf.weights = T)

#save(posterior_fixedpods_logmeanNe2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = posterior_fixedpods_logmeanNe2_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmeanNe2.fixedpods_add <- data.frame(x = c(logmeanNe2_fixedpods[c(1:100)], 
                                                  logmeanNe2_fixedpods_add),
                                            y = c(posterior_fixedpods_logmeanNe2$expectation[c(1:100)], 
                                                  posterior_fixedpods_logmeanNe2_add$expectation),
                                            c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logmeanNe2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add",".RData"))

ggplot(pred.logmeanNe2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))


## comparison with WFABC Ne estimates
##---------------------------------------------------

wfabcNe_neutral_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/wfabc_1_output_mutation_neutral.txt",header=TRUE)
wfabcNe_limitedAdd1_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.01//wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_limitedAdd2_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.25//wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_unlimitedAdd1_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.01//wfabc_1_output_mutation_unlimited.txt",header=TRUE)
wfabcNe_unlimitedAdd2_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.25//wfabc_1_output_mutation_unlimited.txt",header=TRUE)

wfabcNe_fixedpods_add <- rbind(wfabcNe_neutral_raw , 
                               wfabcNe_limitedAdd1_raw,
                               wfabcNe_limitedAdd2_raw,
                               wfabcNe_unlimitedAdd1_raw,
                               wfabcNe_unlimitedAdd2_raw)

# combine fixed pods sim, meanNe2 and wfabc_Ne
wfabcNe_RFNe_table_fixedpods_add <- data.frame(rbind(pooled_reftable_fixedpods[1:100,c("sim","meanNe2")], 
                                                     pooled_reftable_fixedpods_add[1:400,c("sim","meanNe2")]),
                                               wfabcNe_fixedpods_add[,c("wfabc_ne","wfabc_sd")])

wfabcNe_RFNe_table_fixedpods_add$wfabc_ne <- wfabcNe_RFNe_table_fixedpods_add$wfabc_ne/2

# RMSE
sqrt(mean((wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[401:500]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[401:500])^2))
# neutral: 163.9951
# limited s=0.01: 165.5622
# limited s=0.25: 163.3911
# unlimited s=0.01: 205.5207
# unlimited s=0.25: 103.2209

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = log10(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[-c(1:100)]),
     xlab = "True value", 
     ylab = "WF-ABC estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.wfabc.fixedpods_add <- data.frame(x = log10(wfabcNe_RFNe_table_fixedpods_add$meanNe2),
                                            y = log10(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne),
                                            c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(estimated.wfabc.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods_add",".RData"))

ggplot(estimated.wfabc.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(WF-ABC)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## comparison with FST-based Ne estimates
##---------------------------------------------------
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

fstne2_fixedpods_add <- globalFSTNe(x=global_sumstats_fixedpods_add$GSS_WCst, tau=10)

# RMSE
sqrt(mean((fstne2_fixedpods_add[301:400]-logmeanNe2_fixedpods_add[301:400])^2, na.rm = T))
# limited s=0.01: 508.5855
# limited s=0.25: 491.6989
# unlimited s=0.01: 227.6457
# unlimited s=0.25: 14.12808

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = log10(fstne2_fixedpods_add),
     xlab = "True value", 
     ylab = "FST-Ne estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.fstNe2.fixedpods_add <- data.frame(x = c(logmeanNe2_fixedpods[1:100], logmeanNe2_fixedpods_add),
                                             y = c(log10(fstne2_fixedpods[1:100]), log10(fstne2_fixedpods_add)),
                                             c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(estimated.fstNe2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods_add",".RData"))

ggplot(estimated.fstNe2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")))+
  xlim(0,4) +
  ylim(0,4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Population size of period 2 - census size Ncs
```{r predition Ncs, echo=TRUE, eval=FALSE, include=TRUE}

# RANDOM PODS
##-----------------------------------------------
posterior_radnompods_logncs <- predict(object     = reg_logncs,
                                       obs        = global_sumstats_pods,
                                       training   = data.frame(logncs, global_sumstats),
                                       quantiles  = c(0.025,0.5,0.975),
                                       paral      = T,
                                       ncores     = 28,
                                       rf.weights = T)
#save(posterior_radnompods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))

## prepare the vector with the true values - transformed
logncs_radnompods <- log10(pooled_reftable_pods[, "Ncs"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logncs_radnompods, 
     y    = posterior_radnompods_logncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logncs <- data.frame(x = logncs_radnompods,
                          y = posterior_radnompods_logncs$expectation)
#save(pred.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logncs, nbins=30, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[cs]))),
       ylab = expression(paste(log(italic(hat(N))[cs]), " ","(ABC-RF)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Fixed PODs
##-----------------------------------------------
posterior_fixedpods_logncs <- predict(object     = reg_logncs,
                                      obs        = global_sumstats_fixedpods,
                                      training   = data.frame(logncs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 6,
                                      rf.weights = T)

#save(posterior_fixedpods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs",".RData"))

## prepare the vector with the true values - transformed
logncs_fixedpods <- log10(pooled_reftable_fixedpods[, "Ncs"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logncs_fixedpods, 
     y    = posterior_fixedpods_logncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logncs.fixedpods <- data.frame(x = logncs_fixedpods,
                                        y = posterior_fixedpods_logncs$expectation,
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods",".RData"))

ggplot(pred.logncs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[cs]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## Fixed PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logncs_add <- predict(object     = reg_logncs,
                                          obs        = global_sumstats_fixedpods_add,
                                          training   = data.frame(logncs, global_sumstats),
                                          quantiles  = c(0.025,0.5,0.975),
                                          paral      = T,
                                          ncores     = 6,
                                          rf.weights = T)

#save(posterior_fixedpods_logncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add",".RData"))

## prepare the vector with the true values - transformed
logncs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "Ncs"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logncs_fixedpods_add, 
     y    = posterior_fixedpods_logncs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logncs.fixedpods_add <- data.frame(x = c(logncs_fixedpods[1:100], logncs_fixedpods_add),
                                        y = c(posterior_fixedpods_logncs$expectation[1:100], posterior_fixedpods_logncs_add$expectation),
                                        c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add",".RData"))

ggplot(pred.logncs.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[cs]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

```

#### Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r predition MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------
posterior_randompods_logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
                                              obs        = global_sumstats_pods,
                                              training   = data.frame(logmeanNe2ncs, global_sumstats),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 28,
                                              rf.weights = T)
#(posterior_randompods_logmeanNe2ncs)

#save(posterior_randompods_logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmeanNe2ncs",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2ncs_randompods <- log10(pooled_reftable_pods[, "meanNe2"]/pooled_reftable_pods[, "Ncs"])


# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmeanNe2ncs_randompods, 
     y    = posterior_randompods_logmeanNe2ncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,1),
     ylim = c(-4,1),
     main = expression(italic(N)[e]/italic(N)[cs]), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "#cb181d")

# manuscript plot
pred.logmeanNe2ncs <- data.frame(x = logmeanNe2ncs_randompods,
                                 y = posterior_randompods_logmeanNe2ncs$expectation)
#save(pred.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logmeanNe2ncs, nbins=30, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log(italic(hat(N))[e]), " ","(ABC-RF)")),
       xlim = c(-4,1),
       ylim = c(-4,1),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
                                             obs        = global_sumstats_fixedpods,
                                             training   = data.frame(logmeanNe2ncs, global_sumstats),
                                             quantiles  = c(0.025,0.5,0.975),
                                             paral      = T,
                                             ncores     = 6,
                                             rf.weights = T)

#save(posterior_fixedpods_logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2ncs_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"]/pooled_reftable_fixedpods[, "Ncs"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmeanNe2ncs_fixedpods, 
     y    = posterior_fixedpods_logmeanNe2ncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,1),
     ylim = c(-4,1),
     main = expression(italic(N)[e]/italic(N)[cs]), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "#cb181d")

# manuscript plot
pred.logmeanNe2ncs.fixedpods <- data.frame(x = logmeanNe2ncs_fixedpods,
                                           y = posterior_fixedpods_logmeanNe2ncs$expectation,
                                           c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logmeanNe2ncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods",".RData"))

ggplot(pred.logmeanNe2ncs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75, fill="white") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(ABC-RF)")))+
  xlim(-1,0.5) +
  ylim(-1,0.5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logmeanNe2ncs_add <- predict(object     = reg_logmeanNe2ncs,
                                                 obs        = global_sumstats_fixedpods_add,
                                                 training   = data.frame(logmeanNe2ncs, global_sumstats),
                                                 quantiles  = c(0.025,0.5,0.975),
                                                 paral      = T,
                                                 ncores     = 6,
                                                 rf.weights = T)

#save(posterior_fixedpods_logmeanNe2ncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2ncs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"]/pooled_reftable_fixedpods_add[, "Ncs"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmeanNe2ncs_fixedpods_add, 
     y    = posterior_fixedpods_logmeanNe2ncs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,1),
     ylim = c(-4,1),
     main = expression(italic(N)[e]/italic(N)[cs]), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "#cb181d")

# manuscript plot
pred.logmeanNe2ncs.fixedpods_add <- data.frame(x = c(logmeanNe2ncs_fixedpods[1:100], logmeanNe2ncs_fixedpods_add),
                                               y = c(posterior_fixedpods_logmeanNe2ncs$expectation[1:100], posterior_fixedpods_logmeanNe2ncs_add$expectation),
                                               c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logmeanNe2ncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add",".RData"))

ggplot(pred.logmeanNe2ncs.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75, fill="white") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(ABC-RF)")))+
  xlim(-1,0.5) +
  ylim(-1,0.5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Theta of period 2
```{r prediction theta2, echo=TRUE, eval=FALSE, include=TRUE}
## RANDOM PODs
##-----------------------------------------------
posterior_randompods_logtheta2 <- predict(object     = reg_logtheta2,
                                          obs        = global_sumstats_pods,
                                          training   = data.frame(logtheta2, global_sumstats),
                                          quantiles  = c(0.025,0.5,0.975),
                                          paral      = T,
                                          ncores     = 6,
                                          rf.weights = T)

#save(posterior_randompods_logtheta2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta2",".RData"))
#
## prepare the vector with the true values - transformed
genomeS = 100e+06
logtheta2_randompods <- log10(4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logtheta2_randompods, 
     y    = posterior_randompods_logtheta2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-1,6),
     ylim = c(-1,6),
     main = expression(log[10](italic(θ))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logtheta2 <- data.frame(x = logtheta2_randompods,
                             y = posterior_randompods_logtheta2$expectation)
#save(pred.logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(pred.logtheta2, nbins=50, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(θ)))),
       ylab = expression(paste(log(italic(hat(θ))), " ","(ABC-RF)")),
       xlim = c(-1.5,6),
       ylim = c(-1.5,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)


##FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logtheta2 <- predict(object     = reg_logtheta2,
                                         obs        = global_sumstats_fixedpods,
                                         training   = data.frame(logtheta2, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 6,
                                         rf.weights = T)

#save(posterior_fixedpods_logtheta2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2",".RData"))
#
## prepare the vector with the true values - transformed
#genomeS = 100e+06
logtheta2_fixedpods <- log10(4 * pooled_reftable_fixedpods[, "meanNe1"] * (pooled_reftable_fixedpods[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logtheta2_fixedpods, 
     y    = posterior_fixedpods_logtheta2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-1,6),
     ylim = c(-1,6),
     main = expression(log[10](italic(θ))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logtheta2.fixedpods <- data.frame(x = logtheta2_fixedpods,
                                       y = posterior_fixedpods_logtheta2$expectation,
                                       c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logtheta2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods",".RData"))

ggplot(pred.logtheta2.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ))))) +
  ylab(expression(paste(log[10](italic(hat(θ))), " ","(ABC-RF)")))+
  xlim(-1,6) +
  ylim(-1,6) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logtheta2_add <- predict(object     = reg_logtheta2,
                                             obs        = global_sumstats_fixedpods_add,
                                             training   = data.frame(logtheta2, global_sumstats),
                                             quantiles  = c(0.025,0.5,0.975),
                                             paral      = T,
                                             ncores     = 6,
                                             rf.weights = T)

#save(posterior_fixedpods_logtheta2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add",".RData"))
#
## prepare the vector with the true values - transformed
#genomeS = 100e+06
logtheta2_fixedpods_add <- log10(4 * pooled_reftable_fixedpods_add[, "meanNe1"] * (pooled_reftable_fixedpods_add[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logtheta2_fixedpods_add, 
     y    = posterior_fixedpods_logtheta2_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-1,6),
     ylim = c(-1,6),
     main = expression(log[10](italic(θ))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logtheta2.fixedpods_add <- data.frame(x = c(logtheta2_fixedpods[c(1:100)], logtheta2_fixedpods_add),
                                           y = c(posterior_fixedpods_logtheta2$expectation[c(1:100)], posterior_fixedpods_logtheta2_add$expectation),
                                           c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logtheta2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add",".RData"))

ggplot(pred.logtheta2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ))))) +
  ylab(expression(paste(log[10](italic(hat(θ))), " ","(ABC-RF)")))+
  xlim(-1,6) +
  ylim(-1,6) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Theta of period 1
```{r prediction theta1, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
#posterior_randompods_logtheta1 <- predict(object     = reg_logtheta1,
#                                          obs        = global_sumstats_pods,
#                                          training   = data.frame(logtheta1, global_sumstats),
#                                          quantiles  = c(0.025,0.5,0.975),
#                                          paral      = T,
#                                          ncores     = 28,
#                                          rf.weights = T)
#
#save(posterior_randompods_logtheta1, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta1",".RData"))
#
#genomeS = 100e+06
#log_randompods_theta1 <- log10(4 * pooled_reftable_pods[, "meanNe1"] * (pooled_reftable_pods[, "mu"]) * genomeS)
#
# Expected True vs estimated
#plot(x    = log_randompods_theta1, 
#     y    = posterior_randompods_logtheta1$expectation,
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     xlab = expression(italic(theta[(1)])), 
#     ylab = expression(hat(italic(theta[(1)]))),
#     pch  = 1
#     )
#abline(a=0, b=1, col = "#cb181d")
#
##FIXED PODs
#posterior_fixedpods_logtheta1 <- predict(object     = reg_logtheta1,
#                                         obs        = global_sumstats_fixedpods,
#                                         training   = data.frame(logtheta1, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 28,
#                                         rf.weights = T)
#save(posterior_fixedpods_logtheta1, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta1",".RData"))
#
#genomeS = 100e+06
#log_fixedpods_theta1 <- log10(4 * pooled_reftable_fixedpods[, "meanNe1"] * (pooled_reftable_fixedpods[, "mu"]) * genomeS)
#
# Expected True vs estimated
#plot(x    = log_fixedpods_theta1, 
#     y    = posterior_fixedpods_logtheta1$expectation,
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     xlab = expression(italic(theta[(1)])), 
#     ylab = expression(hat(italic(theta[(1)]))),
#     pch  = 1,
#     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
#     )
#abline(a=0, b=1, col = "#cb181d")
```

#### Per site mutation rate mu
```{r prediction site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
#posterior_randompods_logmu <- predict(object     = reg_logmu,
#                                      obs        = global_sumstats_pods,
#                                      training   = data.frame(logmu, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#save(posterior_randompods_logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmu",".RData"))
#
#log_randompods_mu <- log10(pooled_reftable_pods[, "mu"])
#
#hist(log_randompods_mu, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")
#
# Expected True vs estimated
#plot(x    = log_randompods_mu, 
#     y    = posterior_randompods_logmu$expectation,
#     xlim = c(-10,-5),
#     ylim = c(-10,-5),
#     xlab = expression(log[10](italic(mu))), 
#     ylab = expression(hat(log[10](italic(mu)))),
#     pch  = 1
#     )
#abline(a=0, b=1, col = "#cb181d")
#
## Fixed PODs 
#posterior_fixedpods_logmu <- predict(object     = reg_logmu,
#                                     obs        = global_sumstats_fixedpods,
#                                     training   = data.frame(logmu, global_sumstats),
#                                     quantiles  = c(0.025,0.5,0.975),
#                                     paral      = T,
#                                     ncores     = 28,
#                                     rf.weights = T)
#
#save(posterior_fixedpods_logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu",".RData"))
#
#log_fixedpods_mu <- log10(pooled_reftable_fixedpods[, "mu"])
#
# Expected True vs estimated
#plot(x    = log_fixedpods_mu, 
#     y    = posterior_fixedpods_logmu$expectation,
#     xlim = c(-10,-5),
#     ylim = c(-10,-5),
#     xlab = expression(log[10](italic(mu))), 
#     ylab = expression(hat(log[10](italic(mu)))),
#     pch  = 1,
#     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
#     )
#abline(a=0, b=1, col = "#cb181d")
```

#### Rho = Nr
```{r prediction Rho, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
#posterior_randompods_logrho <- predict(object     = reg_logrho,
#                                       obs        = global_sumstats_pods,
#                                       training   = data.frame(logrho, global_sumstats),
#                                       quantiles  = c(0.025,0.5,0.975),
#                                       paral      = T,
#                                       ncores     = 28,
#                                       rf.weights = T)
#
#save(posterior_randompods_logrho, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logrho",".RData"))
#
#log_randompods_rho <- log10(pooled_reftable_pods[, "meanNe2"] * pooled_reftable_pods[, "rr"])
#
# Expected True vs estimated
#plot(x    = log_randompods_rho, 
#     y    = posterior_randompods_logrho$expectation,
#     xlim = c(-9,-3),
#     ylim = c(-9,-3),
#     xlab = expression(log[10](italic(rho))), 
#     ylab = expression(hat(log[10](italic(rho)))),
#     pch  = 1
#     )
#abline(a=0, b=1, col = "#cb181d")
#
## FIXED PODs
#posterior_fixedpods_logrho <- predict(object     = reg_logrho,
#                                      obs        = global_sumstats_fixedpods,
#                                      training   = data.frame(logrho, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#save(posterior_fixedpods_logrho, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrho",".RData"))
#
#log_fixedpods_rho <- log10(pooled_reftable_fixedpods[, "meanNe2"] * pooled_reftable_fixedpods[, "rr"])
#
# Expected True vs estimated
#plot(x    = log_fixedpods_rho, 
#     y    = posterior_fixedpods_logrho$expectation,
#     xlim = c(-9,-3),
#     ylim = c(-9,-3),
#     xlab = expression(log[10](italic(rho))), 
#     ylab = expression(hat(log[10](italic(rho)))),
#     pch  = 1,
#     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
#     )
#abline(a=0, b=1, col = "#cb181d")
```