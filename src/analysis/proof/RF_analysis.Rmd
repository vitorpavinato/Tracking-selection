---
title: "Tracking Selection with ABC-RF"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r clean cache, echo=TRUE, eval=FALSE, include=TRUE}
rm(list=ls())
ls()
```

## ABC random forests analysis

#### Install required packages
```{r install packages, echo=TRUE}
#install.packages(c("DataExplorer", 
#                   "dplyr",
#                   "abcrf",
#                   "weights",
#                   "grDevices"),
#                 dependencies = T)
```

#### Load packages and source file
```{r load packages, echo=TRUE, eval=FALSE, include=TRUE}
library(DataExplorer)
library(dplyr)
library(abcrf)
library(ggplot2)
library(viridis)
library(weights)
library(gtools)
library(ROCR)
library(boot)
library(grDevices)
library(foreach)     # ->
library(parallel)    # -> for simulating in parallel
library(doParallel)  # ->

source("~/My_repositories/Tracking-selection/src/analysis/RF_analysis_fun.R")
```

#### Upload the RF training reference table files
```{r load superbatch 1, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 1
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_1_genotoul/results/pooled_reftable_1.RData")
pooled_raw_reftable_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 2, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 2
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_2_genotoul/results/pooled_reftable_2.RData")
pooled_raw_reftable_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 3, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 3
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_3_genotoul/results/pooled_reftable_3.RData")
pooled_raw_reftable_3 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

```{r load superbatch 4, echo=TRUE, eval=FALSE, include=TRUE}
# Super-batch 4
load("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_4_cbgp/results/pooled_reftable_4.RData")
pooled_raw_reftable_4 <- pooled_raw_reftable
rm(pooled_raw_reftable)
```

#### Pool together the reftables from super-batches
```{r pooling reftable, echo=TRUE, eval=FALSE, include=TRUE}
pooled_raw_reftable_total <- rbind(pooled_raw_reftable_1,
                                   pooled_raw_reftable_2,
                                   pooled_raw_reftable_3,
                                   pooled_raw_reftable_4)

rm(pooled_raw_reftable_1)
rm(pooled_raw_reftable_2)
rm(pooled_raw_reftable_3)
rm(pooled_raw_reftable_4)

#save(pooled_raw_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_total",".RData"))
```

#### RANDOM PODS
```{r load randompods, echo=TRUE, eval=FALSE, include=TRUE}

# random PODs 1
load("~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_1_genotoul/results/pooled_reftable_pods_1.RData")
pooled_raw_reftable_pods_1 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_1[which(is.na(pooled_raw_reftable_pods_1[, "meanNe2"])), "sim"]
# 38 39 126 165 175 251 281 681 720 735 737 917 # ==> these simulations crashed but produced rows with NA in the reference table.


# random PODs 2
load("~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods_2_genotoul/results/pooled_reftable_pods_2.RData")
pooled_raw_reftable_pods_2 <- pooled_raw_reftable
rm(pooled_raw_reftable)

pooled_raw_reftable_pods_2[which(is.na(pooled_raw_reftable_pods_2[, "meanNe2"])), "sim"]
# 1438 is missing # ==> this simulation crashed before produce rows in the reference table.
# 1481 1716 # ==> these simulations crashed but produced rows with NA in the reference table.

pooled_raw_reftable_pods <- rbind(pooled_raw_reftable_pods_1,
                                  pooled_raw_reftable_pods_2)

rm(pooled_raw_reftable_pods_1)
rm(pooled_raw_reftable_pods_2)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_pods)
# 1999 713

# save pooled_raw_reftable_pods as pooled_raw_reftable_pods
#save(pooled_raw_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_pods",".RData"))
```

#### FIXED PODS
```{r load fixedpods, echo=TRUE, eval=FALSE, include=TRUE}

# fixed PODs 1 - neutral
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/reference_table.RData")
raw_reftable_neutral_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 2 - mutation limited
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/original_s0.1/reference_table.RData")
raw_reftable_limited_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 3 - mutation unlimited
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/original_s0.1/reference_table.RData")
raw_reftable_unlimited_pods <- raw_reftable
rm(raw_reftable)

pooled_raw_reftable_fixedpods <- rbind(raw_reftable_neutral_pods,
                                       raw_reftable_limited_pods,
                                       raw_reftable_unlimited_pods)

rm(raw_reftable_neutral_pods)
rm(raw_reftable_limited_pods)
rm(raw_reftable_unlimited_pods)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_fixedpods)
# 300 713

# save pooled_raw_reftable_fixedpods as pooled_raw_reftable_fixedpods
#save(pooled_raw_reftable_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods",".RData"))
```

#### ADDITIONAL FIXED PODS
```{r load fixedpods, echo=TRUE, eval=FALSE, include=TRUE}

# fixed PODs 4 - mutation limited s=0.01
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.01/reference_table.RData")
raw_reftable_limitedAdd1_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 5 - mutation limited s=0.25
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.25/reference_table.RData")
raw_reftable_limitedAdd2_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 6 - mutation unlimited s=0.01
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.01/reference_table.RData")
raw_reftable_unlimitedAdd1_pods <- raw_reftable
rm(raw_reftable)

# fixed PODs 7 - mutation unlimited s=0.25
load("~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.25/reference_table.RData")
raw_reftable_unlimitedAdd2_pods <- raw_reftable
rm(raw_reftable)

pooled_raw_reftable_fixedpods_add <- rbind(raw_reftable_limitedAdd1_pods,
                                           raw_reftable_limitedAdd2_pods,
                                           raw_reftable_unlimitedAdd1_pods,
                                           raw_reftable_unlimitedAdd2_pods)
rm(raw_reftable_limitedAdd1_pods)
rm(raw_reftable_limitedAdd2_pods)
rm(raw_reftable_unlimitedAdd1_pods)
rm(raw_reftable_unlimitedAdd2_pods)

# check dim before remove rows with NAs
dim(pooled_raw_reftable_fixedpods_add)
# 400 713

# save pooled_raw_reftable_fixedpods_add as pooled_raw_reftable_fixedpods_add
#save(pooled_raw_reftable_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_raw_reftable_fixedpods_add",".RData"))
```

#### Prepare the training RF reftable
```{r training data preparation, echo=TRUE, eval=FALSE, include=TRUE}

# Check missing data
plot_missing(pooled_raw_reftable_total) 
missing_count <- sapply(pooled_raw_reftable_total, function(x) sum(is.na(x)))

# produce a data.frame with only summary statistics that contain missing values higher than a threshold
pooled_reftable_total <- pooled_raw_reftable_total[,missing_count < nrow(pooled_raw_reftable_total)/10]

# remove also POPSelSd and SAMSelSd columns
pooled_reftable_total <- pooled_reftable_total[,-c(31,37)]

# check it!
missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x)))
plot_missing(pooled_reftable_total) 

# remove remaining rows with missing data
pooled_reftable_total <- pooled_reftable_total[complete.cases(pooled_reftable_total), ]

# check it again
plot_missing(pooled_reftable_total)
table(missing_count <- sapply(pooled_reftable_total, function(x) sum(is.na(x))))

# Check != numeric values
infinite_count <- sapply(pooled_reftable_total, function(x) sum(is.infinite(x)))

# check the number of rows and columns of the final reference table
dim(pooled_reftable_total)
# 53757   509

#save(pooled_reftable_total, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats <- pooled_reftable_total[, -c(1:104)]

# check the number of rows and columns of the final global summary stats table
dim(global_sumstats)
# 53757   405

#save(global_sumstats, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats",".RData"))
```

#### Prepare the RANDOM PODS reftable
```{r randompods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_pods <- pooled_raw_reftable_pods[, names(pooled_raw_reftable_pods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_pods <- pooled_reftable_pods[complete.cases(pooled_reftable_pods), ]

#save(pooled_reftable_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_pods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_pods <- pooled_reftable_pods[, -c(1:104)]

#save(global_sumstats_pods, 
#     file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_pods",".RData"))
```

#### UPDATE [17-03-20]: Combine the Random PODs simulations with the training Reference table
```{r combinade reference table, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_total <- rbind(pooled_reftable_total, pooled_reftable_pods)
dim(pooled_reftable_total)
# 55634   509

#save(pooled_reftable_total, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_total_c",".RData"))

global_sumstats <- rbind(global_sumstats, global_sumstats_pods)
dim(global_sumstats)
# 55634   405

#save(global_sumstats, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_c",".RData"))
```

#### Prepare the FIXED PODS reftable
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_fixedpods <- pooled_raw_reftable_fixedpods[, names(pooled_raw_reftable_fixedpods) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_fixedpods <- pooled_reftable_fixedpods[complete.cases(pooled_reftable_fixedpods), ]

#save(pooled_reftable_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_fixedpods <- pooled_reftable_fixedpods[, -c(1:104)]

#save(global_sumstats_fixedpods, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods",".RData"))
```

#### Prepare the FIXED PODS reftable - ADDITIONAL
```{r fixedpods data preparation, echo=TRUE, eval=FALSE, include=TRUE}

pooled_reftable_fixedpods_add <- pooled_raw_reftable_fixedpods_add[, names(pooled_raw_reftable_fixedpods_add) %in% names(pooled_reftable_total), drop=FALSE]

# remove remaining rows with missing data
pooled_reftable_fixedpods_add <- pooled_reftable_fixedpods_add[complete.cases(pooled_reftable_fixedpods_add), ]

#save(pooled_reftable_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/pooled_reftable_fixedpods_add",".RData"))

# Prepare the global summary statistics table by removing columns that do not contain summary stats
global_sumstats_fixedpods_add <- pooled_reftable_fixedpods_add[, -c(1:104)]

#save(global_sumstats_fixedpods_add, 
#     file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/global_sumstats_fixedpods_add",".RData"))
```

## Sampling period inference

### ABC-RF classification for selection: growing trees for short-term evolution inference

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification neutral_selection, echo=TRUE, eval=FALSE, include=TRUE}

## Classification 1
selection_1 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1)

## rf-classification
class_selection_1 <- abcrf(formula = selection_1~.,
                           data    = data.frame(selection_1, global_sumstats[,-c(117)]),
                           lda     = TRUE, 
                           ntree   = 5000,
                           paral   = T,
                           ncores  = 28)

#save(class_selection_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1",".RData"))

## Combined: original reftable + randompods reftable
#save(class_selection_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_1_c",".RData"))

(class_selection_1)
##Number of simulations: 55634
#Out-of-bag prior error rate: 19.3173%
#
#Confusion matrix:
#         qNeutral  sSel class.error
#qNeutral    21624  4746   0.1799772
#sSel         6001 23263   0.2050642

#TPR = 21624/(21624+6001) = 0.7827692 #sensitivity, recall
#TNR = 23263/(4746+23263) = 0.8305545 #specificity, selectivity
#PPV = 21624/(21624+4746) = 0.8200228 # precision
#NPV = 23263/(23263+6001) = 0.7949358

# accuracy:
((21624+23263)/((21624+23263) + (6001+4746))) * 100 
# 80.68268

#same as:
#table(selection_1, class_selection_1$model.rf$predictions)

# GLOBAL ERROR
sum(as.character(class_selection_1$model.rf$predictions)!=selection_1)/length(selection_1)
class_selection_1$model.rf$confusion.matrix
# 0.1931732
#         qNeutral  sSel class.error
#qNeutral    21624  4746   0.1799772
#sSel         6001 23263   0.2050642

## error rate plot
err.abcrf(object   = class_selection_1,
          training = data.frame(selection_1, global_sumstats[,-c(117)]),
          paral    = T,
         ncores   = 8)

plot(class_selection_1, 
     training = data.frame(selection_1, global_sumstats[,-c(117)]),
     obs=NULL, 
     n.var=20,
     )

variableImpPlot(class_selection_1,
                n.var = 20)

## Classification as a function of theta*PS

# theta * P_S 
#-----------------------------------------------------------
#genomeS = 100e+6
#prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
#  
#logthetaPS <- log10(4 * pooled_reftable_total[, "Ncs"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)

obs_pred_class <- data.frame(obs=selection_1, pred=class_selection_1$model.rf$predictions, logthetaPS=logthetaPS) 

error <- (obs_pred_class$obs!=obs_pred_class$pred)

tol<-0.2
local_error <- array(NA,nrow(obs_pred_class))
for (i in seq_len(nrow(obs_pred_class))){
  
    distance <- abs(obs_pred_class$logthetaPS-obs_pred_class$logthetaPS[i])
  
  # calculate weigths from epachnikov kernel
  nacc <- ceiling(length(distance) * tol)
  ds   <- sort(distance)[nacc]
  weights <- 1 - (distance/ds)^2
  weights[which(weights<0)]<-0

  # calculated weighthed proportion of error
  local_error[i]<-sum(error*weights)/sum(weights)
}

obs_pred_class["error"] <- local_error

obs_pred_class <- obs_pred_class[order(obs_pred_class$logthetaPS),]

#save(obs_pred_class, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error",".RData"))

## Combined: original reftable + randompods reftable
#save(obs_pred_class, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/obs_pred_class_error_c",".RData"))

# simple plot
plot(obs_pred_class$logthetaPS,
     obs_pred_class$error,
     xlab=expression(log[10](italic(θ) * italic(P)[S])),
     ylab="error rate",
     xlim=c(-7, 7),
     type="l",lwd=2,col="black")
abline(v=0, lty=3, col="gray")

# manuscript plot
#class_theta <- ggplot(obs_pred_class , aes(x=logthetaPS, y=error, colour=logthetaPS))
#class_theta_g <- class_theta + 
#                 geom_line(size = 1.2) + 
#                 scale_colour_gradientn(colours=viridis::plasma(32),name="",
#                                      breaks = c(-4,0,4),labels = c(-4,0,4)) +
#                 xlab(expression(log[10](italic(θ)*italic(P)[S]))) +
#                 ylab("error rate") +
#                 geom_vline(xintercept = 0, color = "black") + 
#                 geom_segment(x = 0.05, y = 0.34, xend = 5, yend = 0.34, color="black",
#                              arrow = arrow(length = unit(0.5, "cm"))) +
#                 geom_segment(x = 0.05, y = 0.34, xend = -6, yend = 0.34, color="black",
#                              arrow = arrow(length = unit(0.5, "cm"))) +
#                 annotate("text", x = 2.5, y = 0.33, label = "mutation unlimited",color = "black", fontface = 1) +
#                 annotate("text", x = -3, y = 0.33, label = "mutation limited",color = "black", fontface = 1) +
#                 theme_bw() + 
#                 theme(panel.border = element_rect(colour = "black", fill=NA), 
#                 panel.grid.major = element_blank(),
#                 panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
#                 legend.position = "top", axis.text = element_text(size = 12),
#                 axis.title=element_text(size=12))
#class_theta_g 

### Classification 2
#selection_2 <- ifelse(pooled_reftable_total[, "POPPrStrongMSel"] == 0 & pooled_reftable_total[, "averageGeneticLoad"] < 0.3, "qNeutral", "sSel")
#table(selection_2)
#
#class_selection_2 <- abcrf(formula = selection_2~.,
#                           data    = data.frame(selection_2, global_sumstats[,-c(117)]),
#                           lda     = TRUE, 
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(class_selection_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/class_selection_2",".RData"))
#
#(class_selection_2)
#
#plot(class_selection_2, 
#     training = data.frame(selection_2, global_sumstats[,-c(117)]),
#     obs=NULL, 
#     n.var=20)
```

### ABC-RF regression for selection: growing trees for short-term evolution inference

#### Average genetic load
```{r regression average genetic load, echo=TRUE, eval=FALSE, include=TRUE}

averageGenLoad <- pooled_reftable_total[, "averageGeneticLoad"]
hist(averageGenLoad, freq = TRUE, xlab = expression(italic(L)), main = "", col = "#bdbdbd")

#logaverageGenload <- -log10(1-averageGenLoad)
#hist(logaverageGenload, freq = TRUE, xlab = expression(-log[10](1 - italic(L))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_averageGenLoad <- regAbcrf(formula = logaverageGenload~.,
#                               data    = data.frame(logaverageGenload, global_sumstats),
#                               ntree   = 1000,
#                               paral   = T,
#                               ncores  = 28)
#
#save(reg_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad",".RData"))
#
## variable Importance plot
#plot(x = reg_averageGenLoad, n.var = 20)
#
#head(sort(reg_averageGenLoad$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_averageGenLoad$model.rf$prediction.error
# 0.01902606
#
## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad,
#             training = data.frame(logaverageGenload, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# basic plot for diagnostic
#plot(x    = logaverageGenload,
#     y    = reg_averageGenLoad$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(-log[10](1 - italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
#identify(x = logaverageGenload,
#         y = reg_averageGenLoad$model.rf$predictions)
# example: simulation row 28263
# meanNe2 super small because of a lot of selection
#
#hist(averageGenLoad[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100, 
#     freq = TRUE, xlab = expression(italic(bar(L))), main = "", col = "#bdbdbd")
#
#hist(logaverageGenload[which(pooled_reftable_total[, "POPPrStrongMSel"] == 0)], breaks = 100,
#     freq = TRUE, xlab = expression(-log[10](1 - italic(bar(L)))), main = "", col = "#bdbdbd")
#
# manuscript plot
#oob.loggl <- data.frame(x = logaverageGenload,
#                        y = reg_averageGenLoad$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.loggl, nbins=70, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       show = T,
#       xlab = expression(paste("true", " ", -log[10](1- italic(L)))),
#       ylab = expression(paste(-log[10](1- italic(hat(L))), " ","(OOB prediction)")),
#       xlim = c(0,3),
#       ylim = c(0,3),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## logit transformation I:
# removing "quasi-neutral" simulations
load_zero <- which(averageGenLoad == 0)
averageGenLoad_2 <- averageGenLoad[-load_zero]
global_sumstats_averageGenLoad <- global_sumstats[-load_zero,]

logitaverageGenload <- log(averageGenLoad_2/(1-averageGenLoad_2))
hist(logitaverageGenload, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")

## rf-regression
reg_averageGenLoad_2 <- regAbcrf(formula = logitaverageGenload~.,
                                 data    = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 28)

#save(reg_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_2",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_averageGenLoad_2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_averageGenLoad_2_c",".RData"))

## variable Importance plot
plot(x = reg_averageGenLoad_2, n.var = 10, main=expression(logit(italic(L))))

## prediction error
reg_averageGenLoad_2$model.rf$prediction.error
# 2.475899

## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_2,
#             training = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# basic plot for diagnostic
plot(x    = logitaverageGenload,
     y    = reg_averageGenLoad_2$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.lgtgl <- data.frame(x = logitaverageGenload,
                        y = reg_averageGenLoad_2$model.rf$predictions)

#save(oob.lgtgl, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtgl",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtgl",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.lgtgl, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.lgtgl_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.lgtgl_c",".RData"))

# Root mean squered error
mean((oob.lgtgl$y - oob.lgtgl$x)^2, na.rm = TRUE) 
# 1.573499

# Mean bias - logit scale
mean(oob.lgtgl$y - oob.lgtgl$x, na.rm = TRUE) 
# -0.03900869

# Mean bias - original scale
#mean(inv.logit(oob.lgtgl$y) - inv.logit(oob.lgtgl$x), na.rm = TRUE) 
# -0.03307493

par(mar=c(5,5,4,1)+.1)
hist2d(oob.lgtgl, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(L)))),
       ylab = expression(paste(logit(italic(hat(L))), " ","(OOB prediction)")),
       xlim = c(-8,6),
       ylim = c(-8,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## logit transformation II:
# substitute 0 for 10e-1 * lowest-before-0-value
#averageGenLoad_3 <- replace(averageGenLoad, averageGenLoad== 0, (5.4186e-09*1e-1))
#
#logitaverageGenload_2 <- log(averageGenLoad_3/(1-averageGenLoad_3))
#hist(logitaverageGenload_2, freq = TRUE, xlab = expression(logit(italic(L))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_averageGenLoad_3 <- regAbcrf(formula = logitaverageGenload_2~.,
#                                 data    = data.frame(logitaverageGenload_2, global_sumstats),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
#save(reg_averageGenLoad_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_averageGenLoad_3",".RData"))
#
## variable Importance plot
#plot(x = reg_averageGenLoad_3, n.var = 20)
#
#head(sort(reg_averageGenLoad_3$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_averageGenLoad_3$model.rf$prediction.error
# 52.70968
#
## error rate plot
#err.regAbcrf(object   = reg_averageGenLoad_3,
#             training = data.frame(logitaverageGenload_2, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnistic plot
#plot(x    = logitaverageGenload_2,
#     y    = reg_averageGenLoad_3$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-22,7),
#     ylim = c(-22,7),
#     main = expression(logit(italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r regression strongly selected mutations, echo=TRUE, eval=FALSE, include=TRUE}

## correlation between the the calculated PrPOPStrongMSel and PrSAMStrongMSel
#cor(pooled_reftable_total$POPPrStrongMSel, pooled_reftable_total$SAMPrStrongMSel)
#0.9843608
#
#plot(x = pooled_reftable_total$POPPrStrongMSel, 
#     y = pooled_reftable_total$SAMPrStrongMSel, 
#     xlab = "POPPrStrongMSel",
#     ylab = "SAMPrStrongMSel")
#abline(lm(pooled_reftable_total$SAMPrStrongMSel ~ pooled_reftable_total$POPPrStrongMSel), col="#cb181d")
#
## correlation between the calculated POPPrMSel and POPPrStrongMSel
#cor(pooled_reftable_total$POPPrMSel, pooled_reftable_total$POPPrStrongMSel)
#0.7035794
#
#plot(x = pooled_reftable_total$POPPrMSel, 
#     y = pooled_reftable_total$POPPrStrongMSel,
#     xlab = "POPPrMSel",
#     ylab = "POPPrStrongMSel",
#     xlim = c(0,1),
#     ylim = c(0,1))
#abline(lm(pooled_reftable_total$POPPrStrongMSel ~ pooled_reftable_total$POPPrMSel), col="#cb181d")

## PrPOPStrongMSel
##-----------------------------------------------------------
prPOPStrongMSel <- pooled_reftable_total[, "POPPrStrongMSel"]
hist(prPOPStrongMSel, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_prPOPStrongMSel <- regAbcrf(formula = prPOPStrongMSel~.,
#                                data    = data.frame(prPOPStrongMSel, global_sumstats),
#                                ntree   = 1000,
#                                paral   = T,
#                                ncores  = 28)
#
#save(reg_prPOPStrongMSel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel",".RData"))
#
## variable Importance plot
#plot(x = reg_prPOPStrongMSel, n.var = 20)
#
#head(sort(reg_prPOPStrongMSel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_prPOPStrongMSel$model.rf$prediction.error
# 0.001121995
#
## error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel,
#             training = data.frame(prPOPStrongMSel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = prPOPStrongMSel,
#     y    = reg_prPOPStrongMSel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(italic(P)),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")

## removing "quasi-neutral" simulations
##-----------------------------------------------------------
neutralsims <- which(prPOPStrongMSel == 0)
prPOPStrongMSel_2 <- prPOPStrongMSel[-neutralsims]
global_sumstats_popstrongmsel <- global_sumstats[-neutralsims,]

hist(prPOPStrongMSel_2, freq = TRUE, xlab = expression(italic(P)), main = "", col = "#bdbdbd")

## rf-regression
#reg_prPOPStrongMSel_2 <- regAbcrf(formula = prPOPStrongMSel_2~.,
#                                  data    = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
#                                  ntree   = 1000,
#                                  paral   = T,
#                                  ncores  = 28)
#
#save(reg_prPOPStrongMSel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_prPOPStrongMSel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_prPOPStrongMSel_2, n.var = 20)
#
#head(sort(reg_prPOPStrongMSel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_prPOPStrongMSel_2$model.rf$prediction.error
# 0.001584579
#
## error rate plot
#err.regAbcrf(object   = reg_prPOPStrongMSel_2,
#             training = data.frame(prPOPStrongMSel_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = prPOPStrongMSel_2,
#     y    = reg_prPOPStrongMSel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     main = expression(italic(P)),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")

## log10 transformation PrPOPStrongMSel
##-----------------------------------------------------------
#logpopstrongmsel <- log10(prPOPStrongMSel_2)
#
#hist(logpopstrongmsel, freq = TRUE, xlab = expression(log[10](italic(P))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logpopstrongmsel <- regAbcrf(formula = logpopstrongmsel~.,
#                                 data    = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 28)
#
#save(reg_logpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopstrongmsel",".RData"))
#
## variable Importance plot
#plot(x = reg_logpopstrongmsel, n.var = 20)
#
#head(sort(reg_logpopstrongmsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logpopstrongmsel$model.rf$prediction.error
# 0.2933011
#
## error rate plot
#err.regAbcrf(object   = reg_logpopstrongmsel,
#             training = data.frame(logpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

## oob predictions vs true values
# diagnostic plot
#plot(x    = logpopstrongmsel,
#     y    = reg_logpopstrongmsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
#     main = expression(log[10](italic(P))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)

## logit transformation I: 
# PrPOPStrongMSel_2 - without neutral/quasi-neutral simulations
logitpopstrongmsel <- log(prPOPStrongMSel_2/(1-prPOPStrongMSel_2))
hist(logitpopstrongmsel, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopstrongmsel <- regAbcrf(formula = logitpopstrongmsel~.,
                                   data    = data.frame(logitpopstrongmsel, global_sumstats_popstrongmsel),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logitpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logitpopstrongmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logitpopstrongmsel_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logitpopstrongmsel_c",".RData"))


## variable Importance plot
plot(x = reg_logitpopstrongmsel, n.var = 10, main=expression(logit(italic(P))))

## prediction error
reg_logitpopstrongmsel$model.rf$prediction.error
# 1.595526

## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel,
#             training = data.frame(logitpopstrongmsel, global_sumstats_logpopstrongmsel),
#             paral    = T,
#            ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logitpopstrongmsel,
     y    = reg_logitpopstrongmsel$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-15,2),
     ylim = c(-15,2),
     #col  = ifelse(averageGenLoad[-neutralsims] < 0.3, "red", "black"),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")
#legend("topleft", legend = c("genetic load < 0.3", "genetic load >= 0.3"), col = c("red", "black"), pch = 1, bty = "n")
#identify(x = logpopstrongmsel,
#         y = reg_logpopstrongmsel$model.rf$predictions)
# example: simulation row 559 (1133)
# probably when wmax == mean(w)

## Relationship between logpopstrongmsel and logaverageGenload
#
#plot(logpopstrongmsel, logaverageGenload[-neutralsims],
#     xlab = expression(log10(italic(P[strong]))),
#     ylab = expression(-log10(1-italic(L)))
#     )

## Relationship between logitpopstrongmsel and logitaverageGenload 
#
#logitaverageGenload <- log(averageGenLoad/(1-averageGenLoad))
#plot(logitpopstrongmsel, logitaverageGenload[-neutralsims],
#     xlab = expression(log(italic(P[strong])/1-italic(P[strong]))),
#     ylab = expression(log(italic(L)/1-italic(L))))

# manuscript plot
oob.lgtps <- data.frame(x = logitpopstrongmsel,
                        y = reg_logitpopstrongmsel$model.rf$predictions)

#save(oob.lgtps, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtps",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.lgtps",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.lgtps, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.lgtps_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.lgtps_c",".RData"))

# Root mean squered error
mean((oob.lgtps$y - oob.lgtps$x)^2, na.rm = TRUE)
# 1.263141

# Mean bias - logit scale
mean(oob.lgtps$y - oob.lgtps$x, na.rm = TRUE) 
# 0.01590031

# Mean bias - original scale
#mean(inv.logit(oob.lgtps$y) - inv.logit(oob.lgtps$x), na.rm = TRUE) 
# -0.008765359

par(mar=c(5,5,4,1)+.1)
hist2d(oob.lgtps, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(P)))),
       ylab = expression(paste(logit(italic(hat(P))), " ","(OOB prediction)")),
       xlim = c(-15,2),
       ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## logit transformation II: 
# PrPOPStrongMSel - with all simulations
# substitute 0 for 10e-1 * lowest-before-0-value
#prPOPStrongMSel_3 <- replace(prPOPStrongMSel, prPOPStrongMSel== 0, (2.638936e-07*1e-1))
#
#logitpopstrongmsel_2 <- log(prPOPStrongMSel_3/(1-prPOPStrongMSel_3))
#hist(logitpopstrongmsel_2, freq = TRUE, xlab = expression(logit(italic(P))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logitpopstrongmsel_2 <- regAbcrf(formula = logitpopstrongmsel_2~.,
#                                     data    = data.frame(logitpopstrongmsel_2, global_sumstats),
#                                     ntree   = 1000,
#                                     paral   = T,
#                                     ncores  = 8)
#
#save(reg_logitpopstrongmsel_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopstrongmsel_2",".RData"))
#
## variable Importance plot
#plot(x = reg_logitpopstrongmsel_2, n.var = 20)
#
#head(sort(reg_logpopstrongmsel_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logitpopstrongmsel_2$model.rf$prediction.error
# 1.608456
#
## error rate plot
#err.regAbcrf(object   = reg_logitpopstrongmsel_2,
#             training = data.frame(logitpopstrongmsel_2, global_sumstats),
#             paral    = T,
#            ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logitpopstrongmsel_2,
#     y    = reg_logitpopstrongmsel_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-18,2),
#     ylim = c(-18,2),
#     main = expression(log(italic(P[strong])/(1-italic(P[strong])))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### Theta selected mutations
```{r regression thetaS, echo=TRUE, eval=FALSE, include=TRUE}
genomeS = 100e+6

## theta * P_S 
##-----------------------------------------------------------
prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
  
logthetaPS <- log10(4 * pooled_reftable_total[, "Ncs"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)

hist(logthetaPS, freq = TRUE, xlab = expression(log[10](italic(θ)[b])), main = "", col = "#bdbdbd")

## rf-regression
reg_logthetaPS <- regAbcrf(formula = logthetaPS~.,
                           data    = data.frame(logthetaPS, global_sumstats),
                           ntree   = 1000,
                           paral   = T,
                           ncores  = 8)

#save(reg_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaPS",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logthetaPS_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logthetaPS_c",".RData"))

## variable Importance plot
plot(x = reg_logthetaPS, n.var = 10, main=expression(log[10](italic(θ)[b])))

## prediction error
reg_logthetaPS$model.rf$prediction.error
# 1.478629

## error rate plot
#err.regAbcrf(object   = reg_logthetaPS,
#             training = data.frame(reg_logthetaPS, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
## diagnostic plot
plot(x    = logthetaPS,
     y    = reg_logthetaPS$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-8,6),
     ylim = c(-8,6),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logthetaPS <- data.frame(x = logthetaPS,
                             y = reg_logthetaPS$model.rf$predictions)

#save(oob.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logthetaPS",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logthetaPS_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logthetaPS_c",".RData"))

# Mean squered error (MSE) - manually calculated
mse_logtheta_b <- mean((oob.logthetaPS$y - oob.logthetaPS$x)^2, na.rm = TRUE)
round(mse_logtheta_b, 3)
# 1.479

# R squared - manually calculated
rsquared_logtheta_b <- 1 - (mse_logtheta_b/var(oob.logthetaPS$x, na.rm = TRUE))
round(rsquared_logtheta_b, 3) #0.659

# Mean bias - log scale
mean(oob.logthetaPS$y - oob.logthetaPS$x, na.rm = TRUE) 
# 0.001926033

# Mean bias - original scale
mean(10^(oob.logthetaPS$y) - 10^(oob.logthetaPS$x), na.rm = TRUE) 
#  -439.8052

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logthetaPS, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(θ) * italic(P)[S]))),
       ylab = expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(OOB prediction)")),
       xlim = c(-8,6),
       ylim = c(-8,6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## ThetaS (original with meanNe2)
##-----------------------------------------------------------
#prRSel <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
#  
#logthetaS <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * prRSel) * genomeS)
#
#hist(logthetaS, freq = TRUE, xlab = expression(log[10](italic(theta)*italic(P)[S])), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS <- regAbcrf(formula = logthetaS~.,
#                          data    = data.frame(logthetaS, global_sumstats),
#                          ntree   = 1000,
#                          paral   = T,
#                          ncores  = 28)
#
#save(reg_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS, n.var = 20)
#
#head(sort(reg_logthetaS$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS$model.rf$prediction.error
# 1.431425
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS,
#             training = data.frame(logthetaS, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS,
#     y    = reg_logthetaS$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logthetaS <- data.frame(x = logthetaS,
#                            y = reg_logthetaS$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logthetaS, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(theta) * italic(P)[S]))),
#       ylab = expression(paste(log[10](italic(hat(theta)) * italic(P)[S]), " ","(OOB prediction)")),
#       xlim = c(-8,6),
#       ylim = c(-8,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## ThetaS_2 - Proportion of selected mutations POPPrMSel
##-----------------------------------------------------------
#prPOPPrMSel <- pooled_reftable_total[, "POPPrMSel"]
#
## removing simulations with POPPrMSel == 0
#zero_prmsel <- which(prPOPPrMSel == 0)
#prPOPPrMSel_2 <- prPOPPrMSel[-zero_prmsel]
#global_sumstats_popmsel <- global_sumstats[-zero_prmsel,]
#
#logthetaS_2 <- log10(4 * pooled_reftable_total[-zero_prmsel, "meanNe2"] * (pooled_reftable_total[-zero_prmsel, "mu"] * prPOPPrMSel_2) * genomeS)
#
#hist(logthetaS_2, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_2 <- regAbcrf(formula = logthetaS_2~.,
#                            data    = data.frame(logthetaS_2, global_sumstats_popmsel),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 2)
#
#save(reg_logthetaS_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_2",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_2, n.var = 20)
#
#head(sort(reg_logthetaS_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_2$model.rf$prediction.error
# 0.5463858
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_2,
#             training = data.frame(logthetaS_2, global_sumstats_popmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_2,
#     y    = reg_logthetaS_2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,6),
#     ylim = c(-7,6),
#     col  = ifelse(selection_1[-zero_prmsel] == "qNeutral", "red", "black"),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("topleft", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
## ThetaS_3 - Proportion of strongly selecte mutations POPPrMSel
##----------------------------------------------------------- 
#neutralsims <- which(prPOPStrongMSel == 0)
#prPOPStrongMSel_2 <- prPOPStrongMSel[-neutralsims]
#global_sumstats_popstrongmsel <- global_sumstats[-neutralsims,]
#
#logthetaS_3 <- log10(4 * pooled_reftable_total[-neutralsims, "meanNe2"] * (pooled_reftable_total[-neutralsims, "mu"] * prPOPStrongMSel_2) * genomeS)
#
#hist(logthetaS_3, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_3 <- regAbcrf(formula = logthetaS_3~.,
#                            data    = data.frame(logthetaS_3, global_sumstats_popstrongmsel),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 4)
#
#save(reg_logthetaS_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_3",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_3, n.var = 20)
#
#head(sort(reg_logthetaS_3$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_3$model.rf$prediction.error
# 0.3136867
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_3,
#             training = data.frame(logthetaS_3, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_3,
#     y    = reg_logthetaS_3$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-7,6),
#     ylim = c(-7,6),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## Relationship between logthetaS_3 and logpopstrongmsel
#
#logthetaS_3 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * pooled_reftable_total[, "POPPrStrongMSel"]) * genomeS)
#plot(logthetaS_3[-neutralsims], logpopstrongmsel,
#     xlab = expression(log(italic(theta[s]))),
#     ylab = expression(log10(italic(P[strong]))))
#
## Relationship between logthetaS_3 and logaverageGenLoad
#
#plot(logthetaS_3, logaverageGenload,
#     xlab = expression(log(italic(theta[s]))),
#     ylab = expression(-log10(1-italic(L)))
#     )
#
## ThetaS_4 - Calculated with the probability of having strongly selected mutations give Ne and gammashape
##-------------------------------------------------------------------------------------------------------- 
#invNe2 <- 1/pooled_reftable_total[, "meanNe2"]
#gammashape <- pooled_reftable_total[, "gammaShape"]
#likelystrongMsel <- pgamma(invNe2,shape=gammashape,rate=1,lower.tail=FALSE)
#
#logthetaS_4 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"] * likelystrongMsel) * genomeS)
#
#hist(logthetaS_4, freq = TRUE, xlab = expression(log[10](italic(theta[S]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logthetaS_4 <- regAbcrf(formula = logthetaS_4~.,
#                            data    = data.frame(logthetaS_4, global_sumstats),
#                            ntree   = 1000,
#                            paral   = T,
#                            ncores  = 8)
#
#save(reg_logthetaS_4, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_4",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logthetaS_4",".RData"))
#
## variable Importance plot
#plot(x = reg_logthetaS_4, n.var = 20)
#
#head(sort(reg_logthetaS_4$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logthetaS_4$model.rf$prediction.error
# 0.6459325
#
## error rate plot
#err.regAbcrf(object   = reg_logthetaS_4,
#             training = data.frame(logthetaS_4, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logthetaS_4,
#     y    = reg_logthetaS_4$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-42,6),
#     ylim = c(-42,6),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### gamma mean - parameter
```{r regression gamma mean parameter, echo=TRUE, eval=FALSE, include=TRUE}

loggammamean <- log10(pooled_reftable_total[, "gammaMean"])

hist(loggammamean, freq = TRUE, xlab = expression(log[10](italic(gamma))), main = "", col = "#bdbdbd")

## rf-regression
reg_loggammamean <- regAbcrf(formula = loggammamean~.,
                             data    = data.frame(loggammamean, global_sumstats),
                             ntree   = 1000,
                             paral   = T,
                             ncores  = 28)

#save(reg_loggammamean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_loggammamean",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_loggammamean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_loggammamean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_loggammamean_c",".RData"))

## variable Importance plot
plot(x = reg_loggammamean, n.var = 10, main=expression(log[10](italic(gamma))))

## prediction error
reg_loggammamean$model.rf$prediction.error
# 0.607108
#
## error rate plot
#err.regAbcrf(object   = reg_loggammamean,
#             training = data.frame(loggammamean, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
plot(x    = loggammamean,
     y    = reg_loggammamean$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-3,0),
     ylim = c(-3,0),
     main = expression(log[10](italic(gamma))),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.loggammamean <- data.frame(x = loggammamean,
                              y = reg_loggammamean$model.rf$predictions)

#save(oob.loggammamean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.loggammamean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.loggammamean_c",".RData"))

# Root mean squered error
sqrt(mean((oob.loggammamean$y - oob.loggammamean$x)^2, na.rm = TRUE)) 
# 0.7791714

# Mean bias - log scale
mean(oob.loggammamean$y - oob.loggammamean$x, na.rm = TRUE) 
# 0.001194325

# Mean bias - original scale
mean(10^(oob.loggammamean$y) - 10^(oob.loggammamean$x), na.rm = TRUE) 
#  -0.09869174

par(mar=c(5,5,4,1)+.1)
hist2d(oob.loggammamean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(gamma)))),
       ylab = expression(paste(log[10](italic(hat(gamma))), " ","(OOB prediction)")),
       xlim = c(-3,0),
       ylim = c(-3,0),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Proportion of beneficial mutation - PrPs - parameter
```{r regression PrPs, echo=TRUE, eval=FALSE, include=TRUE}

## log10
##---------------------
logPrPs <- log10(pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"])

hist(logPrPs, freq = TRUE, xlab = expression(log[10](italic(P)[R] * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logPrPs <- regAbcrf(formula = logPrPs~.,
                        data    = data.frame(logPrPs, global_sumstats),
                        ntree   = 1000,
                        paral   = T,
                        ncores  = 28)

## Combined: original reftable + randompods reftable
#save(reg_logPrPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logPrPs_c",".RData"))

## variable Importance plot
plot(x = reg_logPrPs, n.var = 10, main= expression(log[10](italic(P)[R] * italic(P)[S])))
#
#head(sort(reg_logPrPs$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logPrPs$model.rf$prediction.error
# 1.3858
#
## error rate plot
#err.regAbcrf(object   = reg_logPrPs,
#             training = data.frame(logPrPs, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
plot(x    = logPrPs,
     y    = reg_logPrPs$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-6,0),
     ylim = c(-6,0),
     main = expression(log[10](italic(P)[R] * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logPrPs <- data.frame(x = logPrPs,
                          y = reg_logPrPs$model.rf$predictions)

#save(oob.logPrPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logPrPs_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logPrPs$y - oob.logPrPs$x)^2, na.rm = TRUE)) 
# 1.1772

# Mean bias - log scale
mean(oob.logPrPs$y - oob.logPrPs$x, na.rm = TRUE) 
# 0.0002007585

# Mean bias - original scale
mean(10^(oob.logPrPs$y) - 10^(oob.logPrPs$x), na.rm = TRUE) 
#  -0.03499608

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logPrPs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(P)[R] * italic(P)[S]))),
       ylab = expression(paste(log[10](italic(P)[R] * italic(P)[S]), " ","(OOB prediction)")),
       xlim = c(-6,0),
       ylim = c(-6,0),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## logit
##---------------------
prps <- pooled_reftable_total[, "PrGWSel"] * pooled_reftable_total[, "PrMSel"]
logitPrPs <- log(prps/(1-prps))

hist(logitPrPs, freq = TRUE, xlab = expression(log[10](italic(P)[R] * italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logitPrPs <- regAbcrf(formula = logitPrPs~.,
                          data    = data.frame(logitPrPs, global_sumstats),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 28)

## Combined: original reftable + randompods reftable
#save(reg_logitPrPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logitPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logitPrPs_c",".RData"))

## variable Importance plot
plot(x = reg_logitPrPs, n.var = 20)
#
#head(sort(reg_logitPrPs$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logitPrPs$model.rf$prediction.error
# 7.712546

## prediction error logit scale
inv.logit(reg_logitPrPs$model.rf$prediction.error)
# 0.999553
#
## error rate plot
#err.regAbcrf(object   = reg_logitPrPs,
#             training = data.frame(logitPrPs, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
plot(x    = logitPrPs,
     y    = reg_logitPrPs$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-21,5),
     ylim = c(-21,5),
     main = expression(logit(italic(P)[R] * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.5)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logitPrPs <- data.frame(x = logitPrPs,
                          y = reg_logitPrPs$model.rf$predictions)

#save(oob.logitPrPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logitPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logitPrPs_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logitPrPs$y - oob.logitPrPs$x)^2, na.rm = TRUE)) 
# 2.777147

# Mean bias - log scale
mean(oob.logitPrPs$y - oob.logitPrPs$x, na.rm = TRUE) 
# 0.009528405

# Mean bias - original scale
mean(inv.logit(oob.logitPrPs$y) - inv.logit(oob.logitPrPs$x), na.rm = TRUE) 
#  -0.03386179

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logPrPs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(P)[R] * italic(P)[S]))),
       ylab = expression(paste(logit(italic(P)[R] * italic(P)[S]), " ","(OOB prediction)")),
       xlim = c(-6,0),
       ylim = c(-6,0),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Proportion of selected mutations - POPPrMSel
```{r regression selected mutation, echo=TRUE, eval=FALSE, include=TRUE}

## obtain the vector with values of the population proportion of segragating beneficial mutations
popprmsel <- pooled_reftable_total[, "POPPrMSel"]

## removing simulations with POPPrMSel == 0
zero_popprmsel <- which(popprmsel == 0)
popprmsel_2 <- popprmsel[-zero_popprmsel]
global_sumstats_popprmsel <- global_sumstats[-zero_popprmsel,]

logitpopprmsel <- log(popprmsel_2/(1-popprmsel_2))
hist(logitpopprmsel , freq = TRUE, xlab = expression(logit(italic(P)[S])), main = "", col = "#bdbdbd")

## rf-regression
reg_logitpopprmsel <- regAbcrf(formula = logitpopprmsel~.,
                               data    = data.frame(logitpopprmsel, global_sumstats_popprmsel),
                               ntree   = 1000,
                               paral   = T,
                               ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logitpopprmsel, precheck = T,
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopprmsel_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitpopprmsel_c",".RData"))

## variable Importance plot
plot(x = reg_logitpopprmsel, n.var = 10, main=expression(logit(italic(P)[S])))

#head(sort(reg_logitpopprmsel$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logitpopprmsel$model.rf$prediction.error
# 3.050213
inv.logit(reg_logitpopprmsel$model.rf$prediction.error)
# 0.9547917

## error rate plot
#err.regAbcrf(object   = reg_logitpopprmsel,
#             training = data.frame(logitpopprmsel, global_sumstats_popprmsel),
#             paral    = T,
#            ncores   = 28)

# manuscript plot
oob.logitpopprmsel <- data.frame(x = logitpopprmsel,
                                 y = reg_logitpopprmsel$model.rf$predictions)

## Combined: original reftable + randompods reftable
#save(oob.logitpopprmsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logitpopprmsel_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logitpopprmsel_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logitpopprmsel$y - oob.logitpopprmsel$x)^2, na.rm = TRUE)) 
# 1.746486

# Mean bias - logit scale
mean(oob.logitpopprmsel$y - oob.logitpopprmsel$x, na.rm = TRUE) 
# 0.0250106

# Mean bias - original scale
mean(inv.logit(oob.logitpopprmsel$y) - inv.logit(oob.logitpopprmsel$x), na.rm = TRUE) 
# -0.02766989

par(mar=c(5,5,4,1)+.1)
hist2d(oob.lgtpmsel, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(P)[S]))),
       ylab = expression(paste(logit(italic(hat(P))[S]), " ","(OOB prediction)")),
       xlim = c(-15,2),
       ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### gamma mean - as latent variables
```{r regression gamma mean latent variables, echo=TRUE, eval=FALSE, include=TRUE}

## Mean of selection coefficients of segragating beneficial mutations - POPSelMean
##--------------------------------------------------------------------------------
## obtain the vector with values of the population proportion of segragating beneficial mutations
popselmean_1 <- pooled_reftable_total[, "POPSelMean"]

## removing simulations with POPSelMean == 0
zero_popselmean <- which(popselmean_1 == 0)
popselmean_2 <- popselmean_1[-zero_popselmean]
global_sumstats_popselmean <- global_sumstats[-zero_popselmean ,]

logpopSelMean <- log10(popselmean_2)

hist(logpopSelMean, freq = TRUE, xlab = expression(italic(bar(gamma))[b]), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopselmean <- regAbcrf(formula = logpopSelMean~.,
                              data    = data.frame(logpopSelMean, global_sumstats_popselmean),
                              ntree   = 1000,
                              paral   = T,
                              ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logpopselmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logpopselmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logpopselmean_c",".RData"))
#
## variable Importance plot
#plot(x = reg_logpopselmean, n.var = 20)
#
#head(sort(reg_logpopselmean$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
reg_logpopselmean$model.rf$prediction.error
# 32.13431
#
## error rate plot
#err.regAbcrf(object   = reg_logpopselmean,
#             training = data.frame(logpopselmean, global_sumstats_popselmean),
#             paral    = T,
#             ncores   = 28)

# manuscript plot
oob.logpopselmean <- data.frame(x = logpopSelMean,
                                y = reg_logpopselmean$model.rf$predictions)

## Combined: original reftable + randompods reftable
#save(oob.logpopselmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logpopselmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logpopselmean_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logpopselmean$y - oob.logpopselmean$x)^2, na.rm = TRUE)) 
# 5.668714

# Mean bias - log scale
mean(oob.logpopselmean$y - oob.logpopselmean$x, na.rm = TRUE) 
# -0.3626826

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logpopselmean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(bar(gamma))[b]))),
       ylab = expression(paste(log[10](italic(hat(bar(gamma)))[b]), " ","(OOB prediction)")),
       #xlim = c(-15,2),
       #ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Mean of selection coefficients of segragating strongly beneficial mutations - POPStrongSelMean
##--------------------------------------------------------------------------------
## obtain the vector with values of the population proportion of strongly segragating beneficial mutations
popstrongselmean_1 <- pooled_reftable_total[, "POPStrongSelMean"]

## removing simulations with POPStrongSelMean == 0
zero_popstrongselmean <- which(popstrongselmean_1 == 0)
popstrongselmean_2 <- popstrongselmean_1[-zero_popstrongselmean]
global_sumstats_popstrongselmean <- global_sumstats[-zero_popstrongselmean ,]

logpopStrongSelMean <- log10(popstrongselmean_2)

hist(logpopStrongSelMean, freq = TRUE, xlab = expression(bar(italic(s))), main = "", col = "#bdbdbd")

## rf-regression
reg_logpopstrongselmean <- regAbcrf(formula = logpopStrongSelMean~.,
                                    data    = data.frame(logpopStrongSelMean, global_sumstats_popstrongselmean),
                                    ntree   = 1000,
                                    paral   = T,
                                    ncores  = 8)

#save(reg_logpopstrongselmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logpopstrongselmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logpopstrongselmean_c",".RData"))
#
## variable Importance plot
plot(x = reg_logpopstrongselmean, n.var = 10, main= expression(bar(italic(s))))
#
## prediction error
reg_logpopstrongselmean$model.rf$prediction.error
# 0.1162052
#
## error rate plot
#err.regAbcrf(object   = reg_logpopstrongselmean,
#             training = data.frame(logpopstrongselmean, global_sumstats_popstrongselmean),
#             paral    = T,
#             ncores   = 28)

# manuscript plot
oob.logpopstrongselmean <- data.frame(x = logpopStrongSelMean,
                                      y = reg_logpopstrongselmean$model.rf$predictions)

## Combined: original reftable + randompods reftable
#save(oob.logpopstrongselmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logpopstrongselmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logpopstrongselmean_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logpopstrongselmean$y - oob.logpopstrongselmean$x)^2, na.rm = TRUE)) 
# 0.3408888

# Mean bias - log scale
mean(oob.logpopstrongselmean$y - oob.logpopstrongselmean$x, na.rm = TRUE) 
# -0.005438511

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logpopstrongselmean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", logit(italic(bar(gamma))[s]))),
       ylab = expression(paste(logit(italic(hat(bar(gamma)))[s]), " ","(OOB prediction)")),
       #xlim = c(-15,2),
       #ylim = c(-15,2),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

### ABC-RF regression for demography: growing trees for short-term evolution inference

#### Harmonic mean of the effective population sizes of period 2
```{r regression meanNe2, echo=TRUE, eval=FALSE, include=TRUE}
logmeanNe2 <- log10(pooled_reftable_total[, "meanNe2"])

hist(logmeanNe2, freq = TRUE, xlab = expression(log[10](italic(N)[e])) , main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2 <- regAbcrf(formula = logmeanNe2~.,
                                   data    = data.frame(logmeanNe2, global_sumstats),
                                   ntree   = 1000,
                                   paral   = T,
                                   ncores  = 28)

#save(reg_logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmeanNe2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmeanNe2_c",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2, n.var = 10, main=expression(log[10](italic(N)[e])))

## prediction error
reg_logmeanNe2$model.rf$prediction.error
# 0.02302732

## error rate plot
#err.regAbcrf(object   = reg_logmeanNe2,
#             training = data.frame(logmeanNe2, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logmeanNe2,
     y    = reg_logmeanNe2$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-2,4),
     ylim = c(-2,4),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logmeanNe2 <- data.frame(x = logmeanNe2,
                             y = reg_logmeanNe2$model.rf$predictions)

#save(oob.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logmeanNe2_c",".RData"))

# Mean squered error (MSE) - manually calculated
mse_logmeanNe2 <- mean((oob.logmeanNe2$y - oob.logmeanNe2$x)^2) # (estimated - observed(true))^2
round(mse_logmeanNe2, 3)
# 0.023

# R squared - manually calculated
rsquared_logmeanNe2 <- 1 - (mse_logmeanNe2/var(oob.logmeanNe2$x)) # mse/var(observed)
round(rsquared_logmeanNe2, 3) # 0.972

# Mean bias
mean(oob.logmeanNe2$y - oob.logmeanNe2$x) # estimated - observed(true)
# -0.0002610993

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logmeanNe2, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(OOB prediction)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

# manuscript plot - original scale
#oob.logmeanNe2_origScale <- data.frame(x = 10^logmeanNe2,
#                                       y = 10^reg_logmeanNe2$model.rf$predictions)
#
## Combined: original reftable + randompods reftable
#save(oob.logmeanNe2_origScale, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2_origScale_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logmeanNe2_origScale_c",".RData"))
#
## Mean squered error (MSE) - manually calculated
#mse_meanNe2 <- mean((oob.logmeanNe2_orig$y - oob.logmeanNe2_orig$x)^2) # estimated - observed(true)
#round(mse_meanNe2, 3)
## 17271.92
#
## R squared - manually calculated
#rsquared_meanNe2 <- 1 - (mse_meanNe2/var(oob.logmeanNe2_orig$x)) # mse/var(observed)
#round(rsquared_meanNe2, 3) # 0.913
#
## Mean bias
#mean(oob.logmeanNe2_orig$y - oob.logmeanNe2_orig$x) # estimated - observed(true)
## -16.3499
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logmeanNe2_orig, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", italic(N)[e])),
#       ylab = expression(paste(italic(hat(N))[e], " ","(OOB prediction)")),
#       xlim = c(0,2300),
#       ylim = c(0,2300),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## Comparison with the NE calculation based on the temporal FST
globalFSTNe <- function(x, tau){
  fst  <- x
  ne <- (tau*(1-fst))/(4*fst)
  return(ne)
}

# log10 scale
logfstne2 <- log10(globalFSTNe(x=global_sumstats$GSS_WCst, tau=10))

estimated.fstNe2 <- data.frame(x = logmeanNe2,
                               y = logfstne2)
dim(estimated.fstNe2) #55634     2

#save(estimated.fstNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/estimated.fstNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/estimated.fstNe2",".RData"))

## Combined: original reftable + randompods reftable
#save(estimated.fstNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/estimated.fstNe2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/estimated.fstNe2_c",".RData"))

# remove NAN from the dataset - FST-NE contains NaN after log transformation
estimated.fstNe2.nonan <- estimated.fstNe2[!is.nan(estimated.fstNe2$y), ]
dim(estimated.fstNe2.nonan) #55186     2

# Mean squered error (MSE) - manually calculated
mse_logfstNe2 <- mean((estimated.fstNe2.nonan$y - estimated.fstNe2.nonan$x)^2) # (estimated - observed(true))^2
round(mse_logfstNe2, 3) # 0.299

# R squared 
rsquared_logfstNe2 <- 1 - (mse_logfstNe2/var(estimated.fstNe2.nonan$x)) # mse/var(observed)
round(rsquared_logfstNe2, 3) # 0.630

# Mean bias
mean(estimated.fstNe2.nonan$y - estimated.fstNe2.nonan$x) # estimated - observed(true)
# -0.2744937

par(mar=c(5,5,4,1)+.1)
hist2d(estimated.fstNe2, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

# original scale
#origfstne2 <- globalFSTNe(x=global_sumstats$GSS_WCst, tau=10)
#
#estimated.fstNe2_orig <- data.frame(x = 10^logmeanNe2,
#                                    y = origfstne2)
#
## Combined: original reftable + randompods reftable
#save(estimated.fstNe2_orig, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/estimated.fstNe2_origScale_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/estimated.fstNe2_origScale_c",".RData"))
#
## Mean squered error
#mse_fstNe2 <- mean((estimated.fstNe2_orig$y - estimated.fstNe2_orig$x)^2)
#round(mse_fstNe2, 3)
## 229579508
#
## R squared 
#rsquared_fstNe2 <- 1 - (mse_fstNe2/var(estimated.fstNe2_orig$x)) # mse/var(observed)
#round(rsquared_fstNe2, 3) # -1148.908
#
## Mean bias
#mean(estimated.fstNe2_orig$y - estimated.fstNe2_orig$x, na.rm = TRUE) 
## -162.1487
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(estimated.fstNe2_orig, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", italic(N)[e])),
#       ylab = expression(paste(italic(hat(N))[e], " ","(from", " ", italic(hat(F))[ST], ")")),
#       xlim = c(0,2300),
#       ylim = c(0,2300),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## Error Rata of ABC-RF NE estimates as function of population scaled mutation rate of beneficial mutations
##----------------------------

## RF-NE prediction as a function of theta*PS
ne_thetaPs <- data.frame(obs_ne=oob.logmeanNe2$x, 
                         rf_ne=oob.logmeanNe2$y,
                         #obs_ne_lo=oob.logmeanNe2$x-0.1, # this is not correct: should be the 95% CI
                         #obs_ne_up=oob.logmeanNe2$x+0.1, # this is not correct: should be the 95% CI
                         logthetaPS=logthetaPS) 


#rfne.error <- (!(ne_thetaPs$rf_ne >= ne_thetaPs$obs_ne_lo & ne_thetaPs$rf_ne <= ne_thetaPs$obs_ne_up))
# this is not what we need. It gives the coverage which is interesting, but we need to see the MSE as
# a function of theta_b.

err <- ne_thetaPs$rf_ne - ne_thetaPs$obs_ne # error at each estimate # estimated - observed(true)
global_bias <- mean(err)
global_mse  <- mean(err*err)

tol<-0.2
#rfne.local_error <- array(NA,nrow(ne_thetaPs))
local_bias <- array(NA,nrow(ne_thetaPs))
local_mse <- array(NA,nrow(ne_thetaPs))
for (i in seq_len(nrow(ne_thetaPs))){
  
  distance <- abs(ne_thetaPs$logthetaPS-ne_thetaPs$logthetaPS[i])
  
  # calculate weigths from epachnikov kernel
  nacc <- ceiling(length(distance) * tol)
  ds   <- sort(distance)[nacc]
  weights <- 1 - (distance/ds)^2
  weights[which(weights<0)]<-0

  # calculated weighthed proportion of error
  #rfne.local_error[i]<-sum(rfne.error*weights)/sum(weights)
  local_bias[i] <- weighted.mean(err,weights)
  local_mse[i] <- weighted.mean(err*err,weights)
} # end of loop

#ne_thetaPs["error_rf_ne"] <- rfne.local_error
ne_thetaPs["local_bias"] <- local_bias
ne_thetaPs["local_mse"]  <- local_mse
ne_thetaPs <- ne_thetaPs[order(ne_thetaPs$logthetaPS), ]

## Combined: original reftable + randompods reftable
#save(ne_thetaPs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/ne_thetaPs_mse_bias_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/ne_thetaPs_mse_bias_c",".RData"))

## TRUE NE vs ABCRF-NE - colored by thetaPS
plot(x    = ne_thetaPs$obs_ne,
     y    = ne_thetaPs$rf_ne,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-2,4),
     ylim = c(-2,4),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2,
     col=ifelse(ne_thetaPs$logthetaPS > 4, "red", "black"))
abline(a=0, b=1, col = "green")

# LOCAL MSE PLOT
plot(ne_thetaPs$logthetaPS,
     ne_thetaPs$local_mse,
     xlab=expression(log[10](italic(θ)[b])),
     ylab="Local MSE",
     xlim=c(-7, 7),
     ylim=c(0,1),
     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")

## FST-NE prediction as a function of theta*PS
fstne_thetaPs <- data.frame(obs_ne=estimated.fstNe2$x, 
                            tm_ne =estimated.fstNe2$y,
                            #obs_ne_lo=oob.logmeanNe2$x-0.1, # this is not correct: should be the 95% CI
                            #obs_ne_up=oob.logmeanNe2$x+0.1, # this is not correct: should be the 95% CI
                            logthetaPS=logthetaPS)


dim(fstne_thetaPs) #55634     3

# remove NAN from the dataset - FST-NE contains NaN after log transformation
fstne_thetaPs.nonan <- fstne_thetaPs[!is.nan(fstne_thetaPs$tm_ne), ]
dim(fstne_thetaPs.nonan) #55186     3

#fstne.error <- (!(fstne_thetaPs$tm_ne >= fstne_thetaPs$obs_ne_lo & fstne_thetaPs$tm_ne <= fstne_thetaPs$obs_ne_up))
# this is not what we need. It gives the coverage which is interesting, but we need to see the MSE as
# a function of theta_b.

err <- fstne_thetaPs.nonan$tm_ne - fstne_thetaPs.nonan$obs_ne # error at each estimate # estimated - observed(true)
global_bias <- mean(err)
global_mse  <- mean(err*err)

tol<-0.2
#fstne.local_error <- array(NA,nrow(fstne_thetaPs))
local_bias <- array(NA,nrow(fstne_thetaPs.nonan))
local_mse <- array(NA,nrow(fstne_thetaPs.nonan))
for (i in seq_len(nrow(fstne_thetaPs.nonan))){
  
    distance <- abs(fstne_thetaPs.nonan$logthetaPS-fstne_thetaPs.nonan$logthetaPS[i])
  
  # calculate weigths from epachnikov kernel
  nacc <- ceiling(length(distance) * tol)
  ds   <- sort(distance)[nacc]
  weights <- 1 - (distance/ds)^2
  weights[which(weights<0)]<-0

  # calculated weighthed proportion of error
  #fstne.local_error[i]<-sum(fstne.error*weights)/sum(weights)
  local_bias[i] <- weighted.mean(err,weights)
  local_mse[i] <- weighted.mean(err*err,weights)
}

#fstne_thetaPs["error_tm_ne"] <- fstne.local_error
fstne_thetaPs.nonan["local_bias"] <- local_bias
fstne_thetaPs.nonan["local_mse"]  <- local_mse
fstne_thetaPs.nonan <- fstne_thetaPs.nonan[order(fstne_thetaPs.nonan$logthetaPS),]

## Combined: original reftable + randompods reftable
#save(fstne_thetaPs.nonan, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/fstne_thetaPs_mse_bias_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/fstne_thetaPs_mse_bias_c",".RData"))

## TRUE NE vs FST-NE - colored by thetaPS
plot(x    = fstne_thetaPs.nonan$obs_ne,
     y    = fstne_thetaPs.nonan$tm_ne,
     xlab = "True value",
     ylab = "FST-NE estimates",
     xlim = c(-2,4),
     ylim = c(-2,4),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2,
     col=ifelse(fstne_thetaPs$logthetaPS > 4, "red", "black"))
abline(a=0, b=1, col = "green")

# LOCAL MSE PLOT
plot(fstne_thetaPs.nonan$logthetaPS,
     fstne_thetaPs.nonan$local_mse,
     xlab=expression(log[10](italic(θ)[b])),
     ylab="Local MSE",
     xlim=c(-7, 7),
     ylim=c(0,1),
     type="l",lwd=2,col="black")
#abline(v=0, lty=3, col="gray")

# ERROR RATE PLOT - combined estimates
#-------------------------------------
pdf(file = "~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/abcrfNE_fstNE_local_mse.pdf")
par(mar=c(5,5,4,1)+.1)
plot(ne_thetaPs$logthetaPS,
     ne_thetaPs$local_mse,
     xlab=expression(log[10](italic(theta)[b])),
     ylab=expression(paste("Local MSE", " ",  "from", " ", log[10](hat(italic(N))[e]), " estimates")),
     xlim=c(-7, 7),
     ylim=c(0, 1),
     type="l",lwd=2,col="#4575b4",
     cex.axis = 1.2,
     cex.lab  = 1.2)
lines(fstne_thetaPs.nonan$logthetaPS,
      fstne_thetaPs.nonan$local_mse,
      type="l",lwd=2,col="#fdae61")
#abline(v=0, lty=3, col="gray")
legend("topleft", legend = c(expression(paste(italic(N)[e], " ", "from ABC-RF")),
                             expression(paste(italic(N)[e], " ", "from Temporal", " ", italic(F)[ST]))), 
       col = c("#4575b4", "#fdae61"), lty = 1, lwd=2,bty = "n")
dev.off()
```

#### Population size of period 2 - census size Ncs
```{r regression Ncs, echo=TRUE, eval=FALSE, include=TRUE}
logncs <- log10(pooled_reftable_total[, "Ncs"])

hist(logncs, freq = TRUE, xlab = expression(log[10](italic(N))), main = "", col = "#bdbdbd")

## rf-regression
reg_logncs <- regAbcrf(formula = logncs~.,
                        data = data.frame(logncs, global_sumstats),
                       ntree = 1000,
                       paral = T,
                      ncores = 28)

#save(reg_logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logncs",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logncs_c",".RData"))

## Variable Importance plot
plot(x = reg_logncs, n.var = 10, main=expression(log[10](italic(N)[cs])))

## prediction error
reg_logncs$model.rf$prediction.error
# 0.03172269

## error rate plot
#err.regAbcrf(object   = reg_logncs,
#             training = data.frame(logncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
plot(x    = logncs,
     y    = reg_logncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(0,4),
     ylim = c(0,4),
     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logncs <- data.frame(x = logncs,
                             y = reg_logncs$model.rf$predictions)

#save(oob.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logncs",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob_tables/oob.logncs_c",".RData"))

# Mean squered error (MSE)
mse_logncs <- mean((oob.logncs$y - oob.logncs$x)^2)
round(mse_logncs,3) # 0.032

# R squared
rsquared_logncs <- 1 - (mse_logncs/var(oob.logncs$x, na.rm = TRUE))
round(rsquared_logncs, 3) # 0.966

# Mean bias
mean(oob.logncs$y - oob.logncs$x) 
# 0.002402705

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logncs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[cs]))),
       ylab = expression(paste(log[10](italic(hat(N))[cs]), " ","(OOB prediction)")),
       xlim = c(-0.5,3.5),
       ylim = c(-0.5,3.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r regression MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

logmeanNe2ncs <- log10(pooled_reftable_total[, "meanNe2"]/pooled_reftable_total[, "Ncs"])

hist(logmeanNe2ncs, freq = TRUE, xlab = expression(log[10](italic(N)[e]/italic(N)[cs])), main = "", col = "#bdbdbd")

## rf-regression
reg_logmeanNe2ncs <- regAbcrf(formula = logmeanNe2ncs~.,
                                 data = data.frame(logmeanNe2ncs, global_sumstats),
                                ntree = 1000,
                                paral = T,
                               ncores = 28)

#save(reg_logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmeanNe2ncs",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmeanNe2ncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmeanNe2ncs_c",".RData"))

## Variable Importance plot
plot(x = reg_logmeanNe2ncs, n.var = 10, main=expression(log[10](italic(N)[e]/italic(N)[cs])))

## prediction error
reg_logmeanNe2ncs$model.rf$prediction.error
# 0.02528619

# error rate plot
#err.regAbcrf(object   = reg_logmeanNe2ncs,
#             training = data.frame(logmeanNe2ncs, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logmeanNe2ncs,
     y    = reg_logmeanNe2ncs$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-5,1),
     ylim = c(-5,1),
     main = expression(log[10](italic(N)[e]/italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logmeanNe2ncs <- data.frame(x = logmeanNe2ncs,
                                y = reg_logmeanNe2ncs$model.rf$predictions)

#save(oob.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs",".RData"))

## Combined: original reftable + randompods reftable
#save(oob.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmeanNe2ncs_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logmeanNe2ncs$y - oob.logmeanNe2ncs$x)^2)) 
# 0.1590163

# Mean bias
mean(oob.logmeanNe2ncs$y - oob.logmeanNe2ncs$x) 
# -0.004678916

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logmeanNe2ncs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs]))),
       ylab = expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(OOB prediction)")),
       xlim = c(-3.5,0.5),
       ylim = c(-3.5,0.5),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Per site mutation rate mu
```{r regression site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}
logmu <- log10(pooled_reftable_total[, "mu"])

hist(logmu, freq = TRUE, xlab = expression(log[10](italic(mu))), main = "", col = "#bdbdbd")

## rf-regression
reg_logmu <- regAbcrf(formula = logmu~.,
                      data    = data.frame(logmu, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 8)

#save(reg_logmu, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logmu",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logmu, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmu_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logmu_c",".RData"))

## variable Importance plot
plot(x = reg_logmu, n.var = 10, main=expression(log[10](italic(mu))))

## prediction error
reg_logmu$model.rf$prediction.error
# 0.007255034

## error rate plot
#err.regAbcrf(object   = reg_logmu,
#             training = data.frame(logmu, global_sumstats),
#             paral    = T,
#            ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logmu,
     y    = reg_logmu$model.rf$predictions,
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-10,-6),
     ylim = c(-10,-6),
     main = expression(log[10](italic(mu))),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# Manuscript plot
oob.logmu <- data.frame(x = logmu,
                        y = reg_logmu$model.rf$predictions)

## Combined: original reftable + randompods reftable
#save(oob.logmu, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmu_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logmu_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logmu$y - oob.logmu$x)^2)) 
# 0.08517649

# Mean bias
mean(oob.logmu$y - oob.logmu$x) 
# 0.0006875814

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logmu, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(mu)))),
       ylab = expression(paste(log[10](italic(hat(mu))), " ","(OOB prediction)")),
       xlim = c(-10,-6),
       ylim = c(-10,-6),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### recombination rate rr
```{r regression recombination rate, echo=TRUE, eval=FALSE, include=TRUE}
logrr <- log10(pooled_reftable_total[, "rr"])

hist(logrr, freq = TRUE, xlab = expression(log[10](italic(c)[0])), main = "", col = "#bdbdbd")

## rf-regression
reg_logrr <- regAbcrf(formula = logrr~.,
                       data    = data.frame(logrr, global_sumstats),
                       ntree   = 1000,
                       paral   = T,
                       ncores  = 8)

#save(reg_logrr, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrr",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrr",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logrr, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logrr_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/regression/reg_logrr_c",".RData"))

## variable Importance plot
plot(x = reg_logrr, n.var = 10, main=expression(log[10](italic(c)[0])))

#head(sort(reg_logrr$model.rf$variable.importance, decreasing = T), n=20)

## prediction error
reg_logrr$model.rf$prediction.error
#  0.3642414
#
## error rate plot
#err.regAbcrf(object   = reg_logrr,
#             training = data.frame(logrr, global_sumstats),
#             paral    = T,
#             ncores   = 28)

## oob predictions vs true values
# diagnostic plot
plot(x    = logrr,
     y    = reg_logrr$model.rf$predictions, 
     xlab = "True value",
     ylab = "OOB predictions",
     xlim = c(-10,-6),
     ylim = c(-10,-6),
     main = expression(log[10](italic(c)[0])),
     cex.axis = 1.2,
     cex.lab  = 1.2)
abline(a=0, b=1, col = "green")

# manuscript plot
oob.logrr <- data.frame(x = logrr,
                        y = reg_logrr$model.rf$predictions)

## Combined: original reftable + randompods reftable
#save(oob.logrr, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrr_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrr_c",".RData"))

# Root mean squered error
sqrt(mean((oob.logrr$y - oob.logrr$x)^2)) 
# 0.6013506

# Mean bias
mean(oob.logrr$y - oob.logrr$x) 
#  0.02327319

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logrr, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(c)[0]))),
       ylab = expression(paste(log[10](italic(hat(c)[0])), " ","(OOB prediction)")),
       xlim = c(-9.4,-6.4),
       ylim = c(-9.4,-6.4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

### ABC-RF regression: growing trees for long-term evolution inference

#### Ns - gamma mean parameter
```{r regression Ns gamma mean parameter, echo=TRUE, eval=FALSE, include=TRUE}

## Effective population size of period 2
##--------------------------------------
logNs <- log10(pooled_reftable_total[, "meanNe2"] * pooled_reftable_total[, "gammaMean"])

hist(logNs, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(s))), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logNs <- regAbcrf(formula = logNs~.,
                      data    = data.frame(logNs, global_sumstats),
                      ntree   = 1000,
                      paral   = T,
                      ncores  = 8)

#save(reg_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNs_c",".RData"))

# variable Importance plot
#plot(x = reg_logNs, n.var = 20, main=expression(log[10](italic(N)[e] * italic(s))))

#head(sort(reg_logNs$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNs$model.rf$prediction.error
# 0.6349375

# error rate plot
#err.regAbcrf(object   = reg_logNs,
#             training = data.frame(logNs, global_sumstats),
#             paral    = T,
#             ncores   = 8)
#
#manuscript plot
oob.logNs <- data.frame(x = logNs,
                       y = reg_logNs$model.rf$predictions)

#save(oob.logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNs_c",".RData"))
#
par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(gamma)))),
       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(gamma)), " ","(OOB prediction)")),
       xlim = c(-4,4),
       ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
#
## Population Census size of period 2
###--------------------------------------
logNCSs <- log10(pooled_reftable_total[, "Ncs"] * pooled_reftable_total[, "gammaMean"])

hist(logNCSs, freq = TRUE, xlab = expression(log[10](italic(N) * italic(s))), main = "", col = "#bdbdbd")

## abf-rf regression
reg_logNCSs <- regAbcrf(formula = logNCSs~.,
                        data    = data.frame(logNCSs, global_sumstats),
                        ntree   = 1000,
                        paral   = T,
                        ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logNCSs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSs_c",".RData"))

# variable Importance plot
#plot(x = reg_logNCSs, n.var = 20, main=expression(log[10](italic(N) * italic(s))))

#head(sort(reg_logNs$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNCSs$model.rf$prediction.error
# 0.6660807

# error rate plot
#err.regAbcrf(object   = reg_logNCSs,
#             training = data.frame(logNCSs, global_sumstats),
#             paral    = T,
#             ncores   = 8)

# manuscript plot
oob.logNCSs <- data.frame(x = logNCSs,
                        y = reg_logNCSs$model.rf$predictions)

#save(oob.logNCSs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSs_c",".RData"))
#
par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNCSs, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N) * italic(gamma)))),
       ylab = expression(paste(log[10](italic(hat(N)) * italic(gamma)), " ","(OOB prediction)")),
       xlim = c(-4,4),
       ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Ns - gamma mean laten variable
```{r regression Ns gamma laten variable, echo=TRUE, eval=FALSE, include=TRUE}

## Effective population size of period 2 and POPSelMean
##-----------------------------------------------------
logNsMean <- log10(pooled_reftable_total[-zero_popselmean, "meanNe2"] * pooled_reftable_total[-zero_popselmean, "POPSelMean"])

hist(logNsMean, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(bar(gamma))[b])), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logNsMean <- regAbcrf(formula = logNsMean~.,
                          data    = data.frame(logNsMean, global_sumstats_popselmean),
                          ntree   = 1000,
                          paral   = T,
                          ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logNsMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNsMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNsMean_c",".RData"))

# variable Importance plot
#plot(x = reg_logNsMean, n.var = 20, main=expression(log[10](italic(N)[e] * italic(bar(s)))))

#head(sort(reg_logNsMean$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNsMean$model.rf$prediction.error
# 32.3132

# error rate plot
#err.regAbcrf(object   = reg_logNsMean,
#             training = data.frame(logNs, global_sumstats_popprmsel),
#             paral    = T,
#             ncores   = 8)
#
#manuscript plot
oob.logNsMean <- data.frame(x = logNsMean,
                            y = reg_logNsMean$model.rf$predictions)

#save(oob.logNsMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNsMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNsMean_c",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNsMean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(bar(gamma))[b]))),
       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(bar(gamma))[b]), " ","(OOB prediction)")),
       #xlim = c(-4,4),
       #ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
#
## Population Census size of period 2 and POPSelMean
###-------------------------------------------------
logNCSsmean <- log10(pooled_reftable_total[-zero_popselmean, "Ncs"] * pooled_reftable_total[-zero_popselmean, "POPSelMean"])

hist(logNCSsmean, freq = TRUE, xlab = expression(log[10](italic(N) * italic(bar(gamma))[b])), main = "", col = "#bdbdbd")

## abf-rf regression
reg_logNCSsmean <- regAbcrf(formula = logNCSsmean~.,
                            data    = data.frame(logNCSsmean, global_sumstats_popselmean),
                            ntree   = 1000,
                            paral   = T,
                            ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logNCSsmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSsmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSsmean_c",".RData"))

# variable Importance plot
#plot(x = reg_logNCSsmean, n.var = 20, main=expression(log[10](italic(N) * italic(bar(s)))))

#head(sort(reg_logNCSsmean$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNCSsmean$model.rf$prediction.error
# 32.34188

# error rate plot
#err.regAbcrf(object   = reg_logNCSsmean,
#             training = data.frame(logNCSsmean, global_sumstats_popprmsel),
#             paral    = T,
#             ncores   = 8)

# manuscript plot
oob.logNCSsmean <- data.frame(x = logNCSsmean,
                              y = reg_logNCSsmean$model.rf$predictions)

#save(oob.logNCSsmean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSsmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSsmean_c",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNCSsmean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N) * italic(bar(gamma))[b]))),
       ylab = expression(paste(log[10](italic(hat(N)) * italic(bar(gamma))[b]), " ","(OOB prediction)")),
       #xlim = c(-4,4),
       #ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)

## Effective population size of period 2 and POPStrongSelMean
##-----------------------------------------------------
logNstrongMean <- log10(pooled_reftable_total[-zero_popstrongselmean, "meanNe2"] * 
                          pooled_reftable_total[-zero_popstrongselmean, "POPStrongSelMean"])

hist(logNstrongMean, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(bar(gamma))[s])), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logNstrongMean <- regAbcrf(formula = logNstrongMean~.,
                               data    = data.frame(logNstrongMean, global_sumstats_popstrongselmean),
                               ntree   = 1000,
                               paral   = T,
                               ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logNstrongMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNstrongMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNstrongMean_c",".RData"))

# variable Importance plot
#plot(x = reg_logNsMean, n.var = 20, main=expression(log[10](italic(N)[e] * italic(bar(s)))))

#head(sort(reg_logNsMean$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNstrongMean$model.rf$prediction.error
# 0.1355917

# error rate plot
#err.regAbcrf(object   = reg_logNstrongMean,
#             training = data.frame(logNstrongMean, global_sumstats_popstrongselmean),
#             paral    = T,
#             ncores   = 8)
#
#manuscript plot
oob.logNstrongMean <- data.frame(x = logNstrongMean,
                                 y = reg_logNstrongMean$model.rf$predictions)

#save(oob.logNstrongMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNstrongMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNstrongMean_c",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNstrongMean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N)[e] * italic(bar(gamma))[s]))),
       ylab = expression(paste(log[10](italic(hat(N))[e] * italic(bar(gamma))[s]), " ","(OOB prediction)")),
       #xlim = c(-4,4),
       #ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
#
## Population Census size of period 2 and POPSelMean
###-------------------------------------------------
logNCSstrongMean <- log10(pooled_reftable_total[-zero_popstrongselmean, "Ncs"] * 
                          pooled_reftable_total[-zero_popstrongselmean, "POPStrongSelMean"])

hist(logNCSstrongMean, freq = TRUE, xlab = expression(log[10](italic(N)[e] * italic(bar(gamma))[s])), main = "", col = "#bdbdbd")

# abf-rf regression
reg_logNCSstrongMean <- regAbcrf(formula = logNCSstrongMean~.,
                                 data    = data.frame(logNCSstrongMean, global_sumstats_popstrongselmean),
                                 ntree   = 1000,
                                 paral   = T,
                                 ncores  = 8)

## Combined: original reftable + randompods reftable
#save(reg_logNCSstrongMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSstrongMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logNCSstrongMean_c",".RData"))

# variable Importance plot
#plot(x = reg_logNCSstrongMean, n.var = 20, main=expression(log[10](italic(N)[e] * italic(bar(s)))))

#head(sort(reg_logNCSstrongMean$model.rf$variable.importance, decreasing = T), n=20)

# prediction error
reg_logNCSstrongMean$model.rf$prediction.error
# 0.1658322

# error rate plot
#err.regAbcrf(object   = reg_logNCSstrongMean,
#             training = data.frame(logNCSstrongMean, global_sumstats_popstrongselmean),
#             paral    = T,
#             ncores   = 8)
#
#manuscript plot
oob.logNCSstrongMean <- data.frame(x = logNCSstrongMean,
                                   y = reg_logNCSstrongMean$model.rf$predictions)

#save(oob.logNCSstrongMean, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSstrongMean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logNCSstrongMean_c",".RData"))

par(mar=c(5,5,4,1)+.1)
hist2d(oob.logNCSstrongMean, nbins=100, 
       col=viridis::viridis(32), 
       FUN=function(x) log(length(x)),
       xlab = expression(paste("true", " ", log[10](italic(N) * italic(bar(gamma))[s]))),
       ylab = expression(paste(log[10](italic(hat(N)) * italic(bar(gamma))[s]), " ","(OOB prediction)")),
       #xlim = c(-4,4),
       #ylim = c(-4,4),
       cex.axis = 1.2,
       cex.lab  = 1.2)
abline(a=0, b=1, col = "black", lty = 3)
```

#### Theta of perid 2
```{r regression theta 2, echo=TRUE, eval=FALSE, include=TRUE}
#genomeS = 100e+6
#logtheta2 <- log10(4 * pooled_reftable_total[, "meanNe2"] * (pooled_reftable_total[, "mu"]) * genomeS)
#
#hist(logtheta2, freq = TRUE, xlab = expression(log[10](italic(θ))), main = "", col = "#bdbdbd")
#
#reg_logtheta2 <- regAbcrf(formula = logtheta2~.,
#                          data    = data.frame(logtheta2, global_sumstats),
#                          ntree   = 1000,
#                          paral   = T,
#                          ncores  = 28)
#
#save(reg_logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2",".RData"))

## Combined: original reftable + randompods reftable
#save(reg_logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta2_c",".RData"))
#
## variable Importance plot
#plot(x = reg_logtheta2, n.var = 10, main=expression(log[10](italic(θ))))
#
#head(sort(reg_logtheta2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logtheta2$model.rf$prediction.error
# 0.02078171
#
## error rate plot
#err.regAbcrf(object   = reg_logtheta2,
#             training = data.frame(logtheta1, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logtheta2,
#     y    = reg_logtheta2$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-2,6),
#     ylim = c(-2,6),
#     main = expression(log[10](italic(theta))),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
# Manuscript plot
#oob.logtheta2 <- data.frame(x = logtheta2,
#                                y = reg_logtheta2$model.rf$predictions)
#
#save(oob.logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2",".RData"))
#
## Combined: original reftable + randompods reftable
#save(oob.logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logtheta2_c",".RData"))
#
# Root mean squered error
#sqrt(mean((oob.logtheta2$y - oob.logtheta2$x)^2)) 
# 0.1441586
#
# Mean bias
#mean(oob.logtheta2$y - oob.logtheta2$x) 
# 0.000302432
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logtheta2, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ)))),
#       ylab = expression(paste(log[10](italic(hat(θ))), " ","(OOB prediction)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### Rho = Nr
```{r regression rho, echo=TRUE, eval=FALSE, include=TRUE}

## Effective population size
###---------------------------------------
#
#logrho <- log10(pooled_reftable_total[, "meanNe2"] * pooled_reftable_total[, "rr"])
#
#hist(logrho, freq = TRUE, xlab = expression(log[10](italic(N)[e]*c[0])), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logrho <- regAbcrf(formula = logrho~.,
#                       data    = data.frame(logrho, global_sumstats),
#                       ntree   = 1000,
#                       paral   = T,
#                       ncores  = 8)
#
#save(reg_logrho, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho",".RData"))
#
## Combined: original reftable + randompods reftable
#save(reg_logrho, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrho_c",".RData"))
#
## variable Importance plot
#plot(x = reg_logrho, n.var = 20)
#
#head(sort(reg_logrho$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logrho$model.rf$prediction.error
#  0.3960499
#
## error rate plot
#err.regAbcrf(object   = reg_logrho,
#             training = data.frame(logrho, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logrho,
#     y    = reg_logrho$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-2),
#     ylim = c(-10,-2),
#     main = expression(log[10](italic(N)[e]*c[0])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logrho <- data.frame(x = logrho,
#                         y = reg_logrho$model.rf$predictions)
#
## Combined: original reftable + randompods reftable
#save(oob.logrho, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrho_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrho_c",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logrho, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e]*c[0]))),
#       ylab = expression(paste(log[10](italic(hat(N)[e]*c[0])), " ","(OOB prediction)")),
#       xlim = c(-10,-2),
#       ylim = c(-10,-2),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## Population Census size
##---------------------------------------
#
#logrhoN <- log10(pooled_reftable_total[, "Ncs"] * pooled_reftable_total[, "rr"])
#
#hist(logrhoN, freq = TRUE, xlab = expression(log[10](italic(N)[e]*c[0])), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logrhoN <- regAbcrf(formula = logrhoN~.,
#                       data    = data.frame(logrhoN, global_sumstats),
#                       ntree   = 1000,
#                       paral   = T,
#                       ncores  = 8)
#
## Combined: original reftable + randompods reftable
#save(reg_logrhoN, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrhoN_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logrhoN_c",".RData"))
#
## variable Importance plot
#plot(x = reg_logrhoN, n.var = 20)
#
#head(sort(reg_logrhoN$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logrhoN$model.rf$prediction.error
#  0.4320984
#
## error rate plot
#err.regAbcrf(object   = reg_logrhoN,
#             training = data.frame(logrhoN, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logrhoN,
#     y    = reg_logrhoN$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-2),
#     ylim = c(-10,-2),
#     main = expression(log[10](italic(N)*c[0])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#oob.logrhoN <- data.frame(x = logrhoN,
#                          y = reg_logrhoN$model.rf$predictions)
#
## Combined: original reftable + randompods reftable
#save(oob.logrhoN, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrhoN_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/oob.logrhoN_c",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logrhoN, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)*c[0]))),
#       ylab = expression(paste(log[10](italic(hat(N)*c[0])), " ","(OOB prediction)")),
#       xlim = c(-10,-2),
#       ylim = c(-10,-2),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

## Sampling period inference

### ABC-RF classification for selection: prediction for short-term evolution

#### Classification based on the proportion of strongly selected mutations - POPPrStrongMSel: quasi-Neutral vs strong-Selection
```{r classification testing neutral_selection, echo=TRUE, eval=FALSE, include=TRUE}

### RANDOM PODS
###-----------------------------------------------------------

## rf-classification
#posterior_class_selection_1 <- predict(object     = class_selection_1,
#                                       obs        = global_sumstats_pods[,-c(117)],
#                                       training   = data.frame(selection_1, global_sumstats[,-c(117)]),
#                                       ntree      = 1000,
#                                       paral      = TRUE,
#                                       paral.predict = TRUE,
#                                       ncores     = 2)
#
#save(posterior_class_selection_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1",".RData"))
#
#(posterior_class_selection_1)
#
## True Classification based on POPPrStrongMSel
#selection_1_pods <- ifelse(pooled_reftable_pods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
#table(selection_1_pods)
#
#class_selection_1_table <- data.frame(obs=selection_1_pods, pred=posterior_class_selection_1$allocation)
#table(class_selection_1_table)
#
#Confusion matrix: classification of 1000 RANDOM PODs
#          pred
#obs        qNeutral sSel class.error
#  qNeutral      709  164 0.187858
#  sSel          201  803 0.2001992
#
#TPR = 709/(709+201) = 0.7791209 #sensitivity, recall
#TNR = 803/(803+164) = 0.8304033 #specificity, selectivity
#PPV = 709/(709+164) = 0.812142 # precision
#NPV = 803/(803+201) = 0.7998008
#
## Global error rate
#class_sel_1_global_error <- ifelse(class_selection_1_table$obs == class_selection_1_table$pred, 0, 1)
#sum(class_sel_1_global_error)/length(class_sel_1_global_error)
# global error = 0.1944592
#
## Keep 1000 random PODs and mark those that were classified as qNeutral
#neutral_randompods <- which(posterior_class_selection_1$allocation == "qNeutral")

### FIXED PODS
###-----------------------------------------------------------

## rf-classification
posterior_class_selection_1_fixedpods <- predict(object        = class_selection_1,
                                                 obs           = global_sumstats_fixedpods[,-c(117)],
                                                 training      = data.frame(selection_1, global_sumstats[,-c(117)]),
                                                 ntree         = 5000,
                                                 paral         = TRUE,
                                                 paral.predict = TRUE,
                                                 ncores        = 8)

#save(posterior_class_selection_1_fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_class_selection_1_fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_c",".RData"))

#(posterior_class_selection_1_fixedpods)

## True Classification based on POPPrStrongMSel
selection_1_fixedpods <- ifelse(pooled_reftable_fixedpods[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_fixedpods)

class_selection_1_table_fixedpods <- data.frame(obs=selection_1_fixedpods, pred=posterior_class_selection_1_fixedpods$allocation)
table(class_selection_1_table_fixedpods)
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      164    6  0.03529412
#  sSel           30  100  0.2307692

## Global error rate
class_sel_1_global_error_fixedpods <- ifelse(class_selection_1_table_fixedpods$obs == class_selection_1_table_fixedpods$pred, 0, 1)
sum(class_sel_1_global_error_fixedpods)/length(class_sel_1_global_error_fixedpods)
# global error = 0.12

## NEUTRAL
table(class_selection_1_table_fixedpods[1:100, ])
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      99    1  0.01
#  sSel           0    0  0

#class error qneutral = (1/100)*100 = 1
#Accuracy=((99+0)/100)*100 = 99

sum(class_sel_1_global_error_fixedpods[1:100])/length(class_sel_1_global_error_fixedpods[1:100])
# global error rate = 0.01

## MUTATION LIMITED s = 0.1
table(class_selection_1_table_fixedpods[101:200, ])
#          pred
#obs        qNeutral sSel error.rate
#  qNeutral       65    5 0.07142857
#  sSel           30    0 1
#
#class error qneutral = (5/70)*100 = 7.142857
#class error sselection = (30/30)*100 = 100
#Accuracy=((65+0)/100)*100 = 65

sum(class_sel_1_global_error_fixedpods[101:200])/length(class_sel_1_global_error_fixedpods[101:200])
# global error rate = 0.35

## MUTATION UNLIMITED s = 0.1
table(class_selection_1_table_fixedpods[201:300, ])
#          pred
#obs        qNeutral sSel class.error
#  qNeutral        0    0 0
#  sSel            0  100 0
#
#class error qneutral = (0/0)*100 = 0
#class error sselection = (100/100)*100 = 100
#Accuracy=((100+0)/100)*100 = 100

sum(class_sel_1_global_error_fixedpods[201:300])/length(class_sel_1_global_error_fixedpods[201:300])
# global error rate = 0

### FIXED PODS ADDITIONAL
###-----------------------------------------------------------

## rf-classification
posterior_class_selection_1_fixedpods_add <- predict(object        = class_selection_1,
                                                     obs           = global_sumstats_fixedpods_add[,-c(117)],
                                                     training      = data.frame(selection_1, global_sumstats[,-c(117)]),
                                                     ntree         = 5000,
                                                     paral         = TRUE,
                                                     paral.predict = TRUE,
                                                     ncores        = 28)

#save(posterior_class_selection_1_fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_class_selection_1_fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_class_selection_1_fixedpods_add_c",".RData"))

#(posterior_class_selection_1_fixedpods_add)

## True Classification based on POPPrStrongMSel
selection_1_fixedpods_add <- ifelse(pooled_reftable_fixedpods_add[, "POPPrStrongMSel"] == 0, "qNeutral", "sSel")
table(selection_1_fixedpods_add)

class_selection_1_table_fixedpods_add <- data.frame(obs=selection_1_fixedpods_add, pred=posterior_class_selection_1_fixedpods_add$allocation)

## Global error rate
class_sel_1_global_error_fixedpods_add <- ifelse(class_selection_1_table_fixedpods_add$obs == class_selection_1_table_fixedpods_add$pred, 0, 1)

## MUTATION LIMITED s = 0.01
table(class_selection_1_table_fixedpods_add[1:100, ])
## Confusion matrix: classification
#          pred
#obs        qNeutral sSel  class.error
#  qNeutral      97    0   0
#  sSel           3    0   1
#
#class error qneutral = (0/97)*100 = 0
#class error sselection = (3/3)*100 = 100
#Accuracy=((97+0)/100)*100 = 97

sum(class_sel_1_global_error_fixedpods_add[1:100])/length(class_sel_1_global_error_fixedpods_add[1:100])
# global error rate = 0.03

## MUTATION UNLIMITED s = 0.01
table(class_selection_1_table_fixedpods_add[201:300, ])
#          pred
#obs        qNeutral sSel class.error
#  qNeutral        0    0 0
#  sSel            0  100 0
#
#class error qneutral = (0/0)*100 = 0
#class error sselection = (0/100)*100 = 0
#Accuracy=((100+0)/100)*100 = 100

sum(class_sel_1_global_error_fixedpods_add[201:300])/length(class_sel_1_global_error_fixedpods_add[201:300])
# global error rate = 0
```

### ABC-RF regression for selection: prediction for short-term evolution

#### Average genetic load
```{r prediction average genetic load, echo=TRUE, eval=FALSE, include=TRUE}
### RANDOM PODs
###-----------------------------------------------------------

#posterior_radnompods_averageGenLoad <- predict(object     = reg_averageGenLoad,
#                                               obs        = global_sumstats_pods,
#                                               training   = data.frame(logaverageGenload, global_sumstats),
#                                               quantiles  = c(0.025,0.5,0.975),
#                                               paral      = T,
#                                               ncores     = 2,
#                                               rf.weights = T)
#
#save(posterior_radnompods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad",".RData"))
#
## prepare the vector with the true values - transformed
#log_randompods_averageGenLoad <- -log10(1-pooled_reftable_pods[, "averageGeneticLoad"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = log_randompods_averageGenLoad[-neutral_randompods], 
#     y    = posterior_radnompods_averageGenLoad$expectation[-neutral_randompods],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     main = expression(log[10](italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
## logit transformation I:
#posterior_radnompods_averageGenLoad_2 <- predict(object     = reg_averageGenLoad_2,
#                                                 obs        = global_sumstats_pods,
#                                                 training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
#                                                 quantiles  = c(0.025,0.5,0.975),
#                                                 paral      = T,
#                                                 ncores     = 6,
#                                                 rf.weights = T)
#
#save(posterior_radnompods_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_averageGenLoad_2",".RData"))
#
## prepare the vector with the true values - transformed
#logitaverageGenload_randompods <- log(pooled_reftable_pods[, "averageGeneticLoad"]/(1-pooled_reftable_pods[, "averageGeneticLoad"]))
#
# -Inf for the lowest -1 value 
#logitaverageGenload_randompods <- replace(logitaverageGenload_randompods,
#                                          logitaverageGenload_randompods == -Inf, -17)
## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations ? 
#plot(x    = logitaverageGenload_randompods, 
#     y    = posterior_radnompods_averageGenLoad_2$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-17,6),
#     ylim = c(-17,6),
#     main = expression(logit(italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.lgtgl <- data.frame(x = logitaverageGenload_randompods,
#                         y = posterior_radnompods_averageGenLoad_2$expectation)
#save(pred.lgtgl, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.lgtgl, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", logit(italic(L)))),
#       ylab = expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")),
#       xlim = c(-17,6),
#       ylim = c(-17,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

# Use the trained ABC-RF to predict the parameter of the neutral simulations
averageGenLoad_load_zero <- averageGenLoad[load_zero]
global_sumstats_averageGenLoad_load_zero <- global_sumstats[load_zero,]

posterior_randompods_averageGenLoad_load_zero <- predict(object     = reg_averageGenLoad_2,
                                                         obs        = global_sumstats_averageGenLoad_load_zero[18001:19608,],
                                                         training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                         quantiles  = c(0.025,0.5,0.975),
                                                         paral      = T,
                                                         ncores     = 8,
                                                         rf.weights = T)
# simulations 1:4000
#posterior_randompods_averageGenLoad_load_zero_1 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_1",".RData"))

# simulations 4001:8000
#posterior_randompods_averageGenLoad_load_zero_2 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_2",".RData"))

# simulations 8001:12000
#posterior_randompods_averageGenLoad_load_zero_3 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_3",".RData"))

# simulations 12001:16000
#posterior_randompods_averageGenLoad_load_zero_4 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_4, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_4",".RData"))

# simulations 16001:18000
#posterior_randompods_averageGenLoad_load_zero_5 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_5, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_5",".RData"))

# simulations 18001:19608
#posterior_randompods_averageGenLoad_load_zero_6 <- posterior_randompods_averageGenLoad_load_zero
#save(posterior_randompods_averageGenLoad_load_zero_6, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_6",".RData"))

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_4",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_5",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_averageGenLoad_load_zero_6",".RData"))

posterior_averageGenLoad_load_zero_mean <- c(posterior_randompods_averageGenLoad_load_zero_1$expectation,
                                             posterior_randompods_averageGenLoad_load_zero_2$expectation,
                                             posterior_randompods_averageGenLoad_load_zero_3$expectation,
                                             posterior_randompods_averageGenLoad_load_zero_4$expectation,
                                             posterior_randompods_averageGenLoad_load_zero_5$expectation,
                                             posterior_randompods_averageGenLoad_load_zero_6$expectation)

pred.lgtgl.neutralsims <- data.frame(obs_l = averageGenLoad_load_zero,
                                     est_lgtl = posterior_averageGenLoad_load_zero_mean,
                                     est_l = inv.logit(posterior_averageGenLoad_load_zero_mean),
                                     col = rep("neutral", length(averageGenLoad_load_zero)))

#save(pred.lgtgl.neutralsims, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.neutralsims",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.neutralsims",".RData"))

# MEAN BIAS
mean(pred.lgtgl.neutralsims$est_l - pred.lgtgl.neutralsims$obs_l, na.rm = TRUE) 
# L=0: 0.08941246

# boxplot ABC-RF mean posterior estimates - logit scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.lgtgl.neutralsims$est_lgtl, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")))
axis(1, at=1, labels="neutral/quasi-neutral")

# boxplot ABC-RF mean posterior estimates - natural scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.lgtgl.neutralsims$est_l, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(italic(hat(L)), " ","(ABC-RF)")))
axis(1, at=1, labels="neutral/quasi-neutral")
abline(h=0, col="darkgrey", lty=3)


### FIXED PODs
###-----------------------------------------------------------

#posterior_fixedpods_averageGenLoad <- predict(object     = reg_averageGenLoad,
#                                              obs        = global_sumstats_fixedpods,
#                                              training   = data.frame(logaverageGenload, global_sumstats),
#                                              quantiles  = c(0.025,0.5,0.975),
#                                              paral      = T,
#                                              ncores     = 28,
#                                              rf.weights = T)
#
#save(posterior_fixedpods_averageGenLoad, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad",".RData"))
#
## prepare the vector with the true values - transformed
#log_fixedpods_averageGenLoad <- -log10(1-pooled_reftable_fixedpods[, "averageGeneticLoad"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = log_fixedpods_averageGenLoad, 
#     y    = posterior_fixedpods_averageGenLoad$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(0,3),
#     ylim = c(0,3),
#     main = expression(log[10](italic(L))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation I:
posterior_fixedpods_averageGenLoad_2 <- predict(object     = reg_averageGenLoad_2,
                                                obs        = global_sumstats_fixedpods,
                                                training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                quantiles  = c(0.025,0.5,0.975),
                                                paral      = T,
                                                ncores     = 6,
                                                rf.weights = T)

#save(posterior_fixedpods_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_averageGenLoad_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_c",".RData"))

## prepare the vector with the true values - transformed
logitaverageGenload_fixedpods <- log(pooled_reftable_fixedpods[, "averageGeneticLoad"]/(1-pooled_reftable_fixedpods[, "averageGeneticLoad"]))

# -Inf for the lowest -1 value 
logitaverageGenload_fixedpods <- replace(logitaverageGenload_fixedpods,
                                          logitaverageGenload_fixedpods == -Inf, -17)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitaverageGenload_fixedpods, 
     y    = posterior_fixedpods_averageGenLoad_2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-17,6),
     ylim = c(-17,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtgl.fixedpods <- data.frame(obs_lgt = logitaverageGenload_fixedpods,
                                   est_lgt = posterior_fixedpods_averageGenLoad_2$expectation,
                                   obs_l   = pooled_reftable_fixedpods[, "averageGeneticLoad"],
                                   est_l   = inv.logit(posterior_fixedpods_averageGenLoad_2$expectation),
                                   c = c(rep("A", 100), rep("B", 100), rep("C", 100)))

#save(pred.lgtgl.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.lgtgl.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.lgtgl.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_c_2",".RData"))

ggplot(pred.lgtgl.fixedpods, aes(x=inv.logit(x) , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A", "B", "C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", italic(L)))) +
  ylab(expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")))+
  xlim(0, 1.0) +
  ylim(-6, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.lgtgl.fixedpods$est_l[1:100] - pred.lgtgl.fixedpods$obs_l[1:100], na.rm = TRUE) 
# Neutral: 0.01852189
mean(pred.lgtgl.fixedpods$est_l[101:200] - pred.lgtgl.fixedpods$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.1: -0.00428568
mean(pred.lgtgl.fixedpods$est_l[201:300] - pred.lgtgl.fixedpods$obs_l[201:300], na.rm = TRUE) 
# Limited s=0.1: -0.0486825


### FIXED PODs ADDITIONAL
###-----------------------------------------------------------

## logit transformation I:
posterior_fixedpods_averageGenLoad_2_add <- predict(object     = reg_averageGenLoad_2,
                                                    obs        = global_sumstats_fixedpods_add,
                                                    training   = data.frame(logitaverageGenload, global_sumstats_averageGenLoad),
                                                    quantiles  = c(0.025,0.5,0.975),
                                                    paral      = T,
                                                    ncores     = 6,
                                                    rf.weights = T)

#save(posterior_fixedpods_averageGenLoad_2_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_averageGenLoad_2_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_averageGenLoad_2_add_c",".RData"))

## prepare the vector with the true values - transformed
logitaverageGenload_fixedpods_add <- log(pooled_reftable_fixedpods_add[, "averageGeneticLoad"]/(1-pooled_reftable_fixedpods_add[, "averageGeneticLoad"]))

# -Inf for the lowest -1 value 
logitaverageGenload_fixedpods_add <- replace(logitaverageGenload_fixedpods_add,
                                             logitaverageGenload_fixedpods_add == -Inf, -17)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitaverageGenload_fixedpods_add, 
     y    = posterior_fixedpods_averageGenLoad_2_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-17,6),
     ylim = c(-17,6),
     main = expression(logit(italic(L))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtgl.fixedpods_add <- data.frame(obs_lgt = c(logitaverageGenload_fixedpods[1:100], 
                                                   logitaverageGenload_fixedpods_add),
                                       est_lgt = c(posterior_fixedpods_averageGenLoad_2$expectation[1:100],
                                                   posterior_fixedpods_averageGenLoad_2_add$expectation),
                                       obs_l   = c(pooled_reftable_fixedpods[1:100, "averageGeneticLoad"],
                                                   pooled_reftable_fixedpods_add[, "averageGeneticLoad"]),
                                       est_l   = c(inv.logit(posterior_fixedpods_averageGenLoad_2$expectation[1:100]),
                                                   inv.logit(posterior_fixedpods_averageGenLoad_2_add$expectation)),
                                       c = c(rep("A", 100), rep("B", 200), rep("C", 200)))

#save(pred.lgtgl.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.lgtgl.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.lgtgl.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtgl.fixedpods_add_c_2",".RData"))

ggplot(pred.lgtgl.fixedpods_add[c(1:100, 101:200,301:400),], aes(x=inv.logit(x) , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", italic(L)))) +
  ylab(expression(paste(logit(italic(hat(L))), " ","(ABC-RF)")))+
  xlim(0, 1) +
  ylim(-6, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.lgtgl.fixedpods_add$est_l[101:200] - pred.lgtgl.fixedpods_add$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.01: 0.01089778
mean(pred.lgtgl.fixedpods_add$est_l[301:400] - pred.lgtgl.fixedpods_add$obs_l[301:400], na.rm = TRUE) 
# Unlimited s=0.01: -0.03853554
```

#### Proportion of strongly selected mutations - POPPrStrongMSel
```{r prediction strongly selected mutations, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------

# log10 transformation
#posterior_radnompods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                 obs        = global_sumstats_pods,
#                                                 training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                                 quantiles  = c(0.025,0.5,0.975),
#                                                 paral      = T,
#                                                 ncores     = 20,
#                                                 rf.weights = T)
#
#save(posterior_radnompods_logpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logpopstrongmsel",".RData"))
#
## prepare the vector with the true values - transformed
#log_radnompods_popstrongmsel <- log10(pooled_reftable_pods[, "POPPrStrongMSel"])
#log_radnompods_popstrongmsel[which(log_radnompods_popstrongmsel == -Inf)] <- -7

## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_radnompods_popstrongmsel[-neutral_randompods], 
#     y    = posterior_radnompods_logpopstrongmsel$expectation[-neutral_randompods],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     main = expression(log[10](italic(P))), 
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
## logit transformation
##--------------------------------------
#
#posterior_radnompods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
#                                                   obs        = global_sumstats_pods,
#                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
#                                                   quantiles  = c(0.025,0.5,0.975),
#                                                   paral      = T,
#                                                   ncores     = 28,
#                                                   rf.weights = T)
#
#save(posterior_radnompods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logitpopstrongmsel",".RData"))
#
## prepare the vector with the true values - transformed
#logitpopstrongmsel_radnompods <- log(pooled_reftable_pods[, "POPPrStrongMSel"]/(1-pooled_reftable_pods[, "POPPrStrongMSel"]))
#
# -Inf for the lowest -1 value 
#logitpopstrongmsel_radnompods <- replace(logitpopstrongmsel_radnompods,
#                                         logitpopstrongmsel_radnompods == -Inf, -15)
#
## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations 
#plot(x    = logitpopstrongmsel_radnompods, 
#     y    = posterior_radnompods_logitpopstrongmsel$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-15,2),
#     ylim = c(-15,2),
#     main = expression(logit(italic(P))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.lgtps <- data.frame(x = logitpopstrongmsel_radnompods,
#                         y = posterior_radnompods_logitpopstrongmsel$expectation)
#save(pred.lgtps, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.lgtps, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", logit(italic(P)))),
#       ylab = expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")),
#       xlim = c(-15,2),
#       ylim = c(-15,2),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
#popstrongmsel_applic_data = data.frame(pooled_reftable_pods[-qneutral_qneutral, c("sim", "meanNe2")], 
#                                       True_popstrongmsel=pooled_reftable_pods[-qneutral_qneutral,"POPPrStrongMSel"], 
#                                       Infe_popstrongmsel = inv.logit(posterior_radnompods_logpopstrongmsel$expectation))
#
#cl <- makeCluster(5)
#registerDoParallel(cl)
#clusterEvalQ(cl)
#  
## PARALLEL PROCESSING
#------------------------------------------
#popstrongmsel_calc <- foreach(i=1:length(popstrongmsel_applic_data$sim),
#                              .combine=rbind, 
#                              .errorhandling="pass", .verbose = TRUE) %dopar% { library(ROCR)
#                                                                                selstrongthreshold(x = popstrongmsel_applic_data[i,], tau = 10)}
#stopCluster(cl)
#
#save(popstrongmsel_calc, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/popstrongmsel_calc",".RData"))

# Use the trained ABC-RF to predict the parameter of the neutral simulations
prPOPStrongMSel_neutralsims <- prPOPStrongMSel[neutralsims]
global_sumstats_popstrongmsel_neutralsims <- global_sumstats[neutralsims,]

posterior_randompods_logitpopstrongmsel_neutralsims <- predict(object     = reg_logitpopstrongmsel,
                                                               obs        = global_sumstats_popstrongmsel_neutralsims[20001:26370,],
                                                               training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                               quantiles  = c(0.025,0.5,0.975),
                                                               paral      = T,
                                                               ncores     = 8,
                                                               rf.weights = T)

# simulations 1:4000
#posterior_randompods_logitpopstrongmsel_neutralsims_1 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_1",".RData"))

# simulations 4001:8000
#posterior_randompods_logitpopstrongmsel_neutralsims_2 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_2",".RData"))

# simulations 8001:12000
#posterior_randompods_logitpopstrongmsel_neutralsims_3 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_3",".RData"))

# simulations 12001:16000
#posterior_randompods_logitpopstrongmsel_neutralsims_4 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_4, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_4",".RData"))

# simulations 16001:20000
#posterior_randompods_logitpopstrongmsel_neutralsims_5 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_5, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_5",".RData"))

# simulations 20001:26370
#posterior_randompods_logitpopstrongmsel_neutralsims_6 <- posterior_randompods_logitpopstrongmsel_neutralsims
#save(posterior_randompods_logitpopstrongmsel_neutralsims_6, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_6",".RData"))

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_4",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_5",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logitpopstrongmsel_neutralsims_6",".RData"))

posterior_ogitpopstrongmsel_neutralsims_mean <- c(posterior_randompods_logitpopstrongmsel_neutralsims_1$expectation,
                                                  posterior_randompods_logitpopstrongmsel_neutralsims_2$expectation,
                                                  posterior_randompods_logitpopstrongmsel_neutralsims_3$expectation,
                                                  posterior_randompods_logitpopstrongmsel_neutralsims_4$expectation,
                                                  posterior_randompods_logitpopstrongmsel_neutralsims_5$expectation,
                                                  posterior_randompods_logitpopstrongmsel_neutralsims_6$expectation)

pred.lgtps.neutralsims <- data.frame(obs_p = prPOPStrongMSel_neutralsims,
                                     est_lgtp = posterior_ogitpopstrongmsel_neutralsims_mean,
                                     est_p = inv.logit(posterior_ogitpopstrongmsel_neutralsims_mean),
                                     col = rep("neutral", length(posterior_ogitpopstrongmsel_neutralsims_mean)))

#save(pred.lgtps.neutralsims, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.neutralsims",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.neutralsims",".RData"))

# MEAN BIAS
mean(pred.lgtps.neutralsims$est_p - pred.lgtps.neutralsims$obs_p, na.rm = TRUE) 
# P=0: 0.01440539

# boxplot ABC-RF mean posterior estimates - logit scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.lgtps.neutralsims$est_lgtp, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")), ylim=c(-15,0))
axis(1, at=1, labels="neutral/quasi-neutral")

# boxplot ABC-RF mean posterior estimates - natural scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.lgtps.neutralsims$est_p, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(italic(hat(P)), " ","(ABC-RF)")), ylim=c(0, 0.3))
axis(1, at=1, labels="neutral/quasi-neutral")
abline(h=0, col="darkgrey", lty=3)


## FIXED PODs
##-----------------------------------------------------------

## log10 transformation
#posterior_fixedpods_logpopstrongmsel <- predict(object     = reg_logpopstrongmsel,
#                                                obs        = global_sumstats_fixedpods,
#                                                training   = data.frame(logpopstrongmsel, global_sumstats_popstrongmsel),
#                                                quantiles  = c(0.025,0.5,0.975),
#                                                paral      = T,
#                                                ncores     = 20,
#                                                rf.weights = T)
#
#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongmsel",".RData"))
#
## prepare the vector with the true values - transformed
#log_fixedpods_popstrongmsel <- log10(pooled_reftable_fixedpods[, "POPPrStrongMSel"])
#log_fixedpods_popstrongmsel[which(log_fixedpods_popstrongmsel == -Inf)] <- -7
#
## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_fixedpods_popstrongmsel[-c(1:100)], 
#     y    = posterior_fixedpods_logpopstrongmsel$expectation[-c(1:100)],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,0),
#     ylim = c(-7,0),
#     main = expression(log[10](italic(P))), 
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## logit transformation
posterior_fixedpods_logitpopstrongmsel <- predict(object     = reg_logitpopstrongmsel,
                                                   obs        = global_sumstats_fixedpods,
                                                   training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 6,
                                                   rf.weights = T)

#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logitpopstrongmsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_c",".RData"))

## prepare the vector with the true values - transformed
logitpopstrongmsel_fixedpods <- log(pooled_reftable_fixedpods[, "POPPrStrongMSel"]/(1-pooled_reftable_fixedpods[, "POPPrStrongMSel"]))

# -Inf for the lowest -1 value 
logitpopstrongmsel_fixedpods <- replace(logitpopstrongmsel_fixedpods,
                                        logitpopstrongmsel_fixedpods == -Inf, -12)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitpopstrongmsel_fixedpods, 
     y    = posterior_fixedpods_logitpopstrongmsel$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-15,2),
     ylim = c(-15,2),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtps.fixedpods <- data.frame(obs_lgt = logitpopstrongmsel_fixedpods,
                                   est_lgt = posterior_fixedpods_logitpopstrongmsel$expectation,
                                   obs_l   = pooled_reftable_fixedpods[, "POPPrStrongMSel"],
                                   est_l   = inv.logit(posterior_fixedpods_logitpopstrongmsel$expectation),
                                   c = c(rep("A", 100), rep("B", 100), rep("C", 100)))

#save(pred.lgtps.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.lgtps.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.lgtps.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_c_2",".RData"))


ggplot(pred.lgtps.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75, position = "jitter") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A", "B", "C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", italic(P)))) +
  ylab(expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")))+
  xlim(-13, -3) +
  ylim(-13, -3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.lgtps.fixedpods$est_l[1:100] - pred.lgtps.fixedpods$obs_l[1:100], na.rm = TRUE) 
# Neutral: 7.641137e-05
mean(pred.lgtps.fixedpods$est_l[101:200] - pred.lgtps.fixedpods$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.1: 6.576728e-05
mean(pred.lgtps.fixedpods$est_l[201:300] - pred.lgtps.fixedpods$obs_l[201:300], na.rm = TRUE) 
# Limited s=0.1: -0.009226384

## FIXED PODs ADDITIONAL
##-----------------------------------------------------------

## logit transformation
posterior_fixedpods_logitpopstrongmsel_add <- predict(object     = reg_logitpopstrongmsel,
                                                      obs        = global_sumstats_fixedpods_add,
                                                      training   = data.frame(logitpopstrongmsel,global_sumstats_popstrongmsel),
                                                      quantiles  = c(0.025,0.5,0.975),
                                                      paral      = T,
                                                      ncores     = 6,
                                                      rf.weights = T)

#save(posterior_fixedpods_logitpopstrongmsel_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logitpopstrongmsel_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitpopstrongmsel_add_c",".RData"))

## prepare the vector with the true values - transformed
logitpopstrongmsel_fixedpods_add <- log(pooled_reftable_fixedpods_add[, "POPPrStrongMSel"]/(1-pooled_reftable_fixedpods_add[, "POPPrStrongMSel"]))

# -Inf for the lowest -1 value 
logitpopstrongmsel_fixedpods_add <- replace(logitpopstrongmsel_fixedpods_add,
                                            logitpopstrongmsel_fixedpods_add == -Inf, -12)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitpopstrongmsel_fixedpods_add, 
     y    = posterior_fixedpods_logitpopstrongmsel_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-15,2),
     ylim = c(-15,2),
     main = expression(logit(italic(P))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.lgtps.fixedpods_add <- data.frame(obs_lgt = c(logitpopstrongmsel_fixedpods[1:100], 
                                                   logitpopstrongmsel_fixedpods_add),
                                       est_lgt = c(posterior_fixedpods_logitpopstrongmsel$expectation[1:100],
                                                   posterior_fixedpods_logitpopstrongmsel_add$expectation),
                                       obs_l   = c(pooled_reftable_fixedpods[1:100, "POPPrStrongMSel"],
                                                   pooled_reftable_fixedpods_add[, "POPPrStrongMSel"]),
                                       est_l   = c(inv.logit(posterior_fixedpods_logitpopstrongmsel$expectation[1:100]),
                                                   inv.logit(posterior_fixedpods_logitpopstrongmsel_add$expectation)),
                                       c = c(rep("A", 100), rep("B", 200), rep("C", 200)))


#save(pred.lgtps.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.lgtps.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.lgtps.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.lgtps.fixedpods_add_c_2",".RData"))

ggplot(pred.lgtps.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B", "C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(P))))) +
  ylab(expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")))+
  xlim(-13, -3) +
  ylim(-13, -3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.lgtps.fixedpods_add$est_l[101:200] - pred.lgtps.fixedpods_add$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.01: 7.566312e-05
mean(pred.lgtps.fixedpods_add$est_l[301:400] - pred.lgtps.fixedpods_add$obs_l[301:400], na.rm = TRUE) 
# Unlimited s=0.01: -0.001413788
```

#### Theta selected mutations
```{r prediction thetaS, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------
#
## theta * P_S 
##-----------------------------------------------------------
#posterior_radnompods_logthetaPS <- predict(object     = reg_logthetaPS,
#                                           obs        = global_sumstats_pods,
#                                           training   = data.frame(logthetaPS, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 6,
#                                           rf.weights = T)
#
#save(posterior_radnompods_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaPS",".RData"))
#
## prepare the vector with the true values
#genomeS = 100e+06
#prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]
#logthetaPS_randompods <- log10(4 * pooled_reftable_pods[, "Ncs"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logthetaPS_randompods, 
#     y    = posterior_radnompods_logthetaPS$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-8,6),
#     ylim = c(-8,6),
#     main = expression(log[10](italic(θ) * italic(P)[S])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logthetaPS <- data.frame(x = logthetaPS_randompods,
#                              y = posterior_radnompods_logthetaPS$expectation)
#save(pred.logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logthetaPS, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ) * italic(P)[S]))),
#       ylab = expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")),
#       xlim = c(-8,6),
#       ylim = c(-8,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## ThetaS (original with meanNe2)
##-----------------------------------------------------------
#posterior_radnompods_logthetaS <- predict(object     = reg_logthetaS,
#                                          obs        = global_sumstats_pods,
#                                          training   = data.frame(logthetaS, global_sumstats),
#                                          quantiles  = c(0.025,0.5,0.975),
#                                          paral      = T,
#                                          ncores     = 28,
#                                          rf.weights = T)
#
#save(posterior_radnompods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logthetaS",".RData"))
#
## prepare the vector with the true values
#genomeS = 100e+06
#prRSel_randompods <- pooled_reftable_pods[, "PrGWSel"] * pooled_reftable_pods[, "PrMSel"]
#randompods_thetaS <- 4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"] * prRSel_randompods) * genomeS
#log_randompods_thetaS <- log10(randompods_thetaS)
#
## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_randompods_thetaS, 
#     y    = posterior_radnompods_logthetaS$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     main = expression(log[10](italic(θ) * italic(P)[S])), 
#      cex.axis = 1.2,
#      cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

## FIXED PODs
##-----------------------------------------------------------

## theta * P_S 
##-----------------------------------------------------------
posterior_fixedpods_logthetaPS <- predict(object     = reg_logthetaPS,
                                           obs        = global_sumstats_fixedpods,
                                           training   = data.frame(logthetaPS, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

#save(posterior_fixedpods_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logthetaPS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_c",".RData"))


## prepare the vector with the true values
genomeS = 100e+06
prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]

thetaPS_fixedpods <- 4 * pooled_reftable_fixedpods[, "Ncs"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS
logthetaPS_fixedpods <- log10(4 * pooled_reftable_fixedpods[, "Ncs"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS)

# -Inf for the lowest -1 value 
logthetaPS_fixedpods <- replace(logthetaPS_fixedpods,
                                logthetaPS_fixedpods == -Inf, -2)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logthetaPS_fixedpods, 
     y    = posterior_fixedpods_logthetaPS$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(log[10](italic(θ) * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logthetaPS.fixedpods <- data.frame(obs_logt = logthetaPS_fixedpods,
                                        est_logt = posterior_fixedpods_logthetaPS$expectation,
                                        obs_t   = thetaPS_fixedpods,
                                        est_t   = 10^(posterior_fixedpods_logthetaPS$expectation),
                                        c = c(rep("A", 100), rep("B", 100), rep("C", 100)))

#save(pred.logthetaPS.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logthetaPS.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.logthetaPS.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_c_2",".RData"))

ggplot(pred.logthetaPS.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ) * italic(P)[S])))) +
  ylab(expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")))+
  xlim(-4, 4) +
  ylim(-4, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.logthetaPS.fixedpods$est_t[1:100] - pred.logthetaPS.fixedpods$obs_t[1:100], na.rm = TRUE) 
# Neutral: 0.1414842
mean(pred.logthetaPS.fixedpods$est_t[101:200] - pred.logthetaPS.fixedpods$obs_t[101:200], na.rm = TRUE) 
# Limited s=0.1: 0.12703
mean(pred.logthetaPS.fixedpods$est_t[201:300] - pred.logthetaPS.fixedpods$obs_t[201:300], na.rm = TRUE) 
# Limited s=0.1: -39.14393

## ThetaS (original with meanNe2)
##-----------------------------------------------------------
#posterior_fixedpods_logthetaS <- predict(object     = reg_logthetaS,
#                                         obs        = global_sumstats_fixedpods,
#                                         training   = data.frame(logthetaS, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 28,
#                                         rf.weights = T)
#
#save(posterior_fixedpods_logthetaS, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaS",".RData"))
#
## prepare the vector with the true values
#genomeS = 100e+06
#prRSel_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]
#fixedpods_thetaS <- 4 * pooled_reftable_fixedpods[, "meanNe2"] * (pooled_reftable_fixedpods[, "mu"] * prRSel_fixedpods) * genomeS
#log_fixedpods_thetaS <- log10(fixedpods_thetaS)

## Expected True vs estimated
# basic plot for diagnostic
#plot(x    = log_fixedpods_thetaS, 
#     y    = posterior_fixedpods_logthetaS$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-7,5),
#     ylim = c(-7,5),
#     main = expression(log[10](italic(θ) * italic(P)[S])), 
#      cex.axis = 1.2,
#      cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")


## FIXED PODs ADDITIONAL
##-----------------------------------------------------------

## theta * P_S 
##-----------------------------------------------------------
posterior_fixedpods_logthetaPS_add <- predict(object     = reg_logthetaPS,
                                              obs        = global_sumstats_fixedpods_add,
                                              training   = data.frame(logthetaPS, global_sumstats),
                                              quantiles  = c(0.025,0.5,0.975),
                                              paral      = T,
                                              ncores     = 6,
                                              rf.weights = T)

#save(posterior_fixedpods_logthetaPS_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logthetaPS_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logthetaPS_add_c",".RData"))

## prepare the vector with the true values
#genomeS = 100e+06
prRSel_fixedpods_add <- pooled_reftable_fixedpods_add[, "PrGWSel"] * pooled_reftable_fixedpods_add[, "PrMSel"]

thetaPS_fixedpods_add <- 4 * pooled_reftable_fixedpods_add[, "Ncs"] * (pooled_reftable_fixedpods_add[, "mu"] * prRSel_fixedpods_add) * genomeS
logthetaPS_fixedpods_add <- log10(4 * pooled_reftable_fixedpods_add[, "Ncs"] * (pooled_reftable_fixedpods_add[, "mu"] * prRSel_fixedpods_add) * genomeS)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logthetaPS_fixedpods_add, 
     y    = posterior_fixedpods_logthetaPS_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,6),
     ylim = c(-8,6),
     main = expression(log[10](italic(θ) * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logthetaPS.fixedpods_add <- data.frame(obs_logt = c(logthetaPS_fixedpods[1:100], 
                                                         logthetaPS_fixedpods_add),
                                            est_logt = c(posterior_fixedpods_logthetaPS$expectation[1:100],
                                                         posterior_fixedpods_logthetaPS_add$expectation),
                                            obs_t    = c(thetaPS_fixedpods[1:100],
                                                         thetaPS_fixedpods_add),
                                            est_t    = c(10^(posterior_fixedpods_logthetaPS$expectation[1:100]),
                                                         10^(posterior_fixedpods_logthetaPS_add$expectation)),
                                            c = c(rep("A", 100), rep("B", 200), rep("C", 200)))

#save(pred.logthetaPS.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logthetaPS.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add_c",".RData"))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.logthetaPS.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logthetaPS.fixedpods_add_c_2",".RData"))


ggplot(pred.logthetaPS.fixedpods_add[c(101:200,301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("limited", "unlimited"),
                      labels = c("mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(θ) * italic(P)[S])))) +
  ylab(expression(paste(log[10](italic(hat(θ))*italic(P)[S]), " ","(ABC-RF)")))+
  xlim(-4, 4) +
  ylim(-4, 4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.logthetaPS.fixedpods_add$est_t[101:200] - pred.logthetaPS.fixedpods_add$obs_t[101:200], na.rm = TRUE) 
# Limited s=0.01: 0.0959678
mean(pred.logthetaPS.fixedpods_add$est_t[301:400] - pred.logthetaPS.fixedpods_add$obs_t[301:400], na.rm = TRUE) 
# Unlimited s=0.01: -70.16653
```

#### gamma mean - parameter
```{r prediction gamma mean parameter, echo=TRUE, eval=FALSE, include=TRUE}

## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_loggammamean <- predict(object     = reg_loggammamean,
                                            obs        = global_sumstats_fixedpods,
                                            training   = data.frame(loggammamean, global_sumstats),
                                            quantiles  = c(0.025,0.5,0.975),
                                            paral      = T,
                                            ncores     = 8,
                                            rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_loggammamean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_loggammamean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_loggammamean_c",".RData"))

## prepare the vector with the true values
loggammamean_fixedpods <- log10(pooled_reftable_fixedpods[, "gammaMean"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = loggammamean_fixedpods, 
     y    = posterior_fixedpods_loggammamean$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-2,0),
     ylim = c(-2,0),
     main = expression(log[10](italic(gamma))), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.loggammamean.fixedpods <- data.frame(x = loggammamean_fixedpods,
                                          y = posterior_fixedpods_loggammamean$expectation,
                                          c = c(rep("A",100),rep("B", 100), rep("C", 100)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.loggammamean.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.loggammamean.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.loggammamean.fixedpods_c",".RData"))


# Mean Bias
mean(10^(pred.loggammamean.fixedpods$y[1:100]) - 10^(pred.loggammamean.fixedpods$x[1:100]))
# neutral: -0.09261859
mean(10^(pred.loggammamean.fixedpods$y[101:200]) - 10^(pred.loggammamean.fixedpods$x[101:200]))
# limited: -0.09069292
mean(10^(pred.loggammamean.fixedpods$y[201:300]) - 10^(pred.loggammamean.fixedpods$x[201:300]))
# unlimited: 0.01160417

ggplot(pred.loggammamean.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(gamma))))) +
  ylab(expression(paste(log[10](italic(hat(gamma))), " ","(ABC-RF)")))+
  xlim(-2,0) +
  ylim(-2,0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

gammamean.fix <- ggplot(pred.loggammamean.fixedpods, aes(x=c, y=y, fill=c))
gammamean.fix <- gammamean.fix +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(gamma))), " ","(ABC-RF)")))+
               ylim(-3.0, -0.5) +
               geom_abline(intercept = -1 , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
gammamean.fix

##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_loggammamean_add <- predict(object     = reg_loggammamean,
                                                obs        = global_sumstats_fixedpods_add,
                                                training   = data.frame(loggammamean, global_sumstats),
                                                quantiles  = c(0.025,0.5,0.975),
                                                paral      = T,
                                                ncores     = 6,
                                                rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_loggammamean_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_loggammamean_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_loggammamean_add_c",".RData"))

## prepare the vector with the true values
loggammamean_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "gammaMean"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = loggammamean_fixedpods_add, 
     y    = posterior_fixedpods_loggammamean_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-3,0),
     ylim = c(-3,0),
     main = expression(log[10](italic(gamma))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.loggammamean.fixedpods_add <- data.frame(x = c(loggammamean_fixedpods[c(1:100)], 
                                                    loggammamean_fixedpods_add),
                                              y = c(posterior_fixedpods_loggammamean$expectation[c(1:100)], 
                                                    posterior_fixedpods_loggammamean_add$expectation),
                                              c = c(rep("A",100),rep("B", 200), rep("C", 200)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.loggammamean.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.loggammamean.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.loggammamean.fixedpods_add_c",".RData"))

# Mean Bias
mean(10^(pred.loggammamean.fixedpods_add$y[101:200]) - 10^(pred.loggammamean.fixedpods_add$x[101:200]))
# limited s=0.01: -0.002167054
mean(10^(pred.loggammamean.fixedpods_add$y[301:400]) - 10^(pred.loggammamean.fixedpods_add$x[301:400]))
# unlimited s=0.01: 0.02324922

ggplot(pred.loggammamean.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(gamma))))) +
  ylab(expression(paste(log[10](italic(hat(gamma))), " ","(ABC-RF)")))+
  xlim(-3,0) +
  ylim(-3,0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

gammamean.fix_add1 <- ggplot(pred.loggammamean.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=c, y=y, fill=c))
gammamean.fix_add1 <- gammamean.fix_add1 +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(gamma))), " ","(ABC-RF)")))+
               ylim(-3.0, -0.5) +
               geom_abline(intercept = -2 , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
gammamean.fix_add1
```

#### Proportion of beneficial mutation - PrPs - parameter
```{r prediction PrPs, echo=TRUE, eval=FALSE, include=TRUE}

## Log10 PrPs
##--------------------

## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logPrPs <- predict(object     = reg_logPrPs,
                                       obs        = global_sumstats_fixedpods,
                                       training   = data.frame(logPrPs, global_sumstats),
                                       quantiles  = c(0.025,0.5,0.975),
                                       paral      = T,
                                       ncores     = 8,
                                       rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logPrPs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logPrPs_c",".RData"))

## prepare the vector with the true values
logPrPs_fixedpods <- log10(pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logPrPs_fixedpods, 
     y    = posterior_fixedpods_logPrPs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     #xlim = c(-2,0),
     #ylim = c(-2,0),
     main = expression(log[10](italic(P)[R] * italic(P)[S])), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logPrPs.fixedpods <- data.frame(x = logPrPs_fixedpods,
                                          y = posterior_fixedpods_logPrPs$expectation,
                                          c = c(rep("A",100),rep("B", 100), rep("C", 100)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logPrPs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logPrPs.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logPrPs.fixedpods_c",".RData"))

# Mean Bias
mean(10^(pred.logPrPs.fixedpods$y[1:100]) - 10^(pred.logPrPs.fixedpods$x[1:100]))
# neutral:  8.443543e-05
mean(10^(pred.logPrPs.fixedpods$y[101:200]) - 10^(pred.logPrPs.fixedpods$x[101:200]))
# limited: 7.592037e-05
mean(10^(pred.logPrPs.fixedpods$y[201:300]) - 10^(pred.logPrPs.fixedpods$x[201:300]))
# unlimited: -0.01687224

ggplot(pred.logPrPs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(P)[R] * italic(P)[S])))) +
  ylab(expression(paste(log[10](italic(P)[R] * italic(P)[S]), " ","(ABC-RF)")))+
  #xlim(-2,0) +
  #ylim(-2,0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

PrPs.fix <- ggplot(pred.logPrPs.fixedpods, aes(x=c, y=y, fill=c))
PrPs.fix <- PrPs.fix +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(P))[R] * italic(P)[S]), " ","(ABC-RF)")))+
               ylim(-5.0, -1.0) +
               geom_abline(intercept = c(-4.60206, -1.30103) , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
PrPs.fix


##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logPrPs_add <- predict(object     = reg_logPrPs,
                                           obs        = global_sumstats_fixedpods_add,
                                           training   = data.frame(logPrPs, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logPrPs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logPrPs_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logPrPs_add_c",".RData"))

## prepare the vector with the true values
logPrPs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "PrGWSel"] * pooled_reftable_fixedpods_add[, "PrMSel"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logPrPs_fixedpods_add, 
     y    = posterior_fixedpods_logPrPs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     #xlim = c(-3,0),
     #ylim = c(-3,0),
     main = expression(log[10](italic(P)[R] * italic(P)[S])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logPrPs.fixedpods_add <- data.frame(x = c(logPrPs_fixedpods[c(1:100)], 
                                                    logPrPs_fixedpods_add),
                                              y = c(posterior_fixedpods_logPrPs$expectation[c(1:100)], 
                                                    posterior_fixedpods_logPrPs_add$expectation),
                                              c = c(rep("A",100),rep("B", 200), rep("C", 200)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logPrPs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logPrPs.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logPrPs.fixedpods_add_c",".RData"))

# Mean Bias
mean(10^(pred.logPrPs.fixedpods_add$y[101:200]) - 10^(pred.logPrPs.fixedpods_add$x[101:200]))
# limited s=0.01: 5.92644e-05
mean(10^(pred.logPrPs.fixedpods_add$y[301:400]) - 10^(pred.logPrPs.fixedpods_add$x[301:400]))
# unlimited s=0.01: -0.03582647

ggplot(pred.logPrPs.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(gamma))))) +
  ylab(expression(paste(log[10](italic(hat(gamma))), " ","(ABC-RF)")))+
  #xlim(-3,0) +
  #ylim(-3,0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

PrPs.fix_add1 <- ggplot(pred.logPrPs.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=c, y=y, fill=c))
PrPs.fix_add1 <- PrPs.fix_add1 +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(P))[R] * italic(P)[S]), " ","(ABC-RF)")))+
               ylim(-5.0, -1.0) +
               geom_abline(intercept = c(-4.60206, -1.30103) , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
PrPs.fix_add1

## Logit PrPs
##--------------------

## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logitPrPs <- predict(object     = reg_logitPrPs,
                                         obs        = global_sumstats_fixedpods,
                                         training   = data.frame(logitPrPs, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 8,
                                         rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logitPrPs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitPrPs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitPrPs_c",".RData"))

## prepare the vector with the true values
prps_fixedpods <- pooled_reftable_fixedpods[, "PrGWSel"] * pooled_reftable_fixedpods[, "PrMSel"]
logitPrPs_fixedpods <- log(prps_fixedpods/(1 - prps_fixedpods))

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logitPrPs_fixedpods, 
     y    = posterior_fixedpods_logitPrPs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     #xlim = c(-2,0),
     #ylim = c(-2,0),
     main = expression(log[10](italic(P)[R] * italic(P)[B])), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logitPrPs.fixedpods <- data.frame(x = logitPrPs_fixedpods,
                                          y = posterior_fixedpods_logitPrPs$expectation,
                                          c = c(rep("A",100),rep("B", 100), rep("C", 100)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logitPrPs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logitPrPs.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logitPrPs.fixedpods_c",".RData"))

# Mean Bias
mean(pred.logitPrPs.fixedpods$y[1:100]-pred.logitPrPs.fixedpods$x[1:100])
# neutral: Inf
mean(pred.logitPrPs.fixedpods$y[101:200]-pred.logitPrPs.fixedpods$x[101:200])
# limited: 1.334702
mean(pred.logitPrPs.fixedpods$y[201:300]-pred.logitPrPs.fixedpods$x[201:300])
# unlimited: -0.3750801

ggplot(pred.logitPrPs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(P)[R] * italic(P)[B])))) +
  ylab(expression(paste(log[10](italic(P)[R] * italic(P)[B]), " ","(ABC-RF)")))+
  #xlim(-2,0) +
  #ylim(-2,0) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

PrPs.fix <- ggplot(pred.logitPrPs.fixedpods, aes(x=c, y=y, fill=c))
PrPs.fix <- PrPs.fix +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(P))[R] * italic(P)[B]), " ","(ABC-RF)")))+
               ylim(-11.0, -1.0) +
               geom_abline(intercept = c(-10.596610, -2.944439) , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
PrPs.fix


##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logitPrPs_add <- predict(object     = reg_logitPrPs,
                                           obs        = global_sumstats_fixedpods_add,
                                           training   = data.frame(logitPrPs, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logitPrPs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitPrPs_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logitPrPs_add_c",".RData"))

## prepare the vector with the true values
prps_fixedpods_add <- pooled_reftable_fixedpods_add[, "PrGWSel"] * pooled_reftable_fixedpods_add[, "PrMSel"]
logitPrPs_fixedpods_add <- log(prps_fixedpods_add/(1 - prps_fixedpods_add))

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logitPrPs_fixedpods_add, 
     y    = posterior_fixedpods_logitPrPs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     #xlim = c(-3,0),
     #ylim = c(-3,0),
     main = expression(logit(italic(P)[R] * italic(P)[B])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logitPrPs.fixedpods_add <- data.frame(x = c(logitPrPs_fixedpods[c(1:100)], 
                                                 logitPrPs_fixedpods_add),
                                           y = c(posterior_fixedpods_logitPrPs$expectation[c(1:100)], 
                                                 posterior_fixedpods_logitPrPs_add$expectation),
                                           c = c(rep("A",100),rep("B", 200), rep("C", 200)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logitPrPs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logitPrPs.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logitPrPs.fixedpods_add_c",".RData"))

# Mean Bias
mean(pred.logitPrPs.fixedpods_add$y[101:200]-pred.logitPrPs.fixedpods_add$x[101:200])
# limited s=0.01: 1.202169
mean(pred.logitPrPs.fixedpods_add$y[201:300]-pred.logitPrPs.fixedpods_add$x[201:300])
# limited s=0.25: 1.52628
mean(pred.logitPrPs.fixedpods_add$y[301:400]-pred.logitPrPs.fixedpods_add$x[301:400])
# unlimited s=0.01: -1.387441
mean(pred.logitPrPs.fixedpods_add$y[401:500]-pred.logitPrPs.fixedpods_add$x[401:500])
# unlimited s=0.25: 0.2239142

PrPs.fix_add1 <- ggplot(pred.logitPrPs.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=c, y=y, fill=c))
PrPs.fix_add1 <- PrPs.fix_add1 +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(logit(italic(hat(P))[R] * italic(P)[B]), " ","(ABC-RF)")))+
               ylim(-11.0, -1.0) +
               geom_abline(intercept = c(-10.596610, -2.944439) , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
PrPs.fix_add1
```

#### gamma mean - as latent variables 
```{r prediction gamma mean latent variables, echo=TRUE, eval=FALSE, include=TRUE}

## Mean of selection coefficients of segragating strongly beneficial mutations - POPStrongSelMean
##--------------------------------------------------------------------------------

# Use the trained ABC-RF to predict the parameter of the neutral simulations
popstrongselmean_zeroValues <- popstrongselmean_1[zero_popstrongselmean]
global_sumstats_popstrongselmean_zeroValues  <- global_sumstats[zero_popstrongselmean,]

posterior_randompods_logpopStrongSelMean_zeroValues <- predict(object     = reg_logpopstrongselmean,
                                                               obs        = global_sumstats_popstrongselmean_zeroValues[20001:26370,],
                                                               training   = data.frame(logpopStrongSelMean, global_sumstats_popstrongselmean),
                                                               quantiles  = c(0.025,0.5,0.975),
                                                               paral      = T,
                                                               ncores     = 8,
                                                               rf.weights = T)

# simulations 1:5000
#posterior_randompods_logpopStrongSelMean_zeroValues_1 <- posterior_randompods_logpopStrongSelMean_zeroValues
#save(posterior_randompods_logpopStrongSelMean_zeroValues_1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_1",".RData"))

# simulations 5001:10000
#posterior_randompods_logpopStrongSelMean_zeroValues_2 <- posterior_randompods_logpopStrongSelMean_zeroValues
#save(posterior_randompods_logpopStrongSelMean_zeroValues_2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_2",".RData"))

# simulations 10001:15000
#posterior_randompods_logpopStrongSelMean_zeroValues_3 <- posterior_randompods_logpopStrongSelMean_zeroValues
#save(posterior_randompods_logpopStrongSelMean_zeroValues_3, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_3",".RData"))

# simulations 15001:20000
#posterior_randompods_logpopStrongSelMean_zeroValues_4 <- posterior_randompods_logpopStrongSelMean_zeroValues
#save(posterior_randompods_logpopStrongSelMean_zeroValues_4, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_4",".RData"))

# simulations 20001:26370
#posterior_randompods_logpopStrongSelMean_zeroValues_5 <- posterior_randompods_logpopStrongSelMean_zeroValues
#save(posterior_randompods_logpopStrongSelMean_zeroValues_5, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_5",".RData"))

#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_3",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_4",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logpopStrongSelMean_zeroValues_5",".RData"))

posterior_logpopStrongSelMean_zeroValues_mean <- c(posterior_randompods_logpopStrongSelMean_zeroValues_1$expectation,
                                                   posterior_randompods_logpopStrongSelMean_zeroValues_2$expectation,
                                                   posterior_randompods_logpopStrongSelMean_zeroValues_3$expectation,
                                                   posterior_randompods_logpopStrongSelMean_zeroValues_4$expectation,
                                                   posterior_randompods_logpopStrongSelMean_zeroValues_5$expectation)

pred.logpopStrongSelMean.zeroValues <- data.frame(obs_smean = popstrongselmean_zeroValues,
                                                  est_logsmean = posterior_logpopStrongSelMean_zeroValues_mean,
                                                  est_smean = 10^(posterior_logpopStrongSelMean_zeroValues_mean),
                                                  col = rep("neutral", length(posterior_logpopStrongSelMean_zeroValues_mean)))

#save(pred.logpopStrongSelMean.zeroValues, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.zeroValues",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.zeroValues",".RData"))

## MEAN BIAS SelMean=0
mean(pred.logpopStrongSelMean.zeroValues$est_smean - pred.logpopStrongSelMean.zeroValues$obs_smean, na.rm = TRUE) 
# 0.4007506

# boxplot ABC-RF mean posterior estimates - logit scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.logpopStrongSelMean.zeroValues$est_logsmean, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(logit(italic(hat(P))), " ","(ABC-RF)"))
        #,ylim=c(-15,0)
        )
axis(1, at=1, labels="neutral/quasi-neutral")

# boxplot ABC-RF mean posterior estimates - natural scale
par(mar=c(5,5,4,1)+.1)
boxplot(pred.logpopStrongSelMean.zeroValues$est_smean, lwd = 1,  xaxt="n", xlab="",
        ylab = expression(paste(italic(hat(P)), " ","(ABC-RF)"))
        #, ylim=c(0, 0.3)
        )
axis(1, at=1, labels="neutral/quasi-neutral")
abline(h=0, col="darkgrey", lty=3)

## FIXED PODs
##-----------------------------------------------------------

posterior_fixedpods_logpopstrongselmean <- predict(object     = reg_logpopstrongselmean,
                                                   obs        = global_sumstats_fixedpods,
                                                   training   = data.frame(logpopStrongSelMean, global_sumstats_popstrongselmean),
                                                   quantiles  = c(0.025,0.5,0.975),
                                                   paral      = T,
                                                   ncores     = 6,
                                                   rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logpopstrongselmean, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongselmean_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongselmean_c",".RData"))

## prepare the vector with the true values - transformed
logpopstrongselmean_fixedpods <- log10(pooled_reftable_fixedpods[, "POPStrongSelMean"])

# -Inf for the lowest -1 value 
logpopstrongselmean_fixedpods <- replace(logpopstrongselmean_fixedpods,
                                         logpopstrongselmean_fixedpods == -Inf, -4)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logpopstrongselmean_fixedpods, 
     y    = posterior_fixedpods_logpopstrongselmean$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-5,2),
     ylim = c(-5,2),
     main = expression(log[10](italic(bar(s)))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logpopStrongSelMean.fixedpods <- data.frame(obs_log = logpopstrongselmean_fixedpods,
                                                 est_log = posterior_fixedpods_logpopstrongselmean$expectation,
                                                 obs_l   = pooled_reftable_fixedpods[, "POPStrongSelMean"],
                                                 est_l   = 10^(posterior_fixedpods_logpopstrongselmean$expectation),
                                                 c = c(rep("A", 100), rep("B", 100), rep("C", 100)))

## Prediction with Combined: or iginal reftable + randompods reftable: observations in the natural and logit scales
#save(pred.logpopStrongSelMean.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.fixedpods_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.fixedpods_c_2",".RData"))

ggplot(pred.logpopStrongSelMean.fixedpods, aes(x=obs_log , y=est_log, color=c)) + 
  geom_point(size=3, alpha=0.75, position = "jitter") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A", "B", "C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", italic(bar(s))))) +
  ylab(expression(paste(logit(italic(hat(bar(s)))), " ","(ABC-RF)")))+
  xlim(-5, 2) +
  ylim(-5, 2) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.logpopStrongSelMean.fixedpods$est_l[1:100] - pred.logpopStrongSelMean.fixedpods$obs_l[1:100], na.rm = TRUE) 
# Neutral: 0.07243656
mean(pred.logpopStrongSelMean.fixedpods$est_l[101:200] - pred.logpopStrongSelMean.fixedpods$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.1: -0.01132362
mean(pred.logpopStrongSelMean.fixedpods$est_l[201:300] - pred.logpopStrongSelMean.fixedpods$obs_l[201:300], na.rm = TRUE) 
# Limited s=0.1: 0.08310403

## FIXED PODs ADDITIONAL
##-----------------------------------------------------------

posterior_fixedpods_logpopstrongselmean_add <- predict(object     = reg_logpopstrongselmean,
                                                       obs        = global_sumstats_fixedpods_add,
                                                       training   = data.frame(logpopStrongSelMean, global_sumstats_popstrongselmean),
                                                       quantiles  = c(0.025,0.5,0.975),
                                                       paral      = T,
                                                       ncores     = 6,
                                                       rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logpopstrongselmean_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongselmean_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logpopstrongselmean_add_c",".RData"))

## prepare the vector with the true values - transformed
logpopstrongselmean_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "POPStrongSelMean"])

# -Inf for the lowest -1 value 
logpopstrongselmean_fixedpods_add <- replace(logpopstrongselmean_fixedpods_add,
                                         logpopstrongselmean_fixedpods_add == -Inf, -4)

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logpopstrongselmean_fixedpods_add, 
     y    = posterior_fixedpods_logpopstrongselmean_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-5,2),
     ylim = c(-5,2),
     main = expression(log[10](italic(bar(s)))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logpopStrongSelMean.fixedpods_add <- data.frame(obs_log = c(logpopstrongselmean_fixedpods[1:100], 
                                                                 logpopstrongselmean_fixedpods_add),
                                                     est_log = c(posterior_fixedpods_logpopstrongselmean$expectation[1:100],
                                                                 posterior_fixedpods_logpopstrongselmean_add$expectation),
                                                     obs_l   = c(pooled_reftable_fixedpods[1:100, "POPStrongSelMean"],
                                                                 pooled_reftable_fixedpods_add[, "POPStrongSelMean"]),
                                                     est_l   = c(10^(posterior_fixedpods_logpopstrongselmean$expectation[1:100]),
                                                                 10^(posterior_fixedpods_logpopstrongselmean_add$expectation)),
                                                     c = c(rep("A", 100), rep("B", 200), rep("C", 200)))

## Prediction with Combined: original reftable + randompods reftable: observations in the natural and logit scales
#save(pred.logpopStrongSelMean.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.fixedpods_add_c_2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logpopStrongSelMean.fixedpods_add_c_2",".RData"))

ggplot(pred.logpopStrongSelMean.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=obs_log , y=est_log, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B", "C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", logit(italic(P))))) +
  ylab(expression(paste(logit(italic(hat(P))), " ","(ABC-RF)")))+
  xlim(-4, 2) +
  ylim(-4, 2) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# Mean bias
mean(pred.logpopStrongSelMean.fixedpods_add$est_l[101:200] - pred.logpopStrongSelMean.fixedpods_add$obs_l[101:200], na.rm = TRUE) 
# Limited s=0.01: 0.05680696
mean(pred.logpopStrongSelMean.fixedpods_add$est_l[301:400] - pred.logpopStrongSelMean.fixedpods_add$obs_l[301:400], na.rm = TRUE) 
# Unlimited s=0.01: 0.04244021
```

### ABC-RF regression for demography: prediction for short-term evolution

#### Harmonic mean of the effective population sizes of period 2 - meanNe2
```{r prediction MeanNe2, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
##-----------------------------------------------
#posterior_radnompods_logmeanNe2 <- predict(object     = reg_logmeanNe2,
#                                           obs        = global_sumstats_pods,
#                                           training   = data.frame(logmeanNe2, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 2,
#                                           rf.weights = T)
#
#save(posterior_radnompods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logmeanNe2",".RData"))
#
## prepare the vector with the true values - transformed
#logmeanNe2_radnompods <- log10(pooled_reftable_pods[, "meanNe2"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logmeanNe2_radnompods, 
#     y    = posterior_radnompods_logmeanNe2$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-0.5,3.5),
#     ylim = c(-0.5,3.5),
#     main = expression(log[10](italic(N)[e])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logmeanNe2 <- data.frame(x = logmeanNe2_radnompods,
#                              y = posterior_radnompods_logmeanNe2$expectation)
#save(pred.logmeanNe2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logmeanNe2, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
#       ylab = expression(paste(log(italic(hat(N))[e]), " ","(ABC-RF)")),
#       xlim = c(-0.5,3.5),
#       ylim = c(-0.5,3.5),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## comparison with WFABC Ne estimates
##---------------------------------------------------
#
#wfabcNe_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/Cluster_data/pooled_reftable_pods/results/wfabc_1_output_pods_mod.txt",header=TRUE)
#
# keep only same simulations
#wfabcNe <- wfabcNe_raw[wfabcNe_raw$sim %in% pooled_reftable_pods$sim, ]
#
# merge random pods sim, meanNe2 and wfabc_Ne
#wfabcNe_RFNe_table <- merge(pooled_reftable_pods[,c("sim","meanNe2")], wfabcNe, by.x = 1, by.y = 1, all = TRUE)
#
#wfabcNe_RFNe_table$wfabc_ne <- wfabcNe_RFNe_table$wfabc_ne/2
#
# WFABC-ne and true temporal NE in the original scale
#save(wfabcNe_RFNe_table, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/wfabcNe_RFNe_table",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/wfabcNe_RFNe_table",".RData"))
#
# basic plot for diagnostic
#plot(x    = logmeanNe2_radnompods, 
#     y    = log10(wfabcNe_RFNe_table$wfabc_ne),
#     xlab = "True value", 
#     ylab = "WF-ABC estimated",
#     xlim = c(-0.5,3.5),
#     ylim = c(-0.5,3.5),
#     main = expression(log[10](italic(N)[e])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#estimated.wfabc.randompods <- data.frame(x = log10(wfabcNe_RFNe_table$meanNe2),
#                                         y = log10(wfabcNe_RFNe_table$wfabc_ne))
#save(estimated.wfabc.randompods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.randompods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.randompods",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(estimated.wfabc.randompods, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
#       ylab = expression(paste(log(italic(hat(N))[e]), " ","(WF-ABC)")),
#       xlim = c(-0.5,3.5),
#       ylim = c(-0.5,3.5),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
# RMSE log10 scale
sqrt(mean((estimated.wfabc.randompods$y - estimated.wfabc.randompods$x)^2, na.rm = T))
# 0.6556139

# Mean bias log10 scale
mean(estimated.wfabc.randompods$y - estimated.wfabc.randompods$x, na.rm = T)
# 0.2589572

# RMSE original scale
sqrt(mean((wfabcNe_RFNe_table$wfabc_ne - wfabcNe_RFNe_table$meanNe2)^2, na.rm = T)) 
# 2880.175

# Mean bias original scale
mean(wfabcNe_RFNe_table$wfabc_ne - wfabcNe_RFNe_table$meanNe2, na.rm = T) 
# 3.717988

## comparison with FST-based Ne estimates
##---------------------------------------------------
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}
#
#fstne2_randompods <- globalFSTNe(x=global_sumstats_pods$GSS_WCst, tau=10)
#
# basic plot for diagnostic
#plot(x    = logmeanNe2_radnompods, 
#     y    = log10(fstne2_randompods),
#     xlab = "True value", 
#     ylab = "FST-Ne estimated",
#     xlim = c(-0.5,3.5),
#     ylim = c(-0.5,3.5),
#     main = expression(log[10](italic(N)[e])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#estimated.fstNe2.randompods <- data.frame(x = logmeanNe2_radnompods,
#                                          y = log10(fstne2_randompods))
#save(estimated.fstNe2.randompods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.randompods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.randompods",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(estimated.fstNe2.randompods, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
#       ylab = expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")),
#       xlim = c(-0.5,3.5),
#       ylim = c(-0.5,3.5),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
# RMSE
#sqrt(mean((fstne2_randompods-wfabcNe_RFNe_table$meanNe2)^2, na.rm = T))
# 15682.76
#
#
## Fixed PODs 
##-----------------------------------------------
posterior_fixedpods_logmeanNe2 <- predict(object      = reg_logmeanNe2,
                                           obs        = global_sumstats_fixedpods,
                                           training   = data.frame(logmeanNe2, global_sumstats),
                                           quantiles  = c(0.025,0.5,0.975),
                                           paral      = T,
                                           ncores     = 6,
                                           rf.weights = T)

#save(posterior_fixedpods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmeanNe2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_c",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = posterior_fixedpods_logmeanNe2$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmeanNe2.fixedpods <- data.frame(x = logmeanNe2_fixedpods,
                                        y = posterior_fixedpods_logmeanNe2$expectation,
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logmeanNe2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmeanNe2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_c",".RData"))

# Mean Bias original scale
mean(10^(pred.logmeanNe2.fixedpods$y[1:100]) - 10^(pred.logmeanNe2.fixedpods$x[1:100]))
# neutral: 26.69357
mean(10^(pred.logmeanNe2.fixedpods$y[101:200]) - 10^(pred.logmeanNe2.fixedpods$x[101:200]))
# limited: 11.37571
mean(10^(pred.logmeanNe2.fixedpods$y[201:300]) - 10^(pred.logmeanNe2.fixedpods$x[201:300]))
# unlimited: -13.80552

ggplot(pred.logmeanNe2.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))


## comparison with WFABC Ne estimates
##---------------------------------------------------

wfabcNe_neutral_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/wfabc_1_output_mutation_neutral.txt",header=TRUE)
wfabcNe_limited_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/original_s0.1/wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_unlimited_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/original_s0.1/wfabc_1_output_mutation_unlimited.txt",header=TRUE)

wfabcNe_fixedpods <- rbind(wfabcNe_neutral_raw , 
                           wfabcNe_limited_raw,
                           wfabcNe_unlimited_raw)

# combine fixed pods sim, meanNe2 and wfabc_Ne
wfabcNe_RFNe_table_fixedpods <- data.frame(pooled_reftable_fixedpods[,c("sim","meanNe2")],
                                           wfabcNe_fixedpods[,c("wfabc_ne","wfabc_sd")])

wfabcNe_RFNe_table_fixedpods$wfabc_ne <- wfabcNe_RFNe_table_fixedpods$wfabc_ne/2

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = log10(wfabcNe_RFNe_table_fixedpods$wfabc_ne),
     xlab = "True value", 
     ylab = "WF-ABC estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.wfabc.fixedpods <- data.frame(x = log10(wfabcNe_RFNe_table_fixedpods$meanNe2),
                                        y = log10(wfabcNe_RFNe_table_fixedpods$wfabc_ne),
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(estimated.wfabc.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods",".RData"))

# RMSE log10 scale
sqrt(mean((estimated.wfabc.fixedpods$y[1:100]-estimated.wfabc.fixedpods$x[1:100])^2, na.rm = T))
# neutral: 0.1061527
sqrt(mean((estimated.wfabc.fixedpods$y[101:200]-estimated.wfabc.fixedpods$x[101:200])^2, na.rm = T))
# limited: 0.1025068
sqrt(mean((estimated.wfabc.fixedpods$y[201:300]-estimated.wfabc.fixedpods$x[201:300])^2, na.rm = T))
# unlimited: 0.4598296

# Mean Bias log10 scale
mean(estimated.wfabc.fixedpods$y[1:100]-estimated.wfabc.fixedpods$x[1:100])
# neutral: 0.09750287
mean(estimated.wfabc.fixedpods$y[101:200]-estimated.wfabc.fixedpods$x[101:200])
# limited: 0.08771047
mean(estimated.wfabc.fixedpods$y[201:300]-estimated.wfabc.fixedpods$x[201:300])
# unlimited: -0.45248

# RMSE original scale
sqrt(mean((wfabcNe_RFNe_table_fixedpods$wfabc_ne[1:100]-wfabcNe_RFNe_table_fixedpods$meanNe2[1:100])^2, na.rm = T))
# neutral: 163.9951
sqrt(mean((wfabcNe_RFNe_table_fixedpods$wfabc_ne[101:200]-wfabcNe_RFNe_table_fixedpods$meanNe2[101:200])^2, na.rm = T))
# limited: 161.4271
sqrt(mean((wfabcNe_RFNe_table_fixedpods$wfabc_ne[201:300]-wfabcNe_RFNe_table_fixedpods$meanNe2[201:300])^2, na.rm = T))
# unlimited: 192.8862

# Mean Bias original scale
mean(wfabcNe_RFNe_table_fixedpods$wfabc_ne[1:100]-wfabcNe_RFNe_table_fixedpods$meanNe2[1:100])
# neutral: 146.9917
mean(wfabcNe_RFNe_table_fixedpods$wfabc_ne[101:200]-wfabcNe_RFNe_table_fixedpods$meanNe2[101:200])
# limited: 132.7121
mean(wfabcNe_RFNe_table_fixedpods$wfabc_ne[201:300]-wfabcNe_RFNe_table_fixedpods$meanNe2[201:300])
# unlimited: -187.002

ggplot(estimated.wfabc.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(WF-ABC)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## comparison with FST-based Ne estimates
##---------------------------------------------------
globalFSTNe <- function(x, tau){
  fst  <- x
  ne <- (tau*(1-fst))/(4*fst)
  return(ne)
}

fstne2_fixedpods <- globalFSTNe(x=global_sumstats_fixedpods$GSS_WCst, tau=10)

# RMSE original scale
sqrt(mean((fstne2_fixedpods[1:100]-wfabcNe_RFNe_table_fixedpods$meanNe2[1:100])^2, na.rm = T))
# neutral: 74.17983
sqrt(mean((fstne2_fixedpods[101:200]-wfabcNe_RFNe_table_fixedpods$meanNe2[101:200])^2, na.rm = T))
# limited: 95.26698
sqrt(mean((fstne2_fixedpods[201:300]-wfabcNe_RFNe_table_fixedpods$meanNe2[201:300])^2, na.rm = T))
# unlimited: 263.7881

# Mean Bias original scale
mean(fstne2_fixedpods[1:100]-wfabcNe_RFNe_table_fixedpods$meanNe2[1:100])
# neutral: -57.73358
mean(fstne2_fixedpods[101:200]-wfabcNe_RFNe_table_fixedpods$meanNe2[101:200])
# limited: -74.86537
mean(fstne2_fixedpods[201:300]-wfabcNe_RFNe_table_fixedpods$meanNe2[201:300])
# unlimited: -259.9887

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods, 
     y    = log10(fstne2_fixedpods),
     xlab = "True value", 
     ylab = "FST-Ne estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.fstNe2.fixedpods <- data.frame(x = logmeanNe2_fixedpods,
                                        y = log10(fstne2_fixedpods),
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(estimated.fstNe2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods",".RData"))

ggplot(estimated.fstNe2.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

# RMSE log10 scale
sqrt(mean((estimated.fstNe2.fixedpods$y[1:100]-estimated.fstNe2.fixedpods$x[1:100])^2, na.rm = T))
# neutral:  0.0625192
sqrt(mean((estimated.fstNe2.fixedpods$y[101:200]-estimated.fstNe2.fixedpods$x[101:200])^2, na.rm = T))
# limited: 0.0897548
sqrt(mean((estimated.fstNe2.fixedpods$y[201:300]-estimated.fstNe2.fixedpods$x[201:300])^2, na.rm = T))
# unlimited: 1.039864

# Mean Bias log10 scale
mean(estimated.fstNe2.fixedpods$y[1:100]-estimated.fstNe2.fixedpods$x[1:100])
# neutral: -0.04830905
mean(estimated.fstNe2.fixedpods$y[101:200]-estimated.fstNe2.fixedpods$x[101:200])
# limited: -0.06551443
mean(estimated.fstNe2.fixedpods$y[201:300]-estimated.fstNe2.fixedpods$x[201:300])
# unlimited: -1.032799

## Fixed PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logmeanNe2_add <- predict(object      = reg_logmeanNe2,
                                               obs        = global_sumstats_fixedpods_add,
                                               training   = data.frame(logmeanNe2, global_sumstats),
                                               quantiles  = c(0.025,0.5,0.975),
                                               paral      = T,
                                               ncores     = 6,
                                               rf.weights = T)

#save(posterior_fixedpods_logmeanNe2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmeanNe2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2_add_c",".RData"))


## prepare the vector with the true values - transformed
logmeanNe2_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = posterior_fixedpods_logmeanNe2_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmeanNe2.fixedpods_add <- data.frame(x = c(logmeanNe2_fixedpods[c(1:100)], 
                                                  logmeanNe2_fixedpods_add),
                                            y = c(posterior_fixedpods_logmeanNe2$expectation[c(1:100)], 
                                                  posterior_fixedpods_logmeanNe2_add$expectation),
                                            c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logmeanNe2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmeanNe2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2.fixedpods_add_c",".RData"))

# Mean bias
mean(10^(pred.logmeanNe2.fixedpods_add$y[101:200]) - 10^(pred.logmeanNe2.fixedpods_add$x[101:200]), na.rm = TRUE) 
# Limited s=0.01: 22.47767
mean(10^(pred.logmeanNe2.fixedpods_add$y[301:400]) - 10^(pred.logmeanNe2.fixedpods_add$x[301:400]), na.rm = TRUE) 
# Unlimited s=0.01: 5.104712

ggplot(pred.logmeanNe2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral", "mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))


## comparison with WFABC Ne estimates
##---------------------------------------------------

wfabcNe_neutral_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/neutral/wfabc_1_output_mutation_neutral.txt",header=TRUE)
wfabcNe_limitedAdd1_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.01//wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_limitedAdd2_raw   <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_limited/add_s0.25//wfabc_1_output_mutation_limited.txt",header=TRUE)
wfabcNe_unlimitedAdd1_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.01//wfabc_1_output_mutation_unlimited.txt",header=TRUE)
wfabcNe_unlimitedAdd2_raw <- read.table(file="~/My_repositories/Tracking-selection/results/pipeline_v5/fixedpods/mutation_unlimited/add_s0.25//wfabc_1_output_mutation_unlimited.txt",header=TRUE)

wfabcNe_fixedpods_add <- rbind(wfabcNe_neutral_raw , 
                               wfabcNe_limitedAdd1_raw,
                               wfabcNe_limitedAdd2_raw,
                               wfabcNe_unlimitedAdd1_raw,
                               wfabcNe_unlimitedAdd2_raw)

# combine fixed pods sim, meanNe2 and wfabc_Ne
wfabcNe_RFNe_table_fixedpods_add <- data.frame(rbind(pooled_reftable_fixedpods[1:100,c("sim","meanNe2")], 
                                                     pooled_reftable_fixedpods_add[1:400,c("sim","meanNe2")]),
                                               wfabcNe_fixedpods_add[,c("wfabc_ne","wfabc_sd")])

wfabcNe_RFNe_table_fixedpods_add$wfabc_ne <- wfabcNe_RFNe_table_fixedpods_add$wfabc_ne/2

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = log10(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[-c(1:100)]),
     xlab = "True value", 
     ylab = "WF-ABC estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
estimated.wfabc.fixedpods_add <- data.frame(x = log10(wfabcNe_RFNe_table_fixedpods_add$meanNe2),
                                            y = log10(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne),
                                            c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(estimated.wfabc.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.wfabc.fixedpods_add",".RData"))

# RMSE log scale
sqrt(mean((estimated.wfabc.fixedpods_add$y[1:100]-estimated.wfabc.fixedpods_add$x[1:100])^2))
# neutral: 0.1061527
sqrt(mean((estimated.wfabc.fixedpods_add$y[101:200]-estimated.wfabc.fixedpods_add$x[101:200])^2))
# limited s=0.01: 0.1065496
sqrt(mean((estimated.wfabc.fixedpods_add$y[301:400]-estimated.wfabc.fixedpods_add$x[301:400])^2))
# unlimited s=0.01: 0.2540548

# Mean Bias log scale
mean(estimated.wfabc.fixedpods_add$y[1:100]-estimated.wfabc.fixedpods_add$x[1:100])
# neutral: 0.09750287
mean(estimated.wfabc.fixedpods_add$y[101:200]-estimated.wfabc.fixedpods_add$x[101:200])
# limited s=0.01: 0.09529776
mean(estimated.wfabc.fixedpods_add$y[301:400]-estimated.wfabc.fixedpods_add$x[301:400])
# unlimited s=0.01: -0.2338261

# RMSE original scale
sqrt(mean((wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[1:100]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[1:100])^2))
# neutral: 163.9951
sqrt(mean((wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[101:200]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[101:200])^2))
# limited s=0.01: 165.5622
sqrt(mean((wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[301:400]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[301:400])^2))
# unlimited s=0.01: 205.5207

# Mean Bias original scale
mean(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[1:100]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[1:100])
# neutral: 146.9917
mean(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[101:200]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[101:200])
# limited s=0.01: 144.1203
mean(wfabcNe_RFNe_table_fixedpods_add$wfabc_ne[301:400]-wfabcNe_RFNe_table_fixedpods_add$meanNe2[301:400])
# unlimited s=0.01: -197.5035

ggplot(estimated.wfabc.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(WF-ABC)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## comparison with FST-based Ne estimates
##---------------------------------------------------
#globalFSTNe <- function(x, tau){
#  fst  <- x
#  ne <- (tau*(1-fst))/(4*fst)
#  return(ne)
#}

fstne2_fixedpods_add <- globalFSTNe(x=c(global_sumstats_fixedpods$GSS_WCst[1:100],global_sumstats_fixedpods_add$GSS_WCst), tau=10)

# basic plot for diagnostic
plot(x    = logmeanNe2_fixedpods_add, 
     y    = log10(fstne2_fixedpods_add),
     xlab = "True value", 
     ylab = "FST-Ne estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[e])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# Mean Bias original scale
mean(fstne2_fixedpods_add[1:100] - wfabcNe_RFNe_table_fixedpods_add$meanNe2[1:100])
# neutral: -60.82837
mean(fstne2_fixedpods_add[101:200] - wfabcNe_RFNe_table_fixedpods_add$meanNe2[101:200])
# limited s=0.01: -60.82837
mean(fstne2_fixedpods_add[301:400] - wfabcNe_RFNe_table_fixedpods_add$meanNe2[301:400])
# unlimited s=0.01: -305.7189

# manuscript plot
estimated.fstNe2.fixedpods_add <- data.frame(x = c(logmeanNe2_fixedpods[1:100], logmeanNe2_fixedpods_add),
                                             y = c(log10(fstne2_fixedpods[1:100]), log10(fstne2_fixedpods_add)),
                                             c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(estimated.fstNe2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/estimated.fstNe2.fixedpods_add",".RData"))

# Mean Bias log10 scale
mean(estimated.fstNe2.fixedpods_add$y[101:200]-estimated.fstNe2.fixedpods_add$x[101:200])
# limited s=0.01: -0.05140555
mean(estimated.fstNe2.fixedpods_add$y[301:400]-estimated.fstNe2.fixedpods_add$x[301:400])
# unlimited s=0.01: -0.4823771

ggplot(estimated.fstNe2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]), " ","(from", " ", italic(hat(F))[ST], ")")))+
  xlim(0,4) +
  ylim(0,4) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Population size of period 2 - census size Ncs
```{r predition Ncs, echo=TRUE, eval=FALSE, include=TRUE}

# RANDOM PODS
##-----------------------------------------------
#posterior_radnompods_logncs <- predict(object     = reg_logncs,
#                                       obs        = global_sumstats_pods,
#                                       training   = data.frame(logncs, global_sumstats),
#                                       quantiles  = c(0.025,0.5,0.975),
#                                       paral      = T,
#                                       ncores     = 28,
#                                       rf.weights = T)
#save(posterior_radnompods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logncs",".RData"))
#
## prepare the vector with the true values - transformed
#logncs_radnompods <- log10(pooled_reftable_pods[, "Ncs"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logncs_radnompods, 
#     y    = posterior_radnompods_logncs$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-0.5,3.5),
#     ylim = c(-0.5,3.5),
#     main = expression(log[10](italic(N)[cs])),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logncs <- data.frame(x = logncs_radnompods,
#                          y = posterior_radnompods_logncs$expectation)
#save(pred.logncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logncs, nbins=30, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[cs]))),
#       ylab = expression(paste(log(italic(hat(N))[cs]), " ","(ABC-RF)")),
#       xlim = c(-0.5,3.5),
#       ylim = c(-0.5,3.5),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)

## Fixed PODs
##-----------------------------------------------
posterior_fixedpods_logncs <- predict(object     = reg_logncs,
                                      obs        = global_sumstats_fixedpods,
                                      training   = data.frame(logncs, global_sumstats),
                                      quantiles  = c(0.025,0.5,0.975),
                                      paral      = T,
                                      ncores     = 6,
                                      rf.weights = T)

#save(posterior_fixedpods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_c",".RData"))

## prepare the vector with the true values - transformed
logncs_fixedpods <- log10(pooled_reftable_fixedpods[, "Ncs"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logncs_fixedpods, 
     y    = posterior_fixedpods_logncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logncs.fixedpods <- data.frame(x = logncs_fixedpods,
                                        y = posterior_fixedpods_logncs$expectation,
                                        c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_c",".RData"))

# Mean Bias
mean(10^(pred.logncs.fixedpods$y[1:100])- 10^(pred.logncs.fixedpods$x[1:100]))
# neutral: 23.93672
mean(10^(pred.logncs.fixedpods$y[101:200]) - 10^(pred.logncs.fixedpods$x[101:200]))
# limited: 9.082598
mean(10^(pred.logncs.fixedpods$y[201:300]) - 10^(pred.logncs.fixedpods$x[201:300]))
# unlimited: -20.36097


ggplot(pred.logncs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[cs]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## Fixed PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logncs_add <- predict(object     = reg_logncs,
                                          obs        = global_sumstats_fixedpods_add,
                                          training   = data.frame(logncs, global_sumstats),
                                          quantiles  = c(0.025,0.5,0.975),
                                          paral      = T,
                                          ncores     = 6,
                                          rf.weights = T)

#save(posterior_fixedpods_logncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logncs_add_c",".RData"))


## prepare the vector with the true values - transformed
logncs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "Ncs"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logncs_fixedpods_add, 
     y    = posterior_fixedpods_logncs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-0.5,3.5),
     ylim = c(-0.5,3.5),
     main = expression(log[10](italic(N)[cs])),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logncs.fixedpods_add <- data.frame(x = c(logncs_fixedpods[1:100], logncs_fixedpods_add),
                                        y = c(posterior_fixedpods_logncs$expectation[1:100], posterior_fixedpods_logncs_add$expectation),
                                        c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logncs.fixedpods_add_c",".RData"))

# Mean Bias
mean(10^(pred.logncs.fixedpods_add$y[101:200])- 10^(pred.logncs.fixedpods_add$x[101:200]))
# limited s=0.01: 20.36992
mean(10^(pred.logncs.fixedpods_add$y[301:400])- 10^(pred.logncs.fixedpods_add$x[301:400]))
# unlimited s=0.01: 18.90576

ggplot(pred.logncs.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[cs]), " ","(ABC-RF)")))+
  xlim(1.5,3) +
  ylim(1.5,3) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

```

#### Ratio Mean effective size / population size of period 2 - MeanNe2/Ncs
```{r predition MeanNe2Ncs, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------
#posterior_randompods_logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
#                                              obs        = global_sumstats_pods,
#                                              training   = data.frame(logmeanNe2ncs, global_sumstats),
#                                              quantiles  = c(0.025,0.5,0.975),
#                                              paral      = T,
#                                              ncores     = 28,
#                                              rf.weights = T)
#(posterior_randompods_logmeanNe2ncs)
#
#save(posterior_randompods_logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmeanNe2ncs",".RData"))
#
## prepare the vector with the true values - transformed
#logmeanNe2ncs_randompods <- log10(pooled_reftable_pods[, "meanNe2"]/pooled_reftable_pods[, "Ncs"])
#
#
# Expected True vs estimated
# basic plot for diagnostic
#plot(x    = logmeanNe2ncs_randompods, 
#     y    = posterior_randompods_logmeanNe2ncs$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-4,1),
#     ylim = c(-4,1),
#     main = expression(italic(N)[e]/italic(N)[cs]), 
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "#cb181d")
#
# manuscript plot
#pred.logmeanNe2ncs <- data.frame(x = logmeanNe2ncs_randompods,
#                                 y = posterior_randompods_logmeanNe2ncs$expectation)
#save(pred.logmeanNe2ncs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logmeanNe2ncs, nbins=30, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(N)[e]))),
#       ylab = expression(paste(log(italic(hat(N))[e]), " ","(ABC-RF)")),
#       xlim = c(-4,1),
#       ylim = c(-4,1),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logmeanNe2ncs <- predict(object     = reg_logmeanNe2ncs,
                                             obs        = global_sumstats_fixedpods,
                                             training   = data.frame(logmeanNe2ncs, global_sumstats),
                                             quantiles  = c(0.025,0.5,0.975),
                                             paral      = T,
                                             ncores     = 6,
                                             rf.weights = T)

#save(posterior_fixedpods_logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmeanNe2ncs, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_c",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2ncs_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"]/pooled_reftable_fixedpods[, "Ncs"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmeanNe2ncs_fixedpods, 
     y    = posterior_fixedpods_logmeanNe2ncs$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,1),
     ylim = c(-4,1),
     main = expression(italic(N)[e]/italic(N)[cs]), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "#cb181d")

# manuscript plot
pred.logmeanNe2ncs.fixedpods <- data.frame(x = logmeanNe2ncs_fixedpods,
                                           y = posterior_fixedpods_logmeanNe2ncs$expectation,
                                           c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logmeanNe2ncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmeanNe2ncs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_c",".RData"))

# Mean Bias
mean(10^(pred.logmeanNe2ncs.fixedpods$y[1:100])- 10^(pred.logmeanNe2ncs.fixedpods$x[1:100]))
# neutral: -0.002290994
mean(10^(pred.logmeanNe2ncs.fixedpods$y[101:200])- 10^(pred.logmeanNe2ncs.fixedpods$x[101:200]))
# limited: 0.0006343472
mean(10^(pred.logmeanNe2ncs.fixedpods$y[201:300])- 10^(pred.logmeanNe2ncs.fixedpods$x[201:300]))
# unlimited: 0.0267374

ggplot(pred.logmeanNe2ncs.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75, fill="white") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(ABC-RF)")))+
  xlim(-1,0.5) +
  ylim(-1,0.5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

## FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logmeanNe2ncs_add <- predict(object     = reg_logmeanNe2ncs,
                                                 obs        = global_sumstats_fixedpods_add,
                                                 training   = data.frame(logmeanNe2ncs, global_sumstats),
                                                 quantiles  = c(0.025,0.5,0.975),
                                                 paral      = T,
                                                 ncores     = 6,
                                                 rf.weights = T)

#save(posterior_fixedpods_logmeanNe2ncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmeanNe2ncs_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmeanNe2ncs_add_c",".RData"))

## prepare the vector with the true values - transformed
logmeanNe2ncs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"]/pooled_reftable_fixedpods_add[, "Ncs"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmeanNe2ncs_fixedpods_add, 
     y    = posterior_fixedpods_logmeanNe2ncs_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-4,1),
     ylim = c(-4,1),
     main = expression(italic(N)[e]/italic(N)[cs]), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "#cb181d")

# manuscript plot
pred.logmeanNe2ncs.fixedpods_add <- data.frame(x = c(logmeanNe2ncs_fixedpods[1:100], 
                                                     logmeanNe2ncs_fixedpods_add),
                                               y = c(posterior_fixedpods_logmeanNe2ncs$expectation[1:100], 
                                                     posterior_fixedpods_logmeanNe2ncs_add$expectation),
                                               c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logmeanNe2ncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmeanNe2ncs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmeanNe2ncs.fixedpods_add_c",".RData"))

# Mean Bias
mean(10^(pred.logmeanNe2ncs.fixedpods_add$y[101:200])-10^(pred.logmeanNe2ncs.fixedpods_add$x[101:200]))
# limited s=0.01: -0.001727951
mean(10^(pred.logmeanNe2ncs.fixedpods_add$y[301:400])-10^(pred.logmeanNe2ncs.fixedpods_add$x[301:400]))
# unlimited s=0.01: -0.03988554

ggplot(pred.logmeanNe2ncs.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75, fill="white") + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(N)[e]/italic(N)[cs])))) +
  ylab(expression(paste(log[10](italic(hat(N))[e]/italic(N)[cs]), " ","(ABC-RF)")))+
  xlim(-1,0.5) +
  ylim(-1,0.5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### Per site mutation rate mu
```{r prediction site mutation rate, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------
#posterior_randompods_logmu <- predict(object     = reg_logmu,
#                                      obs        = global_sumstats_pods,
#                                      training   = data.frame(logmu, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#save(posterior_randompods_logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logmu",".RData"))
#
## prepare the vector with the true values
#log_randompods_mu <- log10(pooled_reftable_pods[, "mu"])
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = log_randompods_mu, 
#     y    = posterior_randompods_logmu$expectation,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-10,-6),
#     ylim = c(-10,-6),
#     main = expression(log[10](italic(mu))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logmu <- predict(object     = reg_logmu,
                                     obs        = global_sumstats_fixedpods,
                                     training   = data.frame(logmu, global_sumstats),
                                     quantiles  = c(0.025,0.5,0.975),
                                     paral      = T,
                                     ncores     = 8,
                                     rf.weights = T)

#save(posterior_fixedpods_logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmu, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_c",".RData"))

## prepare the vector with the true values
logmu_fixedpods <- log10(pooled_reftable_fixedpods[, "mu"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logmu_fixedpods, 
     y    = posterior_fixedpods_logmu$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     main = expression(log[10](italic(mu))), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmu.fixedpods <- data.frame(x = logmu_fixedpods,
                                   y = posterior_fixedpods_logmu$expectation,
                                   c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logmu.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmu.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods_c",".RData"))

# Mean Bias
mean(pred.logmu.fixedpods$y[1:100]-pred.logmu.fixedpods$x[1:100])
# neutral: -0.04202229
mean(pred.logmu.fixedpods$y[101:200]-pred.logmu.fixedpods$x[101:200])
# limited: -0.03686272
mean(pred.logmu.fixedpods$y[201:300]-pred.logmu.fixedpods$x[201:300])
# unlimited: 2.859344e-09

ggplot(pred.logmu.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(mu))))) +
  ylab(expression(paste(log[10](italic(hat(mu))), " ","(ABC-RF)")))+
  xlim(-10,-5) +
  ylim(-10,-5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logmu_add <- predict(object     = reg_logmu,
                                         obs        = global_sumstats_fixedpods_add,
                                         training   = data.frame(logmu, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 6,
                                         rf.weights = T)

#save(posterior_fixedpods_logmu_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logmu_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logmu_add_c",".RData"))

## prepare the vector with the true values
logmu_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "mu"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logmu_fixedpods_add, 
     y    = posterior_fixedpods_logmu_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     main = expression(log[10](italic(mu))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logmu.fixedpods_add <- data.frame(x = c(logmu_fixedpods[c(1:100)], 
                                             logmu_fixedpods_add),
                                       y = c(posterior_fixedpods_logmu$expectation[c(1:100)], 
                                             posterior_fixedpods_logmu_add$expectation),
                                       c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logmu.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtmu.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logmu.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logmu.fixedpods_add_c",".RData"))

# Mean Bias
mean(pred.logmu.fixedpods_add$y[101:200]-pred.logmu.fixedpods_add$x[101:200])
# limited s=0.01: -0.0408521
mean(pred.logmu.fixedpods_add$y[301:400]-pred.logmu.fixedpods_add$x[301:400])
# unlimited s=0.01: 0.01923556

ggplot(pred.logmu.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(mu))))) +
  ylab(expression(paste(log[10](italic(hat(mu))), " ","(ABC-RF)")))+
  xlim(-10,-5) +
  ylim(-10,-5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))
```

#### recombination rate rr
```{r prediction recombination rate, echo=TRUE, eval=FALSE, include=TRUE}

## FIXED PODs
##-----------------------------------------------
posterior_fixedpods_logrr <- predict(object     = reg_logrr,
                                     obs        = global_sumstats_fixedpods,
                                     training   = data.frame(logrr, global_sumstats),
                                     quantiles  = c(0.025,0.5,0.975),
                                     paral      = T,
                                     ncores     = 8,
                                     rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logrr, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrr_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrr_c",".RData"))

## prepare the vector with the true values
logrr_fixedpods <- log10(pooled_reftable_fixedpods[, "rr"])

# Expected True vs estimated
# basic plot for diagnostic
plot(x    = logrr_fixedpods, 
     y    = posterior_fixedpods_logrr$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-8,-5),
     ylim = c(-8,-5),
     main = expression(log[10](italic(c)[0])), 
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logrr.fixedpods <- data.frame(x = logrr_fixedpods,
                                   y = posterior_fixedpods_logrr$expectation,
                                   c = c(rep("A",100),rep("B", 100), rep("C", 100)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logrr.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logrr.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logrr.fixedpods_c",".RData"))

# Mean Bias
mean(pred.logrr.fixedpods$y[1:100]-pred.logrr.fixedpods$x[1:100])
# neutral: -0.06048098
mean(pred.logrr.fixedpods$y[101:200]-pred.logrr.fixedpods$x[101:200])
# limited: -0.05536155
mean(pred.logrr.fixedpods$y[201:300]-pred.logrr.fixedpods$x[201:300])
# unlimited: -0.2560132

ggplot(pred.logrr.fixedpods, aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(mu))))) +
  ylab(expression(paste(log[10](italic(hat(mu))), " ","(ABC-RF)")))+
  xlim(-10,-5) +
  ylim(-10,-5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

rr.fix <- ggplot(pred.logrr.fixedpods_add, aes(x=c, y=y, fill=c))
rr.fix <- rr.fix +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(c))[0]), " ","(ABC-RF)")))+
               ylim(-8.8,-6.40) +
               geom_abline(intercept = -7.30103 , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
rr.fix

##FIXED PODs ADDITIONAL
##-----------------------------------------------
posterior_fixedpods_logrr_add <- predict(object     = reg_logrr,
                                         obs        = global_sumstats_fixedpods_add,
                                         training   = data.frame(logrr, global_sumstats),
                                         quantiles  = c(0.025,0.5,0.975),
                                         paral      = T,
                                         ncores     = 6,
                                         rf.weights = T)

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logrr_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrr_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrr_add_c",".RData"))

## prepare the vector with the true values
logrr_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "rr"])

## Expected True vs estimated value
# basic plot for diagnostic
plot(x    = logrr_fixedpods_add, 
     y    = posterior_fixedpods_logrr_add$expectation,
     xlab = "True value", 
     ylab = "ABC-RF estimated",
     xlim = c(-10,-5),
     ylim = c(-10,-5),
     main = expression(log[10](italic(mu))),
     cex.axis = 1.2,
     cex.lab  = 1.2
     )
abline(a=0, b=1, col = "green")

# manuscript plot
pred.logrr.fixedpods_add <- data.frame(x = c(logrr_fixedpods[c(1:100)], 
                                             logrr_fixedpods_add),
                                       y = c(posterior_fixedpods_logrr$expectation[c(1:100)], 
                                             posterior_fixedpods_logrr_add$expectation),
                                       c = c(rep("A",100),rep("B", 200), rep("C", 200)))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logrr.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logrr.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logrr.fixedpods_add_c",".RData"))

# Mean Bias
mean(pred.logrr.fixedpods_add$y[101:200]-pred.logrr.fixedpods_add$x[101:200])
# limited s=0.01: -0.06282266
mean(pred.logrr.fixedpods_add$y[301:400]-pred.logrr.fixedpods_add$x[301:400])
# unlimited s=0.01: -0.0278929

ggplot(pred.logrr.fixedpods_add[c(1:100, 101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
  geom_point(size=3, alpha=0.75) + 
  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
                      name   = "Scenario",
                      breaks = c("A","B","C"),
                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
  xlab(expression(paste("true", " ", log[10](italic(mu))))) +
  ylab(expression(paste(log[10](italic(hat(mu))), " ","(ABC-RF)")))+
  xlim(-10,-5) +
  ylim(-10,-5) +
  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                           panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                           legend.position = "top", axis.text = element_text(size = 12),
                           axis.title=element_text(size=12))

rr.fix_add1 <- ggplot(pred.logrr.fixedpods_add[c(1:200, 301:400), ], aes(x=c, y=y, fill=c))
rr.fix_add1 <- rr.fix_add1 +  geom_boxplot(alpha=1) + 
               scale_fill_manual(values = c("black","#2ca25f","#fd8d3c"),
                                 name   = "", #"Scenario",
                                 breaks = "", #c("A","B","C"),
                                 labels = "", #c("neutral","mutation limited", "mutation unlimited")
                                 ) + 
               scale_x_discrete(labels = c("neutral","limited", "unlimited")) +
               xlab("") +
               ylab(expression(paste(log[10](italic(hat(c))[0]), " ","(ABC-RF)")))+
               ylim(-8.8,-6.40) +
               geom_abline(intercept = -7.30103 , slope = 0,color = "black",  linetype="dashed") +
               theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
                                  panel.grid.major = element_blank(),
                                  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                                  legend.position = "top", axis.text = element_text(size = 12),
                                  axis.title=element_text(size=12))
rr.fix_add1
```

### ABC-RF regression: predictions for long-term evolution

#### Ns
```{r prediction Ns, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
##-----------------------------------------------------------
#
#posterior_radnompods_logNs <- predict(object     = reg_logNs,
#                                      obs        = global_sumstats_pods,
#                                      training   = data.frame(logNs, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 6,
#                                      rf.weights = T)
#
#save(posterior_radnompods_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_logNs",".RData"))
#
## prepare the vector with the true values - transformed
#logNs_randompods <- log10(pooled_reftable_pods[, "meanNe2"] * pooled_reftable_pods[, "gammaMean"])
#
## Expected True vs estimated value
# basic plot for diagnostic
# remove qNeutral simulations 
#plot(x    = logNs_randompods, 
#     y    = posterior_radnompods_logNs$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-4,4),
#     ylim = c(-4,4),
#     main = expression(log[10](italic(N)[e] * italic(s))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logNs <- data.frame(x = logNs_randompods,
#                         y = posterior_radnompods_logNs$expectation)
#save(pred.logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logNs, nbins=30, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", logit(italic(N)[e]*italic(s)))),
#       ylab = expression(paste(log[10](italic(hat(N))[e]*italic(s)), " ","(ABC-RF)")),
#       xlim = c(-4,4),
#       ylim = c(-4,4),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#
## FIXED PODs
##-----------------------------------------------------------
posterior_fixedpods_logNs <- predict(object     = reg_logNs,
                                     obs        = global_sumstats_fixedpods,
                                     training   = data.frame(logNs, global_sumstats),
                                     quantiles  = c(0.025,0.5,0.975),
                                     paral      = T,
                                     ncores     = 6,
                                     rf.weights = T)

#save(posterior_fixedpods_logNs, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs",".RData"))
#
## prepare the vector with the true values
#logNs_fixedpods <- log10(pooled_reftable_fixedpods[, "meanNe2"] * pooled_reftable_fixedpods[, "gammaMean"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logNs_fixedpods[-c(1:100)], 
#     y    = posterior_fixedpods_logNs$expectation[-c(1:100)],
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-4,4),
#     ylim = c(-4,4),
#     main = expression(log[10](italic(N)[e] * italic(s))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logNs.fixedpods <- data.frame(x = logNs_fixedpods[-c(1:100)],
#                                   y = posterior_fixedpods_logNs$expectation[-c(1:100)],
#                                   c = c(rep("A", 100), rep("B", 100)))
#
#save(pred.logNs.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods",".RData"))
#
#ggplot(pred.logNs.fixedpods, aes(x=x , y=y, color=c)) + 
#  geom_point(size=3, alpha=0.75) + 
#  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
#                      name   = "Scenario",
#                      breaks = c("A","B"),
#                      labels = c("mutation limited", "mutation unlimited")) + 
#  xlab(expression(paste("true", " ", log[10](italic(N)[e] * italic(s))))) +
#  ylab(expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(ABC-RF)")))+
#  xlim(0, 2) +
#  ylim(0, 2) +
#  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
#  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
#                           panel.grid.major = element_blank(),
#                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
#                           legend.position = "top", axis.text = element_text(size = 12),
#                           axis.title=element_text(size=12))
#
## FIXED PODs ADDITIONL
##-----------------------------------------------------------
#posterior_fixedpods_logNs_add <- predict(object     = reg_logNs,
#                                         obs        = global_sumstats_fixedpods_add,
#                                         training   = data.frame(logNs, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 6,
#                                         rf.weights = T)
#
#save(posterior_fixedpods_logNs_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logNs_add",".RData"))
#
## prepare the vector with the true values
#logNs_fixedpods_add <- log10(pooled_reftable_fixedpods_add[, "meanNe2"] * pooled_reftable_fixedpods_add[, "gammaMean"])
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logNs_fixedpods_add, 
#     y    = posterior_fixedpods_logNs_add$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-4,4),
#     ylim = c(-4,4),
#     main = expression(log[10](italic(N)[e] * italic(s))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logNs.fixedpods_add <- data.frame(x = logNs_fixedpods_add,
#                                       y = posterior_fixedpods_logNs_add$expectation,
#                                       c = c(rep("A", 200), rep("B", 200)))
#
#save(pred.logNs.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logNs.fixedpods_add",".RData"))
#
#ggplot(pred.logNs.fixedpods_add[c(101:200, 301:400), ], aes(x=x , y=y, color=c)) + 
#  geom_point(size=3, alpha=0.75) + 
#  scale_colour_manual(values = c("#2ca25f","#fd8d3c"),
#                      name   = "Scenario",
#                      breaks = c("A","B"),
#                      labels = c("mutation limited", "mutation unlimited")) + 
#  xlab(expression(paste("true", " ", log[10](italic(N)[e] * italic(s))))) +
#  ylab(expression(paste(log[10](italic(hat(N))[e] * italic(s)), " ","(ABC-RF)")))+
#  xlim(0, 3) +
#  ylim(0, 3) +
#  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
#  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
#                           panel.grid.major = element_blank(),
#                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
#                           legend.position = "top", axis.text = element_text(size = 12),
#                           axis.title=element_text(size=12))
```

#### Theta of period 2
```{r prediction theta 2, echo=TRUE, eval=FALSE, include=TRUE}
## RANDOM PODs
##-----------------------------------------------
#posterior_randompods_logtheta2 <- predict(object     = reg_logtheta2,
#                                          obs        = global_sumstats_pods,
#                                          training   = data.frame(logtheta2, global_sumstats),
#                                          quantiles  = c(0.025,0.5,0.975),
#                                          paral      = T,
#                                          ncores     = 6,
#                                          rf.weights = T)
#
#save(posterior_randompods_logtheta2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta2",".RData"))
#
## prepare the vector with the true values - transformed
#genomeS = 100e+06
#logtheta2_randompods <- log10(4 * pooled_reftable_pods[, "meanNe2"] * (pooled_reftable_pods[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logtheta2_randompods, 
#     y    = posterior_randompods_logtheta2$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     main = expression(log[10](italic(θ))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logtheta2 <- data.frame(x = logtheta2_randompods,
#                             y = posterior_randompods_logtheta2$expectation)
#save(pred.logtheta2, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2",".RData"))
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(pred.logtheta2, nbins=50, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(θ)))),
#       ylab = expression(paste(log(italic(hat(θ))), " ","(ABC-RF)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
#

##FIXED PODs
##-----------------------------------------------
#posterior_fixedpods_logtheta2 <- predict(object     = reg_logtheta2,
#                                         obs        = global_sumstats_fixedpods,
#                                         training   = data.frame(logtheta2, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 6,
#                                         rf.weights = T)
#
#save(posterior_fixedpods_logtheta2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logtheta2, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_c",".RData"))

## prepare the vector with the true values - transformed
#genomeS = 100e+06
#logtheta2_fixedpods <- log10(4 * pooled_reftable_fixedpods[, "meanNe1"] * (pooled_reftable_fixedpods[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logtheta2_fixedpods, 
#     y    = posterior_fixedpods_logtheta2$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     main = expression(log[10](italic(θ))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")
#
# manuscript plot
#pred.logtheta2.fixedpods <- data.frame(x = logtheta2_fixedpods,
#                                       y = posterior_fixedpods_logtheta2$expectation,
#                                       c = c(rep("A",100),rep("B", 100), rep("C", 100)))
#save(pred.logtheta2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logtheta2.fixedpods, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_c",".RData"))

# RMSE
#sqrt(mean((pred.logtheta2.fixedpods$y[1:100]-pred.logtheta2.fixedpods$x[1:100])^2))
# neutral: 0.0463825
#sqrt(mean((pred.logtheta2.fixedpods$y[101:200]-pred.logtheta2.fixedpods$x[101:200])^2))
# limited: 0.05278063
#sqrt(mean((pred.logtheta2.fixedpods$y[201:300]-pred.logtheta2.fixedpods$x[201:300])^2))
# unlimited: 0.1827057

# Mean Bias
#mean(pred.logtheta2.fixedpods$y[1:100]-pred.logtheta2.fixedpods$x[1:100])
# neutral: -0.01732754
#mean(pred.logtheta2.fixedpods$y[101:200]-pred.logtheta2.fixedpods$x[101:200])
# limited: -0.02203022
#mean(pred.logtheta2.fixedpods$y[201:300]-pred.logtheta2.fixedpods$x[201:300])
# unlimited: -0.1004485

#ggplot(pred.logtheta2.fixedpods, aes(x=x , y=y, color=c)) + 
#  geom_point(size=3, alpha=0.75) + 
#  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
#                      name   = "Scenario",
#                      breaks = c("A","B","C"),
#                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
#  xlab(expression(paste("true", " ", log[10](italic(θ))))) +
#  ylab(expression(paste(log[10](italic(hat(θ))), " ","(ABC-RF)")))+
#  xlim(-1,6) +
#  ylim(-1,6) +
#  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
#  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
#                           panel.grid.major = element_blank(),
#                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
#                           legend.position = "top", axis.text = element_text(size = 12),
#                           axis.title=element_text(size=12))

##FIXED PODs ADDITIONAL
##-----------------------------------------------
#posterior_fixedpods_logtheta2_add <- predict(object     = reg_logtheta2,
#                                             obs        = global_sumstats_fixedpods_add,
#                                             training   = data.frame(logtheta2, global_sumstats),
#                                             quantiles  = c(0.025,0.5,0.975),
#                                             paral      = T,
#                                             ncores     = 6,
#                                             rf.weights = T)
#
#save(posterior_fixedpods_logtheta2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(posterior_fixedpods_logtheta2_add, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta2_add_c",".RData"))

## prepare the vector with the true values - transformed
#genomeS = 100e+06
#logtheta2_fixedpods_add <- log10(4 * pooled_reftable_fixedpods_add[, "meanNe1"] * (pooled_reftable_fixedpods_add[, "mu"]) * genomeS)
#
## Expected True vs estimated value
# basic plot for diagnostic
#plot(x    = logtheta2_fixedpods_add, 
#     y    = posterior_fixedpods_logtheta2_add$expectation,
#     xlab = "True value", 
#     ylab = "ABC-RF estimated",
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     main = expression(log[10](italic(θ))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2
#     )
#abline(a=0, b=1, col = "green")

# manuscript plot
#pred.logtheta2.fixedpods_add <- data.frame(x = c(logtheta2_fixedpods[c(1:100)], 
#                                                 logtheta2_fixedpods_add),
#                                           y = c(posterior_fixedpods_logtheta2$expectation[c(1:100)], 
#                                                 posterior_fixedpods_logtheta2_add$expectation),
#                                           c = c(rep("A",100),rep("B", 200), rep("C", 200)))
#save(pred.logtheta2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add",".RData"))

## Prediction with Combined: original reftable + randompods reftable
#save(pred.logtheta2.fixedpods_add, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add_c",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/pred.logtheta2.fixedpods_add_c",".RData"))

# RMSE
#sqrt(mean((pred.logtheta2.fixedpods_add$y[101:200]-pred.logtheta2.fixedpods_add$x[101:200])^2, na.rm = T))
# limited s=0.01: 0.04815154
#sqrt(mean((pred.logtheta2.fixedpods_add$y[201:300]-pred.logtheta2.fixedpods_add$x[201:300])^2, na.rm = T))
# limited s=0.25: 0.04406306
#sqrt(mean((pred.logtheta2.fixedpods_add$y[301:400]-pred.logtheta2.fixedpods_add$x[301:400])^2, na.rm = T))
# unlimited s=0.01: 0.09787078
#sqrt(mean((pred.logtheta2.fixedpods_add$y[401:500]-pred.logtheta2.fixedpods_add$x[401:500])^2, na.rm = T))
# unlimited s=0.25: 0.2194379

# Mean Bias
#mean(pred.logtheta2.fixedpods_add$y[101:200]-pred.logtheta2.fixedpods_add$x[101:200])
# limited s=0.01: -0.01918933
#mean(pred.logtheta2.fixedpods_add$y[201:300]-pred.logtheta2.fixedpods_add$x[201:300])
# limited s=0.25: -0.01645874
#mean(pred.logtheta2.fixedpods_add$y[301:400]-pred.logtheta2.fixedpods_add$x[301:400])
# unlimited s=0.01: 0.03290689
#mean(pred.logtheta2.fixedpods_add$y[401:500]-pred.logtheta2.fixedpods_add$x[401:500])
# unlimited s=0.25: -0.1398164

#ggplot(pred.logtheta2.fixedpods_add[c(1:100, 201:300, 401:500), ], aes(x=x , y=y, color=c)) + 
#  geom_point(size=3, alpha=0.75) + 
#  scale_colour_manual(values = c("black","#2ca25f","#fd8d3c"),
#                      name   = "Scenario",
#                      breaks = c("A","B","C"),
#                      labels = c("neutral","mutation limited", "mutation unlimited")) + 
#  xlab(expression(paste("true", " ", log[10](italic(θ))))) +
#  ylab(expression(paste(log[10](italic(hat(θ))), " ","(ABC-RF)")))+
#  xlim(-1,6) +
#  ylim(-1,6) +
#  geom_abline(intercept = 0, slope = 1, color = "black",  linetype="dashed") +
#  theme_bw() + theme(panel.border = element_rect(colour = "black", fill=NA), 
#                           panel.grid.major = element_blank(),
#                           panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
#                           legend.position = "top", axis.text = element_text(size = 12),
#                           axis.title=element_text(size=12))
```

#### Rho = Nr
```{r prediction Rho, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
#posterior_randompods_logrho <- predict(object     = reg_logrho,
#                                       obs        = global_sumstats_pods,
#                                       training   = data.frame(logrho, global_sumstats),
#                                       quantiles  = c(0.025,0.5,0.975),
#                                       paral      = T,
#                                       ncores     = 28,
#                                       rf.weights = T)
#
#save(posterior_randompods_logrho, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logrho",".RData"))
#
#log_randompods_rho <- log10(pooled_reftable_pods[, "meanNe2"] * pooled_reftable_pods[, "rr"])
#
# Expected True vs estimated
#plot(x    = log_randompods_rho, 
#     y    = posterior_randompods_logrho$expectation,
#     xlim = c(-9,-3),
#     ylim = c(-9,-3),
#     xlab = expression(log[10](italic(rho))), 
#     ylab = expression(hat(log[10](italic(rho)))),
#     pch  = 1
#     )
#abline(a=0, b=1, col = "#cb181d")
#
## FIXED PODs
#posterior_fixedpods_logrho <- predict(object     = reg_logrho,
#                                      obs        = global_sumstats_fixedpods,
#                                      training   = data.frame(logrho, global_sumstats),
#                                      quantiles  = c(0.025,0.5,0.975),
#                                      paral      = T,
#                                      ncores     = 28,
#                                      rf.weights = T)
#save(posterior_fixedpods_logrho, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrho",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logrho",".RData"))
#
#log_fixedpods_rho <- log10(pooled_reftable_fixedpods[, "meanNe2"] * pooled_reftable_fixedpods[, "rr"])
#
# Expected True vs estimated
#plot(x    = log_fixedpods_rho, 
#     y    = posterior_fixedpods_logrho$expectation,
#     xlim = c(-9,-3),
#     ylim = c(-9,-3),
#     xlab = expression(log[10](italic(rho))), 
#     ylab = expression(hat(log[10](italic(rho)))),
#     pch  = 1,
#     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
#     )
#abline(a=0, b=1, col = "#cb181d")
```

### ABC-RF regression: growing trees for other parameters

#### Theta of perid 1
```{r regression theta, echo=TRUE, eval=FALSE, include=TRUE}
#genomeS = 100e+6
#logtheta1 <- log10(4 * pooled_reftable_total[, "meanNe1"] * (pooled_reftable_total[, "mu"]) * genomeS)
#
#hist(logtheta1, freq = TRUE, xlab = expression(log[10](italic(theta[1]))), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logtheta1 <- regAbcrf(formula = logtheta1~.,
#                          data    = data.frame(logtheta1, global_sumstats),
#                          ntree   = 1000,
#                          paral   = T,
#                          ncores  = 28)
#
#save(reg_logtheta1, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logtheta1",".RData"))
#
## variable Importance plot
#plot(x = reg_logtheta1, n.var = 20)
#
#head(sort(reg_logtheta1$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logtheta1$model.rf$prediction.error
# 0.02243393
#
## error rate plot
#err.regAbcrf(object   = reg_logtheta1,
#             training = data.frame(logtheta1, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = logtheta1,
#     y    = reg_logtheta1$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     main = expression(log[10](italic(theta[1]))),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#abline(a=0, b=1, col = "green")
#
# Manuscript plot
#oob.logtheta1 <- data.frame(x = logtheta1,
#                                y = reg_logtheta1$model.rf$predictions)
#
#par(mar=c(5,5,4,1)+.1)
#hist2d(oob.logtheta1, nbins=100, 
#       col=viridis::viridis(32), 
#       FUN=function(x) log(length(x)),
#       xlab = expression(paste("true", " ", log[10](italic(theta[1])))),
#       ylab = expression(paste(log[10](italic(hat(theta[1]))), " ","(OOB prediction)")),
#       xlim = c(-1.5,6),
#       ylim = c(-1.5,6),
#       cex.axis = 1.2,
#       cex.lab  = 1.2)
#abline(a=0, b=1, col = "black", lty = 3)
```

#### FDR 1% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
#fstfdrNs01 <- pooled_reftable_total[, "FSTfdrNS01"]
#hist(fstfdrNs01, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## rf-regression
#reg_fstfdrNs01 <- regAbcrf(formula = fstfdrNs01~.,
#                           data    = data.frame(fstfdrNs01, global_sumstats),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs01, n.var = 20)
#
#head(sort(reg_fstfdrNs01$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs01$model.rf$prediction.error
#  0.004060022
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01,
#             training = data.frame(fstfdrNs01, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
# diagnostic plot
#plot(x    = fstfdrNs01,
#     y    = reg_fstfdrNs01$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
#
## removing "quasi-neutral" simulations
#fstfdrNs01_2 <- fstfdrNs01[-neutralsims]
#hist(fstfdrNs01_2, freq = TRUE, xlab = "1% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## abf-rf regression
#reg_fstfdrNs01_2 <- regAbcrf(formula = fstfdrNs01_2~.,
#                           data    = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs01_2, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs01_2",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs01_2, n.var = 20)
#
#head(sort(reg_fstfdrNs01_2$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs01_2$model.rf$prediction.error
# 0.00575472
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs01_2,
#             training = data.frame(fstfdrNs01_2, global_sumstats_popstrongmsel),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = fstfdrNs01_2,
#     y    = reg_fstfdrNs01_2$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 1%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r regression fdrFST, echo=TRUE, eval=FALSE, include=TRUE}
#fstfdrNs05 <- pooled_reftable_total[, "FSTfdrNS05"]
#hist(fstfdrNs05, freq = TRUE, xlab = "5% FST FDR Ns>1", main = "", col = "#bdbdbd")
#
## rf-regression
#reg_fstfdrNs05 <- regAbcrf(formula = fstfdrNs05~.,
#                           data    = data.frame(fstfdrNs05, global_sumstats),
#                           ntree   = 1000,
#                           paral   = T,
#                           ncores  = 28)
#
#save(reg_fstfdrNs05, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_fstfdrNs05",".RData"))
#
## variable Importance plot
#plot(x = reg_fstfdrNs05, n.var = 20)
#
#head(sort(reg_fstfdrNs05$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_fstfdrNs05$model.rf$prediction.error
#  0.004149811
#
## error rate plot
#err.regAbcrf(object   = reg_fstfdrNs05,
#             training = data.frame(fstfdrNs05, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = fstfdrNs05,
#     y    = reg_fstfdrNs05$model.rf$predictions,
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     #col  = ifelse(selection_1 == "qNeutral", "red", "black"),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.2)
#legend("bottomright", legend = c("Quasi Neutral", "Strong Selection"), col = c("red", "black"), pch = 1, bty = "n")
#abline(a=0, b=1, col = "green")
```

#### Likelihood of having strongly selected mutations given the Ne and s mean (gamma shape) of sampling period
```{r regression likelihoods strong selection, echo=TRUE, eval=FALSE, include=TRUE}

#invNe2 <- 1/pooled_reftable_total[, "meanNe2"]
#gammashape <- pooled_reftable_total[, "gammaShape"]
#likelystrongMsel <- pgamma(invNe2,shape=gammashape,rate=1,lower.tail=FALSE)
#
#hist(likelystrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), #main = "", col = "#bdbdbd")
#
## rf-regression
#reg_likelystrongMsel <- regAbcrf(formula = likelystrongMsel~.,
#                                 data    = data.frame(likelystrongMsel, global_sumstats),
#                                 ntree   = 1000,
#                                 paral   = T,
#                                 ncores  = 8)
#
#save(reg_likelystrongMsel, 
#     file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_likelystrongMsel",".RData"))
#
## variable Importance plot
#plot(x = reg_likelystrongMsel, n.var = 20)
#
#head(sort(reg_likelystrongMsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_likelystrongMsel$model.rf$prediction.error
#0.07389625
#
## error rate plot
#err.regAbcrf(object   = reg_likelystrongMsel,
#             training = data.frame(likelystrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = likelystrongMsel,
#     y    = reg_likelystrongMsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(0,1),
#     ylim = c(0,1),
#     main = expression(paste("Pr mutations with"," ", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
#
## logit transformation of the likelihood
##-----------------------------------------------------------
#logitlikelyhoodstrongMsel <- log(likelystrongMsel/(1-likelystrongMsel))
#
#hist(logitlikelyhoodstrongMsel, freq = TRUE, xlab = expression(paste("Likelihood of mutations with"," ", italic(N[s]) , " > 1")), main = "", col = "#bdbdbd")
#
## rf-regression
#reg_logitlikelyhoodstrongMsel <- regAbcrf(formula = logitlikelyhoodstrongMsel~.,
#                                          data    = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
#                                          ntree   = 1000,
#                                          paral   = T,
#                                          ncores  = 8)
#save(reg_logitlikelyhoodstrongMsel, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/random_forests/reg_logitlikelyhoodstrongMsel",".RData"))
#
## variable Importance plot
#plot(x = reg_logitlikelyhoodstrongMsel, n.var = 20)
#
#head(sort(reg_logitlikelyhoodstrongMsel$model.rf$variable.importance, decreasing = T), n=20)
#
## prediction error
#reg_logitlikelyhoodstrongMsel$model.rf$prediction.error
#5.519425
#
## error rate plot
#err.regAbcrf(object   = reg_logitlikelyhoodstrongMsel,
#             training = data.frame(logitlikelyhoodstrongMsel, global_sumstats),
#             paral    = T,
#             ncores   = 28)
#
## oob predictions vs true values
## diagnostic plot
#plot(x    = logitlikelyhoodstrongMsel,
#     y    = reg_logitlikelyhoodstrongMsel$model.rf$predictions, 
#     xlab = "True value",
#     ylab = "OOB predictions",
#     xlim = c(-40,10),
#     ylim = c(-40,10),
#     main = expression(paste("Logit Pr mutations with"," ", italic(N[s]) , " > 1")),
#     cex.axis = 1.2,
#     cex.lab  = 1.5)
#abline(a=0, b=1, col = "green")
```

### ABC-RF regression: predictions for other parameters

#### Theta of period 1
```{r prediction theta1, echo=TRUE, eval=FALSE, include=TRUE}

## RANDOM PODs
#posterior_randompods_logtheta1 <- predict(object     = reg_logtheta1,
#                                          obs        = global_sumstats_pods,
#                                          training   = data.frame(logtheta1, global_sumstats),
#                                          quantiles  = c(0.025,0.5,0.975),
#                                          paral      = T,
#                                          ncores     = 28,
#                                          rf.weights = T)
#
#save(posterior_randompods_logtheta1, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_randompods_logtheta1",".RData"))
#
#genomeS = 100e+06
#log_randompods_theta1 <- log10(4 * pooled_reftable_pods[, "meanNe1"] * (pooled_reftable_pods[, "mu"]) * genomeS)
#
# Expected True vs estimated
#plot(x    = log_randompods_theta1, 
#     y    = posterior_randompods_logtheta1$expectation,
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     xlab = expression(italic(theta[(1)])), 
#     ylab = expression(hat(italic(theta[(1)]))),
#     pch  = 1
#     )
#abline(a=0, b=1, col = "#cb181d")
#
##FIXED PODs
#posterior_fixedpods_logtheta1 <- predict(object     = reg_logtheta1,
#                                         obs        = global_sumstats_fixedpods,
#                                         training   = data.frame(logtheta1, global_sumstats),
#                                         quantiles  = c(0.025,0.5,0.975),
#                                         paral      = T,
#                                         ncores     = 28,
#                                         rf.weights = T)
#save(posterior_fixedpods_logtheta1, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta1",".RData"))
#load(file=paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_fixedpods_logtheta1",".RData"))
#
#genomeS = 100e+06
#log_fixedpods_theta1 <- log10(4 * pooled_reftable_fixedpods[, "meanNe1"] * (pooled_reftable_fixedpods[, "mu"]) * genomeS)
#
# Expected True vs estimated
#plot(x    = log_fixedpods_theta1, 
#     y    = posterior_fixedpods_logtheta1$expectation,
#     xlim = c(-1,6),
#     ylim = c(-1,6),
#     xlab = expression(italic(theta[(1)])), 
#     ylab = expression(hat(italic(theta[(1)]))),
#     pch  = 1,
#     col  = c(rep("#1f78b4",100), rep("#ff7f00",100), rep("#e31a1c",100))
#     )
#abline(a=0, b=1, col = "#cb181d")
```

#### FDR 5% of the FST hypothesis of Ns>1
```{r prediction fdrFST, echo=TRUE, eval=FALSE, include=TRUE}

## Random PODs
#radnompods_fstfdrNs05 <- pooled_reftable_pods[, "FSTfdrNS05"]
#
#posterior_radnompods_fstfdrNs05 <- predict(object     = reg_fstfdrNs05,
#                                           obs        = global_sumstats_pods,
#                                           training   = data.frame(fstfdrNs05, global_sumstats),
#                                           quantiles  = c(0.025,0.5,0.975),
#                                           paral      = T,
#                                           ncores     = 28,
#                                           rf.weights = T)
#(posterior_radnompods_fstfdrNs05)
#
#save(posterior_radnompods_fstfdrNs05, 
#     file = paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/posterior_radnompods_fstfdrNs05",".RData"))
#
# Expected True vs estimated
#plot(x    = radnompods_fstfdrNs05, 
#     y    = posterior_radnompods_fstfdrNs05$expectation,
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = expression(eta[3]), 
#     ylab = expression(tilde(eta[3])),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     pch  = 1
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
# Median True vs estimated
#plot(x    = radnompods_fstfdrNs05, 
#     y    = posterior_radnompods_fstfdrNs05$med,
#     xlim = c(0,1),
#     ylim = c(0,1),
#     xlab = expression(eta[3]), 
#     ylab = expression(tilde(eta[3])),
#     main = expression(paste("FDR 5%"," ", F[ST], " and ", "mutations with", italic(N[s]) , " > 1")),
#     pch  = 1
#     #,
#     #cex.axis = 1.2,
#     #cex.lab  = 1.5
#     )
#abline(a=0, b=1, col = "#cb181d")
#
# Apply the threshold
#fstfdrNs05_applic_data = data.frame(sim=pooled_reftable_pods[,"sim"], meanNe2=pooled_reftable_pods[,"meanNe2"], 
#                                    True_fdr05=pooled_reftable_pods[,"FSTfdrNS05"], Infe_fdr05 = posterior_radnompods_fstfdrNs05$expectation)
#
#fstfdrNs05_applic_data <- fstfdrNs05_applic_data[1:6,]
#
#fstfdrNs05_calc = NULL
#for (i in 1:length(fstfdrNs05_applic_data$sim)){
#  t <- fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)
#  fstfdrNs05_calc = rbind(fstfdrNs05_calc, t)
#}
#
#cl <- makeCluster(18)
#registerDoParallel(cl)
#clusterEvalQ(cl)
#  
## PARALLEL PROCESSING
#------------------------------------------
#fstfdrNs05_calc <- foreach(i=1:length(fstfdrNs05_applic_data$sim),.combine=rbind, 
#                                                                  .errorhandling="pass", .verbose = TRUE) %dopar% {
#                                                                                                                   fdrthreshold(x = fstfdrNs05_applic_data[i,], tau = 10)}
#stopCluster(cl)
#
#save(fstfdrNs05_calc, 
#    file = paste0("~/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/fstfdrNs05_calc",".RData"))
#load(file=paste0("/home/pavinato/My_repositories/Tracking-selection/results/pipeline_v5/posterior_pods/fstfdrNs05_calc",".RData"))
#
```